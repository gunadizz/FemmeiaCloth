<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Pencatatan & Monitoring Mutu Ikan Segar - Makassar</title>
<meta name="description" content="Aplikasi pencatatan dan monitoring mutu ikan segar di pasar tradisional Kota Makassar (Single File App)">
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Nunito:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<!-- External Libraries (CDN) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
/* ===========================================================
   MMIS APP UI STYLES (Enhanced UX Animations Edition)
  
   orchestrated entrances, subtle motion layering, feedback states.
   
   =========================================================== */

:root {
  --accent: 210 100% 50%;
  --radius: 20px;
  --glass-bg: 220 25% 12%;
  --glass-alpha: 0.55;
  --transition: 0.25s cubic-bezier(.4,.0,.2,1);
  --transition-fast: 0.18s cubic-bezier(.4,.0,.2,1);           /* UX+ */
  --transition-slow: 0.45s cubic-bezier(.4,.0,.2,1);           /* UX+ */
  --spring: cubic-bezier(.34,1.56,.64,1);                      /* UX+ */
  --elastic: cubic-bezier(.63,-0.35,.36,1.4);                  
  --sidebar-width: 250px;
  --danger: #ef4444;
  --warn: #f59e0b;
  --ok: #10b981;
  --info: #3b82f6;
  --font-sans: 'Quicksand', system-ui, sans-serif;
  --font-base: 15px;
  --panel-gap: 1.35rem;
  --layout-max: 1480px;
  --panel-padding: 1.15rem 1.15rem 1.3rem;
  --gradient-accent: linear-gradient(135deg, hsl(var(--accent)/0.95), hsl(var(--accent)/0.55));
  --gradient-bg: radial-gradient(circle at 35% 15%, hsl(var(--accent)/0.22), transparent 70%),
    radial-gradient(circle at 85% 75%, hsl(var(--accent)/0.15), transparent 65%),
    linear-gradient(160deg, hsl(var(--accent)/0.08), transparent 70%);
  --topbar-height: 66px;

  /* UX+ Depth & Motion */
  --elev-1: 0 2px 6px -2px rgba(0,0,0,.25), 0 1px 3px -1px rgba(0,0,0,.2);
  --elev-2: 0 4px 12px -4px rgba(0,0,0,.35), 0 2px 6px -2px rgba(0,0,0,.3);
  --elev-3: 0 8px 24px -10px rgba(0,0,0,.45), 0 4px 10px -4px rgba(0,0,0,.4);
  --elev-glow: 0 0 0 1px hsl(var(--accent)/0.25), 0 6px 16px -4px hsl(var(--accent)/0.45), 0 2px 8px -2px hsl(var(--accent)/0.35);
  --focus-ring: 0 0 0 3px hsl(var(--accent)/0.40), 0 0 0 1px hsl(var(--accent)/0.85);

  /* UX+ Animation Durations */
  --dur-xs: .18s;
  --dur-s: .28s;
  --dur-m: .45s;
  --dur-l: .75s;
  --dur-xl: 1.1s;

  /* UX+ Motion Multipliers (scale dynamic) */
  --motion-scale: 1;
}
[data-theme="light"] {
  --glass-bg: 220 40% 98%;
  --glass-alpha: 0.68;
  --text-color: 220 25% 15%;
  --text-dim: 220 15% 42%;
  --bg: 220 35% 97%;
  --panel-border: 220 20% 82%;
  --shadow: 220 40% 30%;
}
[data-theme="dark"] {
  --text-color: 0 0% 100%;
  --text-dim: 220 10% 70%;
  --bg: 220 18% 8%;
  --panel-border: 220 15% 30%;
  --shadow: 220 70% 2%;
}

* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { font-size: var(--font-base); }

html, body { height:100%; }
body {
  margin:0;
  font-family: var(--font-sans);
  background: var(--gradient-bg), hsl(var(--bg));
  color: hsl(var(--text-color));
  line-height:1.45;
  -webkit-font-smoothing: antialiased;
  
  transition: background .6s ease, font-size .4s, color .4s; /* UX+ */
  accent-color: hsl(var(--accent));
}

body.reduce-motion * {
  animation: none !important;
  transition: none !important;
}

body.high-contrast {
  --glass-alpha: 0.9;
  --panel-border: 220 10% 20%;
  --text-color: 0 0% 10%;
  --text-dim: 0 0% 30%;
}

/* ===================== TYPOGRAPHY ===================== */
h1,h2,h3,h4 { font-weight:600; margin:0 0 var(--space-3); }
p { margin:0 0 var(--space-4); }
main.content > section { max-width: var(--layout-max); margin: 0 auto; width:100%; }

a {
  color:hsl(var(--accent)/0.9);
  text-decoration:none;
  outline:none;
  position:relative; /* UX+ */
  transition: color var(--dur-s), text-shadow var(--dur-s);
}
a:hover {
  color:hsl(var(--accent)/1);
  text-shadow:0 0 4px hsl(var(--accent)/0.5);
}
a:active {
  filter:brightness(.85);
}
a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
  outline:2px solid hsl(var(--accent)/0.8);
  outline-offset:2px;
  border-radius:6px;
  transition:outline-color .25s;
}

/* ===================== BUTTONS ===================== */
button {
  font-family:inherit;
  cursor:pointer;
  border:none;
  background: var(--gradient-accent);
  color:#fff;
  padding:.7rem 1rem;
  font-size:.79rem;
  border-radius:14px;
  display:inline-flex;
  gap:.5rem;
  align-items:center;
  font-weight:600;
  letter-spacing:.3px;
  position:relative;
  overflow:hidden;
  line-height:1.1;
  isolation:isolate; /* UX+ */
  transform:translateZ(0);
  backface-visibility:hidden;
  transition:
    background var(--dur-m),
    box-shadow var(--dur-m),
    transform var(--dur-m),
    filter var(--dur-s);
  box-shadow: var(--elev-2);
}
button::before,
button::after {
  content:"";
  position:absolute;
  inset:0;
  opacity:0;
  pointer-events:none;
  transition:opacity var(--dur-m);
}
button::before {
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 60%),
    linear-gradient(60deg,rgba(255,255,255,.25),transparent 70%);
  mix-blend-mode:overlay;
}
button::after { /* Ripple placeholder */ /* UX+ */
  background:
    radial-gradient(circle at var(--rx,50%) var(--ry,50%), rgba(255,255,255,.45), transparent 55%);
  transform:scale(0);
  transition: transform .6s var(--spring), opacity .6s;
  opacity:.0;
}
button:hover::before { opacity:1; }
button:hover {
  transform:translateY(-4px) scale(1.015);
  box-shadow: var(--elev-3);
  filter:brightness(1.05);
}
button:active {
  transform:translateY(0) scale(.97);
  filter:brightness(.95);
}
button:active::after {
  transform:scale(1);
  opacity:.35;
}
button.outline {
  background:hsl(var(--accent)/0.07);
  border:1px solid hsl(var(--accent)/0.5);
  color:hsl(var(--accent)/0.95);
  box-shadow:none;
}
button.outline:hover {
  background:hsl(var(--accent)/0.18);
}
button.ghost {
  background:hsl(var(--accent)/0.09);
  color:hsl(var(--accent)/0.95);
  box-shadow:none;
}
button.ghost:hover { background:hsl(var(--accent)/0.16); }
button.danger {
  background:linear-gradient(135deg,#ef4444,#b91c1c);
  box-shadow:0 6px 18px -4px rgba(239,68,68,0.55);
}
button.small {
  padding:.45rem .65rem;
  font-size:.62rem;
  border-radius:10px;
}

input, select, textarea {
  width:100%;
  border:1px solid hsl(var(--panel-border)/0.55);
  background:hsl(var(--glass-bg)/0.55);
  color:hsl(var(--text-color));
  backdrop-filter: blur(22px) saturate(1.3);
  -webkit-backdrop-filter: blur(22px) saturate(1.3);
  padding:.55rem .75rem;
  font-size:.74rem;
  border-radius:12px;
  outline:none;
  font-family:inherit;
  transition:
    background var(--dur-m),
    border-color var(--dur-m),
    box-shadow var(--dur-m),
    transform var(--dur-s);
}
input:hover, select:hover, textarea:hover {
  background:hsl(var(--glass-bg)/0.7);
}
input:focus, select:focus, textarea:focus {
  border-color:hsl(var(--accent)/0.9);
  box-shadow:0 0 0 3px hsl(var(--accent)/0.35);
  background:hsl(var(--glass-bg)/0.85);
  transform:translateY(-2px); /* UX+ */
}
textarea {
  line-height:1.45;
}

/* ===================== GLOBAL UTILITIES ===================== */
label {
  font-size:.58rem;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.55px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.4rem;
  margin-bottom:.35rem;
  color:hsl(var(--text-dim));
  position:relative;
  overflow:hidden;
}
label::after { /* UX+ subtle underline reveal */
  content:"";
  position:absolute;
  left:0;
  bottom:-2px;
  width:0;
  height:2px;
  background:hsl(var(--accent)/0.8);
  transition:width var(--dur-m);
}
input:focus + label::after,
select:focus + label::after,
textarea:focus + label::after {}

.small { font-size:.7rem; color:hsl(var(--text-dim)); }
.xsmall { font-size:.58rem; }
.muted { opacity:.75; }

.hidden { display:none !important; }
.flex { display:flex; }
.col { flex-direction:column; }
.center { align-items:center; justify-content:center; }
.gap { gap:1rem; }
.gap-s { gap:.5rem; }

/* ===================== AUTH CONTAINER ===================== */
.container-auth {
  max-width:520px;
  margin: clamp(2rem,6vh,4rem) auto;
  padding:2.35rem 2.2rem 2.6rem;
  background:linear-gradient(150deg, hsl(var(--glass-bg)/var(--glass-alpha)), hsl(var(--glass-bg)/calc(var(--glass-alpha) + .1)));
  border:1px solid hsl(var(--panel-border)/0.55);
  backdrop-filter:blur(30px) saturate(1.4);
  -webkit-backdrop-filter:blur(30px) saturate(1.4);
  border-radius:40px;
  box-shadow:0 8px 34px -12px rgba(0,0,0,.55), 0 0 0 1px hsl(var(--panel-border)/0.35), inset 0 0 0 1px hsl(var(--accent)/0.08);
  position:relative;
  overflow:hidden;
  animation: cardEnter .9s var(--spring);
  transform-origin: 50% 60%; /* UX+ */
}
.container-auth:hover { /* UX+ subtle breathing tilt */
  animation: none;
  transform:translateY(-4px);
  box-shadow:0 12px 40px -14px rgba(0,0,0,.65), 0 0 0 1px hsl(var(--panel-border)/0.4);
}

@keyframes cardEnter {
  from { transform:translateY(18px) scale(.96); opacity:0; }
  to { transform:translateY(0) scale(1); opacity:1; }
}

/* Lite mode */
body.lite-mode .panel,
body.lite-mode .sidebar,
body.lite-mode .topbar,
body.lite-mode .container-auth,
body.lite-mode .table-wrapper,
body.lite-mode .dropdown {
  backdrop-filter:none !important;
  -webkit-backdrop-filter:none !important;
  background:hsl(var(--glass-bg)/0.96) !important;
}
body.lite-mode .panel {
  box-shadow:0 4px 14px -6px rgba(0,0,0,.25), 0 0 0 1px hsl(var(--panel-border)/0.4);
}
body.lite-mode .sidebar { box-shadow:4px 0 16px -8px rgba(0,0,0,.35); }
body.lite-mode #loadingOverlay { backdrop-filter:none; -webkit-backdrop-filter:none; }
body.lite-mode .indicator::before { display:none; }
body.lite-mode .avatar, body.lite-mode .logo-circle { box-shadow:0 4px 12px -6px rgba(0,0,0,.35); }
body.lite-mode #appModal .modal-box { backdrop-filter:none; -webkit-backdrop-filter:none; }

.logo-circle {
  width:62px; height:62px;
  border-radius:20px;
  background:var(--gradient-accent);
  display:grid; place-items:center;
  color:#fff; font-weight:700; font-size:1.1rem; letter-spacing:.9px;
  box-shadow:0 10px 20px -6px hsl(var(--accent)/0.55);
  margin-bottom:.85rem;
  position:relative;
  overflow:hidden;
  transform:translateZ(0);
  animation: popIn .8s var(--spring); /* UX+ */
}
.logo-circle::after {
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(circle at 30% 30%,rgba(255,255,255,.35),transparent 60%),
    linear-gradient(to bottom,rgba(255,255,255,.15),transparent 70%);
  mix-blend-mode:overlay;
}

@keyframes popIn { /* UX+ */
  0% { transform:scale(.4) rotate(-12deg); opacity:0; filter:blur(3px); }
  60% { transform:scale(1.07) rotate(2deg); opacity:1; filter:blur(0); }
  100% { transform:scale(1) rotate(0); }
}

.glow {
  position:absolute; inset:0;
  background:
    radial-gradient(circle at 20% 15%, hsl(var(--accent)/0.28), transparent 60%),
    radial-gradient(circle at 80% 70%, hsl(var(--accent)/0.25), transparent 65%);
  pointer-events:none;
  mix-blend-mode:screen;
  opacity:.5;
  animation: subtlePulse 6s ease-in-out infinite;
}
@keyframes subtlePulse {
  0%,100% { transform:scale(1); opacity:.45; }
  50% { transform:scale(1.04); opacity:.62; }
}

.switch-auth {
  display:flex;
  gap:.6rem;
  margin-top:.9rem;
  flex-wrap:wrap;
  font-size:.75rem;
  align-items:center;
  animation: fadeSlide .55s var(--spring); /* UX+ */
}

@keyframes fadeSlide { /* UX+ */
  from { opacity:0; transform:translateY(8px); }
  to { opacity:1; transform:translateY(0); }
}

.alert {
  padding:.75rem .9rem;
  border-radius:16px;
  margin-bottom:1rem;
  font-size:.62rem;
  font-weight:600;
  display:flex;
  gap:.55rem;
  align-items:center;
  line-height:1.25;
  position:relative;
  backdrop-filter: blur(14px) saturate(1.2);
  -webkit-backdrop-filter: blur(14px) saturate(1.2);
  animation: fadeSlide .5s var(--spring);
  transform-origin: left top;
  transition: transform var(--dur-m), box-shadow var(--dur-m);
}
.alert:hover { transform: translateY(-2px) scale(1.01); box-shadow: var(--elev-2); }
.alert.info { background:hsl(var(--accent)/0.18); color:hsl(var(--accent)/1); }
.alert.danger { background:rgba(239,68,68,.18); color:var(--danger); }
.alert.success { background:rgba(16,185,129,.20); color:var(--ok); }
.alert.warn { background:rgba(245,158,11,.20); color:var(--warn); }

/* ===================== LAYOUT ===================== */
.layout {
  display:flex;
  min-height:100dvh;
  width:100%;
  /* overflow:hidden; */ /* dinonaktifkan agar sticky jalan */
  overflow:visible;
  position:relative;
  align-items:flex-start;
}

.sidebar {
  width:var(--sidebar-width);
  background:linear-gradient(160deg,hsl(var(--glass-bg)/0.78), hsl(var(--glass-bg)/0.58));
  backdrop-filter:blur(36px) saturate(1.5);
  -webkit-backdrop-filter:blur(36px) saturate(1.5);
  border-right:1px solid hsl(var(--panel-border)/0.5);
  display:flex; flex-direction:column;
  padding:1rem 1rem 1.4rem;
  position:sticky;   /* tadinya relative */
  top:0;
  height:100vh;
  overflow-y:auto;
  overscroll-behavior:contain;
  transition: transform .55s var(--spring), box-shadow var(--dur-m);
  box-shadow:8px 0 28px -14px rgba(0,0,0,.55);
  z-index:130;
  animation: slideInLeft .65s var(--spring); /* UX+ */
  will-change: transform;
}
.sidebar:hover {
  box-shadow:12px 0 36px -14px rgba(0,0,0,.65);
}

@keyframes slideInLeft { /* UX+ */
  from { transform:translateX(-40px); opacity:0; }
  to { transform:translateX(0); opacity:1; }
}

.sidebar-header {
  display:flex; align-items:center; gap:.7rem; margin-bottom:1.1rem; padding:.25rem .25rem .3rem;
  animation: staggerFade .6s var(--spring);
}
.sidebar-header h2 {
  font-size:.92rem; letter-spacing:.6px; line-height:1.1; margin:0;
  position:relative;
}
.sidebar-header h2 span:first-child { display:inline-block; }

@keyframes staggerFade { /* UX+ */
  from { opacity:0; transform:translateY(10px); filter:blur(4px); }
  to { opacity:1; transform:translateY(0); filter:blur(0); }
}

.nav {
  display:flex;
  flex-direction:column;
  gap:.35rem;
  flex:1;
  overflow-y:auto;
  padding-right:.25rem;
  scrollbar-width:thin;
  animation: listReveal .5s var(--spring); /* UX+ */
}
@keyframes listReveal { /* UX+ */
  from { opacity:0; transform:translateY(12px); }
  to { opacity:1; transform:translateY(0); }
}
.nav button {
  justify-content:flex-start;
  background:linear-gradient(to right, hsl(var(--accent)/0.0), hsl(var(--accent)/0.0));
  border:1px solid hsl(var(--panel-border)/0.25);
  color:hsl(var(--text-dim));
  font-weight:500;
  padding:.65rem .7rem;
  border-radius:16px;
  gap:.65rem;
  position:relative;
  box-shadow:none;
  font-size:.64rem;
  letter-spacing:.4px;
  transition:
    background var(--dur-s),
    color var(--dur-s),
    transform var(--dur-m),
    box-shadow var(--dur-m),
    border-color var(--dur-s);
  overflow:hidden;
}
.nav button::after { /* Hover sheen UX+ */
  content:"";
  position:absolute;
  top:0; left:-60%;
  width:60%; height:100%;
  background:linear-gradient(110deg, rgba(255,255,255,.35), rgba(255,255,255,0));
  opacity:0;
  transform:skewX(-18deg);
  transition: transform .75s var(--spring), opacity .55s;
}
.nav button:hover::after {
  opacity:1;
  transform:translateX(260%) skewX(-18deg);
}
.nav button:hover {
  background:hsl(var(--accent)/0.20);
  color:hsl(var(--accent)/1);
  transform:translateX(6px);
  border-color:hsl(var(--accent)/0.45);
}
.nav button:active {
  transform:translateX(2px) scale(.97);
}
.nav button.active {
  background:var(--gradient-accent);
  color:#fff;
  box-shadow:0 10px 26px -10px hsl(var(--accent)/0.65), 0 0 0 1px hsl(var(--accent)/0.45);
  border-color:transparent;
  transform:translateX(0);
}

.sidebar-footer {
  margin-top:.9rem;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  font-size:.6rem;
  color:hsl(var(--text-dim));
  animation: fadeSlide .55s var(--spring) .08s backwards; /* UX+ */
}

.main {
  flex:1;
  display:flex;
  flex-direction:column;
  min-width:0;
  position:relative;
  animation: mainReveal .65s var(--spring);
}
@keyframes mainReveal {
  from { opacity:0; transform:translateY(14px) scale(.98); }
  to { opacity:1; transform:translateY(0) scale(1); }
}

.topbar {
  position: fixed;
  left:var(--sidebar-width);
  right:0;
  height:var(--topbar-height);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:.75rem clamp(.75rem,1.4vw,1.15rem);
  z-index:120;
  background:linear-gradient(to bottom, hsl(var(--glass-bg)/0.92), hsl(var(--glass-bg)/0.60));
  backdrop-filter: blur(28px) saturate(1.35);
  -webkit-backdrop-filter: blur(28px) saturate(1.35);
  border-bottom:1px solid hsl(var(--panel-border)/0.55);
  box-shadow:0 4px 20px -10px rgba(0,0,0,.35);
  animation: dropIn .55s var(--spring);
}
@keyframes dropIn { /* UX+ */
  from { transform:translateY(-30px); opacity:0; }
  to { transform:translateY(0); opacity:1;}
}

.content {
  padding-top: calc(var(--topbar-height) + 1rem);
}

@media (max-width:1080px){
  .topbar { left:0; }
}
.topbar .group-inline { display:flex; align-items:center; gap:.65rem; flex-wrap:wrap; }

.search-box {
  display:flex;
  align-items:center;
  background:hsl(var(--glass-bg)/0.7);
  border:1px solid hsl(var(--panel-border)/0.6);
  padding:.4rem .65rem;
  gap:.45rem;
  border-radius:14px;
  width:100%;
  max-width:340px;
  position:relative;
  backdrop-filter:blur(22px);
  -webkit-backdrop-filter:blur(22px);
  transition:
    box-shadow var(--dur-m),
    border-color var(--dur-m),
    background var(--dur-m),
    transform var(--dur-m);
}
.search-box:focus-within {
  border-color:hsl(var(--accent)/0.9);
  box-shadow:0 0 0 3px hsl(var(--accent)/0.35), var(--elev-1);
  background:hsl(var(--glass-bg)/0.9);
  transform:translateY(-2px);
}
.search-box input {
  background:transparent;
  padding:.3rem 0;
  border:none;
  font-size:.68rem;
  flex:1;
}

.lang-pill {
  background:hsl(var(--accent)/0.15);
  color:hsl(var(--accent)/0.95);
  padding:.38rem .65rem;
  border-radius:14px;
  font-size:.58rem;
  font-weight:700;
  letter-spacing:.6px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:.35rem;
  transition:background var(--dur-m), transform var(--dur-m), box-shadow var(--dur-m);
  border:1px solid hsl(var(--accent)/0.4);
  position:relative;
  overflow:hidden;
}
.lang-pill::before { /* UX+ pulse highlight */
  content:"";
  position:absolute;
  width:40%;
  aspect-ratio:1;
  top:50%; left:50%;
  transform:translate(-50%,-50%) scale(0);
  background:radial-gradient(circle, hsl(var(--accent)/0.65), transparent 70%);
  opacity:0;
  transition: transform .7s var(--spring), opacity .55s;
}
.lang-pill:hover { background:hsl(var(--accent)/0.28); transform:translateY(-3px); box-shadow:var(--elev-2); }
.lang-pill:active { transform:translateY(-1px) scale(.95); }
.lang-pill:active::before { transform:translate(-50%,-50%) scale(1.5); opacity:.35; }

.avatar {
  width:40px;
  height:40px;
  border-radius:16px;
  background: linear-gradient(135deg,hsl(var(--accent)/0.3),hsl(var(--accent)/0.5));
  display:grid;
  place-items:center;
  color:#fff;
  font-weight:600;
  font-size:.78rem;
  position:relative;
  overflow:hidden;
  cursor:pointer;
  border:1px solid hsl(var(--panel-border)/0.45);
  box-shadow:0 6px 18px -8px rgba(0,0,0,.55);
  transition:
    transform var(--dur-m),
    box-shadow var(--dur-m),
    filter var(--dur-s);
}
.avatar:hover {
  transform:translateY(-4px) rotate(2deg);
  box-shadow:0 10px 28px -12px rgba(0,0,0,.6), 0 0 0 1px hsl(var(--accent)/0.35);
  filter:brightness(1.05);
}
.avatar:active {
  transform:translateY(0) scale(.95) rotate(-1deg);
  filter:brightness(.9);
}
.avatar img { width:100%; height:100%; object-fit:cover; display:block; }

.dropdown {
  position:absolute;
  top:110%;
  right:0;
  background:linear-gradient(145deg, hsl(var(--glass-bg)/0.95), hsl(var(--glass-bg)/0.78));
  backdrop-filter: blur(30px) saturate(1.4);
  -webkit-backdrop-filter: blur(30px) saturate(1.4);
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:20px;
  min-width:260px;
  display:none;
  flex-direction:column;
  padding:.55rem;
  box-shadow:0 20px 48px -18px rgba(0,0,0,0.55);
  z-index:200;
  animation: dropdownPop .55s var(--spring);
  transform-origin: top right;
  will-change: transform, opacity;
}
@keyframes dropdownPop {
  from { transform:translateY(12px) scale(.94); opacity:0; }
  to { transform:translateY(0) scale(1); opacity:1; }
}
.dropdown.show { display:flex; }
.dropdown button {
  background:transparent;
  border:1px solid transparent;
  box-shadow:none;
  padding:.6rem .65rem;
  border-radius:14px;
  color:hsl(var(--text-dim));
  font-size:.62rem;
  gap:.55rem;
  justify-content:flex-start;
  font-weight:600;
  letter-spacing:.4px;
  transition: background var(--dur-m), color var(--dur-m), padding var(--dur-s);
  position:relative;
  overflow:hidden;
}
.dropdown button::after { /* UX+ */
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(125deg,hsl(var(--accent)/0.4),transparent 75%);
  mix-blend-mode:overlay;
  opacity:0;
  transition:opacity var(--dur-m);
}
.dropdown button:hover {
  background:hsl(var(--accent)/0.25);
  color:hsl(var(--accent)/1);
}
.dropdown button:hover::after { opacity:.5; }

/* ===================== CONTENT CONTAINER ===================== */
.content {
  padding: 1.15rem clamp(.8rem, 1.4vw, 1.25rem) 2.2rem;
  flex:1;
  overflow: visible;
  display:flex;
  flex-direction:column;
  gap:1.9rem;
  scroll-behavior:smooth;
  position:relative;
  animation: contentFade .55s ease;
  will-change: scroll-position;
}
@keyframes contentFade { /* UX+ */
  from { opacity:0; transform:translateY(12px); }
  to { opacity:1; transform:translateY(0); }
}

.grid { display:grid; gap:1.15rem; }

.cards-analytics { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

.panel {
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.66), hsl(var(--glass-bg)/0.48));
  backdrop-filter:blur(38px) saturate(1.55);
  -webkit-backdrop-filter:blur(38px) saturate(1.55);
  border:1px solid hsl(var(--panel-border)/0.65);
  border-radius:34px;
  padding:var(--panel-padding);
  position:relative;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  gap:.9rem;
  animation: panelIn .6s var(--spring);
  box-shadow:0 8px 30px -14px rgba(0,0,0,0.6), 0 0 0 1px hsl(var(--panel-border)/0.35), inset 0 0 0 1px hsl(var(--accent)/0.08);
  transition:
    transform var(--dur-m),
    box-shadow var(--dur-m),
    border-color var(--dur-s),
    background var(--dur-m);
  will-change: transform;
}
.panel.compact { padding:1rem 1.05rem 1.15rem; }
@keyframes panelIn {
  from { opacity:0; transform:translateY(14px) scale(.97); }
  to { opacity:1; transform:translateY(0) scale(1); }
}
.panel:hover {
  box-shadow:0 14px 34px -16px rgba(0,0,0,0.65), 0 0 0 1px hsl(var(--panel-border)/0.42), inset 0 0 0 1px hsl(var(--accent)/0.10);
  transform:translateY(-6px);
}
.panel:active {
  transform:translateY(-2px) scale(.99);
}

.panel.bento { min-height:240px; }

.panel-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1rem;
  flex-wrap:wrap;
  padding-bottom:.45rem;
  border-bottom:1px solid hsl(var(--panel-border)/0.4);
  margin:-.3rem -1.3rem .6rem;
  padding: .7rem 1.3rem .55rem;
  position:relative;
  animation: headerRise .5s var(--spring); /* UX+ */
}
@keyframes headerRise { /* UX+ */
  from { opacity:0; transform:translateY(10px); }
  to { opacity:1; transform:translateY(0); }
}
.panel-header h3 {
  font-size:.74rem;
  text-transform:uppercase;
  letter-spacing:.75px;
  font-weight:700;
  color:hsl(var(--text-dim));
  margin:0;
  display:flex;
  gap:.5rem;
  align-items:center;
  position:relative;
  overflow:hidden;
}
.panel-header h3::after { /* UX+ accent underline */
  content:"";
  position:absolute;
  bottom:-4px;
  left:0;
  width:0;
  height:2px;
  background:hsl(var(--accent)/0.6);
  transition:width var(--dur-m) var(--spring);
}
.panel-header h3:hover::after { width:100%; }

.badge {
  display:inline-flex;
  align-items:center;
  gap:.35rem;
  background:hsl(var(--accent)/0.18);
  color:hsl(var(--accent)/0.95);
  padding:.35rem .6rem;
  border-radius:999px;
  font-size:.55rem;
  font-weight:700;
  letter-spacing:.55px;
  text-transform:uppercase;
  box-shadow:0 4px 10px -4px hsl(var(--accent)/0.5);
  animation: popBadge .55s var(--spring);
}
@keyframes popBadge { /* UX+ */
  0% { transform:scale(.6); opacity:0; }
  60% { transform:scale(1.08); opacity:1; }
  100% { transform:scale(1); }
}

/* ===================== TABLE ===================== */
.table-wrapper {
  width:100%;
  overflow:auto;
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:24px;
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.40), hsl(var(--glass-bg)/0.30));
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  max-height:560px;
  position:relative;
  animation: subtleFade .6s ease;
}
@keyframes subtleFade { /* UX+ */
  from { opacity:0; transform:scale(.98); }
  to { opacity:1; transform:scale(1); }
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:.62rem;
  min-width:1400px;
  table-layout:auto;
}

thead {
  background:linear-gradient(90deg,hsl(var(--accent)/0.40), hsl(var(--accent)/0.30));
  color:#fff;
  position:relative;
}
thead th {
  text-align:left;
  padding:.6rem .65rem;
  font-weight:600;
  letter-spacing:.45px;
  position:sticky;
  top:0;
  backdrop-filter:blur(12px);
  z-index:2;
  white-space:nowrap;
  background:linear-gradient(90deg,hsl(var(--accent)/0.38), hsl(var(--accent)/0.26));
  border-right:1px solid hsl(var(--panel-border)/0.3);
  animation: headIn .55s ease;
}
thead th:last-child { border-right:none; }
@keyframes headIn { /* UX+ */
  from { opacity:0; transform:translateY(-6px); }
  to { opacity:1; transform:translateY(0); }
}

tbody tr {
  border-bottom:1px solid hsl(var(--panel-border)/0.35);
  transition:
    background var(--dur-s),
    transform var(--dur-m),
    box-shadow var(--dur-m),
    filter var(--dur-m);
  animation: rowIn .55s ease;
  will-change: transform;
}
@keyframes rowIn {
  from { opacity:0; transform:translateY(6px); }
  to { opacity:1; transform:translateY(0); }
}
tbody tr:hover {
  background:hsl(var(--accent)/0.12);
  box-shadow:0 2px 6px -2px hsl(var(--accent)/0.35);
  transform:translateY(-2px);
}
tbody tr:active {
  transform:translateY(0) scale(.995);
}
tbody tr.flash-new {
  animation: flashRow 1.9s ease;
}
@keyframes flashRow {
  0% { background:hsl(var(--accent)/0.75); color:#fff; }
  30% { background:hsl(var(--accent)/0.40); }
  60% { background:hsl(var(--accent)/0.18); }
  100% { background:transparent; }
}

td {
  padding:.55rem .6rem;
  vertical-align:top;
  line-height:1.2;
  transition: background var(--dur-s);
}
td button.outline.small {
  transition: background var(--dur-s), transform var(--dur-s);
}
td button.outline.small:hover {
  transform:translateY(-2px) scale(1.03);
}

.actions { display:flex; gap:.3rem; flex-wrap:wrap; }

.status-dot {
  width:11px; height:11px;
  border-radius:6px;
  background:gray;
  box-shadow:0 0 0 3px rgba(255,255,255,0.06);
  position:relative;
  overflow:hidden;
}
.status-dot::after {
  content:"";
  position:absolute; inset:-4px;
  border-radius:inherit;
  background:currentColor;
  opacity:0;
  animation:pulse 2.6s ease-in-out infinite;
}
@keyframes pulse {
  0%,100% { transform:scale(1); opacity:.18; }
  50% { transform:scale(1.6); opacity:0; }
}

.status-good { background:var(--ok); color:var(--ok); }
.status-warn { background:var(--warn); color:var(--warn); }
.status-bad { background:var(--danger); color:var(--danger); }

.inline { display:inline-flex; align-items:center; gap:.35rem; }

/* ===================== FORM GRID ===================== */
.form-grid {
  display:grid;
  gap:.95rem;
  grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  align-items:start;
  animation: fadeScale .6s var(--spring);
}

.divider {
  height:1px;
  background:linear-gradient(to right, transparent, hsl(var(--panel-border)/0.9), transparent);
  margin:.9rem 0 1.2rem;
  position:relative;
  overflow:hidden;
}
.divider::after { /* UX+ flowing accent line */
  content:"";
  position:absolute;
  top:0; left:-30%;
  width:30%; height:100%;
  background:linear-gradient(90deg, hsl(var(--accent)/0.7), transparent);
  animation: dividerRun 2.8s linear infinite;
}
@keyframes dividerRun {
  0% { transform:translateX(0); }
  100% { transform:translateX(430%); }
}

.toggle-group { display:flex; gap:.45rem; flex-wrap:wrap; }

.toggle-chip {
  padding:.42rem .75rem;
  background:hsl(var(--accent)/0.16);
  color:hsl(var(--accent)/0.95);
  font-size:.55rem;
  letter-spacing:.55px;
  font-weight:700;
  border-radius:14px;
  cursor:pointer;
  user-select:none;
  border:1px solid hsl(var(--accent)/0.0);
  transition:
    background var(--dur-s),
    transform var(--dur-m),
    color var(--dur-s),
    box-shadow var(--dur-m),
    letter-spacing var(--dur-s);
  position:relative;
  overflow:hidden;
}
.toggle-chip::before { /* sheen */
  content:"";
  position:absolute;
  top:0; left:-60%;
  width:60%; height:100%;
  background:linear-gradient(120deg, rgba(255,255,255,.45), transparent 75%);
  opacity:0;
  transform:skewX(-18deg);
  transition: transform .9s var(--spring), opacity .55s;
}
.toggle-chip.active, .toggle-chip:hover {
  background:var(--gradient-accent);
  color:#fff;
  transform:translateY(-4px) scale(1.04);
  letter-spacing:.65px;
  box-shadow: var(--elev-glow);
}
.toggle-chip.active::before,
.toggle-chip:hover::before {
  opacity:.65;
  transform:translateX(240%) skewX(-18deg);
}

.inline-field { display:flex; flex-direction:column; gap:.3rem; }

footer.app {
  padding:1rem 1.4rem;
  font-size:.55rem;
  text-align:center;
  color:hsl(var(--text-dim));
  opacity:.9;
  letter-spacing:.4px;
  animation: footerFade .6s ease;
}
@keyframes footerFade { from{opacity:0;} to{opacity:.9;} }

/* ===================== DASHBOARD INDICATORS ===================== */
.indicators {
  display:grid;
  gap:.8rem;
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
  margin-top:.2rem;
  animation: indicatorsIntro .7s var(--spring);
}
@keyframes indicatorsIntro {
  from { opacity:0; transform:translateY(14px); filter:blur(4px); }
  to { opacity:1; transform:translateY(0); filter:blur(0); }
}
.indicators .indicator {
  position:relative;
  background:linear-gradient(150deg,hsl(var(--accent)/0.20), hsl(var(--accent)/0.08));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:20px;
  padding:.75rem .85rem .95rem;
  display:flex;
  flex-direction:column;
  gap:.4rem;
  font-variant-numeric: tabular-nums;
  isolation:isolate;
  transition:
    transform var(--dur-m),
    box-shadow var(--dur-m),
    background var(--dur-m),
    border-color var(--dur-s);
  overflow:hidden;
  animation: indicatorAppear .6s var(--spring);
  will-change: transform;
}
@keyframes indicatorAppear {
  from { opacity:0; transform:translateY(14px) scale(.95); }
  to { opacity:1; transform:translateY(0) scale(1); }
}
.indicator::before {
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(circle at 35% 20%, hsl(var(--accent)/0.45), transparent 65%),
    radial-gradient(circle at 80% 75%, hsl(var(--accent)/0.35), transparent 70%);
  mix-blend-mode:overlay;
  opacity:.35;
  pointer-events:none;
  animation: indicatorGlow 7s linear infinite;
}
@keyframes indicatorGlow {
  0% { transform:translateX(-10%) scale(1); }
  50% { transform:translateX(10%) scale(1.04); }
  100% { transform:translateX(-10%) scale(1); }
}
.indicator:hover {
  transform:translateY(-6px) scale(1.03);
  box-shadow: var(--elev-3);
  background:linear-gradient(150deg,hsl(var(--accent)/0.30), hsl(var(--accent)/0.10));
}
.indicator:active {
  transform:translateY(-2px) scale(.98);
}
.indicator h4 {
  margin:0;
  font-size:.5rem;
  letter-spacing:.7px;
  text-transform:uppercase;
  color:hsl(var(--text-dim));
  font-weight:800;
  display:flex;
  align-items:center;
  gap:.35rem;
  position:relative;
}
.indicator .val {
  font-size:1.65rem;
  font-weight:700;
  line-height:1;
  letter-spacing:.5px;
  color:hsl(var(--text-color));
  animation: numberPop .6s var(--spring);
}
@keyframes numberPop { /* UX+ */
  0% { transform:translateY(6px) scale(.95); opacity:0; }
  60% { transform:translateY(-2px) scale(1.04); opacity:1; }
  100% { transform:translateY(0) scale(1); }
}
.indicator .trend {
  font-size:.5rem;
  font-weight:700;
  letter-spacing:.55px;
  padding:.3rem .55rem;
  border-radius:10px;
  background:hsl(var(--accent)/0.30);
  color:#fff;
  align-self:flex-start;
  box-shadow:0 4px 12px -6px hsl(var(--accent)/0.55);
  animation: fadeSlide .65s var(--spring);
}

/* ===================== CHARTS ===================== */
.chart-container {
  position:relative;
  width:100%;
  height:250px;
  animation: fadeScale .65s var(--spring);
  will-change: transform, opacity;
}

/* ===================== ROLE BADGE ===================== */
.badge-role {
  background:hsl(var(--accent)/0.30);
  color:#fff;
  border-radius:12px;
  padding:.35rem .6rem;
  font-size:.55rem;
  letter-spacing:.65px;
  font-weight:700;
  text-transform:uppercase;
  box-shadow:0 4px 12px -6px hsl(var(--accent)/0.55);
  animation: popBadge .6s var(--spring);
}

/* ===================== PREFERENCES ===================== */
.preference-grid {
  display:grid;
  gap:1.1rem;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  align-items:start;
  animation: fadeIn .6s ease;
}
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

.color-palette {
  display:flex;
  gap:.45rem;
  flex-wrap:wrap;
}
.color-swatch {
  width:36px; height:36px;
  border-radius:12px;
  cursor:pointer;
  position:relative;
  box-shadow:0 0 0 1px hsl(var(--panel-border)/0.6), 0 6px 14px -6px rgba(0,0,0,0.6);
  transition:
    transform var(--dur-m),
    box-shadow var(--dur-m),
    filter var(--dur-m);
  overflow:hidden;
}
.color-swatch:hover {
  transform:translateY(-8px) rotate(-6deg) scale(1.07);
  filter:brightness(1.05) saturate(1.1);
}
.color-swatch.active {
  transform:translateY(-4px) scale(1.12);
  box-shadow:0 10px 26px -12px hsl(var(--accent)/0.65), 0 0 0 2px rgba(255,255,255,.45);
}
.color-swatch.active::after {
  content:"âœ“";
  position:absolute; inset:0;
  display:grid; place-items:center;
  color:#fff;
  font-size:.95rem;
  font-weight:700;
  text-shadow:0 2px 6px rgba(0,0,0,0.5);
  animation: scaleIn .5s var(--spring);
}
@keyframes scaleIn {
  from { transform:scale(.4) rotate(-20deg); opacity:0; }
  to { transform:scale(1) rotate(0); opacity:1; }
}

.toggle {
  display:inline-flex;
  align-items:center;
  gap:.45rem;
  background:hsl(var(--accent)/0.26);
  color:#fff;
  padding:.5rem .8rem;
  font-size:.55rem;
  border-radius:16px;
  cursor:pointer;
  font-weight:800;
  letter-spacing:.55px;
  user-select:none;
  box-shadow:0 8px 20px -8px hsl(var(--accent)/0.55);
  transition:
    background var(--dur-m),
    transform var(--dur-m),
    box-shadow var(--dur-m),
    filter var(--dur-m);
  position:relative;
  overflow:hidden;
  text-transform:uppercase;
}
.toggle::before {
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(90deg,rgba(255,255,255,.25),transparent 60%);
  opacity:0;
  transition:opacity .55s;
}
.toggle:hover::before { opacity:.9; }
.toggle:hover {
  transform:translateY(-4px) scale(1.03);
  box-shadow: var(--elev-glow);
}
.toggle:active {
  transform:translateY(-1px) scale(.96);
  filter:brightness(.95);
}

.responsive-hide { display:none; }

/* ===================== MODALS ===================== */
#appModal, #userProfileModal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
  z-index:10000;
  display:none;
  align-items:center;
  justify-content:center;
  padding:1.5rem;
  animation: modalBg .35s ease;
}
@keyframes modalBg {
  from { opacity:0; }
  to { opacity:1; }
}
#appModal.show, #userProfileModal.show { display:flex; }
#appModal .modal-box, #userProfileModal .modal-box {
  width:100%;
  max-width:420px;
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.92),hsl(var(--glass-bg)/0.72));
  border:1px solid hsl(var(--panel-border)/0.55);
  backdrop-filter:blur(30px) saturate(1.4);
  -webkit-backdrop-filter:blur(30px) saturate(1.4);
  border-radius:28px;
  padding:1.2rem 1.35rem 1.4rem;
  display:flex;
  flex-direction:column;
  gap:.9rem;
  animation: modalIn .55s var(--spring);
  position:relative;
  box-shadow:0 18px 46px -18px rgba(0,0,0,.65), 0 0 0 1px hsl(var(--panel-border)/0.35);
  transform-origin:center;
  overflow:hidden;
}
#userProfileModal .modal-box { max-width:480px; }
@keyframes modalIn {
  from {opacity:0;transform:translateY(18px) scale(.94) rotateX(-8deg);}
  to {opacity:1;transform:translateY(0) scale(1) rotateX(0);}
}
.modal-actions { display:flex; gap:.6rem; flex-wrap:wrap; justify-content:flex-end; }
.modal-title { font-size:.8rem; font-weight:700; letter-spacing:.6px; display:flex; gap:.5rem; align-items:center; }
.modal-text { font-size:.65rem; line-height:1.4; color:hsl(var(--text-dim)); }

#recordDetailModal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px);
  z-index:10050;
  display:none;
  align-items:center;
  justify-content:center;
  padding:1.2rem;
  animation: modalBg .35s ease;
}
#recordDetailModal.show { display:flex; }
#recordDetailModal .detail-box {
  width:100%;
  max-width:640px;
  background:linear-gradient(150deg,hsl(var(--glass-bg)/0.92), hsl(var(--glass-bg)/0.78));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:30px;
  padding:1.3rem 1.4rem 1.5rem;
  display:flex;
  flex-direction:column;
  gap:.9rem;
  max-height:85vh;
  overflow:auto;
  animation: modalIn .55s var(--spring);
  position:relative;
  box-shadow:0 22px 52px -18px rgba(0,0,0,.7);
}
#recordDetailModal .close-btn {
  position:absolute;
  top:.65rem;
  right:.65rem;
  background:hsl(var(--accent)/0.18);
  border:1px solid hsl(var(--panel-border)/0.5);
  color:#fff;
  padding:.4rem .55rem;
  border-radius:12px;
  cursor:pointer;
  font-size:.55rem;
  display:inline-flex;
  gap:.35rem;
  align-items:center;
  transition:background var(--dur-s), transform var(--dur-s);
}
#recordDetailModal .close-btn:hover {
  background:hsl(var(--accent)/0.35);
  transform:translateY(-2px);
}
.detail-grid {
  display:grid;
  gap:.65rem;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  font-size:.55rem;
  line-height:1.35;
}
.detail-grid div {
  background:hsl(var(--accent)/0.12);
  padding:.55rem .65rem .6rem;
  border-radius:14px;
  border:1px solid hsl(var(--panel-border)/0.5);
  display:flex;
  flex-direction:column;
  gap:.25rem;
  animation: fadeSlide .5s var(--spring);
  position:relative;
  overflow:hidden;
}
.detail-grid div::after { /* shimmer accent */
  content:"";
  position:absolute;
  top:0; left:-40%;
  width:40%; height:100%;
  background:linear-gradient(115deg,rgba(255,255,255,.35),transparent 70%);
  opacity:0;
  transform:skewX(-18deg);
  transition: transform .9s var(--spring), opacity .6s;
}
.detail-grid div:hover::after {
  opacity:.6;
  transform:translateX(260%) skewX(-18deg);
}
.detail-label {
  font-size:.48rem;
  letter-spacing:.55px;
  font-weight:700;
  text-transform:uppercase;
  color:hsl(var(--text-dim));
}
.detail-image {
  max-width:100%;
  border-radius:18px;
  border:1px solid hsl(var(--panel-border)/0.55);
  box-shadow:0 6px 18px -8px rgba(0,0,0,.5);
  object-fit:cover;
  display:block;
  margin-top:.35rem;
  animation: fadeScale .55s var(--spring);
}

/* ===================== SOCIAL ===================== */
.social-container {
  display:grid;
  gap:1.2rem;
  grid-template-columns: minmax(0,1fr) 320px;
  animation: fadeSlide .6s var(--spring);
}
@media (max-width:980px){
  .social-container { grid-template-columns:1fr; }
}
.social-form {
  background:linear-gradient(150deg,hsl(var(--accent)/0.16),hsl(var(--accent)/0.08));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.9rem 1rem 1.05rem;
  border-radius:24px;
  display:flex;
  flex-direction:column;
  gap:.6rem;
  animation: panelIn .6s var(--spring);
}
.social-form textarea {
  resize:vertical;
  min-height:90px;
  font-size:.65rem;
  transition: border-color var(--dur-m), background var(--dur-m), box-shadow var(--dur-m);
}
.social-form textarea:focus {
  background:hsl(var(--accent)/0.08);
  box-shadow:0 0 0 3px hsl(var(--accent)/0.25);
}
.social-form .actions {
  display:flex;
  gap:.55rem;
  flex-wrap:wrap;
  justify-content:space-between;
}
.social-feed {
  display:flex;
  flex-direction:column;
  gap:.8rem;
  max-height:640px;
  overflow:auto;
  padding-right:.3rem;
  animation: fadeSlide .6s var(--spring);
  scrollbar-width:thin;
}
.social-feed::-webkit-scrollbar { width:8px; }
.social-feed::-webkit-scrollbar-thumb {
  background:hsl(var(--accent)/0.4);
  border-radius:10px;
  border:2px solid transparent;
  background-clip:content-box;
}
.social-post {
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.65),hsl(var(--glass-bg)/0.50));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:24px;
  padding:.85rem .95rem 1rem;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  font-size:.6rem;
  position:relative;
  animation: postEnter .65s var(--spring);
  transition:
    transform var(--dur-m),
    box-shadow var(--dur-m),
    border-color var(--dur-s),
    background var(--dur-m);
  will-change: transform;
}
@keyframes postEnter { /* UX+ */
  from { opacity:0; transform:translateY(14px) scale(.96); }
  to { opacity:1; transform:translateY(0) scale(1); }
}
.social-post:hover {
  transform:translateY(-6px);
  box-shadow: var(--elev-3);
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.75),hsl(var(--glass-bg)/0.55));
}
.social-post:active {
  transform:translateY(-2px) scale(.98);
}
.social-post-header {
  display:flex;
  align-items:center;
  gap:.55rem;
  font-weight:700;
  letter-spacing:.4px;
}
.social-post-role {
  background:hsl(var(--accent)/0.25);
  padding:.2rem .5rem;
  border-radius:10px;
  font-size:.48rem;
  font-weight:700;
  letter-spacing:.4px;
}
.social-post-time {
  font-size:.48rem;
  color:hsl(var(--text-dim));
  margin-left:auto;
}
.social-post-content {
  font-size:.62rem;
  line-height:1.4;
  white-space:pre-wrap;
  word-break:break-word;
}
.social-post-image {
  max-width:100%;
  max-height:320px;
  border-radius:18px;
  object-fit:cover;
  border:1px solid hsl(var(--panel-border)/0.55);
  box-shadow:0 6px 16px -8px rgba(0,0,0,.45);
  animation: fadeScale .55s var(--spring);
  transition: transform var(--dur-m), box-shadow var(--dur-m), filter var(--dur-m);
  cursor:zoom-in;
}
.social-post-image:hover {
  transform:scale(1.025);
  box-shadow:0 10px 28px -12px rgba(0,0,0,.55);
  filter:brightness(1.04);
}
.social-post-actions {
  display:flex;
  gap:.5rem;
  flex-wrap:wrap;
  margin-top:.2rem;
}

.social-users {
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.66), hsl(var(--glass-bg)/0.50));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:24px;
  padding:.95rem 1rem 1.1rem;
  display:flex;
  flex-direction:column;
  gap:.6rem;
  max-height:640px;
  overflow:auto;
  animation: panelIn .6s var(--spring);
  scrollbar-width:thin;
}
.social-users::-webkit-scrollbar { width:8px; }
.social-users::-webkit-scrollbar-thumb {
  background:hsl(var(--accent)/0.4);
  border-radius:10px;
  border:2px solid transparent;
  background-clip:content-box;
}
.social-user-item {
  display:flex;
  gap:.6rem;
  align-items:flex-start;
  background:hsl(var(--accent)/0.15);
  padding:.55rem .65rem .6rem;
  border-radius:16px;
  font-size:.55rem;
  line-height:1.25;
  border:1px solid hsl(var(--panel-border)/0.55);
  cursor:pointer;
  transition:
    background var(--dur-m),
    transform var(--dur-m),
    box-shadow var(--dur-m);
  position:relative;
  overflow:hidden;
}
.social-user-item::after { /* sheen */
  content:"";
  position:absolute;
  top:0; left:-50%;
  height:100%; width:50%;
  background:linear-gradient(115deg,rgba(255,255,255,.4),transparent 70%);
  opacity:0;
  transform:skewX(-18deg);
  transition: transform .9s var(--spring), opacity .6s;
}
.social-user-item:hover {
  background:hsl(var(--accent)/0.22);
  transform:translateY(-4px) scale(1.02);
  box-shadow: var(--elev-2);
}
.social-user-item:hover::after {
  opacity:.55;
  transform:translateX(260%) skewX(-18deg);
}
.social-user-item:active {
  transform:translateY(-1px) scale(.97);
}
.social-user-item .avatar-mini {
  width:38px; height:38px;
  border-radius:14px;
  background:linear-gradient(135deg,hsl(var(--accent)/0.35),hsl(var(--accent)/0.55));
  display:grid; place-items:center;
  color:#fff;
  font-weight:700;
  font-size:.7rem;
  position:relative;
  overflow:hidden;
  flex-shrink:0;
  animation: fadeScale .55s var(--spring);
}
.social-user-item .avatar-mini img {
  width:100%; height:100%; object-fit:cover;
}

/* Reactions & Comments */
.social-post-reactions {
  display:flex;
  gap:.45rem;
  flex-wrap:wrap;
  font-size:.55rem;
  margin-top:.2rem;
}
.reaction-btn {
  background:hsl(var(--accent)/0.22);
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.3rem .55rem;
  border-radius:14px;
  font-size:.55rem;
  display:inline-flex;
  gap:.35rem;
  align-items:center;
  cursor:pointer;
  font-weight:600;
  letter-spacing:.4px;
  transition:
    background var(--dur-m),
    transform var(--dur-m),
    box-shadow var(--dur-m),
    color var(--dur-s);
  position:relative;
  overflow:hidden;
}
.reaction-btn::before {
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(115deg, rgba(255,255,255,.35), transparent 70%);
  opacity:0;
  transform:translateX(-30%) skewX(-18deg);
  transition:opacity .6s, transform 1s var(--spring);
}
.reaction-btn:hover::before {
  opacity:.55;
  transform:translateX(120%) skewX(-18deg);
}
.reaction-btn:hover {
  background:hsl(var(--accent)/0.32);
  transform:translateY(-3px) scale(1.04);
}
.reaction-btn:active {
  transform:translateY(0) scale(.95);
}
.reaction-btn.active {
  background:var(--gradient-accent);
  color:#fff;
  box-shadow:0 6px 18px -8px hsl(var(--accent)/0.55);
  transform:translateY(-2px);
}
.comments-box {
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.75), hsl(var(--glass-bg)/0.60));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:18px;
  padding:.65rem .7rem .75rem;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  font-size:.55rem;
  margin-top:.5rem;
  max-height:260px;
  overflow:auto;
  animation: fadeScale .55s var(--spring);
}
.comment-item {
  background:hsl(var(--accent)/0.16);
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.45rem .55rem .5rem;
  border-radius:14px;
  display:flex;
  gap:.55rem;
  line-height:1.3;
  position:relative;
  transition:
    transform var(--dur-m),
    background var(--dur-m),
    box-shadow var(--dur-m);
  animation: commentIn .55s var(--spring);
}
@keyframes commentIn { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
.comment-item:hover {
  transform:translateY(-3px);
  background:hsl(var(--accent)/0.25);
  box-shadow:0 6px 16px -8px rgba(0,0,0,.4);
}
.comment-item:active {
  transform:translateY(-1px) scale(.97);
}
.comment-item .del-comment-btn {
  position:absolute;
  top:.3rem;
  right:.35rem;
  background:rgba(0,0,0,.25);
  color:#fff;
  border:none;
  font-size:.48rem;
  padding:.15rem .35rem;
  border-radius:8px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:.2rem;
  transition:
    background var(--dur-m),
    transform var(--dur-m);
}
.comment-item .del-comment-btn:hover {
  background:rgba(239,68,68,.55);
  transform:scale(1.15);
}

/* Quality indicator list refined */
#qualityIndicatorList {
  display:flex;
  flex-direction:column;
  gap:.45rem;
  max-height:360px;
  overflow:auto;
  padding-right:.4rem;
  scrollbar-width:thin;
}
#qualityIndicatorList::-webkit-scrollbar {
  width:9px;
}
#qualityIndicatorList::-webkit-scrollbar-thumb {
  background:linear-gradient(180deg,hsl(var(--accent)/0.4),hsl(var(--accent)/0.55));
  border-radius:10px;
  border:2px solid transparent;
  background-clip:content-box;
}
.quality-item {
  display:grid;
  grid-template-columns: 16px 1fr;
  gap:.6rem;
  background:hsl(var(--accent)/0.11);
  padding:.55rem .65rem .6rem;
  border-radius:16px;
  border:1px solid hsl(var(--panel-border)/0.45);
  animation:fadeScale .45s var(--ease-spring);
  position:relative;
  cursor:pointer;
  font-size:.53rem;
  line-height:1.35;
}
.quality-item:hover { background:hsl(var(--accent)/0.18); }
.quality-item:active { transform:scale(.98); }
.quality-meta {
  display:flex;
  flex-wrap:wrap;
  gap:.25rem .45rem;
  margin-top:.25rem;
  font-size:.46rem;
  letter-spacing:.4px;
  text-transform:uppercase;
  font-weight:700;
  color:hsl(var(--text-dim));
}
.quality-hazard-flag {
  display:inline-flex;
  background:#dc2626;
  color:#fff;
  padding:.18rem .45rem;
  border-radius:10px;
  font-size:.46rem;
  font-weight:700;
  letter-spacing:.4px;
  align-items:center;
  gap:.25rem;
}
.quality-hazard-flag.safe {
  background:#059669;
}
.quality-score {
  position:absolute;
  top:.45rem;
  right:.55rem;
  background:hsl(var(--accent)/0.75);
  color:#fff;
  font-size:.48rem;
  padding:.25rem .45rem;
  border-radius:10px;
  font-weight:700;
  letter-spacing:.5px;
  box-shadow:0 4px 10px -5px hsl(var(--accent)/0.55);
}

.fade-scale { animation: fadeScale .55s var(--ease-spring); }
@keyframes fadeScale { from { opacity:0; transform:scale(.94); } to { opacity:1; transform:scale(1); } }

.slide-in-up { animation: slideInUp .6s var(--ease-spring); }
@keyframes slideInUp {
  from { opacity:0; transform:translateY(18px); }
  to { opacity:1; transform:translateY(0); }
}

.notice {
  font-size:.55rem;
  background:hsl(var(--accent)/0.18);
  color:hsl(var(--accent)/1);
  padding:.45rem .6rem;
  border-radius:12px;
  font-weight:600;
  letter-spacing:.4px;
  display:inline-flex;
  gap:.3rem;
  align-items:center;
}



/* ===================== HAZARDS ===================== */
.hazard-badge {
  display:inline-flex;
  align-items:center;
  gap:.3rem;
  background:linear-gradient(135deg,#dc2626,#b91c1c);
  color:#fff;
  padding:.3rem .55rem;
  border-radius:11px;
  font-size:.5rem;
  font-weight:700;
  letter-spacing:.4px;
  box-shadow:0 4px 12px -6px rgba(220,38,38,0.6);
  animation: popBadge .55s var(--spring);
}
.hazard-badge.safe {
  background:linear-gradient(135deg,#059669,#10b981);
  box-shadow:0 4px 12px -6px rgba(5,150,105,.55);
}
.hazard-chip {
  background:hsl(var(--accent)/0.2);
  color:hsl(var(--accent)/0.95);
  font-size:.5rem;
  padding:.3rem .55rem;
  border-radius:10px;
  display:inline-flex;
  gap:.3rem;
  align-items:center;
  font-weight:600;
  letter-spacing:.4px;
  margin:.2rem .25rem .2rem 0;
  cursor:pointer;
  transition:
    background var(--dur-m),
    transform var(--dur-m),
    box-shadow var(--dur-m),
    color var(--dur-m);
  position:relative;
  overflow:hidden;
}
.hazard-chip::after {
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(115deg,rgba(255,255,255,.35),transparent 70%);
  opacity:0;
  transform:translateX(-40%) skewX(-18deg);
  transition: transform .9s var(--spring), opacity .55s;
}
.hazard-chip:hover {
  background:hsl(var(--accent)/0.3);
  transform:translateY(-4px) scale(1.05);
  box-shadow:0 6px 16px -8px hsl(var(--accent)/0.55);
}
.hazard-chip:hover::after {
  opacity:.55;
  transform:translateX(200%) skewX(-18deg);
}
.hazard-chip.active {
  background:linear-gradient(135deg,#dc2626,#991b1b);
  color:#fff;
  transform:translateY(-4px) scale(1.07);
  box-shadow:0 6px 18px -8px rgba(220,38,38,0.6);
}

/* ===================== ADAPTIVE FONT SIZE BODY CLASSES ===================== */
body.font-small { --font-base: 14px; }
body.font-medium { --font-base: 15px; }
body.font-large { --font-base: 17px; }
html.font-small  { --font-base: 14px; }
html.font-medium { --font-base: 15px; }  /* atau 16px kalau mau lebih terlihat */
html.font-large  { --font-base: 18px; }  /* bisa 19 atau 20 kalau ingin lebih besar */

/* ===================== RESPONSIVE ===================== */
@media (max-width:1080px) {
  .sidebar {
    position:fixed;
    inset:0 auto 0 0;
    transform:translateX(-100%);
    max-width:84%;
  }
  .sidebar.open {
    transform:translateX(0);
    box-shadow:16px 0 42px -14px rgba(0,0,0,.7);
  }
  .main { margin-left:0; }
  .responsive-hide { display:inline-flex; }
  .indicators { grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); }
  main.content { padding:1rem .9rem 2.2rem; }
}
@media (max-width:780px){
  table { font-size:.56rem; min-width:1100px; }
  .panel { border-radius:28px; }
  .indicators .indicator { padding:.65rem .7rem .8rem; }
}
@media (max-width:640px) {
  .content { padding:.85rem .75rem 3.8rem; gap:1.4rem; }
  .panel { border-radius:24px; padding:1rem .95rem 1.15rem; }
  .container-auth { margin-left:13px;margin-right:13px;padding:2rem 1.25rem 2.1rem; border-radius:30px; }
  .topbar { padding:.6rem .75rem; }
  .search-box { max-width:100%; }
  .chart-container { height:220px; }
  .indicators { grid-template-columns:repeat(2,minmax(0,1fr)); }
  .indicator { min-width:0; }
  .form-grid { grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:.75rem; }
  .panel-header { margin:-.2rem -1rem .5rem; padding:.65rem 1rem .55rem; }
  .preference-grid { grid-template-columns:1fr; }
  #fishImagePreview img { max-height:180px; }
  .hazard-chip { font-size:.48rem; }
  .social-container { grid-template-columns:1fr; }
}

/* ===================== SCROLLBARS ===================== */
::-webkit-scrollbar { width:10px; height:10px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb {
  background:linear-gradient(180deg,hsl(var(--accent)/0.32), hsl(var(--accent)/0.45));
  border-radius:10px;
  border:2px solid transparent;
  background-clip:content-box;
  transition:background var(--dur-s), transform var(--dur-s);
}
::-webkit-scrollbar-thumb:hover {
  background:linear-gradient(180deg,hsl(var(--accent)/0.55), hsl(var(--accent)/0.7));
  transform:translateY(-2px);
}

/* ===================== GENERIC ANIM CLASSES ===================== */
.fade-in { animation: fade .6s ease; }
@keyframes fade { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

.view-transition-enter { animation: viewEnter .55s var(--spring); }
@keyframes viewEnter {
  from { opacity:0; transform:translateY(18px) scale(.96); }
  to { opacity:1; transform:translateY(0) scale(1); }
}

/* ===================== LOADING OVERLAY ===================== */
#loadingOverlay {
  position:fixed; inset:0;
  display:grid; place-items:center;
  background:linear-gradient(135deg, hsl(var(--accent)/0.35), hsl(var(--glass-bg)/0.94));
  backdrop-filter:blur(34px) saturate(1.3);
  -webkit-backdrop-filter:blur(34px) saturate(1.3);
  z-index:9999;
  color:#fff;
  font-size:.85rem;
  flex-direction:column;
  gap:1.1rem;
  letter-spacing:.45px;
  animation: fade .6s ease;
}
#loadingText {
  animation: pulseText 1.8s ease-in-out infinite;
}
@keyframes pulseText {
  0%,100% { opacity:.6; }
  50% { opacity:1; }
}

.spinner {
  width:60px; height:60px;
  border:6px solid hsl(var(--accent)/0.25);
  border-top-color:#fff;
  border-radius:50%;
  animation: spin 1s linear infinite;
  filter:drop-shadow(0 4px 12px hsl(var(--accent)/0.6));
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===================== INLINE EDIT ===================== */
.inline-editable {
  cursor:text;
  padding:.25rem .4rem;
  border-radius:8px;
  transition:background var(--dur-m), box-shadow var(--dur-m), transform var(--dur-m);
}
.inline-editable:hover {
  background:hsl(var(--accent)/0.22);
  box-shadow:0 2px 6px -2px hsl(var(--accent)/0.35);
  transform:translateY(-2px);
}

.meta {
  font-size:.52rem;
  letter-spacing:.5px;
  color:hsl(var(--text-dim));
  text-transform:uppercase;
  font-weight:600;
}

.empty-state {
  text-align:center;
  padding:2rem 1rem;
  font-size:.72rem;
  color:hsl(var(--text-dim));
  display:flex;
  flex-direction:column;
  gap:1rem;
  animation: fade .6s ease;
}

.inline-stat {
  display:inline-flex;
  align-items:center;
  gap:.4rem;
  background:hsl(var(--accent)/0.28);
  padding:.3rem .55rem;
  border-radius:10px;
  font-size:.52rem;
  font-weight:700;
  letter-spacing:.55px;
  color:#fff;
  text-transform:uppercase;
  animation: popBadge .55s var(--spring);
}

.badge-soft {
  display:inline-flex;
  padding:.35rem .6rem;
  background:hsl(var(--accent)/0.2);
  border-radius:12px;
  font-size:.55rem;
  font-weight:600;
  letter-spacing:.5px;
  color:hsl(var(--accent)/0.95);
  gap:.3rem;
  animation: fadeSlide .55s var(--spring);
}

/* ===================== TOAST ===================== */
#toastContainer {
  position: fixed;
  top: 1rem;
  right: 1rem;
  width: clamp(240px, 28vw, 360px);
  display: flex;
  flex-direction: column;
  gap: .65rem;
  z-index: 4000;
  pointer-events: none;
}
.toast {
  --toast-tone: var(--accent);
  position: relative;
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  gap: .6rem;
  padding: .75rem .85rem .75rem .8rem;
  border-radius: 25px;
  background: linear-gradient(135deg, hsl(var(--toast-tone) / 0.90), hsl(var(--toast-tone) / 0.68));
  color: #fff;
  font-size: .63rem;
  font-weight: 600;
  letter-spacing: .3px;
  line-height: 1.35;
  box-shadow: 0 6px 18px -8px rgba(0,0,0,.35),
              0 0 0 1px hsl(var(--toast-tone) / 0.40);
  border: 1px solid hsl(var(--toast-tone) / 0.55);
  overflow: hidden;
  pointer-events: auto;
  opacity: 0;
  transform: translateY(-8px) scale(.95);
  animation: toastEnter .55s var(--spring) forwards;
  backdrop-filter: blur(10px) saturate(1.2);
  -webkit-backdrop-filter: blur(10px) saturate(1.2);
  position:relative;
}
.toast::before {
  content:"";
  position:absolute;
  top:0; left:0; bottom:0;
  width:4px;
  background:linear-gradient(180deg,
     hsl(var(--toast-tone) / 1),
     hsl(var(--toast-tone) / 0.55)
  );
  border-radius:4px 0 0 4px;
  animation: heightGrow .8s var(--spring);
}
@keyframes heightGrow {
  from { transform:scaleY(0); transform-origin:top; }
  to { transform:scaleY(1); transform-origin:top; }
}
.toast button.toast-close {
  background: rgba(255,255,255,.18);
  border: none;
  color: #fff;
  width: 26px;
  height: 26px;
  display: inline-flex;
  align-items:center;
  justify-content:center;
  border-radius: 8px;
  cursor: pointer;
  transition: background var(--dur-m), transform var(--dur-m);
  padding:0;
}
.toast button.toast-close:hover {
  background: rgba(255,255,255,.32);
  transform:rotate(12deg) scale(1.1);
}
.toast button.toast-close:active {
  transform:rotate(-4deg) scale(.9);
}
.toast[data-type="success"] { --toast-tone:  140 65% 42%; }
.toast[data-type="danger"]  { --toast-tone:  0 72% 52%; }
.toast[data-type="warn"]    { --toast-tone:  38 92% 50%; }
.toast[data-type="info"]    { --toast-tone:  var(--accent); }
@keyframes toastEnter {
  0% { opacity:0; transform: translateY(-10px) scale(.9); filter:blur(3px); }
  55% { opacity:1; transform: translateY(4px) scale(1.02); filter:blur(0); }
  100% { opacity:1; transform: translateY(0) scale(1); }
}
@keyframes toastExit {
  to { opacity:0; transform: translateY(-10px) scale(.92); }
}
[data-theme="dark"] .toast {
  box-shadow: 0 10px 28px -12px rgba(0,0,0,.7),
              0 0 0 1px hsl(var(--toast-tone) / 0.45);
}
@media (max-width:640px) {
  #toastContainer {
    top:.75rem;
    right:.55rem;
    left:.55rem;
    width:auto;
  }
}

.image-preview {
  display:flex;
  flex-direction:column;
  gap:.4rem;
  font-size:.55rem;
  color:hsl(var(--text-dim));
  margin-top:.3rem;
  animation: fadeScale .55s var(--spring);
}
.image-preview canvas, .image-preview img {
  max-width:100%;
  border-radius:12px;
  box-shadow:0 4px 18px -8px rgba(0,0,0,.5);
  border:1px solid hsl(var(--panel-border)/0.55);
  transition: transform var(--dur-m), box-shadow var(--dur-m);
  cursor:zoom-in;
}
.image-preview img:hover {
  transform:scale(1.02);
  box-shadow:0 8px 22px -10px rgba(0,0,0,.6);
}

.btn-mini-inline {
  background:hsl(var(--accent)/0.3);
  border:none;
  color:#fff;
  padding:.25rem .5rem;
  border-radius:8px;
  font-size:.5rem;
  font-weight:700;
  letter-spacing:.4px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:.3rem;
  box-shadow:0 4px 10px -5px hsl(var(--accent)/0.5);
  transition:background var(--dur-m), transform var(--dur-m);
}
.btn-mini-inline:hover {
  background:hsl(var(--accent)/0.5);
  transform:translateY(-2px) scale(1.05);
}

.tag-badge {
  background:hsl(var(--accent)/0.25);
  color:#fff;
  padding:.25rem .55rem;
  font-size:.48rem;
  border-radius:10px;
  font-weight:700;
  letter-spacing:.45px;
  display:inline-flex;
  gap:.35rem;
  align-items:center;
  animation: popBadge .55s var(--spring);
}

/* Floating Action Button */
.fab {
  position:fixed;
  bottom:1.35rem;
  right:1.25rem;
  width:62px;
  height:62px;
  border-radius:32px;
  background:var(--gradient-accent);
  color:#fff;
  display:grid;
  place-items:center;
  font-weight:700;
  font-size:.70rem;
  box-shadow:0 14px 36px -12px hsl(var(--accent)/0.65), 0 4px 8px -3px hsl(var(--accent)/0.5);
  z-index:300;
  border:1px solid hsl(var(--panel-border)/0.45);
  cursor:pointer;
  transition:
    transform var(--dur-m),
    box-shadow var(--dur-m),
    filter var(--dur-m);
  animation: fabBounce 1.2s var(--spring);
}
@keyframes fabBounce { /* UX+ */
  0% { transform:translateY(40px) scale(0); opacity:0; }
  60% { transform:translateY(-8px) scale(1.08); opacity:1; }
  100% { transform:translateY(0) scale(1); }
}
.fab:hover {
  transform:translateY(-9px) scale(1.08) rotate(6deg);
  box-shadow:0 18px 46px -14px hsl(var(--accent)/0.75), 0 6px 12px -4px hsl(var(--accent)/0.6);
  filter:brightness(1.08);
}
.fab:active {
  transform:translateY(-2px) scale(.95) rotate(-4deg);
  filter:brightness(.92);
}

/* ===================== TABLE FOOTER / PAGINATION ===================== */
.table-footer {
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  align-items:center;
  gap:.8rem;
  margin-top:.65rem;
  font-size:.55rem;
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.55),hsl(var(--glass-bg)/0.40));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.55rem .85rem;
  border-radius:18px;
  animation: fadeSlide .55s var(--spring);
}
.table-footer select {
  max-width:110px;
  font-size:.55rem;
  padding:.3rem .45rem;
  transition: background var(--dur-m), border-color var(--dur-m);
}
.pagination-controls {
  display:flex;
  align-items:center;
  gap:.45rem;
  flex-wrap:wrap;
}
.pagination-controls button {
  padding:.4rem .65rem;
  font-size:.55rem;
  border-radius:10px;
  position:relative;
}
.pagination-controls button:hover {
  transform:translateY(-2px);
}

/* Multi-select action bar */
.multi-action-bar {
  display:flex;
  flex-wrap:wrap;
  gap:.4rem;
  background:linear-gradient(145deg,hsl(var(--accent)/0.22),hsl(var(--accent)/0.12));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.55rem .7rem;
  border-radius:16px;
  font-size:.55rem;
  align-items:center;
  box-shadow:0 6px 16px -8px hsl(var(--accent)/0.55);
  margin-bottom:.75rem;
  animation: fadeSlide .55s var(--spring);
}
.multi-action-bar.hidden { display:none; }
.multi-action-bar span {
  font-weight:700;
  letter-spacing:.5px;
  display:inline-flex;
  align-items:center;
  gap:.35rem;
}

/* ===================== ORGANOLPEPTIK TOOL ===================== */
.org-criteria-grid {
  display:grid;
  gap:1rem;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  margin-top:.5rem;
  animation: fadeSlide .6s var(--spring);
}
.org-criterion {
  background:linear-gradient(150deg,hsl(var(--accent)/0.18),hsl(var(--accent)/0.10));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.75rem .85rem .85rem;
  border-radius:22px;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  position:relative;
  overflow:hidden;
  font-size:.58rem;
  animation: panelIn .55s var(--spring);
  transition:
    transform var(--dur-m),
    box-shadow var(--dur-m),
    background var(--dur-m);
}
.org-criterion:hover {
  transform:translateY(-6px);
  box-shadow: var(--elev-2);
  background:linear-gradient(150deg,hsl(var(--accent)/0.25),hsl(var(--accent)/0.14));
}
.org-criterion h4 {
  margin:0;
  font-size:.56rem;
  letter-spacing:.5px;
  text-transform:uppercase;
  font-weight:700;
  color:hsl(var(--text-dim));
  display:flex;
  gap:.4rem;
  align-items:center;
  position:relative;
}
.org-criterion h4::after {
  content:"";
  position:absolute;
  bottom:-4px;
  left:0;
  width:0;
  height:2px;
  background:hsl(var(--accent)/0.5);
  transition:width var(--dur-m);
}
.org-criterion:hover h4::after { width:100%; }

.org-options {
  display:flex;
  flex-direction:column;
  gap:.4rem;
  max-height:240px;
  overflow:auto;
  padding-right:.35rem;
  scrollbar-width:thin;
}
.org-options::-webkit-scrollbar { width:6px; }
.org-options::-webkit-scrollbar-thumb {
  background:hsl(var(--accent)/0.35);
  border-radius:10px;
}
.org-option {
  background:hsl(var(--accent)/0.15);
  border:1px solid hsl(var(--panel-border)/0.5);
  padding:.45rem .5rem .5rem;
  border-radius:14px;
  cursor:pointer;
  display:flex;
  flex-direction:column;
  gap:.25rem;
  transition:
    background var(--dur-m),
    transform var(--dur-m),
    box-shadow var(--dur-m),
    color var(--dur-m);
  position:relative;
  font-size:.53rem;
  line-height:1.3;
  overflow:hidden;
}
.org-option::after {
  content:"";
  position:absolute;
  top:0; left:-55%;
  width:55%; height:100%;
  background:linear-gradient(120deg, rgba(255,255,255,.45), transparent 70%);
  opacity:0;
  transform:skewX(-18deg);
  transition: transform .9s var(--spring), opacity .55s;
}
.org-option:hover {
  background:hsl(var(--accent)/0.25);
  transform:translateY(-4px) scale(1.03);
  box-shadow:0 6px 16px -8px hsl(var(--accent)/0.55);
}
.org-option:hover::after {
  opacity:.6;
  transform:translateX(240%) skewX(-18deg);
}
.org-option.active {
  background:var(--gradient-accent);
  color:#fff;
  box-shadow:0 10px 28px -12px hsl(var(--accent)/0.65);
  transform:translateY(-3px) scale(1.02);
}
.org-option .score-badge {
  position:absolute;
  top:.4rem;
  right:.45rem;
  background:hsl(var(--accent)/0.85);
  color:#fff;
  font-size:.48rem;
  padding:.2rem .45rem;
  border-radius:10px;
  font-weight:700;
  letter-spacing:.5px;
  box-shadow:0 4px 10px -5px hsl(var(--accent)/0.55);
  animation: popBadge .55s var(--spring);
}
.org-result-box {
  background:linear-gradient(150deg,hsl(var(--accent)/0.18),hsl(var(--accent)/0.08));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.9rem 1rem 1.1rem;
  border-radius:24px;
  margin-top:.35rem;
  display:flex;
  flex-direction:column;
  gap:.35rem;
  animation: fadeSlide .55s var(--spring);
}

@media (max-width:640px){
  .org-criteria-grid { grid-template-columns:1fr; }
}

/* ===================== NOTIFICATIONS ===================== */
.badge-dot {
  position:absolute;
  top:2px;
  right:4px;
  width:16px;
  height:16px;
  background:#ef4444;
  color:#fff;
  font-size:.5rem;
  display:grid;
  place-items:center;
  border-radius:50%;
  font-weight:700;
  letter-spacing:.3px;
  box-shadow:0 0 0 2px rgba(0,0,0,.3);
  animation: pulseBadge 1.4s ease-in-out infinite;
}
@keyframes pulseBadge {
  0%,100% { transform:scale(1); }
  50% { transform:scale(1.25); }
}
.badge-dot.hidden { display:none; }
#notifDropdown {
  left:60% !important;
  transform:translateX(-66%) !important; /* tadinya -50%, geser 10% lebih kiri */
}
/* Scrollable notif list */
#notifList {
  max-height: 300px;          /* atur tinggi maksimum sesuai selera */
  overflow-y: auto;
  padding-right: .25rem;
  scrollbar-width: thin;
}
#notifList::-webkit-scrollbar {
  width: 8px;
}
#notifList::-webkit-scrollbar-thumb {
  background: hsl(var(--accent)/0.45);
  border-radius: 10px;
}
#notifList::-webkit-scrollbar-thumb:hover {
  background: hsl(var(--accent)/0.65);
}
.notif-item {
  display:flex;
  flex-direction:column;
  gap:.25rem;
  padding:.55rem .6rem .6rem;
  background:hsl(var(--accent)/0.12);
  border:1px solid hsl(var(--panel-border)/0.45);
  border-radius:14px;
  font-size:.52rem;
  line-height:1.3;
  position:relative;
  cursor:pointer;
  transition:
    background var(--dur-m),
    transform var(--dur-m),
    box-shadow var(--dur-m),
    border-color var(--dur-m);
  animation: fadeSlide .55s var(--spring);
}
.notif-item.unread {
  background:hsl(var(--accent)/0.25);
  border-color:hsl(var(--accent)/0.55);
  box-shadow:0 4px 14px -6px hsl(var(--accent)/0.55);
}
.notif-item:hover {
  background:hsl(var(--accent)/0.30);
  color:#fff;
  transform:translateY(-4px) scale(1.02);
  box-shadow: var(--elev-2);
}
.notif-item:active {
  transform:translateY(-1px) scale(.97);
}
.notif-time {
  font-size:.42rem;
  opacity:.75;
}
.notif-empty {
  font-size:.55rem;
  text-align:center;
  padding:.8rem .3rem;
  opacity:.7;
  animation: fadeSlide .55s ease;
}
.admin-notif-panel .notif-sender {
  font-size:.48rem;
  opacity:.7;
}

/* ===================== MATERIAL CATEGORIES ===================== */
.material-category {
  background:linear-gradient(150deg,hsl(var(--accent)/0.18),hsl(var(--accent)/0.10));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.85rem .95rem 1rem;
  border-radius:24px;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  font-size:.58rem;
  animation: panelIn .55s var(--spring);
  transition: transform var(--dur-m), box-shadow var(--dur-m), background var(--dur-m);
  position:relative;
  overflow:hidden;
}
.material-category:hover {
  transform:translateY(-6px);
  box-shadow: var(--elev-2);
  background:linear-gradient(150deg,hsl(var(--accent)/0.25),hsl(var(--accent)/0.14));
}
.material-category h4 {
  margin:0;
  font-size:.58rem;
  letter-spacing:.55px;
  text-transform:uppercase;
  font-weight:700;
  color:hsl(var(--text-dim));
  display:flex;
  gap:.4rem;
  align-items:center;
  position:relative;
  overflow:hidden;
}
.material-category h4::after {
  content:"";
  position:absolute;
  bottom:-4px;
  left:0;
  width:0;
  height:2px;
  background:hsl(var(--accent)/0.5);
  transition:width var(--dur-m);
}
.material-category:hover h4::after { width:100%; }
.material-points {
  margin:0;
  padding-left:1.1rem;
  line-height:1.5;
  animation: fadeSlide .6s ease;
}

/* ===================== FONT OPTION ===================== */
.font-option {
  display:inline-flex;
  padding:.35rem .6rem;
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:12px;
  font-size:.55rem;
  cursor:pointer;
  background:hsl(var(--accent)/0.15);
  gap:.35rem;
  align-items:center;
  font-weight:600;
  transition:
    background var(--dur-m),
    transform var(--dur-m),
    box-shadow var(--dur-m);
  position:relative;
}
.font-option:hover {
  transform:translateY(-4px);
  background:hsl(var(--accent)/0.25);
  box-shadow:0 6px 14px -6px hsl(var(--accent)/0.45);
}
.font-option.active {
  background:var(--gradient-accent);
  color:#fff;
  box-shadow:0 6px 16px -8px hsl(var(--accent)/0.55);
  transform:translateY(-4px) scale(1.05);
}

/* ===================== PREFERENCE TOGGLE ===================== */
.pref-toggle {
  display:flex;
  align-items:center;
  gap:.5rem;
  font-size:.55rem;
  background:hsl(var(--accent)/0.18);
  padding:.5rem .7rem;
  border-radius:14px;
  cursor:pointer;
  font-weight:700;
  letter-spacing:.45px;
  border:1px solid hsl(var(--panel-border)/0.55);
  transition:
    background var(--dur-m),
    transform var(--dur-m),
    box-shadow var(--dur-m),
    color var(--dur-m);
  position:relative;
  overflow:hidden;
}
.pref-toggle::after {
  content:"";
  position:absolute;
  top:0; left:-55%;
  width:55%; height:100%;
  background:linear-gradient(120deg, rgba(255,255,255,.35), transparent 70%);
  opacity:0;
  transform:skewX(-18deg);
  transition: transform .9s var(--spring), opacity .55s;
}
.pref-toggle:hover {
  background:hsl(var(--accent)/0.30);
  transform:translateY(-3px);
  box-shadow: var(--elev-2);
}
.pref-toggle:hover::after {
  opacity:.55;
  transform:translateX(240%) skewX(-18deg);
}
.pref-toggle.active {
  background:var(--gradient-accent);
  color:#fff;
  box-shadow:0 6px 16px -8px hsl(var(--accent)/0.55);
  transform:translateY(-4px) scale(1.04);
}

/* ===================== SAFETY SECTION ===================== */
.hazard-chip.active,
.hazard-badge,
.hazard-badge.safe,
.badge-role,
.inline-stat {
  will-change: transform;
}

/* ===================== ANIMATION HELPERS ===================== */
.fade-scale { animation: fadeScale .55s var(--spring); }
@keyframes fadeScale { from { opacity:0; transform:scale(.94); } to { opacity:1; transform:scale(1); } }
.slide-in-up { animation: slideInUp .6s var(--spring); }
@keyframes slideInUp {
  from { opacity:0; transform:translateY(18px); }
  to { opacity:1; transform:translateY(0); }
}

/* ===================== REDUCE MOTION SUPPORT ===================== */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration:0.001ms !important;
    animation-iteration-count:1 !important;
    transition:none !important;
  }
}

/* ===================== ACCESSIBILITY (FOCUS RING AUGMENT) ===================== */
:focus-visible {
  outline:2px solid hsl(var(--accent)/0.85);
  outline-offset:3px;
  animation: focusPulse 1.4s ease-in-out infinite;
}
@keyframes focusPulse {
  0%,100% { box-shadow:0 0 0 0 hsl(var(--accent)/0.4); }
  50% { box-shadow:0 0 0 4px hsl(var(--accent)/0.0); }
}
/* Override tombol hapus notifikasi agar selalu jelas */
.del-notif-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  background: #dc2626;           /* merah solid */
  border: 1px solid #b91c1c;
  color: #fff !important;
  width: 24px;
  height: 24px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  cursor: pointer;
  font-size: .55rem;
  line-height: 1;
  box-shadow: 0 3px 6px -2px rgba(0,0,0,.35);
  transition: background .25s, transform .25s, box-shadow .25s;
  z-index: 5;                    /* pastikan di atas isi lain */
}
.del-notif-btn i { color: #fff; stroke: #fff; }
.del-notif-btn:hover {
  background:#ef4444;
  transform: translateY(-3px);
  box-shadow:0 6px 14px -6px rgba(0,0,0,.45);
}
.del-notif-btn:active {
  transform:translateY(0) scale(.92);
}
/* ===== RANKING PANEL IMPROVED ===== */
#rankingPanel .panel-header .toggle-chip {
  background:hsl(var(--accent)/0.15);
  border:1px solid hsl(var(--accent)/0.2);
  margin-right:.15rem;
}
#rankingPanel .panel-header .toggle-chip.active {
  background:var(--gradient-accent);
  color:#fff;
  box-shadow:0 4px 14px -6px hsl(var(--accent)/0.55);
  transform:translateY(-3px);
}

.ranking-grid {
  display:grid;
  gap:1rem;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  align-items:start;
  margin-top:.2rem;
}
@media (max-width:880px){
  .ranking-grid { grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); }
}
@media (max-width:560px){
  .ranking-grid { grid-template-columns:1fr; }
}

.ranking-block {
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.55), hsl(var(--glass-bg)/0.40));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:22px;
  padding:.75rem .85rem .85rem;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  position:relative;
  overflow:hidden;
  font-size:.55rem;
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  transition:
    transform var(--dur-m),
    box-shadow var(--dur-m),
    background var(--dur-m),
    border-color var(--dur-m);
}
.ranking-block:hover {
  transform:translateY(-6px);
  box-shadow:0 10px 28px -14px rgba(0,0,0,.55);
}

.rb-title {
  font-size:.55rem;
  font-weight:800;
  letter-spacing:.55px;
  text-transform:uppercase;
  display:flex;
  align-items:center;
  gap:.4rem;
  opacity:.8;
  position:relative;
}
.rb-title::after {
  content:"";
  height:2px;
  width:42%;
  background:hsl(var(--accent)/0.5);
  position:absolute;
  bottom:-4px;
  left:0;
  border-radius:2px;
  transition:width var(--dur-m);
}
.ranking-block:hover .rb-title::after { width:100%; }

.ranking-list {
  list-style:none;
  margin:0;
  padding:0;
  display:flex;
  flex-direction:column;
  gap:.45rem;
  max-height:230px;
  overflow:auto;
  scrollbar-width:thin;
}
.ranking-list::-webkit-scrollbar { width:6px; }
.ranking-list::-webkit-scrollbar-thumb {
  background:hsl(var(--accent)/0.35);
  border-radius:6px;
}
.ranking-list li {
  background:hsl(var(--accent)/0.15);
  border:1px solid hsl(var(--panel-border)/0.5);
  padding:.5rem .55rem .55rem;
  border-radius:16px;
  display:grid;
  grid-template-columns: 26px 1fr auto;
  gap:.55rem;
  align-items:flex-start;
  font-size:.52rem;
  line-height:1.25;
  position:relative;
  transition:
    background var(--dur-m),
    transform var(--dur-m),
    box-shadow var(--dur-m);
}
.ranking-list li:hover {
  background:hsl(var(--accent)/0.25);
  transform:translateY(-4px);
  box-shadow:0 6px 16px -8px hsl(var(--accent)/0.55);
}
.rank-pos {
  width:26px;
  height:26px;
  border-radius:10px;
  background:hsl(var(--accent)/0.30);
  display:grid;
  place-items:center;
  font-size:.66rem;
  font-weight:800;
  color:#fff;
  box-shadow:0 4px 10px -6px hsl(var(--accent)/0.55);
}
.rank-pos.gold {
  background:linear-gradient(135deg,#fbbf24,#d97706);
}
.rank-pos.silver {
  background:linear-gradient(135deg,#cbd5e1,#64748b);
}
.rank-pos.bronze {
  background:linear-gradient(135deg,#d97706,#92400e);
}

.rank-main {
  font-weight:700;
  letter-spacing:.3px;
  font-size:.54rem;
  line-height:1.2;
}
.rank-meta {
  font-size:.42rem;
  opacity:.75;
  letter-spacing:.4px;
  margin-top:.18rem;
  text-transform:uppercase;
  font-weight:700;
}

.rank-score-badge {
  background:var(--gradient-accent);
  color:#fff;
  font-weight:700;
  font-size:.55rem;
  padding:.3rem .55rem;
  border-radius:12px;
  display:inline-flex;
  align-items:center;
  letter-spacing:.4px;
  box-shadow:0 4px 12px -6px hsl(var(--accent)/0.55);
}
.rank-score-badge.bad { background:linear-gradient(135deg,#ef4444,#b91c1c); }
.rank-score-badge.mid { background:linear-gradient(135deg,#f59e0b,#b45309); }

.rec-wrap {
  display:flex;
  flex-wrap:wrap;
  gap:.4rem;
  font-size:.5rem;
  line-height:1.35;
  min-height:56px;
}
.rec-chip {
  display:inline-flex;
  align-items:center;
  gap:.35rem;
  padding:.35rem .55rem;
  background:hsl(var(--accent)/0.25);
  border-radius:12px;
  font-size:.5rem;
  font-weight:600;
  letter-spacing:.4px;
  color:#fff;
  position:relative;
  overflow:hidden;
  cursor:default;
}
.rec-chip.good { background:linear-gradient(135deg,#10b981,#059669); }
.rec-chip.warn { background:linear-gradient(135deg,#f59e0b,#b45309); }
.rec-chip.low  { background:linear-gradient(135deg,#ef4444,#b91c1c); }
.rec-chip i { stroke-width:2px; }
.rec-empty {
  font-size:.5rem;
  opacity:.65;
  font-style:italic;
}

.ranking-foot {
  margin-top:.9rem;
  padding-top:.55rem;
  border-top:1px solid hsl(var(--panel-border)/0.35);
  font-size:.48rem;
  letter-spacing:.4px;
}
.ranking-list.loading li {
  animation: pulseLoad 1.2s ease-in-out infinite;
  background:linear-gradient(90deg, hsl(var(--accent)/0.12), hsl(var(--accent)/0.20), hsl(var(--accent)/0.12));
  background-size:200% 100%;
  color:transparent;
}
@keyframes pulseLoad {
  0% { background-position:0% 0; }
  100% { background-position:200% 0; }
}
<!-- (Tambahkan di dalam <style> setelah blok CSS ".fab { ... }") -->

/* Tombol Pengaturan Kiri Bawah */
.fab.fab-settings {
	opacity:0;
  left: 1.1rem !important;
  right: auto !important;
  bottom: 1.35rem;
  background: linear-gradient(135deg,hsl(var(--accent)/0.45), hsl(var(--accent)/0.70));
}
@media (max-width:640px){
  .fab.fab-settings {
    bottom: 6rem; /* naik sedikit agar tidak bertumpuk dengan FAB kanan */
  }
}
/* ============ LAYOUT LIST MODE (tampilan kompak vertikal) ============ */
body.layout-list .content {
  gap: 1rem;
}
.color-palette {
  max-height: 180px;
  overflow:auto;
  padding-right:4px;
}
.color-palette::-webkit-scrollbar {
  width:6px;
}
/* Semua grid utama jadi satu kolom */
body.layout-list .grid,
body.layout-list .cards-analytics,
body.layout-list .indicators {
  display: grid;
  grid-template-columns: 1fr !important;
}

/* Indicators jadi list sempit */
body.layout-list .indicators {
  gap: .55rem;
}
body.layout-list .indicators .indicator {
  flex-direction: row;
  align-items: center;
  min-height: 0;
  padding: .6rem .75rem;
}
body.layout-list .indicators .indicator h4 {
  width: 140px;
  font-size: .52rem;
  letter-spacing: .5px;
}
body.layout-list .indicators .indicator .val {
  font-size: 1.1rem;
}
body.layout-list .indicators .indicator .trend {
  margin-left: auto;
}

/* Panel bento tidak perlu tinggi minimal */
body.layout-list .panel.bento {
  min-height: auto;
}

/* Panel: sedikit lebih kompak */
body.layout-list .panel {
  padding: .85rem .9rem 1rem;
  border-radius: 24px;
}

/* Header panel: rapatkan */
body.layout-list .panel-header {
  margin: -.2rem -.9rem .5rem;
  padding: .55rem .9rem .5rem;
}

/* Ranking grid satu kolom */
body.layout-list #rankingPanel .ranking-grid {
  grid-template-columns: 1fr !important;
  gap: .75rem;
}

/* Chart container lebih pendek */
body.layout-list .chart-container {
  height: 200px;
}

/* Quality indicator list item dirapatkan */
body.layout-list .quality-item {
  font-size: .5rem;
  padding: .45rem .55rem .5rem;
}

/* Sosial layout jadi vertikal penuh */
body.layout-list .social-container {
  grid-template-columns: 1fr !important;
}

/* Form grid jadi daftar vertikal */
body.layout-list .form-grid {
  grid-template-columns: 1fr !important;
}

/* Tabel: biarkan apa adanya tapi kurangi border radius wrapper */
body.layout-list .table-wrapper {
  border-radius: 18px;
}

/* Ranking list item kompak */
body.layout-list .ranking-list li {
  padding: .45rem .5rem .5rem;
}

/* Organoleptik criteria grid jadi list */
body.layout-list .org-criteria-grid {
  grid-template-columns: 1fr !important;
}

/* Material categories satu kolom */
body.layout-list #view-materials .grid {
  grid-template-columns: 1fr !important;
}

/* Preference grid satu kolom */
body.layout-list .preference-grid {
  grid-template-columns: 1fr !important;
}

/* Panel footer / pagination dirapatkan */
body.layout-list .table-footer {
  padding: .5rem .65rem;
  gap: .55rem;
}

/* Kurangi animasi scale di list agar terasa lebih simpel */
body.layout-list .panel:hover,
body.layout-list .indicator:hover,
body.layout-list .social-post:hover {
  transform: translateY(-4px);
}

/* FAB tidak berubah tapi bisa dikecilkan kalau mau (opsional) */
/*
body.layout-list .fab {
  width: 54px;
  height: 54px;
  border-radius: 18px;
  font-size: .68rem;
}
*/
/* =========================================
   PERFORMANCE MODES
   Ultra  : (default) gunakan styling existing.
   Default: kurangi blur, glow, intensitas animasi & shadow.
   Lite   : hilangkan blur + animasi + heavy shadow + gradient -> solid.
   ========================================= */

body[class*="perf-"] {
  /* variabel dasar bisa ditimpa per mode */
}


/* ====== OPTIMASI PERFORMANCE MODE: DEFAULT ======
   Tujuan:
   - Kurangi blur, gradient, shadow
   - Hilangkan effect hiasan
   - Pangkas animasi berat tapi tetap lebih kaya dari lite
=================================================== */
body.perf-default {
  --glass-alpha: 0.85;
  --dur-m: .22s;
  --dur-l: .40s;
}
body.perf-default .panel,
body.perf-default .sidebar,
body.perf-default .topbar,
body.perf-default .dropdown,
body.perf-default .container-auth,
body.perf-default .table-wrapper {
  /* Turun dari blur 14 -> 6 */
  backdrop-filter: blur(6px) saturate(1.1) !important;
  -webkit-backdrop-filter: blur(6px) saturate(1.1) !important;
  background: hsl(var(--glass-bg)/0.90) !important;
  box-shadow: 0 3px 10px -4px rgba(0,0,0,.28) !important;
}

/* Hilangkan layer pseudo dekoratif di default (masih ada di ultra) */
body.perf-default .panel::before,
body.perf-default .indicator::before,
body.perf-default .logo-circle::after,
body.perf-default .quality-item::after,
body.perf-default .org-option::after,
body.perf-default .hazard-chip::after,
body.perf-default .toggle-chip::before,
body.perf-default .nav button::after,
body.perf-default .ranking-block:hover .rb-title::after {
  display:none !important;
}

body.perf-default .indicator,
body.perf-default .social-post,
body.perf-default .ranking-block,
body.perf-default .material-category,
body.perf-default .org-criterion {
  box-shadow: 0 3px 12px -6px rgba(0,0,0,.30) !important;
}

/* Box shadow tombol diperingan */
body.perf-default button,
body.perf-default .toggle,
body.perf-default .toggle-chip,
body.perf-default .reaction-btn {
  box-shadow: 0 2px 6px -3px rgba(0,0,0,.35) !important;
}

/* Animasi scale & hover disederhanakan */
body.perf-default .panel:hover,
body.perf-default .indicator:hover,
body.perf-default .social-post:hover,
body.perf-default .ranking-block:hover,
body.perf-default .org-criterion:hover,
body.perf-default .material-category:hover {
  transform: translateY(-4px);
}

body.perf-default .fab {
  box-shadow: 0 6px 18px -8px rgba(0,0,0,.45) !important;
}

/* Kurangi intensitas transition untuk semua child */
body.perf-default * {
  transition-duration: .18s !important;
}

/* Nonaktifkan will-change masal untuk hemat memori compositing */
body.perf-default .panel,
body.perf-default .indicator,
body.perf-default .social-post,
body.perf-default .ranking-block,
body.perf-default .org-criterion,
body.perf-default .quality-item {
  will-change: auto !important;
}

/* Chart container tanpa animasi bayangan */
body.perf-default .chart-container {
  box-shadow:none !important;
}

/* Gambar large: kurangi shadow */
body.perf-default img {
  box-shadow:0 2px 8px -4px rgba(0,0,0,.35);
}

/* Toast lebih ringan */
body.perf-default .toast {
  box-shadow:0 4px 14px -8px rgba(0,0,0,.45) !important;
}

/* Hilangkan shimmer / running gradient dekoratif */
body.perf-default .divider::after {
  animation:none !important;
  background:none !important;
}

/* Kualitas list item: tanpa box-shadow tambahan */
body.perf-default .quality-item {
  box-shadow:none !important;
}


/* ---------- LITE MODE (sangat ringan) ---------- */
body.perf-lite {
  --glass-alpha: 0.95;
  --panel-border: 220 18% 80%;
  --shadow: 220 10% 35%;
}

/* Matikan semua animasi & transition di lite */
body.perf-lite * {
  animation: none !important;
  transition: none !important;
}

/* Ganti background blur menjadi solid */
body.perf-lite .panel,
body.perf-lite .sidebar,
body.perf-lite .topbar,
body.perf-lite .dropdown,
body.perf-lite .container-auth,
body.perf-lite .table-wrapper,
body.perf-lite .social-post,
body.perf-lite .ranking-block,
body.perf-lite .indicator,
body.perf-lite .material-category,
body.perf-lite .org-criterion {
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  background: hsl(var(--glass-bg)/0.98) !important;
  box-shadow: 0 1px 3px rgba(0,0,0,.12) !important;
  border:1px solid hsl(var(--panel-border)/0.6) !important;
}

/* Hilangkan gradient kuat & glow */
body.perf-lite .panel::before,
body.perf-lite .indicator::before,
body.perf-lite .logo-circle::after,
body.perf-lite .quality-item::after,
body.perf-lite .org-option::after,
body.perf-lite .hazard-chip::after,
body.perf-lite .toggle-chip::before,
body.perf-lite .nav button::after {
  display:none !important;
}

body.perf-lite .indicator,
body.perf-lite .social-post,
body.perf-lite .ranking-block,
body.perf-lite .material-category,
body.perf-lite .org-criterion,
body.perf-lite .quality-item,
body.perf-lite .org-option,
body.perf-lite .hazard-chip,
body.perf-lite button,
body.perf-lite .toggle,
body.perf-lite .toggle-chip,
body.perf-lite .reaction-btn {
  transform:none !important;
}

/* Buttons di-lite */
body.perf-lite button,
body.perf-lite .toggle,
body.perf-lite .toggle-chip,
body.perf-lite .reaction-btn {
  background: hsl(var(--accent)/0.15) !important;
  box-shadow: none !important;
  filter:none !important;
}

/* FAB minimal */
body.perf-lite .fab {
  background:hsl(var(--accent)/0.55) !important;
  box-shadow:0 3px 8px -4px rgba(0,0,0,.35) !important;
}

/* Chart container tanpa animasi bawaan Chart.js (opsional) */
body.perf-lite canvas {
  animation:none !important;
  transition:none !important;
}

/* Toast sederhana */
body.perf-lite .toast {
  box-shadow:0 4px 12px -6px rgba(0,0,0,.35) !important;
  background: hsl(var(--accent)/0.85) !important;
}

/* Hilangkan efek hover intens */
body.perf-lite .panel:hover,
body.perf-lite .indicator:hover,
body.perf-lite .social-post:hover,
body.perf-lite .ranking-block:hover,
body.perf-lite .quality-item:hover,
body.perf-lite .org-option:hover {
  transform:none !important;
  box-shadow:0 1px 3px rgba(0,0,0,.15) !important;
  background:hsl(var(--glass-bg)/1) !important;
}

/* Sidebar shadow ringan */
body.perf-lite .sidebar {
  box-shadow: 2px 0 6px -3px rgba(0,0,0,.25) !important;
}

/* Nonaktifkan pulse / glow decorative */
body.perf-lite .glow,
body.perf-lite .indicator::before,
body.perf-lite .badge-dot {
  display:none !important;
}

/* Simplify gradients global (bisa optional) */
body.perf-lite {
  background: hsl(var(--bg)) !important;
}
/* Achievement badges */
.achievement-badge {
  display:inline-flex;
  align-items:center;
  gap:.3rem;
  background:linear-gradient(135deg,hsl(var(--accent)/0.55),hsl(var(--accent)/0.35));
  color:#fff;
  padding:.35rem .65rem;
  font-size:.5rem;
  font-weight:700;
  letter-spacing:.45px;
  border-radius:14px;
  box-shadow:0 4px 12px -6px hsl(var(--accent)/0.55);
  position:relative;
  overflow:hidden;
}
.achievement-badge.new {
  animation: pulseNew 1.6s ease-in-out 0s 2;
}
@keyframes pulseNew {
  0%,100% { transform:scale(1); box-shadow:0 4px 12px -6px hsl(var(--accent)/0.55); }
  50% { transform:scale(1.07); box-shadow:0 6px 18px -8px hsl(var(--accent)/0.7); }
}

/* ==== Presence (Online / Offline) Indicator ==== */
.presence-indicator {
  display:inline-flex;
  align-items:center;
  gap:.40rem;
  font-size:.55rem;
  padding:.38rem .65rem;
  background:hsl(var(--accent)/0.18);
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:14px;
  font-weight:700;
  letter-spacing:.45px;
  position:relative;
  line-height:1;
  cursor:default;
  user-select:none;
  transition:background .35s, border-color .35s;
}
.presence-indicator:hover {
  background:hsl(var(--accent)/0.28);
}
.presence-indicator .dot {
  width:10px; height:10px;
  border-radius:50%;
  background:#10b981;                 /* default (online) */
  position:relative;
  box-shadow:0 0 0 0 rgba(16,185,129,.7);
  animation:pulsePresence 1.4s ease-in-out infinite;
}
@keyframes pulsePresence {
  0%   { box-shadow:0 0 0 0 currentColor; transform:scale(1); }
  60%  { box-shadow:0 0 0 8px rgba(0,0,0,0); transform:scale(.85); }
  100% { box-shadow:0 0 0 0 rgba(0,0,0,0); transform:scale(1); }
}
body.offline .presence-indicator {
  background:rgba(239,68,68,.18);
  border-color:rgba(239,68,68,.55);
}
body.offline .presence-indicator .dot {
  background:#ef4444;
  animation:pulsePresenceOffline 1.4s ease-in-out infinite;
  box-shadow:0 0 0 0 rgba(239,68,68,.65);
}
@keyframes pulsePresenceOffline {
  0%   { box-shadow:0 0 0 0 rgba(239,68,68,.8); transform:scale(1); }
  60%  { box-shadow:0 0 0 8px rgba(239,68,68,0); transform:scale(.78); }
  100% { box-shadow:0 0 0 0 rgba(239,68,68,0); transform:scale(1); }
}
.presence-indicator .label {
  font-weight:500;
  letter-spacing:.5px;color: white;
  text-transform:uppercase;
}
body.offline .presence-indicator .label {
  color:#ef4444;
}
body.offline .presence-indicator .dot::after {
  /* garis retak kecil opsional */
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  background:
    radial-gradient(circle at 65% 35%, rgba(255,255,255,.45), transparent 60%);
  mix-blend-mode:overlay;
  opacity:.5;
}

/* ========== AI ASSISTANT MODULE STYLES ========== */
.fab-ai {
  left:1.25rem;
  
  bottom:1.35rem;
  background:linear-gradient(135deg,hsl(var(--accent)/0.95),hsl(var(--accent)/0.65));
}
@media (max-width:680px){
  .fab-ai { bottom:1.35rem; }
}
#aiChatModal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px);
  z-index:11000;
  display:none;
  align-items:center;
  justify-content:center;
  padding:1rem;
  animation:modalBg .35s ease;
}
#aiChatModal.show { display:flex; }
.ai-chat-box {
  width:100%;
  max-width:560px;
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.94),hsl(var(--glass-bg)/0.72));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:30px;
  padding:1rem .95rem 1.2rem;
  display:flex;
  flex-direction:column;
  gap:.7rem;
  position:relative;
  animation:modalIn .55s var(--spring);
  box-shadow:0 20px 50px -16px rgba(0,0,0,.65), 0 0 0 1px hsl(var(--panel-border)/0.4);
}
.ai-chat-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.6rem;
  padding: .25rem .15rem .4rem;
  border-bottom:1px solid hsl(var(--panel-border)/0.45);
}
.ai-chat-history {
  background:linear-gradient(135deg,hsl(var(--glass-bg)/0.66),hsl(var(--glass-bg)/0.55));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:20px;
  padding:.7rem .7rem;
  max-height:380px;
  overflow:auto;
  font-size:.6rem;
  line-height:1.45;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  scroll-behavior:smooth;
}
.ai-chat-history::-webkit-scrollbar { width:8px; }
.ai-chat-history::-webkit-scrollbar-thumb {
  background:hsl(var(--accent)/0.45);
  border-radius:8px;
  border:2px solid transparent;
  background-clip:content-box;
}
.ai-msg {
  display:flex;
  flex-direction:column;
  max-width:82%;
  animation:fade .45s ease;
}
.ai-msg.user { align-self:flex-end; }
.ai-bubble {
  background:hsl(var(--accent)/0.25);
  color:#fff;
  padding:.55rem .75rem;
  border-radius:16px;
  font-size:.6rem;
  white-space:pre-wrap;
  word-break:break-word;
  box-shadow:0 4px 14px -7px hsl(var(--accent)/0.55);
}
.ai-msg.user .ai-bubble {
  background:linear-gradient(135deg,hsl(var(--accent)/0.95),hsl(var(--accent)/0.7));
}
.ai-meta {
  font-size:.45rem;
  margin-top:.25rem;
  opacity:.7;
  letter-spacing:.4px;
  text-transform:uppercase;
}
.ai-chat-form {
  display:flex;
  gap:.55rem;
  align-items:flex-end;
  flex-wrap:wrap;
}
.ai-chat-form textarea {
  flex:1;
  min-height:72px;
  max-height:220px;
  resize:vertical;
  background:hsl(var(--glass-bg)/0.65);
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:18px;
  padding:.6rem .75rem;
  font-family:var(--font-sans);
  font-size:.65rem;
  line-height:1.4;
  transition:background .3s,border-color .3s,box-shadow .3s;
}
.ai-chat-form textarea:focus {
  border-color:hsl(var(--accent)/0.85);
  background:hsl(var(--glass-bg)/0.85);
  box-shadow:0 0 0 3px hsl(var(--accent)/0.35);
}
.ai-status-line {
  font-size:.52rem;
  display:flex;
  gap:.5rem;
  align-items:center;
  letter-spacing:.4px;
  color:hsl(var(--accent)/0.85);
  min-height:16px;
  flex-wrap:wrap;
}
.ai-badge {
  background:hsl(var(--accent)/0.35);
  padding:.35rem .55rem;
  border-radius:12px;
  font-size:.5rem;
  font-weight:700;
  letter-spacing:.45px;
  display:inline-flex;
  align-items:center;
  gap:.35rem;
  color:#fff;
}
.ai-fallback-note {
  font-size:.5rem;
  color:#f97316;
  font-weight:600;
  letter-spacing:.4px;
  margin-top:.15rem;
}
.ai-quick-grid {
  display:flex;
  flex-wrap:wrap;
  gap:.5rem;
}
.ai-chip {
  background:hsl(var(--accent)/0.18);
  color:hsl(var(--accent)/0.95);
  padding:.4rem .65rem;
  font-size:.55rem;
  font-weight:600;
  border-radius:14px;
  cursor:pointer;
  border:1px solid hsl(var(--panel-border)/0.5);
  transition:background .25s,transform .25s;
}
.ai-chip:hover {
  background:hsl(var(--accent)/0.30);
  transform:translateY(-3px);
  color:#fff;
}
.ai-chip:active {
  transform:translateY(-1px) scale(.95);
}
@keyframes fade { from{opacity:0;transform:translateY(6px);} to{opacity:1;transform:translateY(0);} }
@keyframes modalBg { from{opacity:0;} to{opacity:1;} }
@keyframes modalIn { from{opacity:0;transform:translateY(18px) scale(.94);} to{opacity:1;transform:translateY(0) scale(1);} }

/* Dark theme adaptation */
[data-theme="dark"] #aiChatModal .ai-chat-box {
  background:linear-gradient(145deg,hsl(220 15% 14% / .92),hsl(220 15% 12% / .78));
  border-color:hsl(220 15% 28%);
}
[data-theme="dark"] .ai-chat-history {
  background:hsl(var(--accent)/0.12);
}

/* WELCOME MODAL */
#welcomeModal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px);
  z-index:10020;
  display:none;
  align-items:center;
  justify-content:center;
  padding:1.4rem;
  animation: modalBg .35s ease;
}
#welcomeModal.show { display:flex; }
#welcomeModal .modal-box {
  width:100%;
  max-width:560px;
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.94),hsl(var(--glass-bg)/0.72));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:32px;
  padding:1.25rem 1.35rem 1.4rem;
  display:flex;
  flex-direction:column;
  gap:.85rem;
  position:relative;
  animation: modalIn .55s var(--spring);
  box-shadow:0 22px 54px -18px rgba(0,0,0,.65), 0 0 0 1px hsl(var(--panel-border)/0.4);
}
[data-theme="dark"] #welcomeModal .modal-box {
  background:linear-gradient(145deg,hsl(220 15% 14% / .94),hsl(220 15% 12% / .78));
  border-color:hsl(220 15% 28%);
}
/* ==== Welcome Modal: Switch Style ==== */
.welcome-switch {
  --ws-w: 44px;
  --ws-h: 22px;
  --ws-pad: 3px;
  display:inline-flex;
  align-items:center;
  gap:.65rem;
  cursor:pointer;
  font-size:.58rem;
  font-weight:600;
  user-select:none;
}

.welcome-switch input {
  position:absolute;
  opacity:0;
  pointer-events:none;
}

.welcome-switch .ws-track {
  width:var(--ws-w);
  height:var(--ws-h);
  background:hsl(var(--accent)/0.30);
  border-radius:999px;
  position:relative;
  display:inline-block;
  transition:background .35s var(--spring);
  box-shadow:0 2px 6px -2px rgba(0,0,0,.35) inset;
}

.welcome-switch .ws-knob {
  position:absolute;
  top:var(--ws-pad);
  left:var(--ws-pad);
  width:calc(var(--ws-h) - var(--ws-pad)*2);
  height:calc(var(--ws-h) - var(--ws-pad)*2);
  background:linear-gradient(135deg,#fff,#eaeaea);
  border-radius:50%;
  transition:.35s var(--spring);
  box-shadow:0 3px 10px -4px rgba(0,0,0,.45);
}

.welcome-switch input:checked + .ws-track {
  background:var(--gradient-accent);
}
.welcome-switch input:checked + .ws-track .ws-knob {
  transform:translateX(calc(var(--ws-w) - var(--ws-h)));
}

.welcome-switch input:focus-visible + .ws-track {
  outline:2px solid hsl(var(--accent)/0.85);
  outline-offset:3px;
}

.welcome-switch:hover .ws-track {
  filter:brightness(1.05);
}
/* ===== HACCP / CCP MODULE ===== */
.haccp-master-list {
  display:flex;
  flex-direction:column;
  gap:.55rem;
  margin-top:.6rem;
  max-height:320px;
  overflow:auto;
  padding-right:.3rem;
  scrollbar-width:thin;
  font-size:.55rem;
}
.haccp-master-item {
  background:hsl(var(--accent)/0.14);
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:16px;
  padding:.55rem .65rem .6rem;
  display:grid;
  grid-template-columns: 1fr auto;
  gap:.5rem;
  position:relative;
  transition:background .3s, transform .3s, box-shadow .3s;
}
.haccp-master-item:hover {
  background:hsl(var(--accent)/0.22);
  transform:translateY(-3px);
  box-shadow:0 4px 12px -6px hsl(var(--accent)/0.55);
}
.haccp-master-meta {
  font-size:.48rem;
  opacity:.75;
  display:flex;
  flex-wrap:wrap;
  gap:.35rem;
  margin-top:.25rem;
}
.haccp-status-ok {
  background:linear-gradient(135deg,#059669,#10b981);
  color:#fff;
  padding:.25rem .55rem;
  border-radius:10px;
  font-size:.48rem;
  font-weight:700;
  letter-spacing:.4px;
}
.haccp-status-out {
  background:linear-gradient(135deg,#ef4444,#b91c1c);
  color:#fff;
  padding:.25rem .55rem;
  border-radius:10px;
  font-size:.48rem;
  font-weight:700;
  letter-spacing:.4px;
}
.ccp-action-btn {
  background:hsl(var(--accent)/0.25);
  border:1px solid hsl(var(--panel-border)/0.5);
  color:#fff;
  padding:.3rem .55rem;
  border-radius:10px;
  font-size:.5rem;
  cursor:pointer;
  display:inline-flex;
  gap:.35rem;
  align-items:center;
  transition:background .3s, transform .3s;
}
.ccp-action-btn:hover {
  background:hsl(var(--accent)/0.38);
  transform:translateY(-2px);
}
.ccp-tag {
  background:hsl(var(--accent)/0.3);
  color:#fff;
  padding:.2rem .45rem;
  border-radius:8px;
  font-size:.45rem;
  font-weight:700;
  letter-spacing:.4px;
  display:inline-flex;
  gap:.25rem;
  align-items:center;
}
/* ==== SENSOR MODULE CSS (Ringan) ==== */
#sensorList .sensor-item {
  background:hsl(var(--accent)/0.15);
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.45rem .55rem .5rem;
  border-radius:14px;
  display:flex;
  flex-direction:column;
  gap:.25rem;
  position:relative;
  transition:background .25s, transform .25s;
  font-size:.55rem;
}
#sensorList .sensor-item:hover {
  background:hsl(var(--accent)/0.25);
  transform:translateY(-3px);
}
.sensor-badge {
  background:hsl(var(--accent)/0.40);
  color:#fff;
  font-size:.48rem;
  padding:.2rem .45rem;
  border-radius:10px;
  font-weight:700;
  letter-spacing:.4px;
  display:inline-flex;
  gap:.3rem;
  align-items:center;
}
.sensor-badge.alert {
  background:linear-gradient(135deg,#ef4444,#b91c1c);
}
.sensor-badge.ok {
  background:linear-gradient(135deg,#10b981,#059669);
}
/* ====== SENSOR TEMP INDICATOR IMPROVED ====== */
.indicator.temp-indicator {
  transition: background .45s, box-shadow .45s, border-color .45s;
  position:relative;
  overflow:visible;
  padding:.75rem .8rem 1rem;
}

.indicator.temp-indicator .temp-head {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.6rem;
  margin-bottom:.35rem;
}
.indicator.temp-indicator .temp-head h4 {
  display:flex;
  align-items:center;
  gap:.35rem;
  font-size:.52rem;
  letter-spacing:.65px;
  margin:0;
  text-transform:uppercase;
  font-weight:800;
  color:hsl(var(--text-dim));
}

.temp-status-badge {
  font-size:.48rem;
  font-weight:700;
  letter-spacing:.5px;
  padding:.3rem .55rem;
  border-radius:10px;
  background:hsl(var(--accent)/0.30);
  color:#fff;
  display:inline-flex;
  align-items:center;
  gap:.25rem;
  box-shadow:0 3px 10px -4px hsl(var(--accent)/0.55);
  transition:background .35s, transform .35s;
}

.indicator.temp-indicator .temp-main {
  display:flex;
  align-items:baseline;
  gap:.6rem;
  margin-bottom:.55rem;
}

.indicator.temp-indicator .val {
  font-size:1.65rem;
  font-weight:700;
  line-height:1;
  letter-spacing:.5px;
  animation:numberPop .6s var(--spring);
}

.indicator.temp-indicator .trend {
  font-size:.55rem;
  font-weight:700;
  padding:.35rem .55rem;
  border-radius:10px;
  background:hsl(var(--accent)/0.30);
  color:#fff;
  box-shadow:0 4px 12px -6px hsl(var(--accent)/0.55);
  align-self:flex-start;
  margin-top:.25rem;
  letter-spacing:.45px;
  animation:fadeSlide .55s var(--spring);
}

/* Range bar */
.temp-range-wrap {
  margin-top:.15rem;
}
.temp-range-bar {
  position:relative;
  height:12px;
  background:linear-gradient(90deg,#1d4ed8,#0ea5e9 20%,#10b981 36%,#f59e0b 66%,#ef4444 90%);
  border-radius:10px;
  overflow:hidden;
  box-shadow:0 2px 6px -2px rgba(0,0,0,.3);
}
.temp-range-fill {
  position:absolute;
  top:0;
  left:0;
  height:100%;
  width:0%;
  background:rgba(255,255,255,.55);
  mix-blend-mode:overlay;
  pointer-events:none;
  transition:width .6s var(--spring);
}
.temp-range-marker {
  position:absolute;
  top:50%;
  transform:translate(-50%,-50%);
  font-size:.42rem;
  font-weight:700;
  color:#fff;
  text-shadow:0 0 2px rgba(0,0,0,.5);
  user-select:none;
  pointer-events:none;
}
.temp-range-marker.low { left:0%; }
.temp-range-marker.mid { left:33.33%; }
.temp-range-marker.high{ left:66.66%; }
.temp-range-marker.max { left:100%; }

.temp-mini-note {
  margin-top:.45rem;
  font-size:.46rem;
  letter-spacing:.4px;
  font-weight:600;
  opacity:.75;
}

/* Dynamic color states */
.temp-indicator.temp-cold {
  background:linear-gradient(145deg,rgba(29,78,216,.28),rgba(29,78,216,.10));
  border:1px solid rgba(59,130,246,.45);
}
.temp-indicator.temp-ideal {
  background:linear-gradient(145deg,rgba(16,185,129,.30),rgba(16,185,129,.12));
  border:1px solid rgba(16,185,129,.5);
}
.temp-indicator.temp-warn {
  background:linear-gradient(145deg,rgba(245,158,11,.32),rgba(245,158,11,.12));
  border:1px solid rgba(245,158,11,.55);
}
.temp-indicator.temp-alert {
  background:linear-gradient(145deg,rgba(239,68,68,.35),rgba(239,68,68,.18));
  border:1px solid rgba(239,68,68,.55);
  animation: tempPulse 2.2s ease-in-out infinite;
}

@keyframes tempPulse {
  0%,100% { box-shadow:0 0 0 0 rgba(239,68,68,.55); }
  50% { box-shadow:0 0 0 8px rgba(239,68,68,0); }
}

.temp-status-badge.cold  { background:linear-gradient(135deg,#1d4ed8,#0ea5e9); }
.temp-status-badge.ideal { background:linear-gradient(135deg,#059669,#10b981); }
.temp-status-badge.warn  { background:linear-gradient(135deg,#f59e0b,#d97706); }
.temp-status-badge.alert { background:linear-gradient(135deg,#ef4444,#b91c1c); }

.temp-status-badge:hover {
  transform:translateY(-3px);
}
[data-theme="dark"] .temp-range-bar {
  filter:brightness(.92) saturate(1.05);
}
/* ===== MICRO-LEARNING MODULE ===== */
.micro-layout {
  display:grid;
  gap:1rem;
  grid-template-columns:280px 1fr;
}
@media(max-width:880px){
  .micro-layout { grid-template-columns:1fr; }
  .micro-left { order:2; }
  .micro-right { order:1; }
}
.micro-left {
  display:flex;
  flex-direction:column;
  gap:.7rem;
  max-height:640px;
  overflow:auto;
  padding-right:.3rem;
}
.micro-module-item {
  background:linear-gradient(135deg,hsl(var(--accent)/0.18),hsl(var(--accent)/0.10));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.65rem .75rem;
  border-radius:18px;
  font-size:.58rem;
  display:flex;
  flex-direction:column;
  gap:.35rem;
  cursor:pointer;
  position:relative;
  transition:background .3s,transform .3s,box-shadow .3s;
}
.micro-module-item:hover {
  background:hsl(var(--accent)/0.28);
  transform:translateY(-4px);
  box-shadow:0 6px 16px -8px hsl(var(--accent)/0.55);
}
.micro-module-item.active {
  background:var(--gradient-accent);
  color:#fff;
  box-shadow:0 8px 18px -10px hsl(var(--accent)/0.65);
}
.micro-module-item .tag {
  background:hsl(var(--accent)/0.35);
  color:#fff;
  padding:.2rem .45rem;
  border-radius:10px;
  font-size:.48rem;
  font-weight:700;
  letter-spacing:.4px;
  display:inline-flex;
  gap:.25rem;
  align-items:center;
}
.micro-badge-pass {
  background:linear-gradient(135deg,#10b981,#059669);
  color:#fff;
}
.micro-badge-fail {
  background:linear-gradient(135deg,#ef4444,#b91c1c);
  color:#fff;
}
.micro-right {
  min-height:400px;
  display:flex;
  flex-direction:column;
  gap:1rem;
  position:relative;
}
.micro-idle {
  padding:1rem .9rem;
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.66),hsl(var(--glass-bg)/0.50));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:24px;
}
.micro-slide-header {
  display:flex;
  flex-direction:column;
  gap:.55rem;
  background:hsl(var(--accent)/0.18);
  padding:.7rem .75rem;
  border-radius:18px;
  border:1px solid hsl(var(--panel-border)/0.5);
}
.micro-slide-title {
  font-size:.72rem;
  font-weight:700;
  letter-spacing:.55px;
}
.micro-slide-progress {
  display:flex;
  align-items:center;
  gap:.6rem;
  font-size:.52rem;
  font-weight:700;
  letter-spacing:.45px;
}
.micro-progress-bar {
  flex:1;
  height:8px;
  background:hsl(var(--accent)/0.25);
  border-radius:6px;
  overflow:hidden;
  position:relative;
}
.micro-progress-bar > div {
  height:100%;
  width:0%;
  background:var(--gradient-accent);
  transition:width .4s var(--spring);
}
.micro-slide-body {
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.60),hsl(var(--glass-bg)/0.45));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:1rem .95rem 1.1rem;
  border-radius:24px;
  font-size:.62rem;
  line-height:1.55;
  min-height:210px;
  white-space:pre-wrap;
  position:relative;
  overflow:auto;
}
.micro-slide-nav {
  display:flex;
  gap:.6rem;
  flex-wrap:wrap;
  align-items:center;
}
.micro-quiz-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:.6rem;
  background:hsl(var(--accent)/0.18);
  padding:.65rem .75rem;
  border-radius:18px;
  border:1px solid hsl(var(--panel-border)/0.5);
}
.micro-quiz-status {
  font-size:.52rem;
  font-weight:700;
  letter-spacing:.45px;
  background:hsl(var(--accent)/0.35);
  color:#fff;
  padding:.3rem .55rem;
  border-radius:12px;
}
.micro-quiz-list {
  display:flex;
  flex-direction:column;
  gap:.75rem;
  margin-top:.7rem;
}
.micro-question {
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.60),hsl(var(--glass-bg)/0.45));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.75rem .85rem;
  border-radius:20px;
  font-size:.6rem;
  display:flex;
  flex-direction:column;
  gap:.5rem;
}
.micro-question h4 {
  margin:0;
  font-size:.6rem;
  font-weight:700;
  letter-spacing:.5px;
}
.micro-options {
  display:flex;
  flex-direction:column;
  gap:.4rem;
}
.micro-option {
  background:hsl(var(--accent)/0.18);
  border:1px solid hsl(var(--panel-border)/0.5);
  padding:.45rem .55rem;
  border-radius:14px;
  font-size:.57rem;
  cursor:pointer;
  transition:background .3s,transform .3s,box-shadow .3s;
  display:flex;
  gap:.45rem;
  align-items:flex-start;
}
.micro-option:hover {
  background:hsl(var(--accent)/0.32);
  transform:translateY(-3px);
  box-shadow:0 4px 12px -6px hsl(var(--accent)/0.55);
}
.micro-option.active {
  background:var(--gradient-accent);
  color:#fff;
  box-shadow:0 6px 18px -8px hsl(var(--accent)/0.55);
}
.micro-option.correct {
  background:linear-gradient(135deg,#10b981,#059669);
  color:#fff;
}
.micro-option.wrong {
  background:linear-gradient(135deg,#ef4444,#b91c1c);
  color:#fff;
}
.micro-quiz-actions {
  display:flex;
  align-items:center;
  gap:.6rem;
  flex-wrap:wrap;
  margin-top:.85rem;
}
.micro-quiz-result {
  margin-top:.85rem;
  font-size:.58rem;
  font-weight:600;
  letter-spacing:.45px;
  line-height:1.4;
  white-space:pre-wrap;
}
.micro-finish-badge {
  display:inline-flex;
  align-items:center;
  gap:.35rem;
  background:linear-gradient(135deg,#10b981,#059669);
  color:#fff;
  padding:.4rem .65rem;
  border-radius:14px;
  font-size:.55rem;
  font-weight:700;
  letter-spacing:.5px;
  box-shadow:0 6px 16px -8px rgba(0,0,0,.4);
}
@media (max-width: 820px){
  body.font-large .presence-indicator,
  html.font-large .presence-indicator {
    display:none !important;
  }
}
</style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div id="loadingText">Memuat aplikasi...</div>
</div>

<div id="toastContainer"></div>

<!-- Modal (global confirm/info) -->
<div id="appModal" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-title" id="modalTitle">
      <i data-feather="help-circle" width="18"></i>
      <span>Konfirmasi</span>
    </div>
    <div class="modal-text" id="modalMessage">Yakin?</div>
    <div id="modalExtra"></div>
    <div class="modal-actions">
      <button class="outline small" id="modalCancelBtn">
        <i data-feather="x" width="13"></i> <span id="modalCancelText">Batal</span>
      </button>
      <button class="danger small" id="modalOkBtn">
        <i data-feather="check" width="13"></i> <span id="modalOkText">Ya</span>
      </button>
    </div>
  </div>
</div>

<!-- Modal profil pengguna lain -->
<div id="userProfileModal" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-title">
      <i data-feather="user" width="18"></i>
      <span id="userProfileModalTitle">Profil Pengguna</span>
    </div>
    <div id="userProfileContent" class="user-profile-body">
      <!-- Filled dynamically -->
    </div>
    <div class="modal-actions">
      <button class="outline small" id="closeUserProfileModal">
        <i data-feather="x" width="13"></i> Tutup
      </button>
    </div>
  </div>
</div>

<!-- Detail Record Modal -->
<div id="recordDetailModal" aria-hidden="true">
  <div class="detail-box">
    <button class="close-btn" id="closeRecordDetail">
      <i data-feather="x" width="12"></i> Tutup
    </button>
    <div style="display:flex;flex-direction:column;gap:.35rem;">
      <div style="font-size:.75rem;font-weight:700;letter-spacing:.55px;display:flex;align-items:center;gap:.45rem;">
        <i data-feather="file-text" width="16"></i>
        <span id="detailTitle">Detail Data</span>
      </div>
      <div id="detailStatusBadges" style="display:flex;flex-wrap:wrap;gap:.4rem;"></div>
    </div>
    <div class="detail-grid" id="detailGrid"></div>
    <div id="detailImageWrapper"></div>
    <div id="detailHazardsWrapper"></div>
  </div>
</div>

<!-- AI CHAT MODAL -->
<div id="aiChatModal" aria-hidden="true">
  <div class="ai-chat-box">
    <div class="ai-chat-header">
      <div style="display:flex;align-items:center;gap:.5rem;">
        <i data-feather="message-circle" width="18"></i>
        <span style="font-weight:700;letter-spacing:.6px;font-size:.8rem;">AI Asisten</span>
      </div>
      <div style="display:flex;align-items:center;gap:.45rem;">
        <span id="aiModelBadge" class="ai-badge">-</span>
        <button class="outline small" id="aiCloseModal">
          <i data-feather="x" width="14"></i>
        </button>
      </div>
    </div>
    <div id="aiChatHistory" class="ai-chat-history"></div>
    <form id="aiChatForm" class="ai-chat-form">
      <textarea id="aiUserInput" placeholder="Tulis pertanyaan mutu ikan..." maxlength="800"></textarea>
      <div style="display:flex;flex-direction:column;gap:.45rem;">
        <button type="submit" class="small" id="aiSendBtn">
          <i data-feather="send" width="13"></i>Kirim
        </button>
        <button type="button" class="outline small" id="aiClearBtn">
          <i data-feather="trash-2" width="13"></i>Bersih
        </button>
      </div>
    </form>
    <div id="aiStatusLine" class="ai-status-line">
      <span id="aiStatusText">Siap</span>
    </div>
    <div id="aiFallbackNote" class="ai-fallback-note hidden"></div>
  </div>
</div>

<!-- WELCOME MODAL -->
<div id="welcomeModal" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-title">
      <i data-feather="smile" width="18"></i>
      <span>Selamat Datang di MMIS - Monitoring Mutu Ikan Segar</span>
    </div>
<div class="modal-text" style="display:flex;flex-direction:column;gap:.95rem;max-height:62vh;overflow:auto;padding-right:.35rem;">
  <div style="font-size:.63rem;line-height:1.45;">
    <strong>Selamat datang, <span id="welcomeUserName">Pengguna</span>! ðŸ˜Š</strong><br>
    Aplikasi ini membantu Anda <em>mencatat</em>, <em>memantau</em>, dan <em>menganalisis</em> mutu ikan segar di pasar tradisional
    serta memberi edukasi ringkas terkait keamanan pangan.
  </div>

  <div style="background:hsl(var(--accent)/0.16);padding:.65rem .75rem;border:1px solid hsl(var(--panel-border)/0.55);border-radius:16px;font-size:.56rem;line-height:1.4;display:flex;gap:.55rem;">
    <i data-feather="zap" width="14"></i>
    <div>
      <strong>Quick Start:</strong><br>
      <ul style="margin:.25rem 0 0 .9rem;padding:0;list-style:disc;display:flex;flex-direction:column;gap:.25rem;">
        <li>Buka <strong>Input Data</strong>, isi jenis ikan, pasar, skor organoleptik.</li>
        <li>Tulis deskripsi bau, tekstur, warna secara objektif.</li>
        <li>(Opsional) Tambahkan indikasi keamanan hanya bila ada observasi meyakinkan.</li>
        <li>Unggah foto untuk dukungan visual.</li>
      </ul>
    </div>
  </div>

  <div style="font-size:.56rem;line-height:1.5;">
    <strong>Tool Organoleptik > </strong> Gunakan menu <em>â€œTool Organoleptikâ€</em> atau tombol â€œTool Skorâ€ di Form untuk memilih deskripsi standar & menghasilkan skor gabungan otomatis (pilih metode: rata-rata / minimum / median), lalu klik â€œTerapkanâ€.
  </div>

  <div style="font-size:.56rem;line-height:1.5;">
    <strong>HACCP / CCP Checklist > </strong> Gunakan menu <em>â€œHACCP / CCP"</em> untuk mencatat monitoring titik kendali kritis (CCP).
  </div>
  
  <div style="font-size:.56rem;line-height:1.5;">
    <strong>Sensor Suhu > </strong> Menampilkan pembacaan suhu terakhir dari database website ini. Perangkat (ESP32/dll) mengirim data secara periodik. Gunakan grafik untuk memantau tren.
  </div>

  <div style="font-size:.56rem;line-height:1.5;">
    <strong>Kustomisasi Tampilan > </strong> Di menu <em>Pengaturan</em> Anda dapat mengubah Tema (Terang/Gelap), Warna Aksen, Ukuran & Jenis Font, Layout (Grid/List), Mode Kinerja (Ultra / Default / Lite), Bahasa (ID / EN), serta Auto Refresh Dashboard.
  </div>

  <div style="font-size:.56rem;line-height:1.5;">
    <strong>Mode Kinerja > </strong> Jika terasa berat, beralih ke <em>Default</em> atau <em>Lite</em> untuk menonaktifkan blur & animasi berat. Ini bermanfaat di perangkat low-power / koneksi lambat.
  </div>

  <div style="font-size:.56rem;line-height:1.5;">
    <strong>Konsistensi Data > </strong> Gunakan nama jenis ikan & pasar konsisten. Ketik nama baru jika belum ada > sistem menambah otomatis ke daftar metadata.
  </div>

  <div style="font-size:.56rem;line-height:1.5;">
    <strong>Fitur Penting:</strong>
    <ul style="margin:.25rem 0 0 .9rem;padding:0;list-style:disc;display:flex;flex-direction:column;gap:.25rem;">
      <li><em>Export</em> (CSV / Excel / PDF) di tabel & laporan.</li>
      <li><em>AI Asisten</em>: tanya standar mutu, indikasi bahaya, tips penanganan.</li>
      <li><em>Notifikasi</em>: cek ikon lonceng untuk broadcast admin / info penting.</li>
  <li><em>Feed Sosial</em>: diskusi singkat & komentar antar pengguna.</li>
  <li><em>Micro-Learning</em>: Modul mini (1-2 menit) + kuis cepat.</li>
      <li><em>Ranking & Rekomendasi</em>: lihat pasar / ikan dengan mutu tinggi atau perlu perhatian.</li>
    </ul>
  </div>

 
  <div style="font-size:.56rem;line-height:1.5;">
    <strong>Langkah Lanjut:</strong> Setelah menginput 5â€“10 data, buka Dashboard & ubah rentang (Hari Ini / 7 / 30 / Semua) untuk melihat tren. Perhatikan pergeseran mutu & jumlah indikasi bahaya.
  </div>

  <div style="background:hsl(var(--accent)/0.14);padding:.55rem .7rem;border:1px solid hsl(var(--panel-border)/0.5);border-radius:14px;font-size:.55rem;display:flex;gap:.5rem;">
    <i data-feather="info" width="14"></i>
    <div>
      Sesuaikan preferensi tampilan di Pengaturan agar membaca tabel dan form lebih nyaman. Anda dapat menonaktifkan animasi (â€œReduce Motionâ€) dan memakai mode Lite di perangkat lama ðŸ™
    </div>
  </div>

  <div class="welcome-optline">
  <label class="welcome-switch">
    <input type="checkbox" id="welcomeDontShow">
    <span class="ws-track">
      <span class="ws-knob"></span>
    </span>
    <span class="ws-text">Jangan tampilkan lagi</span>
  </label>
</div>
</div>

<div class="modal-actions" style="justify-content:space-between;">
  <button class="outline small" id="welcomeSettingsBtn">
    <i data-feather="settings" width="13"></i> Pengaturan
  </button>
  <div style="display:flex;gap:.45rem;">
    <button class="outline small" id="welcomeCloseBtn">
      <i data-feather="x" width="13"></i> Tutup
    </button>
    <button class="small" id="welcomeOkBtn">
      <i data-feather="check" width="13"></i> Mulai
    </button>
  </div>
</div>
  </div>
</div>

<!-- AUTH SCREENS -->
<div id="authView" class="fade-in">
  <div class="container-auth" id="loginContainer">
    <div class="glow"></div>
    <div class="logo-circle">MMIS</div>
    <h2 data-i18n="app_title">Monitoring Mutu Ikan Segar</h2>
    <p class="muted" data-i18n="app_subtitle">Sistem Informasi Pasar Tradisional Kota Makassar</p>
    <div id="authAlert"></div>
    <form id="loginForm" autocomplete="on">
      <div class="inline-field">
        <label data-i18n="email">Email</label>
        <input type="email" id="loginEmail" required placeholder="email@gmail.com" autocomplete="email" />
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div class="inline-field">
        <label data-i18n="password">Kata Sandi</label>
        <input type="password" id="loginPassword" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      </div><small style="opacity:0;font-size:0.8px">sk</small>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.35rem;gap:.7rem;">
        <button type="submit" style="flex:1;" id="btnLogin">
          <i data-feather="log-in" width="16"></i>
          <span data-i18n="login">Masuk</span>
        </button>
        <div style="flex:1;text-align:right;">
          <a href="#" id="linkForgot" style="font-size:.6rem;font-weight:700;letter-spacing:.55px;" data-i18n="forgot_password">Lupa kata sandi?</a>
        </div>
      </div>
    </form>
    <div class="switch-auth">
      <span data-i18n="no_account">Belum punya akun?</span>
      <a href="#" id="showRegister" data-i18n="register_now">Daftar sekarang</a>
    </div>
    <div style="margin-top:.9rem;display:flex;gap:.6rem;flex-wrap:wrap;">
      <button class="outline small" type="button" id="quickDemoAdmin"><i data-feather="user-check" width="14"></i> Demo Admin</button>
      <button class="outline small" type="button" id="quickDemoUser"><i data-feather="user" width="14"></i> Demo Mahasiswa</button>
    </div>
    <div class="switch-auth" style="margin-top:1.05rem;">
      <span class="small">Â© <span id="year"></span> MMIS - Kota Makassar</span>
    </div>
  </div>

  <div class="container-auth hidden" id="registerContainer">
    <div class="glow"></div>
    <div class="logo-circle">MMIS</div>
    <h2 data-i18n="register_account">Registrasi Akun</h2>
    <p class="muted" data-i18n="register_subtitle">Buat akun baru untuk mulai mencatat data mutu ikan.</p>
    <div id="registerAlert"></div>
    <form id="registerForm" autocomplete="on">
      <div class="inline-field">
        <label data-i18n="full_name">Nama Lengkap</label>
        <input id="regName" required placeholder="Nama lengkap" />
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div class="inline-field">
        <label data-i18n="email">Email</label>
        <input type="email" id="regEmail" required placeholder="email@gmail.com" autocomplete="email" />
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div class="inline-field">
        <label data-i18n="password">Kata Sandi</label>
        <input type="password" id="regPassword" required minlength="6" placeholder="Minimal 6 karakter" autocomplete="new-password"/>
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div class="inline-field">
        <label data-i18n="confirm_password">Konfirmasi Kata Sandi</label>
        <input type="password" id="regConfirmPassword" required placeholder="Ulangi kata sandi" autocomplete="new-password"/>
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div class="inline-field">
        <label data-i18n="role">Peran</label>
        <select id="regRole" required>
          <option value="Mahasiswa">Mahasiswa</option>
          <option value="Petugas Pasar">Petugas Pasar</option>
          <option value="Dosen">Dosen/Pembimbing</option>
          <option value="Lainnya">Lainnya</option>
        </select>
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div id="regExtraFields" class="slide-in-up"></div>
      <button type="submit" style="width:100%;margin-top:.55rem;">
        <i data-feather="user-plus" width="16"></i>
        <span data-i18n="create_account">Buat Akun</span>
      </button>
    </form>
    <div class="switch-auth">
      <span data-i18n="have_account">Sudah punya akun?</span>
      <a href="#" id="showLogin" data-i18n="login">Masuk</a>
    </div>
  </div>

  <div class="container-auth hidden" id="forgotContainer">
    <div class="glow"></div>
    <div class="logo-circle">MMIS</div>
    <h2 data-i18n="reset_password">Reset Kata Sandi</h2>
    <p class="muted" data-i18n="reset_subtitle">Masukkan email anda untuk menerima link reset.</p>
    <div id="forgotAlert"></div>
    <form id="forgotForm">
      <div class="inline-field">
        <label data-i18n="email">Email</label>
        <input type="email" id="forgotEmail" required placeholder="you@example.com">
      </div>
      <button type="submit" style="width:100%;margin-top:.6rem;">
        <i data-feather="mail" width="16"></i>
        <span data-i18n="send_reset_link">Kirim Link Reset</span>
      </button>
    </form>
    <div class="switch-auth">
      <a href="#" id="backToLogin" data-i18n="back_login">Kembali ke Login</a>
    </div>
  </div>
</div>

<!-- APP LAYOUT -->
<div id="appLayout" class="layout hidden">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo-circle" style="width:48px;height:48px;font-size:.85rem;letter-spacing:.8px;">MMIS</div>
      <h2>
        <span style="display:block;">Mutu Ikan</span>
        <span style="font-weight:400;opacity:.7;font-size:.55rem;letter-spacing:.5px;">Makassar</span>
      </h2>
      <button class="ghost responsive-hide" id="closeSidebar" style="margin-left:auto;padding:.5rem .55rem;">
        <i data-feather="x" width="16"></i>
      </button>
    </div>
    <div class="nav" id="navMenu">
      <button data-view="dashboard" class="active">
        <i data-feather="activity" width="18"></i>
        <span data-i18n="dashboard">Dashboard</span>
      </button>
      <button data-view="data">
        <i data-feather="database" width="18"></i>
        <span data-i18n="data_records">Data Mutu</span>
      </button>
      <button data-view="form">
        <i data-feather="edit-3" width="18"></i>
        <span data-i18n="input_form">Input Data</span>
      </button>
      <button data-view="organoleptic-tool">
        <i data-feather="sliders" width="18"></i>
        <span>Tool Organoleptik</span>
      </button>
      <button data-view="reports">
        <i data-feather="bar-chart-2" width="18"></i>
        <span data-i18n="reports">Laporan</span>
      </button>
      <button data-view="haccp">
  <i data-feather="clipboard" width="18"></i>
  <span>HACCP / CCP</span>
</button>

<button data-view="sensors">
  <i data-feather="thermometer" width="18"></i>
  <span>Sensor Suhu</span>
</button>
<button data-view="micro-learning">
  <i data-feather="book" width="18"></i>
  <span>Micro-Learning</span>
</button>
      <button data-view="materials">
        <i data-feather="book-open" width="18"></i>
        <span data-i18n="materials">Materi</span>
      </button>
      <button data-view="settings">
        <i data-feather="settings" width="18"></i>
        <span data-i18n="settings">Pengaturan</span>
      </button>
      <button data-view="profile">
        <i data-feather="user" width="18"></i>
        <span data-i18n="profile">Profil</span>
      </button>
      <button data-view="safety">
        <i data-feather="shield" width="18"></i>
        <span data-i18n="safety">Keamanan</span>
      </button>
      <button data-view="sosial">
        <i data-feather="users" width="18"></i>
        <span data-i18n="social">Sosial</span>
      </button>
      
<button data-view="ai-assistant">
  <i data-feather="message-circle" width="18"></i>
  <span>AI Asisten</span>
</button>
      <button data-view="about">
        <i data-feather="info" width="18"></i>
        <span>Tentang</span>
      </button>
    </div>
    <div class="sidebar-footer">
      <div id="sidebarUserInfo" style="font-size:.55rem;line-height:1.25;"></div>
      <div style="display:flex;gap:.5rem;">
        <button class="outline" id="btnLogout" style="flex:1;justify-content:center;">
          <i data-feather="log-out" width="14"></i>
          <span data-i18n="logout">Keluar</span>
        </button>
      </div>
      <div style="text-align:center;margin-top:.35rem;">
        <span class="muted" style="font-size:.5rem;">v1.7.0 Single File â€¢ Skripsi</span>
      </div>
    </div>
  </aside>

  <div class="main">
    <div style="padding:20px; opacity:0">dk</div>
    <div class="topbar">
      <div class="group-inline">
        <button class="ghost responsive-hide" id="openSidebar" style="padding:.5rem .55rem;">
          <i data-feather="menu" width="18"></i>
        </button>
        <div class="toggle" id="toggleMyData" data-state="all" title="Tampilkan data saya / semua">
          <i data-feather="toggle-right" width="14"></i>
          <span id="toggleMyDataLabel">Semua Data</span>
        </div>
        <div class="lang-pill" id="btnLang">
          <i data-feather="globe" width="14"></i>
          <span id="langLabel">ID</span>
        </div>
      </div>
      <div class="group-inline">
      	<!-- SISIPKAN INI: -->
  <div id="appPresence" class="presence-indicator" title="Status Koneksi">
    <span class="dot"></span>
    <span class="label">Online</span>
  </div>
        <button style="margin-right:-10px" class="ghost" id="btnNotifications" title="Notifikasi">
          <i data-feather="bell" width="16"></i>
          <span id="notifBadge" class="badge-dot hidden">0</span>
        </button>
        <div style="position:relative;">
          <div class="dropdown" id="notifDropdown" style="right:auto; left:50%; transform:translateX(-50%); top:120%;min-width:320px;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:.4rem;margin-bottom:.4rem;">
              <span style="font-size:.58rem;font-weight:700;letter-spacing:.5px;display:flex;align-items:center;gap:.35rem;">
                <i data-feather="bell" width="14"></i><span data-i18n="notifications">Notifikasi</span>
              </span>
              <div style="display:flex;gap:.35rem;">
                <button class="ghost small" id="btnMarkAllRead" style="font-size:.5rem;"><i data-feather="check-circle" width="12"></i><span data-i18n="mark_all_read">Baca Semua</span></button>
                <button class="ghost small" id="btnRefreshNotif" style="font-size:.5rem;"><i data-feather="refresh-cw" width="12"></i></button>
              </div>
            </div>
            <div id="notifList" style="display:flex;flex-direction:column;gap:.55rem;"></div>
            <div id="notifEmpty" class="notif-empty hidden" data-i18n="no_notifications">Tidak ada notifikasi.</div>
          </div>
        </div>
        <button class="ghost" id="btnToggleTheme" title="Mode Gelap/Terang">
          <i data-feather="moon" width="16"></i>
        </button>
        <div style="position:relative;">
          <div class="avatar" id="avatarBtn">
            <span id="avatarInitial">U</span>
            <img id="avatarImg" alt="avatar" class="hidden" />
          </div>
          <div class="dropdown" id="userDropdown">
            <button data-dropdown="profile">
              <i data-feather="user" width="15"></i>
              <span data-i18n="profile">Profil</span>
            </button>
            <button data-dropdown="settings">
              <i data-feather="settings" width="15"></i>
              <span data-i18n="settings">Pengaturan</span>
            </button>
            <button data-dropdown="reports">
              <i data-feather="bar-chart-2" width="15"></i>
              <span data-i18n="reports">Laporan</span>
            </button>
            <div style="height:1px;background:hsl(var(--panel-border)/0.55);margin:.4rem 0;"></div>
            <button id="logoutDropdownBtn">
              <i data-feather="log-out" width="15"></i>
              <span data-i18n="logout">Keluar</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <main class="content">

      <!-- DASHBOARD -->
      <section id="view-dashboard" class="fade-in view-transition-enter">
        <div class="panel bento" style="padding-bottom:.9rem;">
          <div class="panel-header">
            <h3><i data-feather="activity" width="14"></i><span data-i18n="dashboard_overview">Ringkasan Mutu Terkini</span></h3>
            <div style="display:flex;align-items:center;gap:.55rem;flex-wrap:wrap;">
              <div class="toggle-group">
                <div class="toggle-chip active" data-dash-filter="today">Hari Ini</div>
                <div class="toggle-chip" data-dash-filter="7d">7 Hari</div>
                <div class="toggle-chip" data-dash-filter="30d">30 Hari</div>
                <div class="toggle-chip" data-dash-filter="all">Semua</div>
              </div>
              <button class="ghost small" id="btnRefreshDashboard" title="Segarkan Dashboard">
                <i data-feather="refresh-cw" width="14"></i>
              </button>
            </div>
          </div>
          <div class="indicators" id="dashboardIndicators">
            <div class="indicator">
              <h4 data-i18n="total_records">Total Data</h4>
              <div class="val" id="indTotal">0</div>
              <div class="trend" id="indTotalTrend">0%</div>
            </div>
            <div class="indicator">
              <h4 data-i18n="avg_score">Rata-rata Skor</h4>
              <div class="val" id="indAvg">-</div>
              <div class="trend" id="indAvgTrend">0%</div>
            </div>
            <div class="indicator">
              <h4 data-i18n="good_quality">Mutu Baik</h4>
              <div class="val" id="indGood">0</div>
              <div class="trend" id="indGoodTrend">0%</div>
            </div>
            <div class="indicator">
              <h4 data-i18n="warning_quality">Mutu Sedang</h4>
              <div class="val" id="indWarn">0</div>
              <div class="trend" id="indWarnTrend">0%</div>
            </div>
            <div class="indicator">
              <h4 data-i18n="bad_quality">Mutu Buruk</h4>
              <div class="val" id="indBad">0</div>
              <div class="trend" id="indBadTrend">0%</div>
            </div>
            <div class="indicator">
              <h4 data-i18n="hazard_flagged">Indikasi Bahaya</h4>
              <div class="val" id="indHazard">0</div>
              <div class="trend" id="indHazardTrend">0%</div>
            </div>
          </div>
        </div>
        <div style="opacity:0">sk</div>
        
        
              <!-- PANEL RANKING & REKOMENDASI (IMPROVED) -->
<div class="panel bento" id="rankingPanel">
  <div class="panel-header">
    <h3>
      <i data-feather="award" width="14"></i>
      <span>Ranking & Rekomendasi</span>
    </h3>
    <div style="display:flex;gap:.45rem;align-items:center;flex-wrap:wrap;">
      <div class="toggle-chip" id="rankingModeAll" data-mode="all" style="cursor:pointer;">Semua</div>
      <div class="toggle-chip" id="rankingModeActive" data-mode="active" style="cursor:pointer;">Rentang</div>
      <button class="ghost small" id="rankingRefreshBtn" title="Segarkan Ranking">
        <i data-feather="refresh-cw" width="13"></i>
      </button>
    </div>
  </div>
  <div class="ranking-grid">
    <div class="ranking-block">
      <div class="rb-title">
        <i data-feather="map-pin" width="12"></i>
        <span>Top Pasar</span>
      </div>
      <ul id="marketRankingList" class="ranking-list"></ul>
    </div>
    <div class="ranking-block">
      <div class="rb-title">
        <i data-feather="fish" width="12"></i>
        <span>Top Jenis Ikan</span>
      </div>
      <ul id="fishRankingList" class="ranking-list"></ul>
    </div>
   <div class="ranking-block">
      <div class="rb-title">
        <i data-feather="thumbs-up" width="12"></i>
        <span>Rekomendasi Pasar</span>
      </div>
      <div id="marketRecommendations" class="rec-wrap"></div>
    </div>
    <div class="ranking-block">
      <div class="rb-title">
        <i data-feather="star" width="12"></i>
        <span>Rekomendasi Ikan</span>
      </div>
      <div id="fishRecommendations" class="rec-wrap"></div>
    </div>
  </div>
  <div class="ranking-foot small muted">
    Perhitungan mengikuti rentang dashboard (Hari Ini / 7 / 30 / Semua) & toggle "Data Saya".
  </div>
</div>
  <div style="opacity:0">sk</div>
  
  
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(360px,1fr));">
          <div class="panel bento">
            <div class="panel-header">
              <h3><i data-feather="bar-chart-2" width="14"></i><span data-i18n="chart_comparison">Perbandingan Mutu per Pasar</span></h3>
              <div style="display:flex;gap:.35rem;">
                <button class="ghost small btn-refresh-chart" id="refreshCharts1" title="Segarkan">
                  <i data-feather="refresh-cw" width="13"></i>
                </button>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="chartComparison"></canvas>
            </div>
          </div>
     

          <div class="panel bento">
            <div class="panel-header">
              <h3><i data-feather="trending-up" width="14"></i><span data-i18n="chart_trend">Tren Skor Waktu</span></h3>
              <div style="display:flex;gap:.35rem;">
                <button class="ghost small btn-refresh-chart" id="refreshCharts2">
                  <i data-feather="refresh-cw" width="13"></i>
                </button>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="chartTrend"></canvas>
            </div>
          </div>

          <div class="panel bento">
            <div class="panel-header">
              <h3><i data-feather="pie-chart" width="14"></i><span data-i18n="chart_pie">Proporsi Jenis Ikan</span></h3>
              <div style="display:flex;gap:.35rem;">
                <button class="ghost small btn-refresh-chart" id="refreshCharts3">
                  <i data-feather="refresh-cw" width="13"></i>
                </button>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="chartPie"></canvas>
            </div>
          </div>

          <div class="panel bento">
            <div class="panel-header">
              <h3><i data-feather="thermometer" width="14"></i><span data-i18n="quality_indicators">Indikator Mutu</span></h3>
              <div class="toggle-group" style="font-size:.5rem;">
                <div class="toggle-chip active" data-quality-filter="all">Semua</div>
                <div class="toggle-chip" data-quality-filter="baik">Baik</div>
                <div class="toggle-chip" data-quality-filter="sedang">Sedang</div>
                <div class="toggle-chip" data-quality-filter="buruk">Buruk</div>
              </div>
            </div>
            <div id="qualityIndicatorList"></div>
          </div>
        </div>
      </section>

      <!-- DATA TABLE -->
      <section id="view-data" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="database" width="14"></i><span data-i18n="data_mutu_list">Data Mutu Ikan</span></h3>
            <div style="display:flex;gap:.4rem;flex-wrap:wrap;">
              <div class="search-box">
                <i data-feather="search" width="15" class="muted"></i>
                <input id="globalSearch" placeholder="Cari data ikan..." autocomplete="off">
              </div>
              <button class="ghost small" id="btnExportCSV"><i data-feather="download-cloud" width="13"></i> CSV</button>
              <button class="ghost small" id="btnExportExcel"><i data-feather="grid" width="13"></i> Excel</button>
              <button class="ghost small" id="btnExportPDF"><i data-feather="file-text" width="13"></i> PDF</button>
              <button class="ghost small" id="btnPrint"><i data-feather="printer" width="13"></i> Print</button>
            </div>
          </div>

          <div id="multiActionBar" class="multi-action-bar hidden">
            <span><i data-feather="check-square" width="12"></i><span data-i18n="selected">Dipilih</span>: <strong id="multiSelectedCount">0</strong></span>
            <button class="outline small" id="btnSelectAllFiltered"><i data-feather="layers" width="11"></i><span data-i18n="select_all_filtered">Pilih Semua (Filter)</span></button>
            <button class="outline small" id="btnExportSelectedCSV"><i data-feather="download" width="11"></i> CSV</button>
            <button class="outline small" id="btnExportSelectedPDF"><i data-feather="file" width="11"></i> PDF</button>
            <button class="danger small" id="btnDeleteSelected"><i data-feather="trash-2" width="11"></i><span data-i18n="delete_selected">Hapus Terpilih</span></button>
            <button class="ghost small" id="btnClearSelection"><i data-feather="x-circle" width="11"></i><span data-i18n="clear_selection">Bersihkan</span></button>
          </div>

          <div class="form-grid" style="margin-bottom:.75rem;">
            <div>
              <label data-i18n="filter_fish">Jenis Ikan</label>
              <select id="filterFish"></select>
            </div>
            <div>
              <label data-i18n="filter_market">Pasar</label>
              <select id="filterMarket"></select>
            </div>
            <div>
              <label data-i18n="filter_date">Tanggal</label>
              <input type="date" id="filterDate" />
            </div>
            <div>
              <label data-i18n="filter_text">Cari (bau / warna)</label>
              <input id="filterText" placeholder="Kata kunci">
            </div>
          </div>
          <div class="table-wrapper">
            <table id="dataTable">
              <thead>
                <tr>
                  <th>
                    <div class="select-all-wrap">
                      <input type="checkbox" id="selectAllPage">
                      <span>Pilih</span>
                    </div>
                  </th>
                  <th data-i18n="th_no">No</th>
                  <th data-i18n="th_date">Tanggal</th>
                  <th data-i18n="th_fish">Jenis Ikan</th>
                  <th data-i18n="th_market">Pasar</th>
                  <th data-i18n="th_organoleptic">Organoleptik</th>
                  <th data-i18n="th_smell">Bau</th>
                  <th data-i18n="th_texture">Tekstur</th>
                  <th data-i18n="th_color">Warna</th>
                  <th data-i18n="th_hazard">Keamanan</th>
                  <th data-i18n="th_image">Gambar</th>
                  <th data-i18n="th_score_status">Status</th>
                  <th data-i18n="th_user">Pengguna</th>
                  <th data-i18n="th_actions">Aksi</th>
                </tr>
              </thead>
              <tbody id="dataTableBody"></tbody>
            </table>
          </div>
          <div id="dataEmptyState" class="empty-state hidden">
            <i data-feather="inbox" width="38"></i>
            <div data-i18n="empty_data">Belum ada data. Silakan input.</div>
          </div>

          <div class="table-footer">
            <div style="display:flex;align-items:center;gap:.65rem;flex-wrap:wrap;">
              <label style="display:flex;align-items:center;gap:.35rem;">
                <span data-i18n="per_page">Per halaman</span>
                <select id="perPageSelect">
                  <option value="10">10</option>
                  <option value="25" selected>25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </label>
              <div id="selectionInfo">0 dipilih</div>
            </div>
            <div class="pagination-controls">
              <button class="outline small" id="prevPage"><i data-feather="chevron-left" width="12"></i>Prev</button>
              <span id="pageInfo" style="font-weight:700;">Hal 1/1</span>
              <button class="outline small" id="nextPage">Next<i data-feather="chevron-right" width="12"></i></button>
            </div>
          </div>
        </div>
      </section>

      <!-- FORM INPUT -->
      <section id="view-form" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <button class="ghost small" id="btnOpenOrgTool">
              <i data-feather="sliders" width="13"></i> Tool Skor
            </button>
            <h3><i data-feather="edit-3" width="14"></i><span data-i18n="input_new_data">Input Data Mutu Baru</span></h3>
            <div style="display:flex;gap:.4rem;">
              <button class="ghost small" id="btnResetForm"><i data-feather="refresh-cw" width="13"></i> Reset</button>
            </div>
          </div>
          <form id="fishForm" autocomplete="off">
            <input type="hidden" id="recordId">
            <div class="form-grid">
              <div>
                <label data-i18n="fish_type">Jenis Ikan</label>
                <input list="fishTypeList" id="fishTypeInput" placeholder="Ketik atau pilih..." required>
                <datalist id="fishTypeList"></datalist>
              </div>
              <div>
                <label data-i18n="market_location">Lokasi Pasar</label>
                <input list="marketList" id="marketInput" placeholder="Ketik atau pilih..." required>
                <datalist id="marketList"></datalist>
              </div>
              <div>
                <label data-i18n="organoleptic_score">Skor Organoleptik (1-9)</label>
                <input type="number" id="organoleptic" min="1" max="9" required placeholder="1-9">
              </div>
              <div>
                <label data-i18n="smell">Bau</label>
                <input id="smell" required placeholder="Segar / agak amis">
              </div>
              <div>
                <label data-i18n="texture">Tekstur</label>
                <input id="texture" required placeholder="Kenyal / lembek">
              </div>
              <div>
                <label data-i18n="color">Warna</label>
                <input id="colorField" required placeholder="Cerah / pucat">
              </div>
              <div>
                <label data-i18n="date_auto">Tanggal (otomatis)</label>
                <input id="dateAuto" disabled>
              </div>
              <div id="studentFieldWrapper" class="hidden">
                <label data-i18n="student_id">NIM Mahasiswa</label>
                <input id="studentNIMForm" disabled placeholder="NIM Anda">
              </div>
              <div>
                <label data-i18n="food_safety">Keamanan Pangan (Opsional)</label>
                <div id="hazardChips" style="display:flex;flex-wrap:wrap;"></div>
                <textarea id="hazardNotes" placeholder="Catatan indikasi (misal: bau bahan kimia, tekstur aneh)..." style="margin-top:.4rem;height:68px;resize:vertical;"></textarea>
              </div>
              <div>
                <label>Foto Ikan (Opsional)</label>
                <input type="file" id="fishImage" accept="image/*">
                <div id="fishImagePreview" class="image-preview"></div>
              </div>
            </div>
            <div class="divider"></div>
            <div style="display:flex;gap:.65rem;flex-wrap:wrap;">
              <button type="submit" id="submitDataBtn">
                <i data-feather="save" width="14"></i>
                <span data-i18n="save_data">Simpan Data</span>
              </button>
              <button type="button" class="outline" id="cancelEditBtn" style="display:none;">
                <i data-feather="x-circle" width="14"></i>
                <span data-i18n="cancel_edit">Batal Edit</span>
              </button>
            </div>
            <div id="formAlert" style="margin-top:.65rem;"></div>
          </form>
          <div style="margin-top:.95rem;">
            <p class="xsmall muted">
              Tips: Ketik langsung Jenis Ikan / Pasar untuk menambahkan otomatis saat simpan (jika belum ada). Gunakan penilaian objektif keamanan (indikasi Boraks/Formalin hanya jika ada bukti uji cepat).
            </p>
          </div>
        </div>
      </section>

      <!-- REPORTS -->
      <section id="view-reports" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="file-text" width="14"></i><span data-i18n="reports_export">Laporan & Export</span></h3>
            <div style="display:flex;gap:.4rem;flex-wrap:wrap;">
              <button class="ghost small" id="repExportPDF"><i data-feather="file" width="13"></i> PDF</button>
              <button class="ghost small" id="repExportCSV"><i data-feather="download" width="13"></i> CSV</button>
              <button class="ghost small" id="repPrint"><i data-feather="printer" width="13"></i> Print</button>
            </div>
          </div>
          <p class="small" data-i18n="reports_desc">Pilih rentang data dan ekspor laporan yang berisi grafik dan tabel.</p>
          <div class="form-grid">
            <div>
              <label data-i18n="from_date">Dari Tanggal</label>
              <input type="date" id="reportFrom">
            </div>
            <div>
              <label data-i18n="to_date">Sampai Tanggal</label>
              <input type="date" id="reportTo">
            </div>
            <div>
              <label data-i18n="report_scope">Ruang Lingkup</label>
              <select id="reportScope">
                <option value="all">Semua Data</option>
                <option value="mine">Data Saya</option>
              </select>
            </div>
            <div>
              <label data-i18n="report_fish_type">Jenis Ikan (Opsional)</label>
              <select id="reportFish"></select>
            </div>
          </div>
          <div style="margin-top:.9rem;display:flex;gap:.55rem;flex-wrap:wrap;">
            <button id="btnGenerateReport">
              <i data-feather="file-text" width="14"></i>
              <span data-i18n="generate_report">Generate Laporan</span>
            </button>
            <button class="outline" id="btnClearReport">
              <i data-feather="trash-2" width="14"></i>
              <span data-i18n="clear_report">Bersihkan</span>
            </button>
          </div>
          <div class="divider" style="margin-top:1.1rem;"></div>
          <div id="reportResult" class="fade-in"></div>
        </div>
      </section>

<section id="view-haccp" class="hidden fade-in">
  <div class="panel">
    <div class="panel-header">
      <h3>
        <i data-feather="clipboard" width="14"></i>
        <span>HACCP / CCP Checklist</span>
      </h3>
      <div style="display:flex;gap:.45rem;flex-wrap:wrap;">
        <button class="ghost small" id="haccpRefreshBtn" title="Refresh">
          <i data-feather="refresh-cw" width="13"></i>
        </button>
        <button class="ghost small" id="haccpExportCsv">
          <i data-feather="download" width="13"></i> CSV
        </button>
      </div>
    </div>

    <p class="small" style="margin-top:-.35rem;">
      Modul ini mencatat monitoring titik kendali kritis (CCP). Tambah/master CCP lebih dulu jika belum ada.
    </p>

    <!-- MASTER CCP -->
    <div class="panel compact" style="margin-top:.9rem;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap;">
        <div style="font-size:.6rem;font-weight:700;letter-spacing:.55px;display:flex;align-items:center;gap:.4rem;">
          <i data-feather="settings" width="13"></i> Master CCP
        </div>
        <div style="display:flex;gap:.45rem;flex-wrap:wrap;">
          <button class="outline small" id="ccpAddBtn">
            <i data-feather="plus" width="12"></i> Tambah CCP
          </button>
        </div>
      </div>
      <div id="ccpMasterList" class="haccp-master-list"></div>
    </div>

    <!-- FORM CHECKLIST -->
    <div class="panel compact" style="margin-top:.9rem;">
      <div style="font-size:.6rem;font-weight:700;letter-spacing:.55px;display:flex;align-items:center;gap:.4rem;">
        <i data-feather="edit" width="13"></i> Form Monitoring
      </div>
      <form id="ccpCheckForm" style="margin-top:.55rem;">
        <div class="form-grid">
          <div>
            <label>CCP</label>
            <select id="ccpSelect" required></select>
          </div>
          <div>
            <label>Nilai Terukur</label>
            <input type="number" step="any" id="ccpObserved" required placeholder="0.0">
          </div>
          <div>
            <label>Tanggal</label>
            <input type="date" id="ccpDate">
          </div>
          <div>
            <label>Tindakan Koreksi (Jika OUT)</label>
            <input id="ccpAction" placeholder="Kosongkan jika OK">
          </div>
          <div style="grid-column:1/-1;">
            <label>Catatan (Opsional)</label>
            <textarea id="ccpNotes" style="height:60px;resize:vertical;"></textarea>
          </div>
        </div>
        <div style="display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.7rem;">
          <button type="submit" class="small">
            <i data-feather="save" width="13"></i> Simpan Monitoring
          </button>
          <button type="button" class="outline small" id="ccpFormReset">
            <i data-feather="refresh-cw" width="13"></i> Reset
          </button>
        </div>
        <div id="ccpFormAlert" style="margin-top:.55rem;"></div>
      </form>
    </div>

    <!-- FILTER LIST -->
    <div class="panel compact" style="margin-top:.9rem;">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.6rem;">
        <div style="font-size:.6rem;font-weight:700;letter-spacing:.55px;display:flex;align-items:center;gap:.4rem;">
          <i data-feather="list" width="13"></i> Riwayat Monitoring
        </div>
        <div class="form-inline" style="display:flex;gap:.45rem;flex-wrap:wrap;">
          <input type="date" id="ccpFilterDateFrom" style="max-width:140px;">
          <input type="date" id="ccpFilterDateTo" style="max-width:140px;">
          <select id="ccpFilterSelect" style="max-width:160px;"></select>
          <button class="outline small" id="ccpFilterApply">
            <i data-feather="filter" width="12"></i> Filter
          </button>
          <button class="outline small" id="ccpFilterClear">
            <i data-feather="x-circle" width="12"></i>
          </button>
        </div>
      </div>
      <div class="table-wrapper" style="margin-top:.6rem;">
        <table id="ccpHistoryTable">
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>CCP</th>
              <th>Param</th>
              <th>Nilai</th>
              <th>Limit</th>
              <th>Status</th>
              <th>Aksi Koreksi</th>
              <th>User</th>
              <th>#</th>
            </tr>
          </thead>
          <tbody id="ccpHistoryBody"></tbody>
        </table>
      </div>
      <div id="ccpHistoryEmpty" class="empty-state hidden">
        <i data-feather="inbox" width="32"></i>
        <div>Belum ada monitoring.</div>
      </div>
    </div>

  </div>
</section>

<!-- ============ VIEW: SENSORS (REAL-TIME TEMPERATURE) ============ -->
<section id="view-sensors" class="hidden fade-in">
  <div class="panel">
    <div class="panel-header">
      <h3>
        <i data-feather="thermometer" width="14"></i>
        <span>Data Sensor Suhu</span>
      </h3>
      <div style="display:flex;gap:.45rem;flex-wrap:wrap;">
        <button class="ghost small" id="sensorRefreshBtn" title="Refresh Manual">
          <i data-feather="refresh-cw" width="13"></i>
        </button>
        <button class="ghost small" id="sensorToggleLiveBtn" title="Matikan/Hidupkan Live">
          <i data-feather="activity" width="13"></i>
        </button>
      </div>
    </div>

    <p class="small" style="margin-top:-.4rem;">
      Menampilkan pembacaan suhu terakhir dari database lokal <code>aplikasi ini</code>. 
      Perangkat (ESP32/dll) mengirim data secara periodik. Gunakan grafik untuk memantau tren.
    </p>

    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1rem;margin-top:.6rem;">
    	<!-- === DASHBOARD SENSOR AVERAGE TILE (IMPROVED) === -->
<div class="indicator temp-indicator" id="sensorIndicatorTile">
  <div class="temp-head">
    <h4><i data-feather="thermometer" width="12"></i><span>Suhu Rata-rata Ikan</span></h4>
    <span class="temp-status-badge" id="indTempStatus">-</span>
  </div>
  <div class="temp-main">
    <div class="val" id="indTempAvg">-</div>
    <div class="trend" id="indTempTrend">--</div>
  </div>
  <div class="temp-range-wrap">
    <div class="temp-range-bar">
      <div class="temp-range-fill" id="indTempRangeFill"></div>
      <div class="temp-range-marker low"  title="0Â°C">0</div>
      <div class="temp-range-marker mid"  title="4Â°C">4</div>
      <div class="temp-range-marker high" title="8Â°C">8</div>
      <div class="temp-range-marker max"  title="12Â°C">12</div>
    </div>
  </div>
  <div class="temp-mini-note" id="indTempNote">Rentang target ideal 2â€“4Â°C</div>
</div>
      <div class="panel compact" style="min-height:160px;">
        <div style="font-size:.6rem;font-weight:700;letter-spacing:.5px;display:flex;align-items:center;gap:.4rem;">
          <i data-feather="list" width="13"></i> Log Terbaru (50)
        </div>
        <div id="sensorList" style="margin-top:.55rem;display:flex;flex-direction:column;gap:.4rem;max-height:300px;overflow:auto;padding-right:.35rem;font-size:.55rem;"></div>
        <div id="sensorEmpty" class="small muted" style="margin-top:.6rem;display:none;">Belum ada data sensor.</div>
      </div>
      <div class="panel compact" style="min-height:160px;">
        <div style="font-size:.6rem;font-weight:700;letter-spacing:.5px;display:flex;align-items:center;gap:.4rem;">
          <i data-feather="bar-chart-2" width="13"></i> Grafik Suhu (Jam Terakhir)
        </div>
        <div class="chart-container" style="height:230px;margin-top:.6rem;">
          <canvas id="sensorChart"></canvas>
        </div>
        <div id="sensorStats" class="small muted" style="margin-top:.55rem;"></div>
      </div>
    </div>

    <div class="divider"></div>


    <div class="panel compact">
      <div style="font-size:.6rem;font-weight:700;letter-spacing:.5px;display:flex;align-items:center;gap:.4rem;">
        <i data-feather="settings" width="13"></i> Simulasi / Tambah Manual
      </div>
      <form id="sensorManualForm" style="margin-top:.55rem;display:flex;flex-wrap:wrap;gap:.65rem;align-items:flex-end;">
        <div style="flex:1;min-width:140px;">
          <label>Suhu (Â°C)</label>
          <input type="number" step="0.1" id="sensorManualValue" placeholder="25.3" required>
        </div>
        <div style="flex:1;min-width:140px;">
          <label>Source / ID</label>
          <input id="sensorManualSource" placeholder="ESP32-A1">
        </div>
        <div style="flex:1;min-width:160px;">
          <label>Catatan</label>
          <input id="sensorManualNote" placeholder="chiller depan">
        </div>
        <button class="small" type="submit">
          <i data-feather="plus" width="12"></i> Simpan
        </button>
      </form>
      <div id="sensorManualAlert" style="margin-top:.55rem;"></div>
    </div>

    <div class="divider"></div>
    <p class="xsmall muted">
      Catatan: Integrasi real sensor lakukan pengiriman via script/perangkat ke Firestore. 
      Panel ini hanya membaca koleksi <code>sensorTemperatures</code> realâ€‘time.
    </p>
  </div>
</section>

      <!-- MATERIALS -->
      <section id="view-materials" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="book-open" width="14"></i><span data-i18n="materials_page_title">Materi & Edukasi Mutu Ikan</span></h3>
          </div>
          <p class="small" data-i18n="materials_intro">
            Kumpulan materi ringkas mengenai parameter mutu organoleptik, keamanan pangan, penanganan ikan segar, dan tips praktis lapangan.
          </p>
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1rem;">
            <div class="material-category">
              <h4><i data-feather="eye" width="14"></i><span data-i18n="mat_eye_title">Penilaian Mata</span></h4>
              <ul class="material-points" data-i18n="mat_eye_points">
                <li>Mata cembung dan kornea jernih menandakan kesegaran tinggi.</li>
                <li>Kornea keruh dan cekung: ikan menurun mutu.</li>
                <li>Cekung parah & buram: tidak layak konsumsi.</li>
              </ul>
            </div>
            <div class="material-category">
              <h4><i data-feather="droplet" width="14"></i><span data-i18n="mat_gill_title">Penilaian Insang</span></h4>
              <ul class="material-points" data-i18n="mat_gill_points">
                <li>Insang merah cerah & berlendir bening: segar.</li>
                <li>Insang pucat kecoklatan: kesegaran menurun.</li>
                <li>Insang coklat abu & lendir tebal berbau: mendekati busuk.</li>
              </ul>
            </div>
            <div class="material-category">
              <h4><i data-feather="wind" width="14"></i><span data-i18n="mat_odour_title">Bau / Aroma</span></h4>
              <ul class="material-points" data-i18n="mat_odour_points">
                <li>Bau laut segar / amis alami ringan = baik.</li>
                <li>Bau amis tajam / sedikit asam = waspada.</li>
                <li>Bau asam menyengat / busuk = tidak layak.</li>
              </ul>
            </div>
            <div class="material-category">
              <h4><i data-feather="layers" width="14"></i><span data-i18n="mat_texture_title">Tekstur & Daging</span></h4>
              <ul class="material-points" data-i18n="mat_texture_points">
                <li>Fleksibel & kembali cepat bila ditekan.</li>
                <li>Lunak & bekas tekan lama hilang = mutu turun.</li>
                <li>Sangat lembek / hancur = rusak.</li>
              </ul>
            </div>
            <div class="material-category">
              <h4><i data-feather="feather" width="14"></i><span data-i18n="mat_skin_title">Kulit & Warna</span></h4>
              <ul class="material-points" data-i18n="mat_skin_points">
                <li>Mengkilap cerah dengan lendir jernih tipis.</li>
                <li>Kusam & lendir keruh menebal = degradasi.</li>
                <li>Lendir tebal kental / kering = tidak segar.</li>
              </ul>
            </div>
            <div class="material-category">
              <h4><i data-feather="shield" width="14"></i><span data-i18n="mat_safety_title">Indikasi Keamanan</span></h4>
              <ul class="material-points" data-i18n="mat_safety_points">
                <li>Insang terlalu pucat tanpa bau amis â†’ indikasi formalin.</li>
                <li>Tekstur terlalu kenyal elastis â†’ indikasi boraks.</li>
                <li>Warna daging mencolok / tidak alami â†’ pewarna berbahaya.</li>
                <li>Bau bahan kimia tajam (bukan amis) â†’ potensi bahan tambahan.</li>
              </ul>
            </div>
          </div>
          <div class="divider"></div>
          <p class="small" data-i18n="materials_note">
            Catatan: Materi disederhanakan sebagai bantuan awal. Rujuk dokumen SNI dan peraturan resmi untuk standar lengkap.
          </p>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="view-settings" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="settings" width="14"></i><span data-i18n="settings_pref">Pengaturan & Preferensi</span></h3>
          </div>
          <div class="preference-grid">
            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="appearance">Tampilan</h4>
              <div style="display:flex;flex-direction:column;gap:.7rem;">
                <div>
                  <label data-i18n="theme_mode">Mode Tema</label>
                  <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
                    <button class="outline small" id="prefLight"><i data-feather="sun" width="13"></i>Light</button>
                    <button class="outline small" id="prefDark"><i data-feather="moon" width="13"></i>Dark</button>
                  </div>
                </div>
                <div>
                  <label data-i18n="accent_color">Warna Aksen</label>
                  <div class="color-palette" id="accentPalette"></div>
                </div>
                <div style="margin-top:.45rem;font-size:.55rem;display:flex;align-items:center;gap:.5rem;">
  <input type="color" id="customAccentPicker" value="#2f6dff" style="width:42px;height:34px;border:1px solid hsl(var(--panel-border)/0.6);border-radius:10px;cursor:pointer;padding:0;">
  <button class="outline small" id="applyCustomAccent">
    <i data-feather="droplet" width="12"></i>Pakai Custom
  </button>
</div>
                <div>
                  <label data-i18n="layout_style">Gaya Layout</label>
                  <select id="layoutStyle">
                    <option value="grid">Grid (Default)</option>
                    <option value="list">List / Kompak</option>
                  </select>
                </div>
                <div>
                  <label data-i18n="font_size">Ukuran Font</label>
                  <select id="fontSizeSelect">
                    <option value="small">Kecil</option>
                    <option value="medium" selected>Normal</option>
                    <option value="large">Besar</option>
                  </select>
                </div>
                <div>
                  <label data-i18n="font_family">Jenis Font</label>
                  <select id="fontFamilySelect">
                    <option value="Quicksand">Quicksand</option>
                    <option value="Poppins">Poppins</option>
                    <option value="Inter">Inter</option>
                    <option value="Nunito">Nunito</option>
                    <option value="Roboto">Roboto</option>
                  </select>
                </div>
                <div>
  <label>Mode Kinerja (Performance Mode)</label>
  <select id="performanceMode">
    <option value="ultra">Ultra (Penuh)</option>
    <option value="default">Default (Ringan)</option>
    <option value="lite">Lite (Sangat Ringan)</option>
  </select>
  <small class="small" style="display:block;margin-top:.35rem;">
    Ultra: semua efek â€¢ Default: efek moderat â€¢ Lite: tanpa blur & animasi.
  </small>
</div>
                <div>
                  <label data-i18n="language">Bahasa</label>
                  <select id="languageSelect">
                    <option value="id">Indonesia</option>
                    <option value="en">English</option>
                  </select>
                </div>
                <div>
                  <label data-i18n="reduce_motion">Kurangi Animasi</label>
                  <button class="outline small" id="toggleMotion"><i data-feather="activity" width="13"></i><span id="motionLabel">Aktifkan</span></button>
                </div>
                <div>
                  <label data-i18n="high_contrast">High Contrast</label>
                  <button class="outline small" id="toggleContrast"><i data-feather="alert-octagon" width="13"></i><span id="contrastLabel">Aktifkan</span></button>
                </div>
                <div>
                  <label data-i18n="auto_refresh">Auto Refresh Dashboard</label>
                  <select id="autoRefreshSelect">
                    <option value="0" selected>Tidak</option>
                    <option value="30">30s</option>
                    <option value="60">60s</option>
                    <option value="120">120s</option>
                  </select>
                </div>
                <div>
                  <label data-i18n="last_login">Login Terakhir</label>
                  <input id="lastLoginField" disabled>
                </div>
                <div>
                  <label data-i18n="created_at">Dibuat</label>
                  <input id="createdAtField" disabled>
                </div>
              </div>
            </div>

            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="account_info">Info Akun</h4>
              <div id="settingsUserInfo" style="font-size:.64rem;line-height:1.55;"></div>
              <div style="margin-top:.6rem;display:flex;flex-wrap:wrap;gap:.45rem;">
                <button class="ghost small" id="btnResendVerification"><i data-feather="mail" width="13"></i><span data-i18n="resend_verif">Kirim Ulang Verifikasi</span></button>
                <button class="ghost small" id="btnRefreshUser"><i data-feather="refresh-cw" width="13"></i><span data-i18n="refresh">Refresh</span></button>
              </div>
              <div id="verifyAlert" style="margin-top:.55rem;"></div>
            </div>

            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="role_mgmt">Manajemen Peran</h4>
              <p class="small" data-i18n="role_mgmt_desc">Hanya admin dapat mengubah peran pengguna lain. (Client-side demonstrasi)</p>
              <div id="roleMgmt" class="small" style="display:flex;flex-direction:column;gap:.5rem;"></div>
              <div id="adminUserDelete" class="small" style="margin-top:.6rem;"></div>
            </div>

            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="default_input_pref">Preferensi Default Input</h4>
              <div class="small muted" style="margin-bottom:.45rem;" data-i18n="default_input_desc">Atur nilai bawaan untuk Form Input.</div>
              <div style="display:grid;gap:.65rem;">
                <div>
                  <label data-i18n="default_fish_type">Default Jenis Ikan</label>
                  <select id="prefDefaultFish"></select>
                </div>
                <div>
                  <label data-i18n="default_market">Default Pasar</label>
                  <select id="prefDefaultMarket"></select>
                </div>
                <button class="outline small" id="btnSavePreferences"><i data-feather="save" width="13"></i> <span data-i18n="save_pref">Simpan Preferensi</span></button>
                <div id="prefAlert"></div>
              </div>
            </div>

            <div class="panel compact admin-notif-panel">
              <h4 class="section-subtitle" data-i18n="notifications_admin">Kelola Notifikasi</h4>
              <p class="small" data-i18n="notifications_admin_desc">Admin dapat mengirim notifikasi broadcast ke semua atau berdasarkan role.</p>
              <div style="display:grid;gap:.55rem;">
                <select id="notifTargetRole">
                  <option value="ALL">Semua</option>
                  <option value="Mahasiswa">Mahasiswa</option>
                  <option value="Dosen">Dosen</option>
                  <option value="Petugas Pasar">Petugas Pasar</option>
                  <option value="Lainnya">Lainnya</option>
                </select>
                <input id="notifTitleInput" placeholder="Judul notifikasi">
                <textarea id="notifMessageInput" placeholder="Pesan..." style="min-height:70px;resize:vertical;"></textarea>
                <button class="outline small" id="btnSendBroadcast"><i data-feather="send" width="12"></i> <span data-i18n="send_broadcast">Kirim Broadcast</span></button>
                <div id="notifAdminAlert" style="font-size:.55rem;"></div>
              </div>
            </div>

            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="danger_zone">Zona Berbahaya</h4>
              <p class="small" data-i18n="delete_account_warn">Penghapusan akun akan menghapus data profil (tidak menghapus histori data). (Demo)</p>
              <button class="danger small" id="btnDeleteAccount"><i data-feather="user-x" width="13"></i><span data-i18n="delete_account">Hapus Akun</span></button>
              <div id="deleteAccountAlert" style="margin-top:.55rem;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="view-profile" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="user" width="14"></i><span data-i18n="profile_manage">Profil Pengguna</span></h3>
            <div style="display:flex;gap:.4rem;">
              <button class="ghost small" id="btnRefreshProfile" title="Refresh Profil"><i data-feather="refresh-cw" width="13"></i></button>
            </div>
          </div>
          <div style="display:flex;gap:1.6rem;flex-wrap:wrap;">
            <div style="flex:0 0 190px;display:flex;flex-direction:column;align-items:center;gap:.85rem;">
              <div class="avatar" style="width:125px;height:125px;border-radius:38px;font-size:2.1rem;" id="profileAvatar">
                <span id="profileAvatarInitial">U</span>
                <img id="profileAvatarImg" alt="avatar" class="hidden">
              </div>
              <input type="file" id="profilePhotoInput" accept="image/*" style="display:none;">
              <button class="outline small" id="btnChangePhoto" style="width:100%;justify-content:center;">
                <i data-feather="image" width="13"></i><span data-i18n="change_photo">Ganti Foto</span>
              </button>
              <button class="outline small" id="btnRemovePhoto" style="width:100%;justify-content:center;">
                <i data-feather="trash" width="13"></i><span data-i18n="remove_photo">Hapus Foto</span>
              </button>
              <button class="ghost small" id="btnSendPasswordReset">
                <i data-feather="lock" width="13"></i> Reset Password
              </button>
            </div>
            <div style="flex:1;min-width:280px;">
              <form id="profileForm">
                <div class="form-grid">
                  <div>
                    <label data-i18n="full_name">Nama Lengkap</label>
                    <input id="profName" required>
                  </div>
                  <div>
                    <label>Email</label>
                    <input id="profEmail" disabled>
                  </div>
                  <div>
                    <label data-i18n="role">Peran</label>
                    <select id="profRole" disabled>
                      <option>Admin</option>
                      <option>Mahasiswa</option>
                      <option>Dosen</option>
                      <option>Petugas Pasar</option>
                      <option>Lainnya</option>
                    </select>
                  </div>
                  <div>
                    <label data-i18n="email_verified">Email Terverifikasi</label>
                    <input id="profVerified" disabled>
                  </div>
                  <div id="profFieldStudent" class="hidden">
                    <label data-i18n="student_id">NIM Mahasiswa</label>
                    <input id="profStudentId" placeholder="NIM">
                  </div>
                  <div id="profFieldLecturer" class="hidden">
                    <label data-i18n="lecturer_id">NIP Dosen</label>
                    <input id="profLecturerId" placeholder="NIP">
                  </div>
                  <div id="profFieldOfficer" class="hidden">
                    <label data-i18n="officer_id">ID Petugas</label>
                    <input id="profOfficerId" placeholder="ID Petugas">
                  </div>
                  <div id="profFieldOther" class="hidden">
                    <label data-i18n="occupation">Pekerjaan</label>
                    <input id="profOccupationId" placeholder="Pekerjaan">
                  </div>
                </div>
                <div class="divider"></div>
                <div class="form-grid" style="margin-top:-.25rem;">
                  <div>
                    <label data-i18n="change_email_new">Ganti Email Baru</label>
                    <input id="changeEmailField" placeholder="email baru">
                  </div>
                  <div style="display:flex;align-items:flex-end;gap:.5rem;">
                    <button type="button" class="outline small" id="btnChangeEmail" style="margin-top:.95rem;">
                      <i data-feather="mail" width="12"></i> <span data-i18n="change_email_btn">Ganti Email</span>
                    </button>
                  </div>
                  <div>
                    <label data-i18n="new_password">Password Baru</label>
                    <input id="changePasswordField" type="password" placeholder="password baru">
                  </div>
                  <div>
                    <label data-i18n="confirm_password_short">Konfirmasi Password</label>
                    <input id="changePasswordConfirm" type="password" placeholder="ulangi password">
                  </div>
                  <div style="display:flex;align-items:flex-end;">
                    <button type="button" class="outline small" id="btnChangePassword" style="margin-top:.95rem;">
                      <i data-feather="lock" width="12"></i> <span data-i18n="change_password_btn">Ganti Password</span>
                    </button>
                  </div>
                </div>
                <div class="divider"></div>
                <div style="display:flex;gap:.65rem;flex-wrap:wrap;">
                  <button type="submit" class="small">
                    <i data-feather="save" width="13"></i>
                    <span data-i18n="update_profile">Update Profil</span>
                  </button>
                  <button type="button" class="outline small" id="btnSendVerifyProfile">
                    <i data-feather="mail" width="13"></i>
                    <span data-i18n="send_verification">Kirim Verifikasi</span>
                  </button>
                </div>
                <div id="profileAlert" style="margin-top:.6rem;"></div>
              </form>
              <div class="divider"></div>
              <div id="profileStats" class="fade-scale" style="display:flex;flex-direction:column;gap:.6rem;">
                <div style="font-size:.58rem;font-weight:800;letter-spacing:.55px;text-transform:uppercase;color:hsl(var(--text-dim));" data-i18n="contribution_stats">Statistik Kontribusi</div>
                <div style="display:flex;flex-wrap:wrap;gap:.5rem;" id="profileStatsBadges"></div>
                <button class="outline small" id="btnRefreshStats"><i data-feather="bar-chart-2" width="13"></i> <span data-i18n="refresh_stats">Perbarui Statistik</span></button>
              </div>
              
              <!-- Achievements / Pencapaian -->
<div id="profileAchievements" class="fade-scale" style="margin-top:.9rem;display:flex;flex-direction:column;gap:.55rem;">
  <div style="font-size:.58rem;font-weight:800;letter-spacing:.55px;text-transform:uppercase;color:hsl(var(--text-dim));">
    Pencapaian (Achievements)
  </div>
  <div id="profileAchievementsStats" class="small muted"></div>
  <div id="profileAchievementsList" style="display:flex;flex-wrap:wrap;gap:.45rem;"></div>
</div>

            </div>
          </div>
        </div>
      </section>

      <!-- SAFETY -->
      <section id="view-safety" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="shield" width="14"></i><span data-i18n="safety_section">Keamanan Pangan</span></h3>
          </div>
          <p class="small" data-i18n="safety_intro">
            Bagian ini menjelaskan indikator keamanan ikan segar di pasar tradisional. Indikasi bahan berbahaya seperti Boraks, Formalin,
            Pewarna Tekstil (Rhodamin B), atau Pengawet berlebih harus dicatat jika ada bukti visual / uji cepat.
          </p>
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;">
            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="general_indicators">Indikator Umum</h4>
              <ul style="margin:0;padding-left:1.05rem;font-size:.58rem;line-height:1.5;" data-i18n="general_indicator_points">
                <li>Daging ikan terlalu kenyal / elastis tidak wajar â†’ indikasi Boraks.</li>
                <li>Warna insang pucat keabu-abuan tanpa bau amis alami â†’ indikasi Formalin.</li>
                <li>Warna daging sangat mencolok (merah muda cerah / kuning terang) â†’ pewarna tekstil.</li>
                <li>Bau menyengat kimia (bukan bau laut/amis ringan)</li>
                <li>Mata ikan keruh & cekung + lendir berlebih â†’ mutu turun.</li>
              </ul>
            </div>
            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="recommendations">Rekomendasi</h4>
              <ul style="margin:0;padding-left:1.05rem;font-size:.58rem;line-height:1.5;" data-i18n="recommendation_points">
                <li>Lakukan uji cepat formalin/boraks bila tersedia.</li>
                <li>Catat hanya "indikasi" jika tanpa uji laboratorium.</li>
                <li>Gunakan kolom catatan untuk deskripsi temuan.</li>
                <li>Laporkan ke otoritas bila indikasi kuat berulang.</li>
              </ul>
            </div>
            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="safety_statuses">Status Keamanan</h4>
              <div style="display:flex;flex-direction:column;gap:.4rem;font-size:.58rem;">
                <div><span class="hazard-badge safe"><i data-feather="shield" width="11"></i><span data-i18n="safe">Aman</span></span> <span data-i18n="safe_desc">Tidak ada indikasi bahan berbahaya.</span></div>
                <div><span class="hazard-badge"><i data-feather="alert-triangle" width="11"></i><span data-i18n="attention">Perhatian</span></span> <span data-i18n="attention_desc">Ada indikasi awal, perlu verifikasi.</span></div>
              </div>
            </div>
          </div>
          <div class="divider"></div>
            <div class="small muted" data-i18n="disclaimer">
            Disclaimer: Data keamanan pada aplikasi ini bersifat indikatif (observasi lapangan) dan bukan hasil uji laboratorium resmi.
          </div>
        </div>
      </section>

      <!-- SOSIAL -->
      <section id="view-sosial" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="users" width="14"></i><span data-i18n="social_feed_title">Sosial & Aktivitas Pengguna</span></h3>
          </div>
          <p class="small" data-i18n="social_intro">
            Bagian ini menampilkan daftar pengguna, posting singkat, reaksi, dan komentar. Klik avatar/nama untuk melihat profil.
          </p>
          <div class="social-container">
            <div style="display:flex;flex-direction:column;gap:1rem;">
              <div class="social-form" id="socialFormWrapper">
                <div style="font-size:.6rem;font-weight:700;letter-spacing:.55px;display:flex;align-items:center;gap:.45rem;">
                  <i data-feather="edit-3" width="14"></i>
                  <span data-i18n="create_post">Buat Post</span>
                </div>
                <textarea id="socialPostContent" maxlength="800" placeholder="Tulis sesuatu..."></textarea>
                <div style="display:flex;gap:.55rem;flex-wrap:wrap;">
                  <input type="file" id="socialPostImage" accept="image/*" style="font-size:.55rem;">
                  <div id="socialImagePreview" style="font-size:.5rem;color:hsl(var(--text-dim));"></div>
                </div>
                <div class="actions">
                  <button id="btnSubmitPost" class="small">
                    <i data-feather="send" width="13"></i>
                    <span data-i18n="post_now">Kirim</span>
                  </button>
                  <button type="button" id="btnClearPost" class="outline small">
                    <i data-feather="x-circle" width="13"></i>
                    <span data-i18n="clear">Bersih</span>
                  </button>
                </div>
                <div id="socialPostAlert"></div>
              </div>
              <div style="font-size:.58rem;font-weight:800;letter-spacing:.55px;text-transform:uppercase;color:hsl(var(--text-dim));display:flex;align-items:center;gap:.4rem;">
                <i data-feather="message-circle" width="14"></i><span data-i18n="recent_posts">Posting Terbaru</span>
              </div>
              <div class="social-feed" id="socialFeed"></div>
              <div id="socialEmpty" class="small muted hidden" style="text-align:center;padding:1.2rem .6rem;">
                <i data-feather="inbox" width="22"></i> <span data-i18n="no_posts">Belum ada posting.</span>
              </div>
            </div>
            <div class="social-users" id="socialUsers">
              <div style="display:flex;align-items:center;gap:.45rem;font-weight:700;font-size:.6rem;letter-spacing:.55px;">
                <i data-feather="user" width="14"></i>
                <span data-i18n="users_list">Daftar Pengguna</span>
              </div>
              <div id="socialUsersList" style="display:flex;flex-direction:column;gap:.55rem;"></div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-organoleptic-tool" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3>
              <i data-feather="sliders" width="14"></i>
              <span>Tool Perhitungan Organoleptik</span>
            </h3>
            <div style="display:flex;gap:.4rem;flex-wrap:wrap;">
              <select id="orgStandardSelect" style="max-width:160px;">
                <option value="sni2013">SNI 2013</option>
                <option value="sni2021">SNI 2021</option>
              </select>
              <button class="ghost small" id="btnResetOrgTool">
                <i data-feather="refresh-cw" width="13"></i> Reset
              </button>
              <button class="ghost small" id="btnBackToForm">
                <i data-feather="corner-up-left" width="13"></i> Kembali Form
              </button>
            </div>
          </div>

          <p class="small" style="margin-top:-.35rem;">
            Pilih standar (SNI 2013 / SNI 2021), kemudian pilih deskripsi kondisi tiap parameter. Skor total dihitung otomatis (rata-rata / atau ambil skor terendahâ€”dapat diubah sesuai kebijakan).
            Klik "Terapkan ke Form Input" untuk mengisi otomatis field Organoleptik (skor) dan beberapa deskripsi (Bau, Tekstur, Warna) berdasarkan pilihan.
          </p>

          <div class="divider"></div>

          <div id="orgCriteriaContainer" class="org-criteria-grid"></div>

          <div class="divider"></div>

          <div class="org-result-box">
            <div style="display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;">
              <div>
                <div class="meta">Metode Agregasi</div>
                <select id="orgAggregateMethod" style="min-width:160px;">
                  <option value="average">Rata-rata (Mean)</option>
                  <option value="min">Skor Terendah (Conservative)</option>
                  <option value="median">Median</option>
                </select>
              </div>
              <div>
                <div class="meta">Skor Akhir</div>
                <div id="orgFinalScore" class="inline-stat">-</div>
              </div>
              <div>
                <div class="meta">Status</div>
                <div id="orgFinalStatus" class="inline-stat">-</div>
              </div>
            </div>
            <div style="margin-top:.65rem;display:flex;gap:.55rem;flex-wrap:wrap;">
              <button id="btnApplyOrgScore">
                <i data-feather="check" width="14"></i> Terapkan ke Form Input
              </button>
              <button class="outline" id="btnCopyOrgSummary">
                <i data-feather="clipboard" width="14"></i> Salin Ringkasan
              </button>
            </div>
            <div id="orgSummary" class="small muted" style="margin-top:.55rem;white-space:pre-wrap;"></div>
            <div class="small" style="margin-top:.75rem;">
              <strong>Catatan:</strong> Deskripsi standar disederhanakan untuk contoh. Silakan sesuaikan dengan dokumen resmi SNI.
            </div>
          </div>
        </div>
      </section>

<section id="view-micro-learning" class="hidden fade-in">
  <div class="panel">
    <div class="panel-header">
      <h3>
        <i data-feather="book" width="14"></i>
        <span>Micro-Learning Mutu Ikan</span>
      </h3>
      <div style="display:flex;gap:.45rem;flex-wrap:wrap;">
        <button class="ghost small" id="mlResetProgress">
          <i data-feather="rotate-ccw" width="13"></i> Reset
        </button>
      </div>
    </div>

    <p class="small" style="margin-top:-.35rem;">
      Modul mini (1â€“2 menit) + kuis cepat. Selesaikan semua & lulus kuis untuk membuka lencana
      <strong>"Quality Steward"</strong>.
    </p>

    <div class="micro-layout">
      <div class="micro-left">
        <div class="micro-module-list" id="mlModuleList"></div>
      </div>
      <div class="micro-right">
        <div id="mlStageIdle" class="micro-idle">
          <div style="font-size:.75rem;font-weight:700;letter-spacing:.6px;margin-bottom:.5rem;">
            Pilih Modul
          </div>
          <p class="small">
            Klik salah satu modul di sebelah kiri untuk mulai membaca slide, lalu kerjakan kuis.
          </p>
        </div>
        <div id="mlStageSlides" class="hidden">
          <div class="micro-slide-header">
            <div class="micro-slide-title" id="mlSlideTitle">Judul Slide</div>
            <div class="micro-slide-progress">
              <span id="mlSlideCounter">0/0</span>
              <div class="micro-progress-bar"><div id="mlSlideBar"></div></div>
            </div>
          </div>
          <div class="micro-slide-body" id="mlSlideBody"></div>
          <div class="micro-slide-nav">
            <button class="outline small" id="mlPrevSlide"><i data-feather="chevron-left" width="12"></i>Prev</button>
            <div style="flex:1;"></div>
            <button class="outline small" id="mlExitModule"><i data-feather="x" width="12"></i>Tutup</button>
            <button class="small" id="mlNextSlide">Next<i data-feather="chevron-right" width="12"></i></button>
          </div>
        </div>
        <div id="mlStageQuiz" class="hidden">
          <div class="micro-quiz-header">
            <div style="font-weight:700;font-size:.65rem;letter-spacing:.5px;">
              Kuis Modul <span id="mlQuizModuleTitle"></span>
            </div>
            <div class="micro-quiz-status" id="mlQuizStatus"></div>
          </div>
          <div id="mlQuizQuestions" class="micro-quiz-list"></div>
          <div class="micro-quiz-actions">
            <button class="outline small" id="mlBackToSlides">
              <i data-feather="arrow-left" width="12"></i> Slides
            </button>
            <div style="flex:1;"></div>
            <button class="small" id="mlSubmitQuiz">
              <i data-feather="check-circle" width="12"></i> Submit Kuis
            </button>
          </div>
          <div id="mlQuizResult" class="micro-quiz-result"></div>
        </div>
      </div>
    </div>
  </div>
</section>

      <!-- ABOUT -->
      <section id="view-about" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="info" width="14"></i><span>Tentang Aplikasi</span></h3>
          </div>
          <p class="small">
            Aplikasi single-file ini dikembangkan untuk skripsi:
            <strong>"Pengembangan Sistem Informasi Berbasis Website untuk Pencatatan dan Monitoring Mutu Ikan Segar di Pasar Tradisional Kota Makassar"</strong>.
          </p>
          <p class="small">
            Fitur: Auth Firebase, Role-based Access, CRUD Data Mutu, Dashboard, Export, Chart.js, i18n, Dark/Light Mode, Glassmorphism,
            Preferensi Default, Input Dinamis, Upload Gambar, Statistik, Toast, Aksen & Font, Keamanan Pangan, Detail Modal,
            Feed Sosial + Reaksi + Komentar + Modal Profil, Pagination & Seleksi Tabel, FAB Input Cepat, Tool Organoleptik.
          </p>
          <p class="small">
            Catatan Keamanan: Gunakan Firestore Security Rules untuk enforcement role di server. Kode ini contoh client-side.
          </p>
          <details style="margin-top:1rem;">
            <summary style="cursor:pointer;font-size:.6rem;font-weight:800;letter-spacing:.5px;">Contoh Firestore Security Rules (Konseptual)</summary>
<pre class="small" style="white-space:pre-wrap;background:hsl(var(--accent)/0.18);padding:.7rem .85rem;border-radius:14px;line-height:1.35;">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function userRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    match /users/{uid} {
      allow read: if isSignedIn();
      allow create: if request.auth.uid == uid;
      allow update: if request.auth.uid == uid || userRole() == 'Admin';
      allow delete: if userRole() == 'Admin';
    }
    match /fishQuality/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        userRole() in ['Admin','Petugas Pasar'] ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isSignedIn() && (
        userRole() == 'Admin' ||
        (userRole() == 'Petugas Pasar' && resource.data.userId == request.auth.uid)
      );
    }
    match /socialPosts/{p} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update,delete: if isSignedIn() && (
        request.auth.uid == resource.data.userId || userRole() == 'Admin'
      );
    }
    match /socialPosts/{p}/comments/{c} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow delete: if isSignedIn() && (
        request.auth.uid == resource.data.userId || userRole() == 'Admin'
      );
    }
  }
}
</pre>
          </details>
        </div>
      </section>

<!-- VIEW: AI ASSISTANT -->
<section id="view-ai-assistant" class="hidden fade-in">
  <div class="panel">
    <div class="panel-header">
      <h3>
        <i data-feather="message-circle" width="14"></i>
        <span>AI Asisten Perikanan</span>
      </h3>
      <div style="display:flex;gap:.45rem;flex-wrap:wrap;">
        <button class="ghost small" id="aiTestBtn" title="Tes Koneksi">
          <i data-feather="activity" width="13"></i>
        </button>
        <button class="ghost small" id="aiClearHistoryBtn" title="Bersihkan Riwayat">
          <i data-feather="trash-2" width="13"></i>
        </button>
      </div>
    </div>
    <p class="small">
      Gunakan AI untuk membantu tanya jawab mutu ikan segar, organoleptik, keamanan (formalin/boraks), penyimpanan dan praktik higienis.
      Masukkan API Key Groq untuk stabilitas. Tanpa key tidak bisa jalan.
    </p>
    <div class="form-grid" style="margin-top:.6rem;">
      <div>
        <label>API Key Groq</label>
        <input id="aiApiKey" placeholder="gsk_xxxxx..." autocomplete="off">
      </div>
      <div>
        <label>Model</label>
        <select id="aiModelSelect">
          <option value="llama-3.1-8b-instant">llama-3.1-8b-instant</option>
          <option value="llama-3.2-3b-preview">llama-3.2-3b-preview</option>
          <option value="mixtral-8x7b-32768">mixtral-8x7b-32768</option>
        </select>
      </div>
      <div>
        <label>Mode Jawaban</label>
        <select id="aiAnswerMode">
          <option value="short">Singkat</option>
          <option value="detail">Detail</option>
        </select>
      </div>
      <div>
        <label>Prefiks Konteks</label>
        <input id="aiContextPrefix" value="Anda adalah asisten ahli mutu ikan segar dan keamanan pangan.">
      </div>
    </div>
    <div style="margin-top:.7rem;display:flex;gap:.55rem;flex-wrap:wrap;">
      <button class="outline small" id="aiSaveSettings">
        <i data-feather="save" width="13"></i>Simpan
      </button>
      <button class="outline small" id="aiLoadDefaults">
        <i data-feather="refresh-cw" width="13"></i>Reset
      </button>
      <button class="outline small" id="aiOpenChatFromPanel">
        <i data-feather="message-circle" width="13"></i>Buka Chat
      </button>
    </div>
    <div class="divider"></div>
    <div>
      <div style="font-size:.6rem;font-weight:700;letter-spacing:.55px;margin-bottom:.35rem;">Contoh Cepat</div>
      <div class="ai-quick-grid" id="aiQuickExamples"></div>
    </div>
    <div id="aiPanelStatus" class="small muted" style="margin-top:.7rem;"></div>
  </div>
</section>

    </main>

    <footer class="app">
      <span id="footerInfo">Â© <span id="year2"></span> Sistem Mutu Ikan Segar - Single File App</span>
    </footer>
  </div>
</div>

<button id="fabAI" class="fab fab-ai hidden" title="AI Asisten">
  <i data-feather="message-circle" width="22"></i>
</button>
<!-- Floating Action Button -->
<button id="fabInputData" class="fab hidden" title="Input Data">
  <i data-feather="plus" width="22"></i>
</button>

<button id="fabSettings" class="fab fab-settings hidden" title="Pengaturan" aria-label="Buka Pengaturan">
  <i data-feather="settings" width="22"></i>
</button>

<script>
(function applyIOSViewportScale() {
  // Deteksi iOS & iPadOS (termasuk iPadOS yang melaporkan MacIntel + touch)
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  const isIOSDevice =
      /iP(hone|od|ad)/.test(ua) ||
      (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

  if (!isIOSDevice) return;

  // Ambil / buat meta viewport
  let meta = document.querySelector('meta[name="viewport"]');
  if (!meta) {
    meta = document.createElement('meta');
    meta.name = 'viewport';
    document.head.appendChild(meta);
  }

  // Pecah konten lama (jika ada) supaya kita tidak kehilangan parameter lain.
  const existing = meta.getAttribute('content') || '';
  const parts = existing.split(',').map(p => p.trim()).filter(Boolean);
  const map = {};
  parts.forEach(p => {
    const [k,v] = p.split('=');
    if (k) map[k]=v===undefined?true:v;
  });

  // Override / set nilai yang diinginkan
  map['width'] = 'device-width';
  map['initial-scale'] = '0.8';

  // (Opsional) tetap pertahankan viewport-fit agar aman di notch
  if (!('viewport-fit' in map)) {
    map['viewport-fit'] = 'cover';
  }

  // (Opsional) bisa menonaktifkan zoom user (tidak wajib)
  // map['user-scalable'] = 'no';

  // Susun kembali
  const rebuilt = Object.entries(map)
    .map(([k,v]) => v===true ? k : `${k}=${v}`)
    .join(', ');

  meta.setAttribute('content', rebuilt);

  // Tambahkan kelas di <html> atau <body> jika ingin styling kondisional
  document.documentElement.classList.add('is-ios-scale-08');
})();
</script>
<script>
/* ============================================================
   APP.JS (Full Single-File Logic)
   Versi: 1.7.0 (Complete Feature Build)
   Fitur Utama:
   - Firebase Auth + Firestore
   - CRUD Data Mutu Ikan + Gambar (base64)
   - Dashboard (Indikator + Chart.js: Bar, Line, Pie)
   - Filter + Pencarian Global + Pagination + Multi-Select (export/delete)
   - Export CSV / Excel / PDF (dengan chart optional)
   - Organoleptik Tool (SNI 2013 & 2021) + Aggregation Method (avg/min/median)
   - i18n (ID / EN)
   - Preferensi UI: Tema, Aksen, Font Size, Layout, Lite Mode, Motion, Kontras
   - Hazard Flags & Food Safety Notes
   - Sosial Feed: Post + Gambar + Reaksi (like/dislike) + Komentar + Link ke Data
   - Role Management (demo client-side) + Profil Pengguna
   - Notifikasi (Admin Broadcast) + Mark Read, Badge Unread
   - Report Generator (filter date & fish, export)
   - Detail Modal Record + Image Viewer Modal
   - Toast System + Modal Konfirmasi
   - Auto Refresh Dashboard interval
   - Image Compression (Canvas)
   - Demo Accounts
   - Clipboard copy ringkasan organoleptik
   - Proteksi sederhana (client-side) untuk beberapa aksi role

   PERHATIAN:
   - Jalankan Firestore Security Rules di server untuk enforcement sebenarnya.
   - Penyimpanan gambar base64 di field 'image' (bisa dialihkan ke Storage).
   - Notifikasi, sosial, role mgmt semuanya client-side contoh.

   ============================================================ */

/* ======================= KONFIGURASI FIREBASE ======================= */
const firebaseConfig = {
  apiKey: "AIzaSyAxMT-bM6FEPrD-o3I2G-VHdZP7hxhj0uo",
  authDomain: "femmeiacloth-finance.firebaseapp.com",
  projectId: "femmeiacloth-finance",
  storageBucket: "femmeiacloth-finance.appspot.com",
  messagingSenderId: "517478386163",
  appId: "1:517478386163:web:51028f5841baa311126a86",
  measurementId: "G-K4L516Q54R"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const db   = firebase.firestore();

/* ======================= GLOBAL APP SCOPE ======================= */
window.App = (()=>{
  /* ------------------ STATE UTAMA ------------------ */
  const state = {
    currentUser: null,
    userProfile: null,
    fishData: [],
    filteredData: [],
    charts: {},
    myDataOnly: false,
    qualityFilter: 'all',
    perfMode: localStorage.getItem('perfMode') || 'ultra',
    lang: localStorage.getItem('lang') || 'id',
    accent: localStorage.getItem('accent') || '210 100% 50%',
    layoutStyle: localStorage.getItem('layoutStyle') || 'grid',
    dashRange: 'today',
    roleOptions: ['Admin','Mahasiswa','Dosen','Petugas Pasar','Lainnya'],
    fishTypes: [],
    markets: [],
    lastAddedId: null,
    metadataUnsub: { fish:null, markets:null, data:null, social:null, notifications:null },
    debounceTimers: {},
    formImageData: null,
    fontSize: localStorage.getItem('fontSize') || 'medium',
    liteMode: localStorage.getItem('liteMode') === '1',
    reduceMotion: localStorage.getItem('reduceMotion') === '1',
    highContrast: localStorage.getItem('highContrast') === '1',
    hazardList: ['Boraks','Formalin','Pewarna Tekstil','Pengawet Berlebih','Lainnya'],
    formHazards: [],
    table: {
      page: 1,
      perPage: parseInt(localStorage.getItem('tablePerPage')||'25',10),
      selected: new Set()
    },
        microLearning: {
      progress: {},     // { moduleId: { slideIndex, quizPassed } }
      allPassed: false  // akan true jika semua modul lulus
    },
    social: {
      posts: [],
      imageData: null,
      usersCache: [],
      commentUnsubs: {},
      openComments: new Set()
    },
    notifications: {
      list: [],
      unreadCount: 0,
      lastUpdated: null
    },
        sensors: {
      readings: [],     // array dokumen terbaru
      unsub: null,
      live: true,
      chart: null
    },
    autoRefresh: parseInt(localStorage.getItem('autoRefreshDashboard')||'0',10),
    autoRefreshTimer: null
  };

  /* ------------------ KONSTAN ------------------ */
  const defaultFishTypes = ["Ikan Kembung","Ikan Bandeng","Ikan Nila","Tuna Kecil"];
  const defaultMarkets   = ["Pasar Terong","Pasar Paâ€™baeng-baeng","Pasar Maricaya","Pasar Panakkukang"];

/* ------------------ ACHIEVEMENT RULES ------------------ */
const achievementRules = [
  {
    id:'daily_5',
    title:'5 Input Sehari',
    desc:'Mencapai 5 input dalam satu hari',
    check: ({todayCount}) => todayCount >= 5
  },
  {
    id:'daily_10',
    title:'10 Input Sehari',
    desc:'Mencapai 10 input dalam satu hari',
    check: ({todayCount}) => todayCount >= 10
  },
  {
    id:'total_50',
    title:'50 Total Input',
    desc:'Telah menginput 50 data',
    check: ({total}) => total >= 50
  },
  {
    id:'total_100',
    title:'100 Total Input',
    desc:'Telah menginput 100 data',
    check: ({total}) => total >= 100
  },
  {
    id:'streak_3',
    title:'Streak 3 Hari',
    desc:'Input data selama 3 hari berturut-turut',
    check: ({streak}) => streak >= 3
  },
  {
    id:'streak_7',
    title:'Streak 7 Hari',
    desc:'Input data selama 7 hari berturut-turut',
    check: ({streak}) => streak >= 7
  }
  
];
achievementRules.push({
  id: 'quality_steward',
  title: 'Quality Steward',
  desc: 'Menuntaskan semua modul micro-learning & lulus kuis',
  check: ({ microLearningCompleted }) => microLearningCompleted === true
});
  /* ------------------ I18N DICTIONARY ------------------ */
  const i18n = {
    id: {
      app_title:"Monitoring Mutu Ikan Segar", app_subtitle:"Sistem Informasi Pasar Tradisional Kota Makassar",
      email:"Email", password:"Kata Sandi", confirm_password:"Konfirmasi Kata Sandi", login:"Masuk",
      register_now:"Daftar sekarang", no_account:"Belum punya akun?", have_account:"Sudah punya akun?",
      forgot_password:"Lupa kata sandi?", register_account:"Registrasi Akun",
      register_subtitle:"Buat akun baru untuk mulai mencatat data mutu ikan.",
      create_account:"Buat Akun", reset_password:"Reset Kata Sandi", reset_subtitle:"Masukkan email anda untuk menerima link reset.",
      send_reset_link:"Kirim Link Reset", back_login:"Kembali ke Login", full_name:"Nama Lengkap", role:"Peran",
      dashboard:"Dashboard", data_records:"Data Mutu", input_form:"Input Data", reports:"Laporan",
      settings:"Pengaturan", profile:"Profil", logout:"Keluar", dashboard_overview:"Ringkasan Mutu Terkini",
      total_records:"Total Data", avg_score:"Rata-rata Skor", good_quality:"Mutu Baik", warning_quality:"Mutu Sedang",
      bad_quality:"Mutu Buruk", chart_comparison:"Perbandingan Mutu per Pasar", chart_trend:"Tren Skor Waktu",
      chart_pie:"Proporsi Jenis Ikan", quality_indicators:"Indikator Mutu", data_mutu_list:"Data Mutu Ikan",
      filter_fish:"Jenis Ikan", filter_market:"Pasar", filter_date:"Tanggal",
      filter_text:"Cari (bau / warna)", th_no:"No", th_date:"Tanggal", th_fish:"Jenis Ikan", th_market:"Pasar",
      th_organoleptic:"Organoleptik", th_smell:"Bau", th_texture:"Tekstur", th_color:"Warna", th_image:"Gambar",
      th_hazard:"Keamanan", th_score_status:"Status", th_user:"Pengguna", th_actions:"Aksi",
      empty_data:"Belum ada data. Silakan input.", input_new_data:"Input Data Mutu Baru", fish_type:"Jenis Ikan",
      market_location:"Lokasi Pasar", organoleptic_score:"Skor Organoleptik (1-9)", smell:"Bau", texture:"Tekstur",
      color:"Warna", date_auto:"Tanggal (otomatis)", save_data:"Simpan Data", cancel_edit:"Batal Edit",
      reports_export:"Laporan & Export", reports_desc:"Pilih rentang data dan ekspor laporan berisi grafik dan tabel.",
      from_date:"Dari Tanggal", to_date:"Sampai Tanggal", report_scope:"Ruang Lingkup", report_fish_type:"Jenis Ikan (Opsional)",
      generate_report:"Generate Laporan", clear_report:"Bersihkan", settings_pref:"Pengaturan & Preferensi",
      appearance:"Tampilan", theme_mode:"Mode Tema", accent_color:"Warna Aksen", layout_style:"Gaya Layout",
      language:"Bahasa", account_info:"Info Akun", resend_verif:"Kirim Ulang Verifikasi",
      refresh:"Refresh", role_mgmt:"Manajemen Peran",
      role_mgmt_desc:"Hanya admin dapat mengubah peran pengguna lain. (Demo)",
      danger_zone:"Zona Berbahaya", delete_account_warn:"Penghapusan akun hanya hapus profil (data mutu tetap). (Demo)",
      delete_account:"Hapus Akun", profile_manage:"Profil Pengguna", change_photo:"Ganti Foto",
      remove_photo:"Hapus Foto", update_profile:"Update Profil", send_verification:"Kirim Verifikasi",
      email_verified:"Email Terverifikasi", student_id:"NIM Mahasiswa", lecturer_id:"NIP Dosen",
      officer_id:"ID Petugas", default_fish_type:"Default Jenis Ikan", default_market:"Default Pasar",
      hazard_flagged:"Indikasi Bahaya", safety:"Keamanan", safety_section:"Keamanan Pangan",
      safety_intro:"Indikator keamanan ikan segar untuk mendeteksi indikasi bahan berbahaya.",
      food_safety:"Keamanan Pangan", lite_mode:"Mode Lite (Tanpa Blur)",
      social:"Sosial", social_feed_title:"Sosial & Aktivitas Pengguna", social_intro:"Daftar pengguna & posting singkat. Klik avatar untuk profil.",
      create_post:"Buat Post", post_now:"Kirim", clear:"Bersih", recent_posts:"Posting Terbaru", no_posts:"Belum ada posting.",
      users_list:"Daftar Pengguna", last_login:"Login Terakhir", created_at:"Dibuat", detail:"Detail", view_detail:"Lihat Detail",
      notifications:"Notifikasi", mark_all_read:"Baca Semua", no_notifications:"Tidak ada notifikasi.",
      send_broadcast:"Kirim Broadcast", selected:"Dipilih", select_all_filtered:"Pilih Semua (Filter)",
      delete_selected:"Hapus Terpilih", clear_selection:"Bersihkan", per_page:"Per halaman",
      back:"Kembali", safe:"Aman", attention:"Perhatian",
      safe_desc:"Tidak ada indikasi bahan berbahaya.", attention_desc:"Ada indikasi awal, perlu verifikasi.",
      change_email_btn:"Ganti Email", new_password:"Password Baru", change_password_btn:"Ganti Password",
      confirm_password_short:"Konfirmasi Password", update_stats:"Perbarui Statistik", refresh_stats:"Perbarui Statistik"
    },
    en: {
      app_title:"Fresh Fish Quality Monitoring", app_subtitle:"Information System for Traditional Markets in Makassar",
      email:"Email", password:"Password", confirm_password:"Confirm Password", login:"Login",
      register_now:"Register now", no_account:"Don't have an account?", have_account:"Already have an account?",
      forgot_password:"Forgot password?", register_account:"Register Account",
      register_subtitle:"Create a new account to start recording fish quality data.",
      create_account:"Create Account", reset_password:"Reset Password", reset_subtitle:"Enter your email to receive a reset link.",
      send_reset_link:"Send Reset Link", back_login:"Back to Login", full_name:"Full Name", role:"Role",
      dashboard:"Dashboard", data_records:"Quality Data", input_form:"Input Data", reports:"Reports",
      settings:"Settings", profile:"Profile", logout:"Logout", dashboard_overview:"Latest Quality Overview",
      total_records:"Total Records", avg_score:"Average Score", good_quality:"Good Quality", warning_quality:"Medium Quality",
      bad_quality:"Bad Quality", chart_comparison:"Quality Comparison per Market", chart_trend:"Trend Over Time",
      chart_pie:"Fish Type Proportion", quality_indicators:"Quality Indicators", data_mutu_list:"Fish Quality Data",
      filter_fish:"Fish Type", filter_market:"Market", filter_date:"Date",
      filter_text:"Search (smell / color)", th_no:"No", th_date:"Date", th_fish:"Fish Type", th_market:"Market",
      th_organoleptic:"Organoleptic", th_smell:"Smell", th_texture:"Texture", th_color:"Color", th_image:"Image",
      th_hazard:"Safety", th_score_status:"Status", th_user:"User", th_actions:"Actions",
      empty_data:"No data yet. Please input.", input_new_data:"Input New Quality Data", fish_type:"Fish Type",
      market_location:"Market Location", organoleptic_score:"Organoleptic Score (1-9)", smell:"Smell", texture:"Texture",
      color:"Color", date_auto:"Date (auto)", save_data:"Save Data", cancel_edit:"Cancel Edit",
      reports_export:"Reports & Export", reports_desc:"Select a date range and export report (charts and tables).",
      from_date:"From Date", to_date:"To Date", report_scope:"Scope", report_fish_type:"Fish Type (Optional)",
      generate_report:"Generate Report", clear_report:"Clear", settings_pref:"Settings & Preferences",
      appearance:"Appearance", theme_mode:"Theme Mode", accent_color:"Accent Color", layout_style:"Layout Style",
      language:"Language", account_info:"Account Info", resend_verif:"Resend Verification",
      refresh:"Refresh", role_mgmt:"Role Management",
      role_mgmt_desc:"Only admin can change roles. (Demo)",
      danger_zone:"Danger Zone", delete_account_warn:"Account deletion removes profile only (history preserved). (Demo)",
      delete_account:"Delete Account", profile_manage:"User Profile", change_photo:"Change Photo",
      remove_photo:"Remove Photo", update_profile:"Update Profile", send_verification:"Send Verification",
      email_verified:"Email Verified", student_id:"Student ID", lecturer_id:"Lecturer ID",
      officer_id:"Officer ID", default_fish_type:"Default Fish Type", default_market:"Default Market",
      hazard_flagged:"Hazard Flagged", safety:"Safety", safety_section:"Food Safety",
      safety_intro:"Food safety indicators for early detection of hazardous additives.",
      food_safety:"Food Safety", lite_mode:"Lite Mode (No Blur)",
      social:"Social", social_feed_title:"Social & User Activity", social_intro:"Users list & quick posts.",
      create_post:"Create Post", post_now:"Post", clear:"Clear", recent_posts:"Recent Posts", no_posts:"No posts yet.",
      users_list:"Users List", last_login:"Last Login", created_at:"Created", detail:"Detail", view_detail:"View Detail",
      notifications:"Notifications", mark_all_read:"Mark All Read", no_notifications:"No notifications.",
      send_broadcast:"Send Broadcast", selected:"Selected", select_all_filtered:"Select All (Filtered)",
      delete_selected:"Delete Selected", clear_selection:"Clear Selection", per_page:"Per page",
      back:"Back", safe:"Safe", attention:"Attention",
      safe_desc:"No hazard indications.", attention_desc:"Early indication, verify.",
      change_email_btn:"Change Email", new_password:"New Password", change_password_btn:"Change Password",
      confirm_password_short:"Confirm Password", update_stats:"Update Stats", refresh_stats:"Refresh Stats"
    }
  };

  /* ------------------ HELPER DOM & UTIL ------------------ */
  const $    = sel => document.querySelector(sel);
  const $all = sel => Array.from(document.querySelectorAll(sel));
  const sanitize = s => (s||'').toString().replace(/[<>]/g,'');
  const clamp = (n,min,max)=> Math.max(min,Math.min(max,n));
  const isoDateOnly = d => {
    const dt = (d instanceof Date)? d : new Date(d);
    return dt.toISOString().split('T')[0];
  };
  const formatDate = ts => {
    if(!ts) return '-';
    const d = ts instanceof Date ? ts : (ts.toDate? ts.toDate(): new Date(ts));
    return d.toLocaleDateString(state.lang==='en'?'en-US':'id-ID',{year:'numeric',month:'2-digit',day:'2-digit'});
  };
  const formatDateTime = ts => {
    if(!ts) return '-';
    const d = ts instanceof Date ? ts : (ts.toDate? ts.toDate(): new Date(ts));
    return d.toLocaleString(state.lang==='en'?'en-US':'id-ID',{
      year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'
    });
  };
  const average = arr => !arr.length?0: arr.reduce((a,b)=>a+b,0)/arr.length;
  const nowDateInput = ()=> new Date().toISOString().split('T')[0];
  const debounce = (key, fn, delay=300)=>{
    clearTimeout(state.debounceTimers[key]);
    state.debounceTimers[key] = setTimeout(fn, delay);
  };
  function setText(sel,val){ const el=$(sel); if(el) el.textContent=val; }
  function setVal(sel,val){ const el=$(sel); if(el) el.value=val; }
  function setHTML(sel, html){ const el=$(sel); if(el) el.innerHTML=html; }
  function toggle(sel, hidden){
    const el = $(sel);
    if(el) el.classList.toggle('hidden', hidden);
  }

  /* ------------------ TOAST & ALERT ------------------ */
  function toast(msg,type='info',timeout=4000){
    const c = $('#toastContainer'); if(!c) return;
    const div = document.createElement('div');
    div.className = 'toast';
    div.dataset.type = type;
    const icon = type==='success'?'check-circle': type==='danger'?'alert-triangle': type==='warn'?'alert-octagon':'info';
    div.innerHTML = `
      <i data-feather="${icon}" width="14"></i>
      <span style="flex:1;">${msg}</span>
      <button class="toast-close"><i data-feather="x" width="14"></i></button>
    `;
    c.appendChild(div);
    feather.replace();
    let closing=false;
    let timer = setTimeout(close, timeout);
    function close(){
      if(closing) return;
      closing=true;
      div.style.animation='toastExit .5s ease forwards';
      setTimeout(()=> div.remove(),480);
    }
    div.querySelector('.toast-close').onclick = ()=> { clearTimeout(timer); close(); };
    div.addEventListener('mouseenter',()=> clearTimeout(timer));
    div.addEventListener('mouseleave',()=> timer=setTimeout(close,timeout));
  }

  function showAlert(targetId,type,msg,timeout=5000){
    const el = typeof targetId==='string'? document.getElementById(targetId): targetId;
    if(!el) return;
    el.innerHTML = `
      <div class="alert ${type}">
        <i data-feather="${type==='danger'?'alert-triangle':type==='success'?'check-circle': type==='warn'?'alert-octagon':'info'}" width="14"></i>
        <span style="flex:1;">${msg}</span>
        <button style="background:transparent;border:none;color:inherit;cursor:pointer;padding:.2rem .35rem;" onclick="this.closest('.alert').remove();">
          <i data-feather="x" width="12"></i>
        </button>
      </div>`;
    feather.replace();
    if(timeout) setTimeout(()=> el.firstElementChild && el.firstElementChild.remove(), timeout);
  }

  /* ------------------ MODAL GLOBAL ------------------ */
  const Modal = {
    open({
      title='Konfirmasi',
      message='Yakin?',
      icon='help-circle',
      confirmText='Ya',
      cancelText='Batal',
      confirmType='danger',
      extraHTML='',
      onConfirm=()=>{},
      onCancel=()=>{}
    }={}){
      const wrap = $('#appModal');
      if(!wrap) return;
      $('#modalTitle').innerHTML = `<i data-feather="${icon}" width="18"></i><span>${title}</span>`;
      $('#modalMessage').textContent = message;
      $('#modalOkText').textContent = confirmText;
      $('#modalCancelText').textContent = cancelText;
      $('#modalExtra').innerHTML = extraHTML;
      const okBtn = $('#modalOkBtn');
      okBtn.className = confirmType==='danger'?'danger small':'small';
      wrap.classList.add('show');
      feather.replace();

      function cleanup(){
        wrap.classList.remove('show');
        okBtn.onclick = null;
        $('#modalCancelBtn').onclick = null;
        wrap.removeEventListener('click', outside);
      }
      function outside(e){
        if(e.target===wrap){ cleanup(); onCancel(); }
      }

      okBtn.onclick = ()=> { cleanup(); onConfirm(); };
      $('#modalCancelBtn').onclick = ()=> { cleanup(); onCancel(); };
      wrap.addEventListener('click', outside);
    }
  };

  /* ------------------ I18N APPLY ------------------ */
  function applyI18n(){
    const dict = i18n[state.lang] || i18n.id;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      if(dict[key]) el.textContent = dict[key];
    });
    document.documentElement.lang = state.lang;
    localStorage.setItem('lang', state.lang);
    const lbl = $('#toggleMyDataLabel');
    if(lbl) lbl.textContent = state.myDataOnly
      ? (state.lang==='en'?'My Data':'Data Saya')
      : (state.lang==='en'?'All Data':'Semua Data');
    const langLabel = $('#langLabel'); if(langLabel) langLabel.textContent = state.lang.toUpperCase();
    const liteLbl = $('#liteModeLabel');
    if(liteLbl){
      liteLbl.textContent = state.liteMode
        ? (state.lang==='en'?'Disable':'Nonaktifkan')
        : (state.lang==='en'?'Enable':'Aktifkan');
    }
    const motionLbl = $('#motionLabel');
    if(motionLbl){
      motionLbl.textContent = state.reduceMotion
        ? (state.lang==='en'?'Disable':'Nonaktifkan')
        : (state.lang==='en'?'Enable':'Aktifkan');
    }
    const contrastLbl = $('#contrastLabel');
    if(contrastLbl){
      contrastLbl.textContent = state.highContrast
        ? (state.lang==='en'?'Disable':'Nonaktifkan')
        : (state.lang==='en'?'Enable':'Aktifkan');
    }
  }

  function applyFontSize(size){
  const root = document.documentElement;
  root.classList.remove('font-small','font-medium','font-large');

  let px = 15;
  if(size === 'small'){ px = 14; root.classList.add('font-small'); }
  else if(size === 'large'){ px = 18; root.classList.add('font-large'); }
  else { root.classList.add('font-medium'); }

  root.style.setProperty('--font-base', px + 'px');
  localStorage.setItem('fontSize', size);

  const select = document.getElementById('fontSizeSelect');
  if(select) select.value = size;
}

function applyPerformanceMode(mode){
  ['perf-ultra','perf-default','perf-lite'].forEach(c=> document.body.classList.remove(c));
  if(!['ultra','default','lite'].includes(mode)) mode='ultra';
  document.body.classList.add('perf-'+mode);
  localStorage.setItem('perfMode', mode);
  state.perfMode = mode;
}

  /* ------------------ ACCENT PALETTE ------------------ */
  function buildAccentPalette(){
const palette = [
  // Existing
  '210 100% 50%','260 83% 60%','340 82% 52%','14 90% 57%',
  '122 39% 49%','190 90% 45%','45 100% 51%','0 84% 56%',
  '280 95% 55%','200 80% 55%','150 65% 45%','25 95% 55%',
  '300 85% 55%','20 85% 55%','80 70% 45%','100 60% 42%',
  '160 55% 42%','180 70% 45%','220 70% 55%','240 65% 55%',
  '265 70% 58%','330 75% 55%','355 80% 55%','35 90% 55%',
  '60 90% 50%','90 50% 45%','0 0% 40%','0 0% 55%',

  // Tambahan (spectrum lebih rapat; hue kelipatan 15 derajat)
  '15 85% 55%','30 85% 55%','45 85% 55%','60 85% 55%',
  '75 70% 50%','90 65% 50%','105 60% 48%','120 60% 46%',
  '135 55% 44%','150 55% 46%','165 55% 46%','180 65% 48%',
  '195 70% 50%','210 80% 54%','225 70% 52%','240 65% 55%',
  '255 70% 56%','270 75% 58%','285 75% 56%','300 75% 55%',
  '315 70% 54%','330 70% 54%','345 75% 54%','360 80% 55%',

  // Variasi â€œmutedâ€ (luminosity lebih tinggi / saturasi lebih rendah)
  '200 25% 55%','210 30% 60%','220 28% 62%','230 30% 58%',
  '250 25% 55%','260 30% 60%','280 25% 58%',

  // Variasi â€œdeepâ€ (lebih gelap untuk dark mode kontras)
  '210 90% 40%','260 80% 40%','330 70% 40%','14 85% 40%',
  '45 90% 40%','150 55% 38%','190 85% 38%','240 70% 38%'
];
    const wrap = $('#accentPalette');
    if(!wrap) return;
    wrap.innerHTML = palette.map(c=> `
      <div class="color-swatch ${c===state.accent?'active':''}" data-accent="${c}" style="background:hsl(${c});"></div>
    `).join('');
    $all('.color-swatch').forEach(sw=>{
      sw.addEventListener('click', ()=>{
        state.accent = sw.getAttribute('data-accent');
        document.documentElement.style.setProperty('--accent', state.accent);
        localStorage.setItem('accent', state.accent);
        buildAccentPalette();
        rebuildCharts();
        toast(state.lang==='en'?'Accent updated':'Aksen diperbarui','success',1800);
      });
    });
  }

(function initCustomAccent(){
  const picker = document.getElementById('customAccentPicker');
  const btn = document.getElementById('applyCustomAccent');
  if(!picker || !btn) return;

  function hexToHsl(hex){
    hex = hex.replace('#','');
    if(hex.length===3){
      hex = hex.split('').map(c=> c+c).join('');
    }
    const r = parseInt(hex.substring(0,2),16)/255;
    const g = parseInt(hex.substring(2,4),16)/255;
    const b = parseInt(hex.substring(4,6),16)/255;
    const max = Math.max(r,g,b), min = Math.min(r,g,b);
    let h,s,l = (max+min)/2;
    if(max===min){
      h=s=0;
    } else {
      const d = max-min;
      s = l>0.5 ? d/(2-max-min) : d/(max+min);
      switch(max){
        case r: h = (g-b)/d + (g<b?6:0); break;
        case g: h = (b-r)/d + 2; break;
        case b: h = (r-g)/d + 4; break;
      }
      h/=6;
    }
    h = Math.round(h*360);
    s = Math.round(s*100);
    l = Math.round(l*50 + l*50/2); // atau Math.round(l*100)
    // Gunakan format HSL konsisten (h s% l%)
    return `${h} ${s}% ${Math.round(l)}%`;
  }

  btn.addEventListener('click', ()=>{
    const hsl = hexToHsl(picker.value);
    App.state.accent = hsl;
    document.documentElement.style.setProperty('--accent', hsl);
    localStorage.setItem('accent', hsl);
    buildAccentPalette();      // agar highlight active bergerak
    App.rebuildCharts();       // sinkron warna chart
    App.toast('Aksen custom diterapkan','success');
  });
})();

applyPerformanceMode(state.perfMode);
const perfSel = document.getElementById('performanceMode');
if(perfSel){
  perfSel.value = state.perfMode;
  perfSel.addEventListener('change', e=>{
    applyPerformanceMode(e.target.value);
    App.toast('Mode: '+e.target.value,'info');
    // Jika mode lite, bisa otomatis aktifkan reduce-motion bila mau:
    if(e.target.value === 'lite'){
      document.body.classList.add('reduce-motion');
    } else {
      // Biarkan preferensi reduce motion user sendiri
    }
  });
}
  /* ------------------ HAZARD CHIPS ------------------ */
  function renderHazardChips(){
    const wrap = $('#hazardChips');
    if(!wrap) return;
    wrap.innerHTML = state.hazardList.map(h=> `
      <div class="hazard-chip ${state.formHazards.includes(h)?'active':''}" data-hazard="${h}">
        <i data-feather="alert-triangle" width="10"></i>${h}
      </div>
    `).join('') +
    `<div style="flex-basis:100%;font-size:.48rem;color:hsl(var(--text-dim));margin-top:.25rem;">Klik untuk toggle indikasi</div>`;
    $all('.hazard-chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        const v = ch.getAttribute('data-hazard');
        if(state.formHazards.includes(v)){
          state.formHazards = state.formHazards.filter(x=> x!==v);
        } else state.formHazards.push(v);
        renderHazardChips();
      });
    });
    feather.replace();
  }

  /* ------------------ STATUS KOMPUTASI MUTU & KEAMANAN ------------------ */
  function computeQualityStatus(score){
    if(score>=7) return { label: state.lang==='en'?'Good':'Baik', cls:'status-good' };
    if(score>=4) return { label: state.lang==='en'?'Medium':'Sedang', cls:'status-warn' };
    return { label: state.lang==='en'?'Bad':'Buruk', cls:'status-bad' };
  }
  function computeSafetyStatus(record){
    const safe = !(record.hazards && record.hazards.length);
    return safe
      ? { label: state.lang==='en'?'Safe':'Aman', safe:true }
      : { label: state.lang==='en'?'Attention':'Perhatian', safe:false };
  }

  /* ------------------ DATA -> TABLE ROWS EXPORT ------------------ */
  function generateTableData(records){
    const header = state.lang==='en'
      ? ["Date","Fish Type","Market","Organoleptic","Smell","Texture","Color","Safety","HazardList","Image","Status","User","UID","ID"]
      : ["Tanggal","Jenis Ikan","Pasar","Organoleptik","Bau","Tekstur","Warna","Keamanan","DaftarHazard","Gambar","Status","User","UID","ID"];
    const body = records.map(r=>{
      const safety = computeSafetyStatus(r);
      return [
        formatDate(r.date || r.createdAt),
        r.fishType,
        r.market,
        r.organoleptic,
        r.smell,
        r.texture,
        r.color,
        safety.label,
        (r.hazards||[]).join('|'),
        r.image?'YA':'-',
        computeQualityStatus(r.organoleptic).label,
        r.userName,
        r.userId,
        r.id
      ];
    });
    return [header,...body];
  }

  /* ------------------ FILTER + PENCARIAN + PAGINATION ------------------ */
  function applyFilters(){
    const fish = $('#filterFish')?.value || '';
    const market = $('#filterMarket')?.value || '';
    const date = $('#filterDate')?.value || '';
    const text = ($('#filterText')?.value || '').toLowerCase();
    const globalText = ($('#globalSearch')?.value || '').toLowerCase();

    let data = state.fishData.filter(r=>{
      if(state.myDataOnly && r.userId !== state.currentUser?.uid) return false;
      if(fish && r.fishType !== fish) return false;
      if(market && r.market !== market) return false;
      if(date && isoDateOnly(r.date)!==date) return false;
      if(text && ![r.smell,r.texture,r.color,r.fishType,r.market,(r.hazardNotes||''),(r.hazards||[]).join(' ')].some(v=> (v||'').toLowerCase().includes(text))) return false;
      if(globalText && ![r.smell,r.texture,r.color,r.fishType,r.market,r.userName,(r.hazardNotes||''),(r.hazards||[]).join(' ')].some(v=> (v||'').toLowerCase().includes(globalText))) return false;
      return true;
    });

    state.filteredData = data;
    resetToFirstPage();
    state.table.selected.clear();
    updateSelectionInfo();
    toggleMultiActionBar();
    renderTable();
    updateQualityList();
  }

  function getPagedData(){
    const { page, perPage } = state.table;
    const start = (page-1)*perPage;
    return state.filteredData.slice(start, start+perPage);
  }
  function resetToFirstPage(){ state.table.page = 1; }

  function updatePaginationInfo(){
    const pageInfo = $('#pageInfo');
    if(!pageInfo) return;
    const total = state.filteredData.length;
    const perPage = state.table.perPage;
    const pages = Math.max(1, Math.ceil(total/perPage));
    if(state.table.page > pages) state.table.page = pages;
    pageInfo.textContent = `Hal ${pages?state.table.page:0}/${pages}`;
  }

  function updateSelectionInfo(){
    const el = $('#selectionInfo');
    if(el) el.textContent = `${state.table.selected.size} ${state.lang==='en'?'selected':'dipilih'}`;
    const countEl = $('#multiSelectedCount');
    if(countEl) countEl.textContent = state.table.selected.size;
  }

  function toggleSelectAllCurrentPage(checked){
    const paged = getPagedData();
    paged.forEach(r=>{
      if(checked) state.table.selected.add(r.id);
      else state.table.selected.delete(r.id);
    });
    updateSelectionInfo();
    toggleMultiActionBar();
    renderTable();
  }

  function selectAllFiltered(){
    state.filteredData.forEach(r=> state.table.selected.add(r.id));
    updateSelectionInfo();
    toggleMultiActionBar();
    renderTable();
  }

  function clearSelection(){
    state.table.selected.clear();
    updateSelectionInfo();
    toggleMultiActionBar();
    renderTable();
  }

  function toggleMultiActionBar(){
    const bar = $('#multiActionBar');
    if(!bar) return;
    bar.classList.toggle('hidden', state.table.selected.size===0);
  }

  /* ------------------ DYNAMIC OPTIONS (FISH & MARKET) ------------------ */
  function populateDynamic(){
    const dFish = $('#fishTypeList');
    const dMarket = $('#marketList');
    const filterFish = $('#filterFish');
    const filterMarket = $('#filterMarket');
    const reportFish = $('#reportFish');
    const prefFish = $('#prefDefaultFish');
    const prefMarket = $('#prefDefaultMarket');

    if(dFish) dFish.innerHTML = state.fishTypes.map(f=> `<option value="${sanitize(f)}"></option>`).join('');
    if(dMarket) dMarket.innerHTML = state.markets.map(m=> `<option value="${sanitize(m)}"></option>`).join('');

    const allOpt = state.lang==='en'?'All':'Semua';
    if(filterFish) filterFish.innerHTML = [`<option value="">${allOpt}</option>`, ...state.fishTypes.map(f=> `<option>${sanitize(f)}</option>`)].join('');
    if(filterMarket) filterMarket.innerHTML = [`<option value="">${allOpt}</option>`, ...state.markets.map(m=> `<option>${sanitize(m)}</option>`)].join('');
    if(reportFish) reportFish.innerHTML = [`<option value="">${allOpt}</option>`, ...state.fishTypes.map(f=> `<option>${sanitize(f)}</option>`)].join('');

    if(prefFish) prefFish.innerHTML = ['<option value="">(Kosong)</option>', ...state.fishTypes.map(f=> `<option ${state.userProfile?.defaultFishType===f?'selected':''}>${sanitize(f)}</option>`)].join('');
    if(prefMarket) prefMarket.innerHTML = ['<option value="">(Kosong)</option>', ...state.markets.map(m=> `<option ${state.userProfile?.defaultMarket===m?'selected':''}>${sanitize(m)}</option>`)].join('');

    if(!$('#recordId')?.value){
      if(state.userProfile?.defaultFishType && state.fishTypes.includes(state.userProfile.defaultFishType)){
        $('#fishTypeInput').value = state.userProfile.defaultFishType;
      }
      if(state.userProfile?.defaultMarket && state.markets.includes(state.userProfile.defaultMarket)){
        $('#marketInput').value = state.userProfile.defaultMarket;
      }
    }
  }

  /* ------------------ DASHBOARD METRIK + TREN ------------------ */
  function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function getPeriod(range, records){
    const today = startOfDay(new Date());
    let current = [], previous = [];
    const dayMs=86400000;
    if(range==='today'){
      const yesterday=new Date(today.getTime()-dayMs);
      current = records.filter(r=> startOfDay(r.date).getTime()===today.getTime());
      previous= records.filter(r=> startOfDay(r.date).getTime()===yesterday.getTime());
    } else if(range==='7d'){
      const startCurrent= new Date(today.getTime()-6*dayMs);
      const endCurrent = today;
      const endPrev = new Date(startCurrent.getTime()-dayMs);
      const startPrev= new Date(endPrev.getTime()-6*dayMs);
      current = records.filter(r=> {
        const d = startOfDay(r.date);
        return d>=startCurrent && d<=endCurrent;
      });
      previous = records.filter(r=>{
        const d=startOfDay(r.date);
        return d>=startPrev && d<=endPrev;
      });
    } else if(range==='30d'){
      const startCurrent= new Date(today.getTime()-29*dayMs);
      const endCurrent=today;
      const endPrev=new Date(startCurrent.getTime()-dayMs);
      const startPrev=new Date(endPrev.getTime()-29*dayMs);
      current = records.filter(r=>{
        const d = startOfDay(r.date);
        return d>=startCurrent && d<=endCurrent;
      });
      previous = records.filter(r=>{
        const d=startOfDay(r.date);
        return d>=startPrev && d<=endPrev;
      });
    } else {
      if(records.length===0) return {current:[],previous:[]};
      const sorted=[...records].sort((a,b)=> a.date-b.date);
      const earliest = startOfDay(sorted[0].date);
      const latest = startOfDay(sorted[sorted.length-1].date);
      current = records.slice();
      const spanDays = Math.max(1,Math.ceil((latest-earliest)/dayMs)+1);
      const prevEnd = new Date(earliest.getTime()-dayMs);
      const prevStart = new Date(prevEnd.getTime()-(spanDays-1)*dayMs);
      previous = records.filter(r=>{
        const d=startOfDay(r.date);
        return d>=prevStart && d<=prevEnd;
      });
    }
    return {current,previous};
  }
  function calcTrend(curVal, prevVal){
    if(prevVal===0 && curVal===0) return { value:0, text:'0%' };
    if(prevVal===0 && curVal>0) return { value:100, text:'+100%' };
    const diffPct = ((curVal - prevVal)/prevVal)*100;
    return { value: diffPct, text: (diffPct>0?'+':'')+diffPct.toFixed(1)+'%' };
  }
  function formatTrend(tr){
    const v=tr.value;
    let arrow='â–¬';
    if(v>0.5) arrow='â–²';
    else if(v<-0.5) arrow='â–¼';
    return `${arrow} ${tr.text}`;
  }

  function updateDashboard(){
    const base = state.myDataOnly
      ? state.fishData.filter(r=> r.userId === state.currentUser?.uid)
      : state.fishData.slice();

    const { current, previous } = getPeriod(state.dashRange, base);
    const totalCur = current.length;
    const totalPrev= previous.length;
    const avgCur = totalCur? average(current.map(r=> r.organoleptic)) : 0;
    const avgPrev= totalPrev? average(previous.map(r=> r.organoleptic)) : 0;
    const goodCur = current.filter(r=> r.organoleptic>=7).length;
    const goodPrev= previous.filter(r=> r.organoleptic>=7).length;
    const warnCur = current.filter(r=> r.organoleptic>=4 && r.organoleptic<7).length;
    const warnPrev= previous.filter(r=> r.organoleptic>=4 && r.organoleptic<7).length;
    const badCur  = current.filter(r=> r.organoleptic<4).length;
    const badPrev = previous.filter(r=> r.organoleptic<4).length;
    const hazCur  = current.filter(r=> (r.hazards||[]).length).length;
    const hazPrev = previous.filter(r=> (r.hazards||[]).length).length;

    setText('#indTotal', totalCur);
    setText('#indAvg', totalCur? avgCur.toFixed(2): '-');
    setText('#indGood', goodCur);
    setText('#indWarn', warnCur);
    setText('#indBad', badCur);
    setText('#indHazard', hazCur);

    setText('#indTotalTrend', formatTrend(calcTrend(totalCur,totalPrev)));
    setText('#indAvgTrend',   formatTrend(calcTrend(avgCur,avgPrev)));
    setText('#indGoodTrend',  formatTrend(calcTrend(goodCur,goodPrev)));
    setText('#indWarnTrend',  formatTrend(calcTrend(warnCur,warnPrev)));
    setText('#indBadTrend',   formatTrend(calcTrend(badCur,badPrev)));
    setText('#indHazardTrend',formatTrend(calcTrend(hazCur,hazPrev)));
        buildRankings();
  }
  
      /* ===== RANKING & REKOMENDASI (IMPROVED) ===== */
  function buildRankings(){
    const marketListEl = document.getElementById('marketRankingList');
    const fishListEl   = document.getElementById('fishRankingList');
    const marketRecEl  = document.getElementById('marketRecommendations');
    const fishRecEl    = document.getElementById('fishRecommendations');
    if(!marketListEl || !fishListEl) return;

    // Mode: "current" (sesuai rentang) atau "all" (abaikan rentang) â€“ toggle tombol di header
    const btnAll = document.getElementById('rankingModeAll');
    const btnActive = document.getElementById('rankingModeActive');
    const activeMode = (btnActive && btnActive.classList.contains('active')) ? 'current':'all';

    const base = state.myDataOnly
      ? state.fishData.filter(r=> r.userId===state.currentUser?.uid)
      : state.fishData.slice();

    let dataSource = base;
    if(activeMode==='current'){
      const { current } = getPeriod(state.dashRange, base);
      dataSource = current;
    }

    if(!dataSource.length){
      marketListEl.innerHTML = '<li><div class="rank-pos">-</div><div class="rank-main">Tidak ada data</div></li>';
      fishListEl.innerHTML = '<li><div class="rank-pos">-</div><div class="rank-main">Tidak ada data</div></li>';
      marketRecEl.innerHTML = '<div class="rec-empty">Tidak ada rekomendasi.</div>';
      fishRecEl.innerHTML = '<div class="rec-empty">Tidak ada rekomendasi.</div>';
      feather.replace();
      return;
    }

    // Agregasi Pasar
    const marketMap = {};
    dataSource.forEach(r=>{
      if(!marketMap[r.market]) marketMap[r.market] = { scores:[], hazards:0 };
      marketMap[r.market].scores.push(r.organoleptic);
      if((r.hazards||[]).length) marketMap[r.market].hazards++;
    });
    const markets = Object.keys(marketMap).map(m=>{
      const avg = average(marketMap[m].scores);
      return {
        name:m,
        avg,
        count: marketMap[m].scores.length,
        hazards: marketMap[m].hazards
      };
    }).sort((a,b)=> b.avg - a.avg);

    // Agregasi Ikan
    const fishMap = {};
    dataSource.forEach(r=>{
      if(!fishMap[r.fishType]) fishMap[r.fishType] = { scores:[], hazards:0 };
      fishMap[r.fishType].scores.push(r.organoleptic);
      if((r.hazards||[]).length) fishMap[r.fishType].hazards++;
    });
    const fishes = Object.keys(fishMap).map(f=>{
      const avg = average(fishMap[f].scores);
      return {
        name:f,
        avg,
        count: fishMap[f].scores.length,
        hazards: fishMap[f].hazards
      };
    }).sort((a,b)=> b.avg - a.avg);

    function rankPosClass(i){
      if(i===0) return 'gold';
      if(i===1) return 'silver';
      if(i===2) return 'bronze';
      return '';
    }
    function scoreBadgeClass(avg){
      if(avg>=7) return '';
      if(avg>=4) return 'mid';
      return 'bad';
    }

    marketListEl.innerHTML = markets.slice(0,5).map((m,i)=> `
      <li>
        <div class="rank-pos ${rankPosClass(i)}">${i+1}</div>
        <div>
          <div class="rank-main">${sanitize(m.name)}</div>
          <div class="rank-meta">AVG ${m.avg.toFixed(2)} â€¢ ${m.count} data â€¢ ${m.hazards} indikasi</div>
        </div>
        <div class="rank-score-badge ${scoreBadgeClass(m.avg)}">${m.avg.toFixed(1)}</div>
      </li>
    `).join('');

    fishListEl.innerHTML = fishes.slice(0,5).map((f,i)=> `
      <li>
        <div class="rank-pos ${rankPosClass(i)}">${i+1}</div>
        <div>
          <div class="rank-main">${sanitize(f.name)}</div>
          <div class="rank-meta">AVG ${f.avg.toFixed(2)} â€¢ ${f.count} data â€¢ ${f.hazards} indikasi</div>
        </div>
        <div class="rank-score-badge ${scoreBadgeClass(f.avg)}">${f.avg.toFixed(1)}</div>
      </li>
    `).join('');

    // Rekomendasi Pasar
    const unggulan = markets.filter(m=> m.avg>=7);
    const perluPerhatian = markets.filter(m=> m.avg<5);
    marketRecEl.innerHTML = `
      ${unggulan.length
        ? unggulan.map(u=> `<span class="rec-chip good" title="Pasar unggulan (â‰¥7)"><i data-feather="thumbs-up" width="11"></i>${sanitize(u.name)} (${u.avg.toFixed(1)})</span>`).join('')
        : '<div class="rec-empty">Tidak ada pasar unggulan (â‰¥7)</div>'
      }
      ${perluPerhatian.length
        ? '<div style="flex-basis:100%;height:0;"></div>'+ perluPerhatian.map(u=> `<span class="rec-chip low" title="Perlu perhatian (&lt;5)"><i data-feather="alert-triangle" width="11"></i>${sanitize(u.name)} (${u.avg.toFixed(1)})</span>`).join('')
        : ''
      }
    `;

    // Rekomendasi Ikan (AVG â‰¥7)
    const ikanUnggulan = fishes.filter(f=> f.avg>=7);
    fishRecEl.innerHTML = ikanUnggulan.length
      ? ikanUnggulan.map(f=> `<span class="rec-chip good"><i data-feather="star" width="11"></i>${sanitize(f.name)} (${f.avg.toFixed(1)})</span>`).join('')
      : '<div class="rec-empty">Tidak ada ikan unggulan (â‰¥7)</div>';

    feather.replace();
  }
  /* ------------------ CHARTS ------------------ */
  function rebuildCharts(){
    clearTimeout(state.chartBuildTimer);
    state.chartBuildTimer = setTimeout(buildCharts, 250);
  }
  function filterByDashRange(records){
    const now = new Date();
    if(state.dashRange==='today') return records.filter(r=> isoDateOnly(r.date)===isoDateOnly(now));
    if(state.dashRange==='7d'){
      const c=new Date(); c.setDate(c.getDate()-7);
      return records.filter(r=> r.date>=c);
    }
    if(state.dashRange==='30d'){
      const c=new Date(); c.setDate(c.getDate()-30);
      return records.filter(r=> r.date>=c);
    }
    return records;
  }
  function buildCharts(){
    if(!$('#chartComparison')) return;
    const accent = state.accent;
    const base = state.myDataOnly
      ? state.fishData.filter(r=> r.userId===state.currentUser?.uid)
      : state.fishData.slice();
    const data = filterByDashRange(base);

    const markets = state.markets.length? state.markets: defaultMarkets;
    const marketAvg = markets.map(m=>{
      const subset = data.filter(r=> r.market===m);
      return subset.length? average(subset.map(r=> r.organoleptic)).toFixed(2):0;
    });
    if(!state.charts.comparison){
      state.charts.comparison = new Chart($('#chartComparison'),{
        type:'bar',
        data:{
          labels:markets,
          datasets:[{
            label: state.lang==='en'?'Avg Score':'Rata-rata Skor',
            data:marketAvg,
            backgroundColor: marketAvg.map(()=> `hsl(${accent}/0.65)`),
            borderRadius:8,
            borderSkipped:false
          }]
        },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,suggestedMax:9}} }
      });
    } else {
      state.charts.comparison.data.labels = markets;
      state.charts.comparison.data.datasets[0].data = marketAvg;
      state.charts.comparison.data.datasets[0].backgroundColor = marketAvg.map(()=> `hsl(${accent}/0.65)`);
      state.charts.comparison.update();
    }

    const byDate = {};
    data.forEach(r=>{
      const d = isoDateOnly(r.date);
      byDate[d] = byDate[d] || [];
      byDate[d].push(r.organoleptic);
    });
    const labels = Object.keys(byDate).sort((a,b)=> new Date(a)-new Date(b));
    const values = labels.map(d=> average(byDate[d]).toFixed(2));
    if(!state.charts.trend){
      state.charts.trend = new Chart($('#chartTrend'),{
        type:'line',
        data:{
          labels,
          datasets:[{
            label:'Skor',
            data:values,
            borderColor:`hsl(${accent}/0.95)`,
            backgroundColor:`hsl(${accent}/0.30)`,
            fill:true,
            tension:.35,
            pointRadius:4,
            pointBackgroundColor:`hsl(${accent}/0.95)`
          }]
        },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,suggestedMax:9}} }
      });
    } else {
      state.charts.trend.data.labels = labels;
      state.charts.trend.data.datasets[0].data = values;
      state.charts.trend.update();
    }

    const fishTypes = state.fishTypes.length? state.fishTypes: defaultFishTypes;
    const fishCounts = fishTypes.map(f=> data.filter(r=> r.fishType===f).length);
    if(!state.charts.pie){
      state.charts.pie = new Chart($('#chartPie'),{
        type:'pie',
        data:{
          labels:fishTypes,
          datasets:[{
            data:fishCounts,
            backgroundColor: fishTypes.map((_,i)=> `hsl(${accent}/${0.9 - i*0.08})`)
          }]
        },
        options:{ responsive:true, maintainAspectRatio:false }
      });
    } else {
      state.charts.pie.data.labels = fishTypes;
      state.charts.pie.data.datasets[0].data = fishCounts;
      state.charts.pie.data.datasets[0].backgroundColor = fishTypes.map((_,i)=> `hsl(${accent}/${0.9 - i*0.08})`);
      state.charts.pie.update();
    }
  }

  /* ------------------ QUALITY INDICATOR LIST ------------------ */
  function updateQualityList(){
    const container = $('#qualityIndicatorList');
    if(!container) return;
    const subset = state.filteredData
      .filter(r=>{
        if(state.qualityFilter==='all') return true;
        const st = computeQualityStatus(r.organoleptic).label;
        if(state.lang==='en'){
          if(state.qualityFilter==='baik') return st==='Good';
          if(state.qualityFilter==='sedang') return st==='Medium';
          if(state.qualityFilter==='buruk') return st==='Bad';
        } else {
          if(state.qualityFilter==='baik') return st==='Baik';
          if(state.qualityFilter==='sedang') return st==='Sedang';
          if(state.qualityFilter==='buruk') return st==='Buruk';
        }
        return true;
      })
      .slice(0,100);

    container.innerHTML = subset.map(r=>{
      const st = computeQualityStatus(r.organoleptic);
      const safety = computeSafetyStatus(r);
      return `
        <div class="quality-item" data-q-detail="${r.id}" title="Klik untuk detail">
          <div class="status-dot ${st.cls}"></div>
          <div>
            <div style="font-weight:700;letter-spacing:.4px;">${sanitize(r.fishType)}</div>
            <div style="font-size:.5rem;opacity:.75;">${sanitize(r.market)} â€¢ ${formatDate(r.date)} â€¢ Org ${r.organoleptic}</div>
            <div style="margin-top:.25rem;">${sanitize(r.smell)}, ${sanitize(r.texture)}, ${sanitize(r.color)}</div>
            <div class="quality-meta">
              <span class="quality-hazard-flag ${safety.safe?'safe':''}">
                <i data-feather="${safety.safe?'shield':'alert-triangle'}" width="10"></i>${safety.safe?(state.lang==='en'?'Safe':'Aman'):(state.lang==='en'?'Indication':'Indikasi')}
              </span>
              ${r.image? `<span class="tag-badge"><i data-feather="image" width="10"></i>Img</span>`:''}
              <span class="tag-badge" style="background:hsl(var(--accent)/0.35)">${st.label}</span>
            </div>
            <div class="quality-score">${r.organoleptic}</div>
          </div>
        </div>
      `;
    }).join('') || `<div class="small muted">${state.lang==='en'?'No data':'Tidak ada data.'}</div>`;

    feather.replace();
    $all('[data-q-detail]').forEach(el=>{
      el.onclick = ()=> openRecordDetail(el.getAttribute('data-q-detail'));
    });
  }

  /* ------------------ DETAIL MODAL ------------------ */
  function openRecordDetail(id){
    const rec = state.fishData.find(r=> r.id===id);
    if(!rec) return toast('Data tidak ditemukan','warn');
    const modal = $('#recordDetailModal');
    const grid = $('#detailGrid');
    const badges = $('#detailStatusBadges');
    const imgWrap = $('#detailImageWrapper');
    const hazWrap = $('#detailHazardsWrapper');

    const q = computeQualityStatus(rec.organoleptic);
    const s = computeSafetyStatus(rec);

    badges.innerHTML = `
      <span class="badge-soft"><i data-feather="calendar" width="11"></i>${formatDate(rec.date)}</span>
      <span class="badge-soft"><i data-feather="trending-up" width="11"></i>${rec.organoleptic}</span>
      <span class="badge-soft"><i data-feather="${s.safe?'shield':'alert-triangle'}" width="11"></i>${s.label}</span>
      <span class="badge-soft"><i data-feather="activity" width="11"></i>${q.label}</span>
    `;

    grid.innerHTML = `
      <div><span class="detail-label">Jenis Ikan</span><span>${sanitize(rec.fishType)}</span></div>
      <div><span class="detail-label">Pasar</span><span>${sanitize(rec.market)}</span></div>
      <div><span class="detail-label">Organoleptik</span><span>${rec.organoleptic}</span></div>
      <div><span class="detail-label">Bau</span><span>${sanitize(rec.smell)}</span></div>
      <div><span class="detail-label">Tekstur</span><span>${sanitize(rec.texture)}</span></div>
      <div><span class="detail-label">Warna</span><span>${sanitize(rec.color)}</span></div>
      <div><span class="detail-label">User</span><span>${sanitize(rec.userName)}</span></div>
      <div><span class="detail-label">User ID</span><span style="font-size:.48rem;word-break:break-all;">${rec.userId}</span></div>
      <div><span class="detail-label">Catatan Bahaya</span><span>${sanitize(rec.hazardNotes||'-')}</span></div>
      <div><span class="detail-label">Updated</span><span>${rec.updatedAt? formatDateTime(rec.updatedAt):'-'}</span></div>
    `;

    if(rec.image){
      imgWrap.innerHTML = `
        <div style="margin-top:.35rem;">
          <span class="detail-label">Gambar</span>
          <img src="${rec.image}" alt="img" class="detail-image">
        </div>
      `;
    } else imgWrap.innerHTML='';

    if((rec.hazards||[]).length){
      hazWrap.innerHTML = `
        <div style="display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.35rem;">
          ${(rec.hazards||[]).map(h=> `<span class="tag-badge"><i data-feather="alert-triangle" width="10"></i>${sanitize(h)}</span>`).join('')}
        </div>
      `;
    } else hazWrap.innerHTML='';

    modal.classList.add('show');
    feather.replace();
  }
  $('#closeRecordDetail')?.addEventListener('click', ()=> $('#recordDetailModal')?.classList.remove('show'));
  $('#recordDetailModal')?.addEventListener('click', e=>{
    if(e.target.id==='recordDetailModal') e.currentTarget.classList.remove('show');
  });

  /* ------------------ RENDER TABEL ------------------ */
  function renderTable(){
    const tbody = $('#dataTableBody');
    if(!tbody) return;
    tbody.innerHTML='';
    const role = state.userProfile?.role || 'Mahasiswa';

    if(!state.filteredData.length){
      $('#dataEmptyState')?.classList.remove('hidden');
    } else $('#dataEmptyState')?.classList.add('hidden');

    updatePaginationInfo();

    const pageData = getPagedData();
    const allOnPageSelected = pageData.every(r=> state.table.selected.has(r.id)) && pageData.length>0;
    const selectAllPageCb = $('#selectAllPage');
    if(selectAllPageCb) selectAllPageCb.checked = allOnPageSelected;

    pageData.forEach((r,i)=>{
      const st = computeQualityStatus(r.organoleptic);
      const safety = computeSafetyStatus(r);
      const canEdit = (r.userId===state.currentUser?.uid) || ['Admin','Petugas Pasar'].includes(role);
      const canDelete = role==='Admin' || (role==='Petugas Pasar' && r.userId===state.currentUser?.uid);
      const hazardBadge = safety.safe
        ? `<span class="hazard-badge safe"><i data-feather="shield" width="10"></i>${safety.label}</span>`
        : `<span class="hazard-badge"><i data-feather="alert-triangle" width="10"></i>${safety.label}</span>`;
      const tr = document.createElement('tr');
      const globalIndex = (state.table.page-1)*state.table.perPage + i + 1;
      tr.innerHTML = `
        <td><input type="checkbox" data-row-select="${r.id}" ${state.table.selected.has(r.id)?'checked':''} /></td>
        <td>${globalIndex}</td>
        <td>${formatDate(r.date)}</td>
        <td>${sanitize(r.fishType)}</td>
        <td>${sanitize(r.market)}</td>
        <td>${r.organoleptic}</td>
        <td>${sanitize(r.smell)}</td>
        <td>${sanitize(r.texture)}</td>
        <td>${sanitize(r.color)}</td>
        <td style="min-width:120px;">
          ${hazardBadge}
          ${(r.hazards||[]).length? `<div style="margin-top:.25rem;font-size:.45rem;">${r.hazards.map(h=> `<span style="display:inline-block;background:hsl(var(--accent)/0.2);padding:.15rem .4rem;border-radius:8px;margin:1px 2px;">${sanitize(h)}</span>`).join('')}</div>`:''}
        </td>
        <td>${r.image? `<button class="outline small" data-view-img="${r.id}" title="Lihat Gambar"><i data-feather="image" width="11"></i></button>`:'-'}</td>
        <td>
          <div class="inline">
            <div class="status-dot ${st.cls}"></div>
            <span style="font-size:.5rem;font-weight:700;">${st.label}</span>
          </div>
        </td>
        <td style="font-size:.5rem;cursor:pointer;" data-open-user="${r.userId}" title="Lihat Profil">
          ${sanitize(r.userName)}<br><span class="muted">${r.userId.substring(0,6)}...</span>
        </td>
        <td>
          <div class="actions">
            <button class="outline small" data-detail="${r.id}" title="Detail">
              <i data-feather="eye" width="11"></i>
            </button>
            ${canEdit? `<button class="outline small" data-edit="${r.id}" title="Edit"><i data-feather="edit-2" width="11"></i></button>`:''}
            ${canDelete? `<button class="outline danger small" data-del="${r.id}" title="Hapus"><i data-feather="trash" width="11"></i></button>`:''}
          </div>
        </td>
      `;
      if(r.id===state.lastAddedId){
        tr.classList.add('flash-new');
        setTimeout(()=> tr.classList.remove('flash-new'),2500);
      }
      tbody.appendChild(tr);
    });

    feather.replace();

    $all('[data-edit]').forEach(btn=> btn.onclick = ()=> enterEdit(btn.getAttribute('data-edit')));
    $all('[data-del]').forEach(btn=> btn.onclick = ()=> confirmDelete(btn.getAttribute('data-del')));
    $all('[data-view-img]').forEach(btn=> btn.onclick = ()=> viewImage(btn.getAttribute('data-view-img')));
    $all('[data-detail]').forEach(btn=> btn.onclick = ()=> openRecordDetail(btn.getAttribute('data-detail')));
    $all('[data-row-select]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const id = cb.getAttribute('data-row-select');
        if(cb.checked) state.table.selected.add(id); else state.table.selected.delete(id);
        updateSelectionInfo();
        toggleMultiActionBar();
      });
    });
    $all('[data-open-user]').forEach(cell=>{
      cell.addEventListener('click', ()=> openOtherUserProfile(cell.getAttribute('data-open-user')));
    });

    updateSelectionInfo();
  }

  function enterEdit(id){
    const rec = state.fishData.find(r=> r.id===id);
    if(!rec) return;
    setVal('#recordId', rec.id);
    setVal('#fishTypeInput', rec.fishType);
    setVal('#marketInput', rec.market);
    setVal('#organoleptic', rec.organoleptic);
    setVal('#smell', rec.smell);
    setVal('#texture', rec.texture);
    setVal('#colorField', rec.color);
    setVal('#hazardNotes', rec.hazardNotes || '');
    state.formHazards = [...(rec.hazards||[])];
    renderHazardChips();
    if(rec.image){
      state.formImageData = rec.image;
      $('#fishImagePreview').innerHTML = `<img src="${rec.image}" alt="fish">`;
    } else {
      state.formImageData = null;
      $('#fishImagePreview').innerHTML='';
    }
    $('#submitDataBtn span, #submitDataBtn').textContent = state.lang==='en'?'Update Data':'Update Data';
    $('#cancelEditBtn').style.display='inline-flex';
    showView('form');
    toast(state.lang==='en'?'Edit mode':'Mode edit data','info',2200);
  }

  function confirmDelete(id){
    Modal.open({
      title: state.lang==='en'?'Delete Data':'Hapus Data',
      message: state.lang==='en'?'Are you sure to delete this record?':'Yakin menghapus data ini?',
      icon:'trash-2',
      confirmText: state.lang==='en'?'Delete':'Hapus',
      onConfirm: async ()=>{
        try{
          await db.collection('fishQuality').doc(id).delete();
          toast(state.lang==='en'?'Deleted':'Data dihapus','success');
          state.table.selected.delete(id);
          updateSelectionInfo();
          toggleMultiActionBar();
        }catch(err){
          toast('Gagal hapus','danger');
        }
      }
    });
  }

  function deleteSelectedBulk(){
    if(!state.table.selected.size) return;
    Modal.open({
      title: state.lang==='en'?'Delete Selected':'Hapus Terpilih',
      message: `${state.lang==='en'?'Delete':'Hapus'} ${state.table.selected.size} ${state.lang==='en'?'records?':'data?'} `,
      icon:'trash',
      confirmText: state.lang==='en'?'Delete':'Hapus',
      onConfirm: async ()=>{
        const ids = Array.from(state.table.selected);
        let ok=0, fail=0;
        for(const id of ids){
          try { await db.collection('fishQuality').doc(id).delete(); ok++; }
          catch { fail++; }
        }
        toast(`${state.lang==='en'?'Done':'Selesai'}: ${ok} OK, ${fail} Gagal`,'info',5000);
        state.table.selected.clear();
        updateSelectionInfo();
        toggleMultiActionBar();
      }
    });
  }

  function viewImage(id){
    const rec = state.fishData.find(r=> r.id===id);
    if(!rec || !rec.image) return toast(state.lang==='en'?'No image':'Gambar tidak ada','warn');
    let modalImg = $('#imgModal');
    if(!modalImg){
      modalImg = document.createElement('div');
      modalImg.id='imgModal';
      modalImg.style.cssText='position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);z-index:5000;padding:1rem;';
      modalImg.innerHTML = `
        <div style="background:#fff;max-width:92%;max-height:90%;border-radius:20px;position:relative;padding:1rem 1.2rem 1.2rem;display:flex;flex-direction:column;gap:.6rem;">
          <button id="closeImgModal" class="outline small" style="position:absolute;top:.5rem;right:.5rem;"><i data-feather="x" width="14"></i></button>
          <div style="font-size:.6rem;font-weight:700;letter-spacing:.5px;">Gambar</div>
            <img id="imgModalPic" src="${rec.image}" style="max-width:100%;max-height:70vh;border-radius:10px;object-fit:contain;">
          <div id="imgModalCaption" style="font-size:.55rem;opacity:.7;">${sanitize(rec.fishType)} - ${sanitize(rec.market)}</div>
        </div>
      `;
      document.body.appendChild(modalImg);
      feather.replace();
      modalImg.addEventListener('click', e=> { if(e.target===modalImg) modalImg.remove(); });
      $('#closeImgModal').onclick = ()=> modalImg.remove();
    } else {
      $('#imgModalPic').src = rec.image;
      $('#imgModalCaption').textContent = `${rec.fishType} - ${rec.market}`;
      modalImg.style.display='flex';
    }
  }

  function resetForm(){
    setVal('#recordId','');
    setVal('#fishTypeInput', state.userProfile?.defaultFishType || '');
    setVal('#marketInput', state.userProfile?.defaultMarket || '');
    ['#organoleptic','#smell','#texture','#colorField','#hazardNotes'].forEach(sel=> setVal(sel,''));
    state.formImageData = null;
    state.formHazards = [];
    renderHazardChips();
    const img = $('#fishImage'); if(img) img.value='';
    const prev = $('#fishImagePreview'); if(prev) prev.innerHTML='';
    $('#submitDataBtn span, #submitDataBtn').textContent = state.lang==='en'?'Save Data':'Simpan Data';
    $('#cancelEditBtn').style.display='none';
    setVal('#dateAuto', nowDateInput());
  }

  /* ------------------ FIRESTORE: USER PROFILE ------------------ */
  async function loadUserProfile(uid){
    const doc = await db.collection('users').doc(uid).get();
    if(doc.exists){
  const data = doc.data();
  state.userProfile = {
    id: doc.id,
    ...data,
    achievements: data.achievements || {}   // <--- TAMBAHKAN INI
  };
} else {
  state.userProfile = {
    id: uid,
    name: state.currentUser.displayName || 'Pengguna',
    email: state.currentUser.email,
    role:'Mahasiswa',
    studentId:'', lecturerId:'', officerId:'',
    defaultFishType:'', defaultMarket:'',
    photo:'',
    achievements: {},                       // <--- TAMBAHKAN INI
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    emailVerified: state.currentUser.emailVerified,
    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
  };
  await db.collection('users').doc(uid).set(state.userProfile);
}
  }

  /* ------------------ SUBSCRIBE METADATA & DATA ------------------ */
  function subscribeMetadata(){
    state.metadataUnsub.fish && state.metadataUnsub.fish();
    state.metadataUnsub.fish = db.collection('metaFishTypes').orderBy('name','asc')
      .onSnapshot(snap=>{
        const names = new Set(defaultFishTypes);
        snap.docs.forEach(d=> names.add(d.data().name));
        state.fishTypes = Array.from(names).sort();
        populateDynamic();
      });

    state.metadataUnsub.markets && state.metadataUnsub.markets();
    state.metadataUnsub.markets = db.collection('metaMarkets').orderBy('name','asc')
      .onSnapshot(snap=>{
        const names = new Set(defaultMarkets);
        snap.docs.forEach(d=> names.add(d.data().name));
        state.markets = Array.from(names).sort();
        populateDynamic();
      });
  }

  function subscribeData(){
    if(state.metadataUnsub.data) state.metadataUnsub.data();
    state.metadataUnsub.data = db.collection('fishQuality')
      .orderBy('createdAt','desc')
      .onSnapshot(snap=>{
        const oldIds = new Set(state.fishData.map(r=> r.id));
        state.fishData = snap.docs.map(d=>{
          const data = d.data();
            return {
              id: d.id,
              ...data,
              hazards: data.hazards || [],
              hazardNotes: data.hazardNotes || '',
              date: data.date
                ? (data.date.toDate ? data.date.toDate(): data.date)
                : (data.createdAt? (data.createdAt.toDate? data.createdAt.toDate(): data.createdAt): new Date()),
              updatedAt: data.updatedAt? (data.updatedAt.toDate? data.updatedAt.toDate(): data.updatedAt): null
            };
        });
        snap.docChanges().forEach(ch=>{
          if(ch.type==='added' && !oldIds.has(ch.doc.id)){
            state.lastAddedId = ch.doc.id;
          }
        });
        applyFilters();
        updateDashboard();
        rebuildCharts();
        updateProfileStats();
      });
  }

  /* ================== SENSOR SUHU (Firestore) ================== */
  function subscribeSensors(){
    // Bersihkan bila sudah ada
    if(state.sensors.unsub) { state.sensors.unsub(); state.sensors.unsub=null; }
    state.sensors.unsub = db.collection('sensorTemperatures')
      .orderBy('createdAt','desc')
      .limit(50)
      .onSnapshot(snap=>{
        state.sensors.readings = snap.docs.map(d=> ({
          id: d.id,
          ...d.data(),
          createdAt: d.data().createdAt ? (d.data().createdAt.toDate ? d.data().createdAt.toDate() : d.data().createdAt) : new Date()
        }));
        renderSensorList();
        updateSensorStatsAndChart();
        updateSensorIndicatorTile();
      }, err=>{
        toast('Gagal ambil sensor: '+err.message,'danger');
      });
  }

  function renderSensorList(){
    const list = $('#sensorList');
    const empty = $('#sensorEmpty');
    if(!list) return;
    const arr = state.sensors.readings;
    if(!arr.length){
      list.innerHTML='';
      empty && (empty.style.display='block');
      return;
    }
    empty && (empty.style.display='none');
    list.innerHTML = arr.map(r=>{
      const val = typeof r.value==='number' ? r.value.toFixed(2) : r.value;
      const status = r.status || (val>30 ? 'ALERT':'OK');
      return `
        <div class="sensor-item">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.4rem;">
            <span style="font-weight:700;">${val} ${r.unit||'Â°C'}</span>
            <span class="sensor-badge ${status==='ALERT'?'alert':'ok'}">
              <i data-feather="thermometer" width="10"></i>${status}
            </span>
          </div>
          <div style="display:flex;gap:.6rem;flex-wrap:wrap;font-size:.48rem;opacity:.8;">
            <span>ID: ${sanitize(r.sourceId||'-')}</span>
            <span>${formatDateTime(r.createdAt)}</span>
          </div>
          ${r.note? `<div style="font-size:.48rem;opacity:.75;">${sanitize(r.note)}</div>`:''}
        </div>
      `;
    }).join('');
    feather.replace();
  }

  function updateSensorStatsAndChart(){
    const arr = [...state.sensors.readings].reverse(); // ascending waktu
    if(!arr.length) {
      if(state.sensors.chart){
        state.sensors.chart.data.labels=[];
        state.sensors.chart.data.datasets[0].data=[];
        state.sensors.chart.update();
      }
      $('#sensorStats') && ($('#sensorStats').textContent='Tidak ada data.');
      return;
    }
    // Filter jam terakhir (1 jam) -> opsional
    const oneHourAgo = Date.now() - 3600*1000;
    const lastHour = arr.filter(r=> r.createdAt.getTime() >= oneHourAgo);
    const base = lastHour.length ? lastHour : arr;
    const labels = base.map(r=> r.createdAt.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}));
    const values = base.map(r=> typeof r.value==='number'? r.value : parseFloat(r.value)||0);

    if(!state.sensors.chart){
      const ctx = $('#sensorChart');
      if(!ctx) return;
      state.sensors.chart = new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[{
            label:'Suhu (Â°C)',
            data:values,
            borderColor:`hsl(${state.accent}/0.95)`,
            backgroundColor:`hsl(${state.accent}/0.25)`,
            tension:.35,
            fill:true,
            pointRadius:3
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{display:false} },
          scales:{ y:{ beginAtZero:false } }
        }
      });
    } else {
      state.sensors.chart.data.labels = labels;
      state.sensors.chart.data.datasets[0].data = values;
      state.sensors.chart.update();
    }

    const avg = values.reduce((a,b)=>a+b,0)/values.length;
    const min = Math.min(...values);
    const max = Math.max(...values);
    $('#sensorStats') && ($('#sensorStats').textContent =
      `Data: ${values.length} â€¢ Avg: ${avg.toFixed(2)}Â°C â€¢ Min: ${min.toFixed(2)}Â°C â€¢ Max: ${max.toFixed(2)}Â°C`
    );
  }

    function updateSensorIndicatorTile(){
    const avgEl   = $('#indTempAvg');
    const trendEl = $('#indTempTrend');
    const statusEl= $('#indTempStatus');
    const noteEl  = $('#indTempNote');
    const fillEl  = $('#indTempRangeFill');
    const tile    = $('#sensorIndicatorTile');

    if(!avgEl || !tile) return;

    const arr = state.sensors.readings;
    if(!arr.length){
      avgEl.textContent='-';
      trendEl && (trendEl.textContent='--');
      statusEl && (statusEl.textContent='-');
      tile.classList.remove('temp-cold','temp-ideal','temp-warn','temp-alert');
      return;
    }

    // Hitung jendela 5 menit vs 5 menit sebelumnya (mirip versi lama)
    const now = Date.now();
    const win = 5*60*1000;
    const prevStart = now - 2*win;
    const prevEnd   = now - win;
    const curStart  = now - win;

    const cur = arr.filter(r=> r.createdAt.getTime() >= curStart);
    const prev= arr.filter(r=> r.createdAt.getTime() >= prevStart && r.createdAt.getTime() < prevEnd);

    function numeric(a){ return typeof a==='number'? a : parseFloat(a)||0; }
    const curVals  = cur.map(r=> numeric(r.value));
    const prevVals = prev.map(r=> numeric(r.value));

    const curAvg = curVals.length? curVals.reduce((a,b)=>a+b,0)/curVals.length : 0;
    const prevAvg= prevVals.length? prevVals.reduce((a,b)=>a+b,0)/prevVals.length : 0;

    avgEl.textContent = curVals.length? curAvg.toFixed(2): '-';

    // Trend
    let trendTxt='--';
    if(curVals.length && prevVals.length){
      const diff = curAvg - prevAvg;
      const pct  = prevAvg!==0? (diff/prevAvg)*100 : 0;
      const arrow= diff>0.15 ? 'â–²' : diff<-0.15 ? 'â–¼' : 'â–¬';
      trendTxt = `${arrow} ${(pct>0?'+':'')+pct.toFixed(1)}%`;
    }
    trendEl && (trendEl.textContent = trendTxt);

    // Status range & kelas dinamis
    // Rentang rekomendasi: 2â€“4Â°C (contoh untuk ikan segar)
    let statusLabel='-';
    let statusClass='ideal';
    if(!curVals.length){
      statusLabel='-';
      statusClass='';
    } else if(curAvg < 2){
      statusLabel='Dingin'; statusClass='cold';
    } else if(curAvg >=2 && curAvg <=4){
      statusLabel='Ideal'; statusClass='ideal';
    } else if(curAvg >4 && curAvg <=8){
      statusLabel='Waspada'; statusClass='warn';
    } else {
      statusLabel='Alert'; statusClass='alert';
    }

    statusEl && (statusEl.textContent = statusLabel);
    statusEl && statusEl.classList.remove('cold','ideal','warn','alert');
    statusEl && statusEl.classList.add(statusClass);

    tile.classList.remove('temp-cold','temp-ideal','temp-warn','temp-alert');
    if(statusClass) tile.classList.add('temp-'+statusClass);

    // Progress fill (0â€“12Â°C baseline; ubah jika perlu)
    if(fillEl){
      const maxRef = 12;
      const perc = Math.max(0, Math.min(100, (curAvg / maxRef)*100));
      fillEl.style.width = perc + '%';
    }

    // Note dinamis
    if(noteEl){
      if(statusClass==='ideal') noteEl.textContent='Status Ideal (2â€“4Â°C)';
      else if(statusClass==='cold') noteEl.textContent='Terlalu Dingin (<2Â°C) â€“ periksa over-chilling';
      else if(statusClass==='warn') noteEl.textContent='Di atas batas ideal (>4Â°C) â€“ perhatikan penanganan';
      else if(statusClass==='alert') noteEl.textContent='ALERT! >8Â°C â€” risiko mutu menurun cepat';
      else noteEl.textContent='Rentang target ideal 2â€“4Â°C';
    }
  }

  async function addManualSensorReading(val, sourceId, note){
    try{
      await db.collection('sensorTemperatures').add({
        value: val,
        unit: 'Â°C',
        sourceId: sourceId || 'manual',
        note: note || '',
        status: (val>30 ? 'ALERT':'OK'),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      toast('Data sensor disimpan','success');
    }catch(err){
      toast('Gagal simpan sensor','danger');
    }
  }
  
  /* ------------------ SOSIAL POSTS / REACTIONS / KOMENTAR ------------------ */
  function subscribeSocial(){
    if(state.metadataUnsub.social) state.metadataUnsub.social();
    state.metadataUnsub.social = db.collection('socialPosts')
      .orderBy('createdAt','desc')
      .limit(200)
      .onSnapshot(snap=>{
        state.social.posts = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
        renderSocialFeed();
      });
  }

  async function loadSocialUsers(){
    const snap = await db.collection('users').orderBy('name').get();
    state.social.usersCache = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
    renderSocialUsers();
  }

  function renderSocialUsers(){
    const wrap = $('#socialUsersList');
    if(!wrap) return;
    wrap.innerHTML = state.social.usersCache.map(u=> `
      <div class="social-user-item" data-view-user="${u.id}" title="Klik untuk lihat profil">
        <div class="avatar-mini">
          ${u.photo? `<img src="${u.photo}" alt="">` : sanitize((u.name||'U').substring(0,1).toUpperCase())}
        </div>
        <div style="flex:1;">
          <div style="font-weight:700;">${sanitize(u.name||'')}</div>
          <div style="font-size:.46rem;opacity:.8;">${sanitize(u.email||'')}</div>
          <div style="margin-top:.25rem;">
            <span class="social-post-role">${sanitize(u.role||'')}</span>
          </div>
        </div>
      </div>
    `).join('') || '<div class="small muted">Tidak ada pengguna.</div>';
    feather.replace();
    $all('[data-view-user]').forEach(el=>{
      el.addEventListener('click', ()=> openOtherUserProfile(el.getAttribute('data-view-user')));
    });
  }

  function renderSocialFeed(){
    const feed = $('#socialFeed');
    const empty = $('#socialEmpty');
    if(!feed) return;
    if(!state.social.posts.length){
      empty?.classList.remove('hidden');
      feed.innerHTML='';
      return;
    }
    empty?.classList.add('hidden');

    feed.innerHTML = state.social.posts.map(p=>{
      const likes = (p.likes||[]).length;
      const dislikes = (p.dislikes||[]).length;
      const userLiked = state.currentUser && (p.likes||[]).includes(state.currentUser.uid);
      const userDisliked = state.currentUser && (p.dislikes||[]).includes(state.currentUser.uid);
      const commentsOpen = state.social.openComments.has(p.id);
      const commentCount = p.commentCount || 0;
      return `
        <div class="social-post" data-post-id="${p.id}">
          <div class="social-post-header">
            <div style="display:flex;align-items:center;gap:.45rem;cursor:pointer;" data-view-user="${p.userId}">
              <div style="width:34px;height:34px;border-radius:12px;overflow:hidden;background:linear-gradient(135deg,hsl(var(--accent)/0.3),hsl(var(--accent)/0.5));display:grid;place-items:center;font-size:.65rem;color:#fff;font-weight:700;">
                ${p.userPhoto? `<img src="${p.userPhoto}" style="width:100%;height:100%;object-fit:cover;">` : sanitize((p.userName||'U').substring(0,1).toUpperCase())}
              </div>
              <div>
                <div style="font-size:.58rem;font-weight:700;">${sanitize(p.userName||'')}</div>
                <div style="font-size:.45rem;opacity:.75;">${sanitize(p.userRole||'')}</div>
              </div>
            </div>
            <div class="social-post-time">${p.createdAt? formatDateTime(p.createdAt): ''}</div>
          </div>
          <div class="social-post-content">${sanitize(p.content||'')}</div>
          ${p.image? `<img class="social-post-image" src="${p.image}" alt="post-img">`:''}
          <div class="social-post-reactions">
            <button class="reaction-btn ${userLiked?'active':''}" data-like="${p.id}">
              ðŸ‘ <span>${likes}</span>
            </button>
            <button class="reaction-btn ${userDisliked?'active':''}" data-dislike="${p.id}">
              ðŸ‘Ž <span>${dislikes}</span>
            </button>
            <button class="reaction-btn" data-toggle-comments="${p.id}">
              ðŸ’¬ <span>${commentCount}</span>
            </button>
            <button class="reaction-btn" data-open-detail-post="${p.refRecordId||''}" ${p.refRecordId?'':'disabled'} style="${p.refRecordId?'':'opacity:.4;cursor:not-allowed;'}">
              <i data-feather="file-text" width="11"></i>
            </button>
            ${(state.currentUser && (p.userId===state.currentUser.uid || state.userProfile?.role==='Admin')) ?
              `<button class="reaction-btn" data-del-post="${p.id}" style="background:linear-gradient(135deg,#ef4444,#b91c1c);color:#fff;">
                 <i data-feather="trash" width="11"></i>
               </button>` : ''
            }
          </div>
          <div id="comments_${p.id}" class="${commentsOpen?'':'hidden'}"></div>
        </div>
      `;
    }).join('');
    feather.replace();

    $all('[data-view-user]').forEach(el=>{
      el.addEventListener('click', e=>{
        e.stopPropagation();
        openOtherUserProfile(el.getAttribute('data-view-user'));
      });
    });
    $all('[data-del-post]').forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute('data-del-post');
        Modal.open({
          title: state.lang==='en'?'Delete Post':'Hapus Post',
          message: state.lang==='en'?'Delete this post?':'Yakin hapus posting ini?',
          icon:'trash',
            confirmText: state.lang==='en'?'Delete':'Hapus',
          onConfirm: async ()=>{
            try{ await db.collection('socialPosts').doc(id).delete(); toast('Post dihapus','success'); }
            catch{ toast('Gagal hapus','danger'); }
          }
        });
      };
    });
    $all('[data-open-detail-post]').forEach(b=>{
      b.onclick = ()=>{
        const rid = b.getAttribute('data-open-detail-post');
        if(rid) openRecordDetail(rid);
      };
    });
    $all('[data-like]').forEach(btn=>{
      btn.onclick = ()=> toggleReaction(btn.getAttribute('data-like'),'like');
    });
    $all('[data-dislike]').forEach(btn=>{
      btn.onclick = ()=> toggleReaction(btn.getAttribute('data-dislike'),'dislike');
    });
    $all('[data-toggle-comments]').forEach(btn=>{
      btn.onclick = ()=> toggleCommentsBox(btn.getAttribute('data-toggle-comments'));
    });
    state.social.openComments.forEach(id=> renderCommentsBox(id));
  }

  async function toggleReaction(postId, type){
    if(!state.currentUser) return toast('Harus login','warn');
    const ref = db.collection('socialPosts').doc(postId);
    try{
      await db.runTransaction(async tx=>{
        const snap = await tx.get(ref);
        if(!snap.exists) return;
        const data = snap.data();
        const uid = state.currentUser.uid;
        let likes = data.likes||[];
        let dislikes = data.dislikes||[];
        if(type==='like'){
          if(likes.includes(uid)){
            likes = likes.filter(x=> x!==uid);
          } else {
            likes.push(uid);
            dislikes = dislikes.filter(x=> x!==uid);
          }
        } else {
          if(dislikes.includes(uid)){
            dislikes = dislikes.filter(x=> x!==uid);
          } else {
            dislikes.push(uid);
            likes = likes.filter(x=> x!==uid);
          }
        }
        tx.update(ref,{ likes, dislikes });
      });
    }catch{
      toast('Gagal reaksi','danger');
    }
  }

  function toggleCommentsBox(postId){
    if(state.social.openComments.has(postId)){
      state.social.openComments.delete(postId);
      unsubscribeComments(postId);
      renderSocialFeed();
    } else {
      state.social.openComments.add(postId);
      renderSocialFeed();
      subscribeComments(postId);
    }
  }

  function subscribeComments(postId){
    unsubscribeComments(postId);
    const ref = db.collection('socialPosts').doc(postId).collection('comments').orderBy('createdAt','asc');
    const unsub = ref.onSnapshot(snap=>{
      const comments = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
      renderComments(postId, comments);
      db.collection('socialPosts').doc(postId).update({ commentCount: comments.length }).catch(()=>{});
    });
    state.social.commentUnsubs[postId] = unsub;
  }
  function unsubscribeComments(postId){
    if(state.social.commentUnsubs[postId]){
      state.social.commentUnsubs[postId]();
      delete state.social.commentUnsubs[postId];
    }
  }

  function renderCommentsBox(postId){ subscribeComments(postId); }

  function renderComments(postId, comments){
    const box = $('#comments_'+postId);
    if(!box) return;
    const canComment = !!state.currentUser;
    box.classList.remove('hidden');
    box.innerHTML = `
      <div class="comments-box">
        <div style="font-size:.52rem;font-weight:700;letter-spacing:.4px;display:flex;align-items:center;gap:.4rem;">
          <i data-feather="message-square" width="11"></i> Komentar
        </div>
        <div id="commentList_${postId}" style="display:flex;flex-direction:column;gap:.45rem;">
          ${
            comments.map(c=> {
              const own = state.currentUser && c.userId===state.currentUser.uid;
              const canDel = own || state.userProfile?.role==='Admin';
              return `
                <div class="comment-item">
                  <div style="width:28px;height:28px;border-radius:9px;overflow:hidden;background:linear-gradient(135deg,hsl(var(--accent)/0.3),hsl(var(--accent)/0.5));display:grid;place-items:center;font-size:.55rem;color:#fff;font-weight:700;">
                    ${c.userPhoto? `<img src="${c.userPhoto}" style="width:100%;height:100%;object-fit:cover;">` : sanitize((c.userName||'U').substring(0,1).toUpperCase())}
                  </div>
                  <div style="flex:1;">
                    <div style="font-weight:700;font-size:.52rem;">${sanitize(c.userName||'')}</div>
                    <div style="font-size:.55rem;line-height:1.35;margin-top:.15rem;white-space:pre-wrap;">${sanitize(c.content||'')}</div>
                    <div class="comment-meta">
                      <span>${c.createdAt? formatDateTime(c.createdAt):''}</span>
                    </div>
                  </div>
                  ${canDel? `<button class="del-comment-btn" data-del-comment="${postId}|${c.id}" title="Hapus"><i data-feather="x" width="10"></i></button>`:''}
                </div>
              `;
            }).join('')
          }
          ${comments.length===0? `<div class="small muted" style="text-align:center;">Belum ada komentar.</div>`:''}
        </div>
        ${canComment? `
          <form class="comment-form" data-comment-form="${postId}">
            <textarea placeholder="Tulis komentar..." maxlength="400" required></textarea>
            <button class="outline small" type="submit" style="align-self:flex-end;">
              <i data-feather="send" width="11"></i>
            </button>
          </form>
        `: `<div class="small muted">${state.lang==='en'?'Login to comment':'Login untuk berkomentar.'}</div>`}
      </div>
    `;
    feather.replace();

    $all('[data-del-comment]').forEach(btn=>{
      btn.onclick = ()=>{
        const [pid,cid] = btn.getAttribute('data-del-comment').split('|');
        Modal.open({
          title: state.lang==='en'?'Delete Comment':'Hapus Komentar',
          message: state.lang==='en'?'Delete this comment?':'Yakin menghapus komentar?',
          icon:'trash',
          confirmText: state.lang==='en'?'Delete':'Hapus',
          onConfirm: async ()=>{
            try{
              await db.collection('socialPosts').doc(pid).collection('comments').doc(cid).delete();
              toast('Komentar dihapus','success');
            }catch{
              toast('Gagal hapus komentar','danger');
            }
          }
        });
      };
    });

    const form = box.querySelector(`[data-comment-form="${postId}"]`);
    if(form){
      form.onsubmit = async e=>{
        e.preventDefault();
        if(!state.currentUser) return toast('Login dulu','warn');
        const ta = form.querySelector('textarea');
        const content = ta.value.trim();
        if(!content) return;
        try{
          await db.collection('socialPosts').doc(postId).collection('comments').add({
            content,
            userId: state.userProfile.id,
            userName: state.userProfile.name,
            userPhoto: state.userProfile.photo || '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          ta.value='';
          toast('Komentar ditambahkan','success');
        }catch{
          toast('Gagal komentar','danger');
        }
      };
    }
  }

  function bindSocialForm(){
    $('#socialPostImage')?.addEventListener('change', async e=>{
      const file = e.target.files[0];
      if(!file){ state.social.imageData=null; $('#socialImagePreview').textContent=''; return; }
      try{
        state.social.imageData = await compressImage(file,900);
        $('#socialImagePreview').innerHTML = `<span style="color:var(--ok);font-weight:600;">Gambar siap (${Math.round(state.social.imageData.length/1024)} KB)</span>
          <button type="button" class="btn-mini-inline" id="btnRemoveSocialImg"><i data-feather="x" width="10"></i>Hapus</button>`;
        $('#btnRemoveSocialImg').onclick = ()=>{
          state.social.imageData=null;
            $('#socialPostImage').value='';
            $('#socialImagePreview').innerHTML='';
        };
        feather.replace();
      }catch{
        toast('Gagal proses gambar','danger');
      }
    });
    $('#btnClearPost')?.addEventListener('click', ()=>{
      $('#socialPostContent').value='';
      $('#socialPostImage').value='';
      state.social.imageData=null;
      $('#socialImagePreview').innerHTML='';
    });
    $('#btnSubmitPost')?.addEventListener('click', async ()=>{
      const content = $('#socialPostContent')?.value.trim();
      if(!content) return showAlert('socialPostAlert','warn', state.lang==='en'?'Content empty':'Konten kosong');
      if(!state.currentUser) return toast('Harus login','warn');
      try{
        await db.collection('socialPosts').add({
          content,
          image: state.social.imageData || '',
          userId: state.userProfile.id,
          userName: state.userProfile.name,
          userRole: state.userProfile.role,
          userPhoto: state.userProfile.photo || '',
          refRecordId: '', // dapat diisi ID data fishQuality terkait
          likes:[],
          dislikes:[],
          commentCount:0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        $('#socialPostContent').value='';
        state.social.imageData=null;
        $('#socialPostImage').value='';
        $('#socialImagePreview').innerHTML='';
        toast('Post dikirim','success');
      }catch(err){
        showAlert('socialPostAlert','danger','Gagal: '+err.message);
        toast('Gagal kirim','danger');
      }
    });
  }

  /* ------------------ PROFIL PENGGUNA LAIN (MODAL) ------------------ */
  async function openOtherUserProfile(uid){
    if(!uid) return;
    try{
      const doc = await db.collection('users').doc(uid).get();
      if(!doc.exists) return toast('User tidak ditemukan','warn');
      const u = doc.data();
      const modal = $('#userProfileModal');
      const c = $('#userProfileContent');
      c.innerHTML = `
        <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
          <div class="avatar" style="width:86px;height:86px;border-radius:24px;font-size:1.6rem;">
            ${u.photo? `<img src="${u.photo}" alt="pfp" style="object-fit:cover;width:100%;height:100%;">`: sanitize((u.name||'U').substring(0,1).toUpperCase())}
          </div>
          <div style="flex:1;min-width:150px;">
            <div style="font-size:.85rem;font-weight:700;letter-spacing:.5px;">${sanitize(u.name||'')}</div>
            <div style="font-size:.55rem;opacity:.8;margin-top:.2rem;">${sanitize(u.email||'')}</div>
            <div style="margin-top:.4rem;">
              <span class="badge-role" style="background:hsl(var(--accent)/0.45)">${sanitize(u.role||'')}</span>
            </div>
          </div>
        </div>
        <div style="font-size:.55rem;display:flex;flex-direction:column;gap:.35rem;margin-top:.4rem;">
          <div><strong>Created:</strong> ${u.createdAt? formatDateTime(u.createdAt):'-'}</div>
          <div><strong>Last Login:</strong> ${u.lastLogin? formatDateTime(u.lastLogin):'-'}</div>
          ${u.studentId? `<div><strong>NIM:</strong> ${sanitize(u.studentId)}</div>`:''}
          ${u.lecturerId? `<div><strong>NIP:</strong> ${sanitize(u.lecturerId)}</div>`:''}
          ${u.officerId? `<div><strong>ID Petugas:</strong> ${sanitize(u.officerId)}</div>`:''}
          <div><strong>Email Verified:</strong> ${u.emailVerified?'Ya':'Belum'}</div>
        </div>
      `;
      modal.classList.add('show');
      feather.replace();
    }catch{
      toast('Gagal memuat profil','danger');
    }
  }
  $('#closeUserProfileModal')?.addEventListener('click', ()=> $('#userProfileModal')?.classList.remove('show'));
  $('#userProfileModal')?.addEventListener('click', e=>{
    if(e.target.id==='userProfileModal') e.currentTarget.classList.remove('show');
  });

  /* ------------------ MENAMBAH META FISH / MARKET DINAMIS ------------------ */
  async function addNewFishType(name){
    name = (name||'').trim();
    if(!name || state.fishTypes.includes(name)) return;
    try {
      await db.collection('metaFishTypes').add({
        name,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: state.currentUser.uid
      });
      toast('Jenis ikan ditambahkan','success');
    } catch { toast('Gagal tambah ikan','danger'); }
  }
  async function addNewMarket(name){
    name = (name||'').trim();
    if(!name || state.markets.includes(name)) return;
    try {
      await db.collection('metaMarkets').add({
        name,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: state.currentUser.uid
      });
      toast('Pasar ditambahkan','success');
    } catch { toast('Gagal tambah pasar','danger'); }
  }

  /* ------------------ REFRESH USER UI ------------------ */
  function refreshUserUI(){
    const u = state.userProfile || {};
    if($('#avatarInitial')) $('#avatarInitial').textContent = (u.name||'U').substring(0,1).toUpperCase();
    if(u.photo){
      $('#avatarImg')?.classList.remove('hidden');
      $('#avatarImg').src = u.photo;
      $('#avatarInitial')?.classList.add('hidden');
    } else {
      $('#avatarImg')?.classList.add('hidden');
      $('#avatarInitial')?.classList.remove('hidden');
    }
    const sideInfo = $('#sidebarUserInfo');
    if(sideInfo){
      sideInfo.innerHTML = `
        <div style="font-weight:700;">${sanitize(u.name||'')}</div>
        <div style="font-size:.48rem;letter-spacing:.5px;">${sanitize(u.email||'')}</div>
        <div class="badge-role" style="margin-top:.3rem;">${sanitize(u.role||'')}</div>
        <div style="margin-top:.3rem;font-size:.48rem;">Verif: ${u.emailVerified?'Ya':'Belum'}</div>
      `;
    }
    const setInfo = $('#settingsUserInfo');
    if(setInfo){
      setInfo.innerHTML = `
        <strong>${sanitize(u.name||'')}</strong><br>
        ${sanitize(u.email||'')}<br>
        Role: <span class="inline-stat">${sanitize(u.role||'')}</span><br>
        Email Verified: <span class="inline-stat">${u.emailVerified?'YES':'NO'}</span><br>
        ${u.studentId? 'NIM: '+sanitize(u.studentId)+'<br>':''}
        ${u.lecturerId? 'NIP: '+sanitize(u.lecturerId)+'<br>':''}
        ${u.officerId? 'ID: '+sanitize(u.officerId)+'<br>':''}
      `;
    }
    setVal('#profName', u.name||'');
    setVal('#profEmail', u.email||'');
    setVal('#profRole', u.role||'Mahasiswa');
    setVal('#profVerified', u.emailVerified? 'Ya':'Belum');
    setVal('#profStudentId', u.studentId||'');
    setVal('#profLecturerId', u.lecturerId||'');
    setVal('#profOfficerId', u.officerId||'');

    toggle('#profFieldStudent', u.role!=='Mahasiswa');
    toggle('#profFieldLecturer', u.role!=='Dosen');
    toggle('#profFieldOfficer', u.role!=='Petugas Pasar');
    toggle('#profFieldOther',  u.role!=='Lainnya');

    if(u.role==='Mahasiswa'){
      toggle('#studentFieldWrapper', false);
      setVal('#studentNIMForm', u.studentId||'');
    } else toggle('#studentFieldWrapper', true);

    if($('#lastLoginField')) $('#lastLoginField').value = u.lastLogin
      ? formatDateTime(u.lastLogin)
      : '-';
    if($('#createdAtField')) $('#createdAtField').value = u.createdAt
      ? formatDateTime(u.createdAt)
      : '-';

    populateDynamic();
    updateProfileStats();

    if(u.role==='Admin'){
      loadAllUsersForRoleManagement();
      loadAllUsersForDeletion();
      toggle('.admin-notif-panel', false);
    } else {
      const r = $('#roleMgmt');
      if(r) r.innerHTML = '<em class="muted" style="font-size:.55rem;">Hanya Admin.</em>';
      const d = $('#adminUserDelete');
      if(d) d.innerHTML='';
      toggle('.admin-notif-panel', true);
    }
    feather.replace();
  }

  async function loadAllUsersForRoleManagement(){
    if(state.userProfile?.role!=='Admin') return;
    const snap = await db.collection('users').orderBy('name').get();
    const html = snap.docs.map(d=>{
      const u = d.data();
      return `
        <div style="display:flex;align-items:center;gap:.55rem;background:hsl(var(--accent)/0.12);padding:.5rem .55rem;border:1px solid hsl(var(--panel-border)/0.4);border-radius:14px;">
          <div style="flex:1;min-width:110px;cursor:pointer;" data-view-user="${d.id}">
            <strong style="font-size:.52rem;">${sanitize(u.name||'')}</strong><br>
            <span style="font-size:.45rem;">${sanitize(u.email||'')}</span>
          </div>
          <select data-user-role="${d.id}" style="font-size:.5rem;padding:.3rem .4rem;border-radius:10px;">
            ${state.roleOptions.map(r=> `<option ${u.role===r?'selected':''}>${r}</option>`).join('')}
          </select>
          <button class="outline small" data-user-update-role="${d.id}" style="padding:.35rem .5rem;">
            <i data-feather="save" width="11"></i>
          </button>
        </div>
      `;
    }).join('');
    const container = $('#roleMgmt');
    if(container){
      container.innerHTML = html || '<em class="muted">Tidak ada pengguna.</em>';
      feather.replace();
      $all('[data-user-update-role]').forEach(btn=>{
        btn.onclick = async ()=>{
          const uid = btn.getAttribute('data-user-update-role');
          const sel = document.querySelector(`[data-user-role="${uid}"]`);
          const role = sel.value;
          if(uid===state.currentUser.uid && role!=='Admin'){
            toast('Tidak bisa turunkan role sendiri','warn');
            return;
          }
          try{
            await db.collection('users').doc(uid).update({
              role,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            toast('Role diperbarui','success');
            if(uid===state.currentUser.uid){
              await loadUserProfile(uid);
              refreshUserUI();
            }
          }catch{
            toast('Gagal update role','danger');
          }
        };
      });
      $all('[data-view-user]').forEach(el=>{
        el.addEventListener('click', ()=> openOtherUserProfile(el.getAttribute('data-view-user')));
      });
    }
  }

  async function loadAllUsersForDeletion(){
    if(state.userProfile?.role!=='Admin') return;
    const snap = await db.collection('users').orderBy('name').get();
    const html = '<div style="font-weight:700;font-size:.55rem;margin-bottom:.3rem;">Hapus Akun (Admin)</div>' +
      snap.docs.filter(d=> d.id!==state.currentUser.uid).map(d=>{
        const u = d.data();
        return `
          <div style="display:flex;align-items:center;gap:.5rem;background:hsl(var(--accent)/0.1);padding:.45rem .55rem;border-radius:12px;border:1px solid hsl(var(--panel-border)/0.4);">
            <div style="flex:1;cursor:pointer;" data-view-user="${d.id}">
              <strong style="font-size:.5rem;">${sanitize(u.name||'')}</strong><br>
              <span style="font-size:.45rem;">${sanitize(u.email||'')}</span>
            </div>
            <button class="danger small" data-del-user="${d.id}" style="padding:.35rem .55rem;">
              <i data-feather="user-x" width="11"></i>
            </button>
          </div>
        `;
      }).join('');
    const container = $('#adminUserDelete');
    if(container){
      container.innerHTML = html;
      feather.replace();
      $all('[data-del-user]').forEach(btn=>{
        btn.onclick = ()=>{
          const uid = btn.getAttribute('data-del-user');
          Modal.open({
            title:'Hapus Akun',
            message:'Hapus akun ini (profil)?',
            icon:'user-x',
            confirmText:'Hapus',
            onConfirm: async ()=>{
              try{
                await db.collection('users').doc(uid).delete();
                toast('Akun dihapus','success');
                loadAllUsersForDeletion();
                loadAllUsersForRoleManagement();
              }catch{
                toast('Gagal hapus akun','danger');
              }
            }
          });
        };
      });
      $all('[data-view-user]').forEach(el=>{
        el.addEventListener('click', ()=> openOtherUserProfile(el.getAttribute('data-view-user')));
      });
    }
  }

function updateProfileStats(){
  if(!state.userProfile) return;
  const myData = state.fishData.filter(r=> r.userId===state.userProfile.id);

  // Statistik dasar
  const total = myData.length;
  const avg = total? average(myData.map(r=> r.organoleptic)).toFixed(2):'-';
  const good = myData.filter(r=> r.organoleptic>=7).length;
  const medium = myData.filter(r=> r.organoleptic>=4 && r.organoleptic<7).length;
  const bad = myData.filter(r=> r.organoleptic<4).length;
  const haz = myData.filter(r=> (r.hazards||[]).length).length;

  // Aktivitas harian & streak
  const today = isoDateOnly(new Date());
  const todayCount = myData.filter(r=> isoDateOnly(r.date)===today).length;
  const uniqueDates = Array.from(new Set(myData.map(r=> isoDateOnly(r.date)))).sort();
  let streak = 0;
  if(uniqueDates.length){
    const setDates = new Set(uniqueDates);
    let cursor = new Date();
    while(setDates.has(isoDateOnly(cursor))){
      streak++;
      cursor.setDate(cursor.getDate()-1);
    }
  }
  const activeDays = uniqueDates.length || 1;
  const avgPerActiveDay = total ? (total / activeDays).toFixed(2) : '-';

  // Microâ€‘Learning completion
  const microLearningCompleted = !!state.microLearning?.allPassed;

  // Badge ringkas
  const badges=[];
  if(total) badges.push({icon:'check-circle', text:`${total} Input`});
  if(todayCount) badges.push({icon:'sunrise', text:`${todayCount} Hari Ini`});
  if(streak>1) badges.push({icon:'trending-up', text:`Streak ${streak}h`});
  if(good) badges.push({icon:'smile', text:`${good} Baik`});
  if(medium) badges.push({icon:'alert-triangle', text:`${medium} Sedang`});
  if(bad) badges.push({icon:'x-octagon', text:`${bad} Buruk`});
  if(haz) badges.push({icon:'shield-off', text:`${haz} Indikasi`});
  if(avg!=='-') badges.push({icon:'bar-chart-2', text:`Avg ${avg}`});
  if(avgPerActiveDay!=='-') badges.push({icon:'layers', text:`Avg/Hari Aktif ${avgPerActiveDay}`});
  if(microLearningCompleted) badges.push({icon:'award', text:'Quality Steward'});

  const wrap = $('#profileStatsBadges');
  if(wrap){
    wrap.innerHTML = badges.map(b=> `
      <span class="badge-soft">
        <i data-feather="${b.icon}" width="11"></i>${b.text}
      </span>
    `).join('') || '<span class="small muted">Belum ada statistik.</span>';
    feather.replace();
  }

  // Jalankan evaluasi achievements (tambahkan metrik baru)
  computeAndStoreAchievements({
    total,
    todayCount,
    streak,
    microLearningCompleted
  });
}


/* ================== ACHIEVEMENTS (LENCANA) ================== */
async function computeAndStoreAchievements(metrics){
  if(!state.userProfile) return;
  const existing = state.userProfile.achievements || {};
  const newlyUnlocked = [];
  const updates = {};

  achievementRules.forEach(rule=>{
    if(existing[rule.id]) return; // sudah punya
    if(rule.check(metrics)){
      newlyUnlocked.push(rule);
      updates[`achievements.${rule.id}`] = firebase.firestore.FieldValue.serverTimestamp();
    }
  });

  if(newlyUnlocked.length){
    try{
      await db.collection('users').doc(state.userProfile.id).update(updates);
      // Merge ke state lokal agar tidak perlu reload
      newlyUnlocked.forEach(r=>{
        if(!state.userProfile.achievements) state.userProfile.achievements = {};
        state.userProfile.achievements[r.id] = new Date(); // sementara (serverTimestamp akan sync di snapshot)
      });
      newlyUnlocked.forEach(r=>{
        App.toast(`Achievement: ${r.title}`,'success',4500);
      });
    }catch(err){
      console.warn('Gagal update achievements',err);
    }
  }
  renderAchievements();
}

function renderAchievements(){
  const wrap = $('#profileAchievementsList');
  const info = $('#profileAchievementsStats');
  if(!wrap) return;
  const ach = state.userProfile?.achievements || {};
  const unlockedIds = Object.keys(ach);

  // Bangun list detail (gabung rules + status)
  const fullList = achievementRules.map(rule=>{
    const unlocked = unlockedIds.includes(rule.id);
    return {
      ...rule,
      unlocked,
      time: ach[rule.id] || null
    };
  });

  // Info ringkas
  if(info){
    info.textContent = `Unlocked: ${unlockedIds.length} / ${achievementRules.length}`;
  }

  if(!fullList.length){
    wrap.innerHTML = '<span class="small muted">Belum ada lencana.</span>';
    return;
  }

  wrap.innerHTML = fullList.map(item=>{
    if(item.unlocked){
      return `
        <span class="achievement-badge" title="${item.desc}">
          <i data-feather="award" width="11"></i>${item.title}
        </span>
      `;
    } else {
      return `
        <span class="achievement-badge" style="background:hsl(var(--accent)/0.18);color:hsl(var(--text-color));opacity:.55;" title="${item.desc} (Belum)">
          <i data-feather="lock" width="11"></i>${item.title}
        </span>
      `;
    }
  }).join('');
  feather.replace();
}

  /* ------------------ AUTH LISTENER ------------------ */
  auth.onAuthStateChanged(async user=>{
    if(user){
      state.currentUser = user;
      try{
        await db.collection('users').doc(user.uid).set({
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
          emailVerified: user.emailVerified
        },{merge:true});
      }catch{}
      await loadUserProfile(user.uid);
      subscribeMetadata();
      subscribeData();
      subscribeSocial();
      subscribeNotifications();
      loadSocialUsers();
      initLoggedIn();
    } else {
      cleanupSubs();
      state.currentUser = null;
      state.userProfile = null;
      state.fishData = [];
      state.filteredData = [];
      toggleViewAuth(true);
    }
    feather.replace();
    setTimeout(()=> $('#loadingOverlay')?.style && ($('#loadingOverlay').style.display='none'), 400);
  });

  function cleanupSubs(){
    Object.values(state.metadataUnsub).forEach(unsub=>{
      if(typeof unsub==='function') unsub();
    });
    Object.values(state.social.commentUnsubs).forEach(unsub=>{
      if(typeof unsub==='function') unsub();
    });
    state.metadataUnsub = {fish:null, markets:null, data:null, social:null, notifications:null};
    state.social.commentUnsubs = {};
  }

  function toggleViewAuth(showAuth){
  const authView = $('#authView');
  const appLayout = $('#appLayout');
  const fabInput = $('#fabInputData');
  const fabAII = $('#fabAI');
  const fabSettings = $('#fabSettings');

  if(showAuth){
    authView?.classList.remove('hidden');
    appLayout?.classList.add('hidden');
    fabInput?.classList.add('hidden');
    fabAII?.classList.add('hidden');
    fabSettings?.classList.add('hidden');
  } else {
    authView?.classList.add('hidden');
    appLayout?.classList.remove('hidden');
    fabInput?.classList.remove('hidden');
    fabAII?.classList.remove('hidden');
    fabSettings?.classList.remove('hidden');
  }
}

  function initLoggedIn(){
    toggleViewAuth(false);
    refreshUserUI();
    resetForm();
    applyFilters();
    updateDashboard();
    rebuildCharts();
    initAutoRefresh();
    bindWelcomeModalEvents();     
    // === Aktifkan sensor (default live) ===
    subscribeSensors();
    bindSensorUI();   
  showWelcomeModalOnce();    
  (function setWelcomeName(){
  const span = document.getElementById('welcomeUserName');
  if(span && App.state?.userProfile?.name){
    span.textContent = App.state.userProfile.name.split(' ')[0]; // ambil nama depan
  }
})();
  }

  /* ------------------ SUBMIT FORM DATA MUTU ------------------ */
  async function submitForm(){
    if(!state.currentUser) return;
    const id = $('#recordId')?.value;
    const fishType = $('#fishTypeInput')?.value.trim();
    const market   = $('#marketInput')?.value.trim();
    const organoleptic = clamp(parseInt($('#organoleptic')?.value),1,9);
    const smell    = $('#smell')?.value.trim();
    const texture  = $('#texture')?.value.trim();
    const color    = $('#colorField')?.value.trim();
    const hazardNotes = $('#hazardNotes')?.value.trim();
    const hazards  = [...state.formHazards];
    if(!fishType || !market || !organoleptic || !smell || !texture || !color){
      showAlert('formAlert','danger','Field wajib belum lengkap.');
      toast('Lengkapi data','warn');
      return;
    }
    if(!state.fishTypes.includes(fishType)) addNewFishType(fishType);
    if(!state.markets.includes(market)) addNewMarket(market);

    const payload = {
      fishType, market, organoleptic, smell, texture, color,
      image: state.formImageData || '',
      userId: state.currentUser.uid,
      userName: state.userProfile?.name || 'User',
      hazards, hazardNotes,
      date: new Date(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try{
      if(id){
        const rec = state.fishData.find(r=> r.id===id);
        const role = state.userProfile.role;
        if(role==='Dosen') return showAlert('formAlert','warn','Role Dosen tidak bisa edit (demo).');
        if(rec && rec.userId !== state.currentUser.uid && !['Admin','Petugas Pasar'].includes(role)){
          return showAlert('formAlert','danger','Tidak berhak edit.');
        }
        await db.collection('fishQuality').doc(id).update(payload);
        toast('Data diperbarui','success');
        showAlert('formAlert','success','Data diperbarui.');
      } else {
        const ref = await db.collection('fishQuality').add({
          ...payload,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        state.lastAddedId = ref.id;
        toast('Data tersimpan','success');
        showAlert('formAlert','success','Data tersimpan.');
      }
      resetForm();
    }catch(err){
      toast('Gagal simpan','danger');
      showAlert('formAlert','danger','Error: '+err.message);
    }
  }

  /* ------------------ EXPORT FUNCTIONS ------------------ */
  function toCSV(rows){
    return rows.map(r=> r.map(v=> `"${(v??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  }
  function download(filename, content, type='text/plain'){
    const blob = new Blob([content],{type});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1200);
  }
  function exportCSV(records, filename='mutu_ikan.csv'){
    const rows = generateTableData(records);
    download(filename,toCSV(rows),'text/csv;charset=utf-8;');
    toast('CSV diekspor','success');
  }
  function exportExcel(records){
    const rows = generateTableData(records);
    const html = '<table>'+ rows.map(r=> '<tr>'+ r.map(c=> `<td>${c}</td>`).join('') + '</tr>').join('') +'</table>';
    const blob = new Blob([`\ufeff${html}`],{type:'application/vnd.ms-excel'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download='mutu_ikan.xls';
    a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1200);
    toast('Excel diekspor','success');
  }
  async function exportPDF(records, includeCharts=true){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','pt','a4');
    const margin=40;
    let y=margin;
    doc.setFontSize(14);
    doc.text('Laporan Mutu Ikan Segar', margin,y); y+=20;
    doc.setFontSize(9);
    doc.text(`Tanggal Generate: ${formatDate(new Date())}`, margin,y); y+=12;
    doc.text(`Total Data: ${records.length}`, margin,y); y+=14;
    const good = records.filter(r=> r.organoleptic>=7).length;
    const medium = records.filter(r=> r.organoleptic>=4 && r.organoleptic<7).length;
    const bad = records.filter(r=> r.organoleptic<4).length;
    const hazardCount = records.filter(r=> (r.hazards||[]).length).length;
    doc.text(`Mutu Baik: ${good} | Sedang: ${medium} | Buruk: ${bad} | Indikasi Bahaya: ${hazardCount}`, margin, y); y+=16;

    if(includeCharts && state.charts.comparison){
      const charts = [
        { canvas: $('#chartComparison'), title:'Perbandingan Mutu Pasar' },
        { canvas: $('#chartTrend'), title:'Tren Skor' },
        { canvas: $('#chartPie'), title:'Proporsi Jenis Ikan' }
      ];
      for(const ch of charts){
        try{
          const img = ch.canvas.toDataURL('image/png',1.0);
          doc.setFontSize(10);
          doc.text(ch.title, margin,y); y+=8;
          doc.addImage(img,'PNG',margin,y,520,190,null,'FAST');
          y+=200;
          if(y>760){ doc.addPage(); y=margin; }
        }catch{}
      }
    }
    const rows = generateTableData(records);
    if(y>700){ doc.addPage(); y=margin; }
    doc.setFontSize(12); doc.text('Tabel Data', margin,y); y+=10;
    doc.setFontSize(7);
    const colWidths=[55,60,60,45,60,60,50,55,65,45,50,60,40,30];
    doc.setFont(undefined,'bold');
    let x=margin;
    rows[0].forEach((h,i)=> {
      doc.text(String(h).substring(0,16), x, y);
      x+= colWidths[i]||40;
    });
    doc.setFont(undefined,'normal');
    y+=10;
    for(let i=1;i<rows.length;i++){
      x=margin;
      if(y>790){ doc.addPage(); y=margin; }
      rows[i].forEach((cell,ci)=>{
        doc.text(String(cell).substring(0,16), x,y);
        x+= colWidths[ci]||40;
      });
      y+=10;
    }
    doc.save('laporan_mutu.pdf');
    toast('PDF diekspor','success');
  }

  function exportSelectedCSV(){
    const ids = Array.from(state.table.selected);
    const records = state.fishData.filter(r=> ids.includes(r.id));
    exportCSV(records, 'data_terpilih.csv');
  }
  function exportSelectedPDF(){
    const ids = Array.from(state.table.selected);
    const records = state.fishData.filter(r=> ids.includes(r.id));
    exportPDF(records,false);
  }

  /* ------------------ IMAGE COMPRESS ------------------ */
  function compressImage(file, maxW=1000){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = e=>{
        const img = new Image();
        img.onload = ()=>{
          const scale = Math.min(1, maxW/img.width);
          const canvas = document.createElement('canvas');
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img,0,0,canvas.width,canvas.height);
          resolve(canvas.toDataURL('image/jpeg',0.8));
        };
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  /* ------------------ VIEW SWITCH ------------------ */
  function showView(view){
    $all('[id^="view-"]').forEach(sec=> sec.classList.add('hidden'));
    const section = $('#view-'+view);
    if(section){
      section.classList.remove('hidden');
      section.classList.add('view-transition-enter');
      setTimeout(()=> section.classList.remove('view-transition-enter'),600);
    }
    $all('.nav button').forEach(b=> b.classList.remove('active'));
    const navBtn = document.querySelector(`.nav button[data-view="${view}"]`);
    navBtn?.classList.add('active');
    smoothScrollTop();
    feather.replace();
  }
  function smoothScrollTop(){
    const content = document.querySelector('.content');
    if(content) content.scrollTo({top:0,behavior:'smooth'});
  }

  /* ------------------ AUTH SWITCH (Login / Register / Forgot) ------------------ */
  function bindAuthSwitches(){
    $('#showRegister')?.addEventListener('click', e=>{
      e.preventDefault(); toggleAuth('register');
    });
    $('#showLogin')?.addEventListener('click', e=>{
      e.preventDefault(); toggleAuth('login');
    });
    $('#linkForgot')?.addEventListener('click', e=>{
      e.preventDefault(); toggleAuth('forgot');
    });
    $('#backToLogin')?.addEventListener('click', e=>{
      e.preventDefault(); toggleAuth('login');
    });
  }
  function toggleAuth(page){
    $('#loginContainer')?.classList.add('hidden');
    $('#registerContainer')?.classList.add('hidden');
    $('#forgotContainer')?.classList.add('hidden');
    if(page==='login') $('#loginContainer')?.classList.remove('hidden');
    else if(page==='register') $('#registerContainer')?.classList.remove('hidden');
    else if(page==='forgot') $('#forgotContainer')?.classList.remove('hidden');
  }

  /* ------------------ NAVIGATION BIND ------------------ */
  function bindNavigation(){
    $all('.nav button, .dropdown button[data-dropdown]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const view = btn.getAttribute('data-view') || btn.getAttribute('data-dropdown');
        if(!view) return;
        showView(view);
        $('#sidebar')?.classList.remove('open');
      });
    });
    $('#openSidebar')?.addEventListener('click', ()=> $('#sidebar')?.classList.add('open'));
    $('#closeSidebar')?.addEventListener('click', ()=> $('#sidebar')?.classList.remove('open'));
    $('#avatarBtn')?.addEventListener('click', ()=> $('#userDropdown')?.classList.toggle('show'));
    document.addEventListener('click', e=>{
      if(!$('#userDropdown')?.contains(e.target) && !$('#avatarBtn')?.contains(e.target)){
        $('#userDropdown')?.classList.remove('show');
      }
      if(!$('#notifDropdown')?.contains(e.target) && !$('#btnNotifications')?.contains(e.target)){
        $('#notifDropdown')?.classList.remove('show');
      }
    });
    $('#fabInputData')?.addEventListener('click', ()=>{
      showView('form');
      toast('Input Data','info',1200);
    });
    $('#btnNotifications')?.addEventListener('click', ()=>{
      $('#notifDropdown')?.classList.toggle('show');
    });
  }

  /* ------------------ THEME & LANGUAGE ------------------ */
  function bindThemeLang(){
    $('#btnToggleTheme')?.addEventListener('click', ()=>{
      const root = document.documentElement;
      const cur = root.getAttribute('data-theme')==='dark'?'light':'dark';
      root.setAttribute('data-theme',cur);
      localStorage.setItem('theme',cur);
      toast('Tema: '+(cur==='dark'?'Gelap':'Terang'),'info',1800);
    });
    (function initTheme(){
      const saved = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', saved);
    })();
    $('#btnLang')?.addEventListener('click', ()=>{
      state.lang = state.lang==='id'?'en':'id';
      applyI18n();
      toast('Bahasa: '+ (state.lang==='id'?'Indonesia':'English'),'info',1800);
    });
    $('#languageSelect')?.addEventListener('change', e=>{
      state.lang = e.target.value;
      applyI18n();
      toast('Bahasa diubah','success');
    });

// === Inisialisasi font family ===
  const savedFont = localStorage.getItem('fontFamily') || 'Quicksand';
  document.documentElement.style.setProperty('--font-sans', `'${savedFont}', system-ui, sans-serif`);
  const fontSel = document.getElementById('fontFamilySelect');
  if (fontSel) {
    fontSel.value = savedFont;
    fontSel.addEventListener('change', e => {
      const f = e.target.value || 'Quicksand';
      document.documentElement.style.setProperty('--font-sans', `'${f}', system-ui, sans-serif`);
      localStorage.setItem('fontFamily', f);
      App.toast('Font: ' + f, 'info', 1800);
    });
  }
  
    $('#prefLight')?.addEventListener('click', ()=>{
      document.documentElement.setAttribute('data-theme','light');
      localStorage.setItem('theme','light');
      toast('Tema terang','info');
    });
    $('#prefDark')?.addEventListener('click', ()=>{
      document.documentElement.setAttribute('data-theme','dark');
      localStorage.setItem('theme','dark');
      toast('Tema gelap','info');
    });

    document.documentElement.style.setProperty('--accent', state.accent);
    if(state.layoutStyle==='list') document.body.classList.add('layout-list');
    if(state.liteMode) document.body.classList.add('lite-mode');
    if(state.reduceMotion) document.body.classList.add('reduce-motion');
    if(state.highContrast) document.body.classList.add('high-contrast');
    applyFontSize(state.fontSize);

    $('#fontSizeSelect')?.addEventListener('change', e=>{
      applyFontSize(e.target.value);
      toast('Ukuran font diperbarui','success');
    });
    $('#layoutStyle')?.addEventListener('change', e=>{
      state.layoutStyle = e.target.value;
      localStorage.setItem('layoutStyle', state.layoutStyle);
      document.body.classList.toggle('layout-list', state.layoutStyle==='list');
      toast('Layout: '+state.layoutStyle,'info');
    });

    

    $('#toggleMotion')?.addEventListener('click', ()=>{
      state.reduceMotion = !state.reduceMotion;
      document.body.classList.toggle('reduce-motion', state.reduceMotion);
      localStorage.setItem('reduceMotion', state.reduceMotion?'1':'0');
      applyI18n();
      toast('Motion: '+(state.reduceMotion?'Reduced':'Default'),'info');
    });

    $('#toggleContrast')?.addEventListener('click', ()=>{
      state.highContrast = !state.highContrast;
      document.body.classList.toggle('high-contrast', state.highContrast);
      localStorage.setItem('highContrast', state.highContrast?'1':'0');
      applyI18n();
      toast('Kontras: '+(state.highContrast?'Tinggi':'Normal'),'info');
    });

    $('#autoRefreshSelect')?.addEventListener('change', e=>{
      state.autoRefresh = parseInt(e.target.value,10)||0;
      localStorage.setItem('autoRefreshDashboard', state.autoRefresh);
      initAutoRefresh();
      toast('Auto Refresh: '+(state.autoRefresh? state.autoRefresh+'s':'Off'),'info');
    });
    $('#autoRefreshSelect') && ($('#autoRefreshSelect').value = state.autoRefresh);
  }

  function initAutoRefresh(){
    if(state.autoRefreshTimer){
      clearInterval(state.autoRefreshTimer);
      state.autoRefreshTimer=null;
    }
    if(state.autoRefresh>0){
      state.autoRefreshTimer = setInterval(()=>{
        updateDashboard();
        rebuildCharts();
      }, state.autoRefresh*1000);
    }
  }

  /* ------------------ FILTERS ------------------ */
  function bindFilters(){
    ['filterFish','filterMarket','filterDate','filterText','globalSearch'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', ()=> debounce('filter', applyFilters, 250));
    });
  }

  /* ------------------ HAZARD & IMAGE INPUT FORM ------------------ */
  function bindHazardsAndImage(){
    $('#fishImage')?.addEventListener('change', async e=>{
      const file = e.target.files[0];
      if(!file){ state.formImageData=null; $('#fishImagePreview').innerHTML=''; return; }
      try{
        const base64 = await compressImage(file);
        state.formImageData = base64;
        $('#fishImagePreview').innerHTML = `
          <img src="${base64}" alt="fish">
          <div style="margin-top:.4rem;">
            <button type="button" class="btn-mini-inline" id="btnRemoveFishImg"><i data-feather="trash" width="10"></i>Hapus</button>
          </div>
        `;
        $('#btnRemoveFishImg').onclick = ()=>{
          state.formImageData=null;
          $('#fishImage').value='';
          $('#fishImagePreview').innerHTML='';
        };
        feather.replace();
      }catch{
        toast('Gagal proses gambar','danger');
      }
    });
  }

  /* ------------------ FORM BIND ------------------ */
  function bindForm(){
    $('#fishForm')?.addEventListener('submit', e=>{
      e.preventDefault();
      submitForm();
    });
    $('#btnResetForm')?.addEventListener('click', ()=>{
      resetForm();
      showAlert('formAlert','info','Form direset',2000);
    });
    $('#cancelEditBtn')?.addEventListener('click', ()=>{
      resetForm();
      toast('Batal edit','info');
    });
  }

  /* ------------------ DASHBOARD & FILTER BUTTONS ------------------ */
  function bindDashQualityButtons(){
    $all('[data-quality-filter]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $all('[data-quality-filter]').forEach(b=> b.classList.remove('active'));
        btn.classList.add('active');
        state.qualityFilter = btn.getAttribute('data-quality-filter');
        updateQualityList();
        toast('Filter mutu: '+state.qualityFilter,'info',1400);
      });
    });
    $all('[data-dash-filter]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $all('[data-dash-filter]').forEach(b=> b.classList.remove('active'));
        btn.classList.add('active');
        state.dashRange = btn.getAttribute('data-dash-filter');
        updateDashboard();
        rebuildCharts();
      });
    });
    $('#btnRefreshDashboard')?.addEventListener('click', ()=>{
      updateDashboard();
      rebuildCharts();
      updateQualityList();
      toast(state.lang==='en'?'Dashboard refreshed':'Dashboard disegarkan','success');
    });
    $('#toggleMyData')?.addEventListener('click', ()=>{
      state.myDataOnly = !state.myDataOnly;
      $('#toggleMyData').setAttribute('data-state', state.myDataOnly?'mine':'all');
      applyI18n();
      applyFilters();
      updateDashboard();
      toast(state.myDataOnly? (state.lang==='en'?'My Data':'Data Saya') : (state.lang==='en'?'All Data':'Semua Data'),'info');
    });
        
  }
    
    (function bindRankingPanel(){
  const mAll = document.getElementById('rankingModeAll');
  const mAct = document.getElementById('rankingModeActive');
  if(mAll && mAct){
    // Set DEFAULT ke "Semua"
    mAll.classList.add('active');
    mAct.classList.remove('active');

    [mAll, mAct].forEach(btn=>{
      btn.addEventListener('click', ()=>{
        mAll.classList.remove('active');
        mAct.classList.remove('active');
        btn.classList.add('active');
        buildRankings();
      });
    });
  }

  document.getElementById('rankingRefreshBtn')?.addEventListener('click', ()=>{
    buildRankings();
    App.toast('Ranking diperbarui','success');
  });

  // Bangun pertama kali sesuai default
  buildRankings();
})();

  /* ------------------ EXPORT BUTTONS ------------------ */
  function bindExports(){
    $('#btnExportCSV')?.addEventListener('click', ()=> exportCSV(state.filteredData));
    $('#repExportCSV')?.addEventListener('click', ()=> exportCSV(state.filteredData,'laporan_mutu.csv'));
    $('#btnExportExcel')?.addEventListener('click', ()=> exportExcel(state.filteredData));
    $('#btnExportPDF')?.addEventListener('click', ()=> exportPDF(state.filteredData));
    $('#repExportPDF')?.addEventListener('click', ()=> exportPDF(state.filteredData));
    $('#btnPrint')?.addEventListener('click', ()=> { window.print(); toast('Mencetak...','info'); });
    $('#repPrint')?.addEventListener('click', ()=> { window.print(); toast('Mencetak...','info'); });

    // Multi-select exports
    $('#btnExportSelectedCSV')?.addEventListener('click', exportSelectedCSV);
    $('#btnExportSelectedPDF')?.addEventListener('click', exportSelectedPDF);
    $('#btnDeleteSelected')?.addEventListener('click', deleteSelectedBulk);
    $('#btnClearSelection')?.addEventListener('click', clearSelection);
    $('#btnSelectAllFiltered')?.addEventListener('click', selectAllFiltered);
  }

  /* ------------------ REPORT GENERATE ------------------ */
  function bindReportGenerate(){
    $('#btnGenerateReport')?.addEventListener('click', ()=>{
      const from = $('#reportFrom')?.value;
      const to   = $('#reportTo')?.value;
      const scope= $('#reportScope')?.value;
      const fish = $('#reportFish')?.value;
      let recs = [...state.fishData];
      if(scope==='mine') recs = recs.filter(r=> r.userId===state.currentUser?.uid);
      if(fish) recs = recs.filter(r=> r.fishType===fish);
      if(from){
        const fd = new Date(from);
        recs = recs.filter(r=> r.date >= fd);
      }
      if(to){
        const td = new Date(to);
        td.setHours(23,59,59,999);
        recs = recs.filter(r=> r.date <= td);
      }
      const rows = generateTableData(recs);
      const html = `
        <div style="font-size:.65rem;font-weight:700;margin-bottom:.45rem;">Hasil Laporan (${recs.length} data)</div>
        <div style="overflow:auto;max-height:320px;border:1px solid hsl(var(--panel-border)/0.4);border-radius:14px;">
          <table style="width:100%;border-collapse:collapse;font-size:.52rem;min-width:1000px;">
            <thead style="background:hsl(var(--accent)/0.35);color:#fff;">
              <tr>${rows[0].map(h=> `<th style="padding:.4rem .5rem;text-align:left;">${h}</th>`).join('')}</tr>
            </thead>
            <tbody>
              ${rows.slice(1).map(r=> `<tr>${r.map(c=> `<td style="padding:.38rem .5rem;border-bottom:1px solid hsl(var(--panel-border)/0.25);">${c}</td>`).join('')}</tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;
      setHTML('#reportResult', html);
      feather.replace();
      toast('Laporan digenerate','success');
    });
    $('#btnClearReport')?.addEventListener('click', ()=>{
      setHTML('#reportResult','');
      ['#reportFrom','#reportTo','#reportFish'].forEach(sel=> setVal(sel,''));
      setVal('#reportScope','all');
      toast('Filter laporan dibersihkan','info');
    });
  }

  /* ------------------ PROFILE & ACCOUNT BIND ------------------ */
  function bindProfileActions(){
    $('#profileForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const name = $('#profName')?.value.trim();
      if(!name) return showAlert('profileAlert','danger','Nama wajib.');
      const studentId = $('#profStudentId')?.value.trim() || '';
      const lecturerId= $('#profLecturerId')?.value.trim() || '';
      const officerId = $('#profOfficerId')?.value.trim() || '';
      const occupation= $('#profOccupationId')?.value?.trim() || '';
      try{
        await db.collection('users').doc(state.currentUser.uid).update({
          name, studentId, lecturerId, officerId,
          occupation,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await state.currentUser.updateProfile({ displayName:name });
        showAlert('profileAlert','success','Profil diperbarui.');
        toast('Profil diperbarui','success');
        await loadUserProfile(state.currentUser.uid);
        refreshUserUI();
      }catch(err){
        showAlert('profileAlert','danger','Gagal: '+err.message);
        toast('Gagal update profil','danger');
      }
    });

    $('#btnChangeEmail')?.addEventListener('click', async ()=>{
      const newEmail = $('#changeEmailField')?.value.trim();
      if(!newEmail) return toast('Email kosong','warn');
      try{
        await state.currentUser.updateEmail(newEmail);
        await db.collection('users').doc(state.currentUser.uid).update({
          email:newEmail,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        toast('Email diperbarui','success');
        showAlert('profileAlert','success','Email diubah.');
        await loadUserProfile(state.currentUser.uid);
        refreshUserUI();
      }catch(err){
        showAlert('profileAlert','danger','Gagal: '+err.message);
        toast('Gagal ganti email','danger');
      }
    });

    $('#btnChangePassword')?.addEventListener('click', async ()=>{
      const p1 = $('#changePasswordField')?.value;
      const p2 = $('#changePasswordConfirm')?.value;
      if(!p1 || p1.length<6) return toast('Password minimal 6','warn');
      if(p1!==p2) return toast('Konfirmasi tidak cocok','danger');
      try{
        await state.currentUser.updatePassword(p1);
        toast('Password diperbarui','success');
        showAlert('profileAlert','success','Password diperbarui.');
        setVal('#changePasswordField','');
        setVal('#changePasswordConfirm','');
      }catch(err){
        showAlert('profileAlert','danger','Gagal: '+err.message);
        toast('Gagal ganti password','danger');
      }
    });

    $('#btnSendVerifyProfile')?.addEventListener('click', async ()=>{
      if(state.currentUser.emailVerified){
        toast('Sudah terverifikasi','info');
        return showAlert('profileAlert','info','Email sudah terverifikasi.');
      }
      try{
        await state.currentUser.sendEmailVerification();
        toast('Verifikasi dikirim','success');
        showAlert('profileAlert','success','Email verifikasi dikirim.');
      }catch(err){
        showAlert('profileAlert','danger','Gagal: '+err.message);
        toast('Gagal kirim verifikasi','danger');
      }
    });

    $('#btnSendPasswordReset')?.addEventListener('click', async ()=>{
      if(!state.userProfile?.email) return;
      try{
        await auth.sendPasswordResetEmail(state.userProfile.email);
        toast('Email reset dikirim','success');
        showAlert('profileAlert','success','Reset password terkirim.');
      }catch(err){
        showAlert('profileAlert','danger','Gagal: '+err.message);
        toast('Gagal reset','danger');
      }
    });

    $('#btnRefreshUser')?.addEventListener('click', async ()=>{
      await state.currentUser.reload();
      await loadUserProfile(state.currentUser.uid);
      refreshUserUI();
      toast('User direfresh','success');
    });
    $('#btnRefreshProfile')?.addEventListener('click', async ()=>{
      await state.currentUser.reload();
      await loadUserProfile(state.currentUser.uid);
      refreshUserUI();
      toast('Profil direfresh','success');
    });

    $('#btnChangePhoto')?.addEventListener('click', ()=> $('#profilePhotoInput')?.click());
    $('#profilePhotoInput')?.addEventListener('change', async e=>{
      const file = e.target.files[0];
      if(!file) return;
      try{
        const base64 = await compressImage(file,800);
        await db.collection('users').doc(state.currentUser.uid).update({
          photo: base64,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        toast('Foto diperbarui','success');
        showAlert('profileAlert','success','Foto diperbarui.');
        await loadUserProfile(state.currentUser.uid);
        refreshUserUI();
      }catch(err){
        toast('Gagal update foto','danger');
        showAlert('profileAlert','danger','Gagal: '+err.message);
      }
    });
    $('#btnRemovePhoto')?.addEventListener('click', ()=>{
      Modal.open({
        title:'Hapus Foto',
        message:'Hapus foto profil?',
        icon:'trash',
        confirmText:'Hapus',
        onConfirm: async ()=>{
          try{
            await db.collection('users').doc(state.currentUser.uid).update({
              photo:'',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            toast('Foto dihapus','success');
            showAlert('profileAlert','success','Foto dihapus.');
            await loadUserProfile(state.currentUser.uid);
            refreshUserUI();
          }catch(err){
            toast('Gagal hapus foto','danger');
            showAlert('profileAlert','danger','Gagal: '+err.message);
          }
        }
      });
    });

    $('#btnSavePreferences')?.addEventListener('click', async ()=>{
      const defFish = $('#prefDefaultFish')?.value || '';
      const defMarket = $('#prefDefaultMarket')?.value || '';
      try{
        await db.collection('users').doc(state.currentUser.uid).update({
          defaultFishType: defFish,
          defaultMarket: defMarket,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        toast('Preferensi disimpan','success');
        showAlert('prefAlert','success','Preferensi disimpan.');
        await loadUserProfile(state.currentUser.uid);
        refreshUserUI();
      }catch(err){
        showAlert('prefAlert','danger','Gagal: '+err.message);
        toast('Gagal simpan preferensi','danger');
      }
    });

    $('#btnRefreshStats')?.addEventListener('click', updateProfileStats);

    $('#btnDeleteAccount')?.addEventListener('click', ()=>{
      Modal.open({
        title:'Hapus Akun',
        message:'Hapus profil Anda? (Demo, data mutu tidak dihapus)',
        icon:'user-x',
        confirmText:'Hapus',
        onConfirm: async ()=>{
          try{
            await db.collection('users').doc(state.currentUser.uid).delete();
            await state.currentUser.delete();
            toast('Akun dihapus','success');
          }catch(err){
            toast('Gagal hapus akun','danger');
            showAlert('deleteAccountAlert','danger','Gagal: '+err.message);
          }
        }
      });
    });
  }

  /* ------------------ AUTH FORMS (LOGIN, REGISTER, FORGOT) ------------------ */
  function bindAuthForms(){
    $('#loginForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const email = $('#loginEmail')?.value.trim();
      const pass  = $('#loginPassword')?.value;
      if(!email || !pass) return;
      showAlert('authAlert','info','Memproses login...');
      try{
        await auth.signInWithEmailAndPassword(email,pass);
        toast('Login sukses','success');
      }catch(err){
        showAlert('authAlert','danger','Login gagal: '+err.message);
        toast('Login gagal','danger');
      }
    });
    $('#registerForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const name = $('#regName')?.value.trim();
      const email= $('#regEmail')?.value.trim();
      const pass = $('#regPassword')?.value;
      const pass2= $('#regConfirmPassword')?.value;
      const roleSel = $('#regRole')?.value;
      const studentId = $('#regStudentId')?.value?.trim() || '';
      const lecturerId= $('#regLecturerId')?.value?.trim() || '';
      const officerId = $('#regOfficerId')?.value?.trim() || '';
      const otherOcc  = $('#regOtherOccupation')?.value?.trim() || '';
      if(!name||!email||!pass) return showAlert('registerAlert','danger','Isi semua field.');
      if(pass!==pass2) return showAlert('registerAlert','danger','Konfirmasi tidak cocok.');
      showAlert('registerAlert','info','Memproses registrasi...');
      try{
        const cred = await auth.createUserWithEmailAndPassword(email,pass);
        const role = roleSel === 'Admin' ? 'Mahasiswa' : roleSel;
        await db.collection('users').doc(cred.user.uid).set({
          name,email,role,
          studentId: role==='Mahasiswa'? studentId:'',
          lecturerId: role==='Dosen'? lecturerId:'',
          officerId: role==='Petugas Pasar'? officerId:'',
          occupation: role==='Lainnya'? otherOcc:'',
          defaultFishType:'', defaultMarket:'',
          photo:'',
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          emailVerified: cred.user.emailVerified
        });
        await cred.user.updateProfile({ displayName:name });
        await cred.user.sendEmailVerification();
        showAlert('registerAlert','success','Registrasi berhasil. Cek email.');
        toast('Registrasi berhasil','success');
        setTimeout(()=> toggleAuth('login'),1200);
      }catch(err){
        showAlert('registerAlert','danger','Gagal: '+err.message);
        toast('Registrasi gagal','danger');
      }
    });
    $('#forgotForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const email = $('#forgotEmail')?.value.trim();
      if(!email) return;
      showAlert('forgotAlert','info','Mengirim link reset...');
      try{
        await auth.sendPasswordResetEmail(email);
        showAlert('forgotAlert','success','Email reset terkirim.');
        toast('Email reset terkirim','success');
      }catch(err){
        showAlert('forgotAlert','danger','Gagal: '+err.message);
        toast('Reset gagal','danger');
      }
    });
    $('#regRole')?.addEventListener('change', renderExtraFields);
    renderExtraFields();
  }

  function renderExtraFields(){
    const role = $('#regRole')?.value;
    const c = $('#regExtraFields');
    if(!c) return;
    let html='';
    if(role==='Mahasiswa'){
      html = `<div class="inline-field slide-in-up">
        <label data-i18n="student_id">${state.lang==='en'?'Student ID':'NIM Mahasiswa'}</label>
        <input id="regStudentId" placeholder="${state.lang==='en'?'Student ID':'NIM'}">
      </div>`;
    } else if(role==='Dosen'){
      html = `<div class="inline-field slide-in-up">
        <label data-i18n="lecturer_id">${state.lang==='en'?'Lecturer ID':'NIP Dosen'}</label>
        <input id="regLecturerId" placeholder="NIP">
      </div>`;
    } else if(role==='Petugas Pasar'){
      html = `<div class="inline-field slide-in-up">
        <label data-i18n="officer_id">${state.lang==='en'?'Officer ID':'ID Petugas'}</label>
        <input id="regOfficerId" placeholder="ID Petugas">
      </div>`;
    } else if(role==='Lainnya'){
      html = `<div class="inline-field slide-in-up">
        <label>Pekerjaan / Occupation</label>
        <input id="regOtherOccupation" placeholder="Jenis pekerjaan">
      </div>`;
    }
    c.innerHTML = html;
    feather.replace();
  }

  function bindLogout(){
    $('#btnLogout')?.addEventListener('click', ()=> auth.signOut());
    $('#logoutDropdownBtn')?.addEventListener('click', ()=> auth.signOut());
  }

  function bindDemoAccounts(){
    $('#quickDemoAdmin')?.addEventListener('click', ()=> loginDemo('admin_demo@example.com','Admin Demo','Admin','ADM-DEMO'));
    $('#quickDemoUser')?.addEventListener('click', ()=> loginDemo('user_demo@example.com','Mahasiswa Demo','Mahasiswa',''));
  }
  async function loginDemo(email,name,role,officer){
    showAlert('authAlert','info','Masuk akun demo...');
    try{
      try{
        await auth.signInWithEmailAndPassword(email,'password123');
      }catch{
        const cred = await auth.createUserWithEmailAndPassword(email,'password123');
        await db.collection('users').doc(cred.user.uid).set({
          name,email,role,
          studentId: role==='Mahasiswa'?'D1234567':'',
          lecturerId:'',
          officerId: officer || '',
          defaultFishType:'', defaultMarket:'',
          occupation:'',
          photo:'',
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          emailVerified: cred.user.emailVerified
        });
        await cred.user.updateProfile({ displayName:name });
      }
      toast('Masuk demo '+role,'success');
    }catch(err){
      showAlert('authAlert','danger','Gagal demo: '+err.message);
      toast('Gagal demo','danger');
    }
  }

  /* ------------------ PAGINATION BIND ------------------ */
  function bindPaginationControls(){
    $('#perPageSelect')?.addEventListener('change', e=>{
      state.table.perPage = parseInt(e.target.value,10)||25;
      localStorage.setItem('tablePerPage', state.table.perPage);
      resetToFirstPage();
      renderTable();
    });
    $('#prevPage')?.addEventListener('click', ()=>{
      if(state.table.page>1){
        state.table.page--;
        renderTable();
      }
    });
    $('#nextPage')?.addEventListener('click', ()=>{
      const total = state.filteredData.length;
      const pages = Math.max(1, Math.ceil(total/state.table.perPage));
      if(state.table.page < pages){
        state.table.page++;
        renderTable();
      }
    });
    $('#selectAllPage')?.addEventListener('change', e=>{
      toggleSelectAllCurrentPage(e.target.checked);
    });
  }

  /* ------------------ NOTIFIKASI (ADMIN BROADCAST) ------------------ */
  function subscribeNotifications(){
    if(state.metadataUnsub.notifications) state.metadataUnsub.notifications();
    state.metadataUnsub.notifications = db.collection('notifications')
      .orderBy('createdAt','desc')
      .limit(150)
      .onSnapshot(snap=>{
        const all = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
        // Filter sesuai role
        const role = state.userProfile?.role;
        const relevant = all.filter(n=> {
          return n.target==='ALL' || n.target===role;
        });
        state.notifications.list = relevant;
        const unread = relevant.filter(n=> !(n.readBy||[]).includes(state.currentUser.uid));
        state.notifications.unreadCount = unread.length;
        updateNotifBadge();
        renderNotificationsList();
      });
  }

  function updateNotifBadge(){
    const badge = $('#notifBadge');
    if(!badge) return;
    if(state.notifications.unreadCount>0){
      badge.textContent = state.notifications.unreadCount>99?'99+': state.notifications.unreadCount;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  }

  function renderNotificationsList(){
  const list = $('#notifList');
  const empty = $('#notifEmpty');
  if(!list) return;
  if(!state.notifications.list.length){
    empty?.classList.remove('hidden');
    list.innerHTML='';
    return;
  }
  empty?.classList.add('hidden');

  const isAdmin = state.userProfile?.role === 'Admin';

  list.innerHTML = state.notifications.list.map(n=>{
    const unread = !(n.readBy||[]).includes(state.currentUser.uid);
    return `
      <div class="notif-item ${unread?'unread':''}" data-open-notif="${n.id}">
        <div style="font-weight:700;margin-right:1.2rem;">${sanitize(n.title||'-')}</div>
        <div style="font-size:.52rem;line-height:1.3;">${sanitize(n.message||'')}</div>
        <div class="notif-time">${n.createdAt? formatDateTime(n.createdAt):''}</div>
        <div class="notif-sender" style="font-size:.45rem;opacity:.7;">${sanitize(n.senderName||'')}</div>
        ${isAdmin ? `
          <button class="del-notif-btn" data-del-notif="${n.id}" title="Hapus" style="width:auto;padding:0 .45rem;gap:.25rem;">
  <i data-feather="trash-2" width="11"></i><span style="font-size:.48rem;font-weight:600;">Hapus</span>
</button>` : ''
        }
      </div>
    `;
  }).join('');
  feather.replace();

  // Klik untuk menandai baca
  $all('[data-open-notif]').forEach(el=>{
    el.onclick = (e)=>{
      // Jika klik tombol delete jangan mark read
      if(e.target.closest('[data-del-notif]')) return;
      markNotifRead(el.getAttribute('data-open-notif'));
    };
  });

  // Binding delete (Admin)
  if(isAdmin){
    $all('[data-del-notif]').forEach(btn=>{
      btn.onclick = (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute('data-del-notif');
        deleteNotification(id);
      };
    });
  }
}

async function deleteNotification(id){
  if(state.userProfile?.role !== 'Admin') {
    return toast('Hanya Admin','warn');
  }
  Modal.open({
    title: state.lang==='en'?'Delete Notification':'Hapus Notifikasi',
    message: state.lang==='en'?'Are you sure to delete this notification?':'Hapus notifikasi ini?',
    icon:'trash-2',
    confirmText: state.lang==='en'?'Delete':'Hapus',
    onConfirm: async ()=>{
      try{
        await db.collection('notifications').doc(id).delete();
        toast(state.lang==='en'?'Deleted':'Dihapus','success');
      }catch(err){
        toast('Gagal hapus','danger');
      }
    }
  });
}

  async function markNotifRead(id){
    const notif = state.notifications.list.find(n=> n.id===id);
    if(!notif) return;
    if((notif.readBy||[]).includes(state.currentUser.uid)) return;
    try{
      await db.collection('notifications').doc(id).update({
        readBy: firebase.firestore.FieldValue.arrayUnion(state.currentUser.uid)
      });
    }catch{}
  }

  async function markAllNotifRead(){
    const unread = state.notifications.list.filter(n=> !(n.readBy||[]).includes(state.currentUser.uid)).map(n=> n.id);
    for(const id of unread){
      try{
        await db.collection('notifications').doc(id).update({
          readBy: firebase.firestore.FieldValue.arrayUnion(state.currentUser.uid)
        });
      }catch{}
    }
    toast('Semua notif ditandai dibaca','success');
  }

  async function sendBroadcastNotification(){
    if(state.userProfile?.role!=='Admin'){
      return showAlert('notifAdminAlert','danger','Hanya Admin.');
    }
    const target = $('#notifTargetRole')?.value || 'ALL';
    const title  = $('#notifTitleInput')?.value.trim();
    const message= $('#notifMessageInput')?.value.trim();
    if(!title || !message){
      return showAlert('notifAdminAlert','warn','Lengkapi judul & pesan.');
    }
    try{
      await db.collection('notifications').add({
        title, message, target,
        senderId: state.userProfile.id,
        senderName: state.userProfile.name,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        readBy:[]
      });
      $('#notifTitleInput').value='';
      $('#notifMessageInput').value='';
      showAlert('notifAdminAlert','success','Terkirim.');
      toast('Broadcast terkirim','success');
    }catch(err){
      showAlert('notifAdminAlert','danger','Gagal: '+err.message);
    }
  }

  function bindNotificationsActions(){
    $('#btnSendBroadcast')?.addEventListener('click', sendBroadcastNotification);
    $('#btnMarkAllRead')?.addEventListener('click', markAllNotifRead);
    $('#btnRefreshNotif')?.addEventListener('click', ()=>{
      // Snapshot real-time sudah auto-update; cukup trigger animasi/toast
      toast('Notifikasi disegarkan','info');
    });
  }

  function bindSensorUI(){
    $('#sensorRefreshBtn')?.addEventListener('click', ()=>{
      // Re-subscribe (manual)
      subscribeSensors();
      toast('Sensor refresh','info');
    });
    $('#sensorToggleLiveBtn')?.addEventListener('click', ()=>{
      state.sensors.live = !state.sensors.live;
      if(state.sensors.live){
        subscribeSensors();
        toast('Live ON','success');
      } else {
        if(state.sensors.unsub){ state.sensors.unsub(); state.sensors.unsub=null; }
        toast('Live OFF','warn');
      }
    });
    $('#sensorManualForm')?.addEventListener('submit', e=>{
      e.preventDefault();
      const v = parseFloat($('#sensorManualValue').value);
      if(isNaN(v)){ showAlert('sensorManualAlert','danger','Nilai tidak valid'); return; }
      const s = $('#sensorManualSource').value.trim();
      const n = $('#sensorManualNote').value.trim();
      addManualSensorReading(v,s,n);
      e.target.reset();
    });
  }
  /* ------------------ ORGANOLPTIK TOOL ------------------ */
  const organolepticStandards = {
    sni2013: {
      label: 'SNI 2013',
      ref: 'SNI 2729:2013 (Contoh / Ringkasan)',
      criteria: {
        "Mata": [
          {score:9, desc:"Cembung, kornea jernih, pupil hitam mengkilat"},
          {score:7, desc:"Sedikit kurang cembung, kornea agak keruh"},
          {score:5, desc:"Datar, kornea keruh keputihan"},
          {score:3, desc:"Sedikit cekung, pupil pudar"},
          {score:1, desc:"Cekung, kornea keruh tebal, pupil abu-abu"}
        ],
        "Insang": [
          {score:9, desc:"Merah cerah, segar, lendir bening, bau segar laut"},
          {score:7, desc:"Merah ke arah merah muda, lendir agak meningkat"},
          {score:5, desc:"Merah pucat / kecoklatan, lendir keruh"},
          {score:3, desc:"Coklat pucat, lendir kental, bau agak asam"},
          {score:1, desc:"Coklat keabu-abuan, lendir tebal, bau busuk"}
        ],
        "Bau": [
          {score:9, desc:"Segar spesifik ikan, tidak asing"},
          {score:7, desc:"Segar menurun sedikit, masih alami"},
          {score:5, desc:"Sedikit amis tajam / netral"},
          {score:3, desc:"Amis kuat / agak asam"},
          {score:1, desc:"Busuk, asam menyengat, tidak layak"}
        ],
        "Daging / Tekstur": [
          {score:9, desc:"Elastis padat, kembali cepat saat ditekan"},
          {score:7, desc:"Cukup elastis, sedikit lambat kembali"},
          {score:5, desc:"Kurang elastis, agak lunak"},
          {score:3, desc:"Lunak, bekas tekan menetap lama"},
          {score:1, desc:"Sangat lembek, tidak kembali"}
        ],
        "Kulit / Warna": [
          {score:9, desc:"Cerlang, mengkilat, lendir jernih tipis"},
          {score:7, desc:"Agak kurang cerah, lendir meningkat sedikit"},
          {score:5, desc:"Agak kusam, lendir keruh"},
          {score:3, desc:"Kusam, lendir keruh tebal"},
          {score:1, desc:"Sangat kusam, lendir tebal kental"}
        ]
      }
    },
    sni2021: {
      label: 'SNI 2021',
      ref: 'SNI Revisi 2021 (Contoh / Ringkasan)',
      criteria: {
        "Mata": [
          {score:9, desc:"Cembung penuh, bening, refleksi baik"},
          {score:8, desc:"Cembung, sedikit redup"},
          {score:6, desc:"Mulai datar, kornea agak keruh"},
          {score:4, desc:"Datar/cekung ringan, keruh"},
          {score:2, desc:"Cekung jelas, keruh pekat"},
          {score:1, desc:"Cekung parah, hancur / buram"}
        ],
        "Insang": [
          {score:9, desc:"Merah terang, lembab segar, bau laut"},
          {score:8, desc:"Merah agak muda, bau normal"},
          {score:6, desc:"Merah pucat, lendir mulai keruh"},
          {score:4, desc:"Coklat kemerahan, lendir keruh kental"},
          {score:2, desc:"Coklat keabu-abuan, bau kurang sedap"},
          {score:1, desc:"Abu / coklat kusam, bau busuk"}
        ],
        "Aroma Umum": [
          {score:9, desc:"Segar spesifik, alami"},
          {score:8, desc:"Segar normal menurun sedikit"},
          {score:6, desc:"Netral / amis ringan"},
          {score:4, desc:"Amis kuat / agak asam"},
          {score:2, desc:"Asam tajam / hampir busuk"},
          {score:1, desc:"Busuk jelas"}
        ],
        "Tekstur": [
          {score:9, desc:"Padat elastis optimum"},
          {score:8, desc:"Padat, sedikit menurun"},
          {score:6, desc:"Agak lunak"},
                    {score:4, desc:"Lunak, bekas tekan lambat hilang"},
          {score:2, desc:"Lunak sekali, mudah berubah bentuk"},
          {score:1, desc:"Hancur / sangat lembek"}
        ],
        "Kulit / Permukaan": [
          {score:9, desc:"Cerlang, lendir jernih tipis"},
          {score:8, desc:"Agak kurang cerah, masih segar"},
          {score:6, desc:"Kusam ringan, lendir meningkat"},
          {score:4, desc:"Kusam, lendir keruh"},
          {score:2, desc:"Sangat kusam, lendir tebal & pekat"},
          {score:1, desc:"Kering / rusak / berlendir tidak normal"}
        ],
        "Perut / Abdomen": [
          {score:9, desc:"Utuh rapat normal, tidak buncit"},
          {score:8, desc:"Utuh, agak lembut"},
          {score:6, desc:"Sedikit buncit / mulai melonggar"},
          {score:4, desc:"Agak pecah / lunak jelas"},
          {score:2, desc:"Pecah sebagian / isi mulai keluar"},
          {score:1, desc:"Pecah parah / isi keluar banyak"}
        ]
      }
    }
  };

  const organolepticToolState = {
    standard: 'sni2013',
    selections: {} // {criterion: score}
  };

  function buildOrganolepticCriteria(){
    const wrap = document.getElementById('orgCriteriaContainer');
    if(!wrap) return;
    const std = organolepticStandards[organolepticToolState.standard];
    const crits = std.criteria;
    wrap.innerHTML = Object.keys(crits).map(crit=>{
      const opts = crits[crit].map(o=>{
        const active = organolepticToolState.selections[crit] === o.score;
        return `
          <div class="org-option ${active?'active':''}" data-org-opt="${crit}__${o.score}">
            <div class="score-badge">${o.score}</div>
            <div style="font-weight:600;">${o.desc.split('.')[0]}</div>
            <div style="opacity:.85;">${o.desc}</div>
          </div>
        `;
      }).join('');
      return `
        <div class="org-criterion">
          <h4><i data-feather="bookmark" width="11"></i>${crit}</h4>
          <div class="org-options">${opts}</div>
        </div>
      `;
    }).join('') || '<div class="empty-state">Tidak ada kriteria.</div>';
    feather.replace();
    document.querySelectorAll('[data-org-opt]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const [crit, score] = el.getAttribute('data-org-opt').split('__');
        organolepticToolState.selections[crit] = parseInt(score,10);
        buildOrganolepticCriteria();
        computeOrganolepticResult();
      });
    });
    computeOrganolepticResult();
  }

  function computeOrganolepticResult(){
    const scores = Object.values(organolepticToolState.selections);
    let final = '-';
    const method = document.getElementById('orgAggregateMethod')?.value || 'average';
    if(scores.length){
      if(method==='average'){
        final = (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(2);
      } else if(method==='min'){
        final = Math.min(...scores).toFixed(2);
      } else if(method==='median'){
        const sorted=[...scores].sort((a,b)=>a-b);
        const mid = Math.floor(sorted.length/2);
        final = (sorted.length%2? sorted[mid] : (sorted[mid-1]+sorted[mid])/2).toFixed(2);
      }
    }
    const boxScore = document.getElementById('orgFinalScore');
    const boxStatus= document.getElementById('orgFinalStatus');
    if(boxScore) boxScore.textContent = final;
    let status='-';
    if(final!=='-'){
      const f = parseFloat(final);
      if(f>=7) status = (state.lang==='en'?'Good':'Baik');
      else if(f>=4) status = (state.lang==='en'?'Medium':'Sedang');
      else status = (state.lang==='en'?'Bad':'Buruk');
    }
    if(boxStatus) boxStatus.textContent = status;
    buildSummary();
  }

  function buildSummary(){
    const std = organolepticStandards[organolepticToolState.standard];
    const summaryEl = document.getElementById('orgSummary');
    if(!summaryEl) return;
    const lines = [
      `Standar: ${std.label}`,
      `Ref: ${std.ref}`,
      'Pilihan:'
    ];
    Object.keys(organolepticToolState.selections).forEach(k=>{
      lines.push(`- ${k}: ${organolepticToolState.selections[k]}`);
    });
    lines.push(`Skor Akhir: ${document.getElementById('orgFinalScore')?.textContent || '-'}`);
    lines.push(`Status: ${document.getElementById('orgFinalStatus')?.textContent || '-'}`);
    summaryEl.textContent = lines.join('\n');
  }

  function resetOrganolepticTool(){
    organolepticToolState.selections = {};
    buildOrganolepticCriteria();
  }

  function applyOrganolepticToForm(){
    const finalScore = document.getElementById('orgFinalScore')?.textContent;
    if(!finalScore || finalScore==='-'){
      toast('Belum ada skor untuk diterapkan','warn');
      return;
    }
    const organolepticInput = document.getElementById('organoleptic');
    if(organolepticInput){
      organolepticInput.value = Math.round(parseFloat(finalScore));
    }
    const std = organolepticStandards[organolepticToolState.standard];
    const pick = (nameList)=> {
      for(const n of nameList){
        if(organolepticToolState.selections[n]){
          const arr = std.criteria[n];
          const sc = organolepticToolState.selections[n];
          const opt = arr.find(o=>o.score===sc);
          return opt? opt.desc : '';
        }
      }
      return '';
    };
    const smellDesc   = pick(['Bau','Aroma Umum']);
    const textureDesc = pick(['Daging / Tekstur','Tekstur']);
    const colorDesc   = pick(['Kulit / Warna','Kulit / Permukaan']);
    if(smellDesc && $('#smell')) $('#smell').value = smellDesc.split('.')[0];
    if(textureDesc && $('#texture')) $('#texture').value = textureDesc.split('.')[0];
    if(colorDesc && $('#colorField')) $('#colorField').value = colorDesc.split('.')[0];
    toast('Skor & deskripsi diterapkan ke Form','success');
    showView('form');
    setTimeout(()=> window.scrollTo({top:0,behavior:'smooth'}),150);
  }

  function initOrganolepticTool(){
    const stdSelect = document.getElementById('orgStandardSelect');
    if(stdSelect){
      stdSelect.addEventListener('change', e=>{
        organolepticToolState.standard = e.target.value;
        resetOrganolepticTool();
      });
    }
    document.getElementById('btnResetOrgTool')?.addEventListener('click', ()=>{
      resetOrganolepticTool();
      toast('Tool direset','info');
    });
    document.getElementById('btnApplyOrgScore')?.addEventListener('click', applyOrganolepticToForm);
    document.getElementById('btnCopyOrgSummary')?.addEventListener('click', ()=>{
      const txt = document.getElementById('orgSummary')?.textContent || '';
      if(!txt) return toast('Ringkasan kosong','warn');
      navigator.clipboard.writeText(txt)
        .then(()=> toast('Ringkasan disalin','success'))
        .catch(()=> toast('Gagal menyalin','danger'));
    });
    document.getElementById('orgAggregateMethod')?.addEventListener('change', computeOrganolepticResult);
    document.getElementById('btnBackToForm')?.addEventListener('click', ()=> showView('form'));
    document.getElementById('btnOpenOrgTool')?.addEventListener('click', ()=>{
      showView('organoleptic-tool');
    });
    buildOrganolepticCriteria();
  }

  /* ------------------ INISIALISASI APP ------------------ */
  function init(){
    setText('#year', new Date().getFullYear());
    setText('#year2', new Date().getFullYear());
    setVal('#dateAuto', nowDateInput());
    applyI18n();
    buildAccentPalette();
    bindAuthSwitches();
    bindAuthForms();
    bindNavigation();
    bindThemeLang();
    bindFilters();
    bindHazardsAndImage();
    bindForm();
    bindDashQualityButtons();
    bindExports();
    bindReportGenerate();
    bindProfileActions();
    bindLogout();
    bindDemoAccounts();
    bindPaginationControls();
    bindNotificationsActions();
    bindSocialForm();
    renderHazardChips();
    initOrganolepticTool();
    initPresenceIndicator();
        bindSensorUI(); // agar form manual siap bila user sudah login kemudian ke tab
    feather.replace();
    window.addEventListener('load', ()=>{
      setTimeout(()=> $('#loadingOverlay')?.style && ($('#loadingOverlay').style.display='none'), 1200);
    });
  }


document.getElementById('fabSettings')?.addEventListener('click', ()=>{
  if(window.App && typeof App.showView === 'function'){
    App.showView('settings');
    document.querySelector('.content')?.scrollTo({top:0,behavior:'smooth'});
    App.toast('Pengaturan', 'info', 1400);
  } else {
    // fallback bila App belum siap
    location.hash = '#settings';
    
  }
});

/* ==== Presence (Online / Offline) ==== */
function initPresenceIndicator(){
  const el = document.getElementById('appPresence');
  if(!el) return;
  function update(){
    const online = navigator.onLine;
    document.body.classList.toggle('offline', !online);
    const label = el.querySelector('.label');
    if(label){
      // Jika ingin dukungan i18n:
      const isEn = (window.App?.state?.lang || 'id') === 'en';
      label.textContent = online
        ? (isEn ? 'On' : 'On')
        : (isEn ? 'Off' : 'Off');
    }
    el.setAttribute('title', online ? 'Koneksi Online' : 'Koneksi Offline / Periksa Internet');
  }
  window.addEventListener('online', update);
  window.addEventListener('offline', update);
  update();
}


/* ============================================================
   AI ASSISTANT MODULE (Groq API) for MMIS
   Versi: 1.0
   - Tambahan modular, tidak mengganggu App utama
   - Menunggu window.App siap
   - Simpan konfigurasi di localStorage: aiSettings
   - Fallback FAQ lokal jika error
   ============================================================ */
(function(){
  const LS_KEY = 'aiSettingsMMIS';
  const DEFAULTS = {
    apiKey: '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',
    model: 'llama-3.1-8b-instant',
    mode: 'short',
    context: 'Anda adalah asisten ahli mutu ikan segar dan keamanan pangan.',
  };
  const EXAMPLES = [
    'Bagaimana ciri ikan segar organoleptik?',
    'Apa indikasi ikan mengandung formalin?',
    'Mengapa tekstur ikan bisa sangat kenyal?',
    'Cara penyimpanan ikan segar di pasar?',
    'Perbedaan bau ikan segar vs rusak?',
    'Langkah mencegah kontaminasi silang?',
    'Apa parameter mutu utama ikan segar?'
  ];
  const LOCAL_FAQ = [
    {k:/formalin|indikasi.*formalin/i,a:'Indikasi formalin: insang pucat keabu-abuan, bau kimia tajam, tekstur terlalu kenyal. Perlu uji cepat untuk konfirmasi.'},
    {k:/boraks|borax/i,a:'Indikasi boraks: daging sangat kenyal sulit sobek, warna cerah tidak wajar, perlu uji kit untuk memastikan.'},
    {k:/ciri.*ikan segar|pilih.*ikan/i,a:'Ciri ikan segar: mata cembung jernih, insang merah cerah, bau laut alami, daging elastis, kulit mengkilap berlendir jernih.'},
    {k:/penyimpanan|simpan.*ikan/i,a:'Simpan ikan 0â€“4Â°C dengan es bersih, tiriskan lelehan, kemas tertutup, bekukan bila >2 hari simpan.'},
    {k:/organoleptik|skor/i,a:'Organoleptik mencakup: mata, insang, bau, tekstur, lendir/kulit. Skor tinggi = segar.'}
  ];

  let settings = loadSettings();
  let history = []; // {role:'user'|'assistant', text, model}
  let isOpen = false;
  let busy = false;

  function loadSettings(){
    try {
      const s = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
      return {...DEFAULTS, ...s};
    } catch { return {...DEFAULTS}; }
  }
  function saveSettings(){
    localStorage.setItem(LS_KEY, JSON.stringify(settings));
  }

  function waitForApp(cb){
    if(window.App && typeof window.App.toast === 'function'){
      cb();
    } else {
      setTimeout(()=> waitForApp(cb), 120);
    }
  }

  function $(sel){ return document.querySelector(sel); }

  function initUIBindings(){
    // Panel controls
    $('#aiSaveSettings')?.addEventListener('click', savePanelSettings);
    $('#aiLoadDefaults')?.addEventListener('click', ()=> {
      settings = {...DEFAULTS};
      fillPanel();
      saveSettings();
      toast('Pengaturan AI direset');
    });
    $('#aiOpenChatFromPanel')?.addEventListener('click', openModal);

    $('#aiTestBtn')?.addEventListener('click', async ()=>{
      if(!settings.apiKey) return toast('Isi API key dulu','warn');
      setPanelStatus('MengujI koneksi...');
      const ok = await testConnection();
      setPanelStatus(ok?'Tes OK':'Tes gagal');
      toast(ok?'Tes berhasil':'Tes gagal','info');
    });

    $('#aiClearHistoryBtn')?.addEventListener('click', ()=>{
      history = [];
      renderHistory();
      toast('Riwayat chat dibersihkan');
    });

    // FAB
    $('#fabAI')?.addEventListener('click', openModal);

    // Modal
    $('#aiCloseModal')?.addEventListener('click', closeModal);
    $('#aiClearBtn')?.addEventListener('click', ()=>{
      history=[];
      renderHistory();
      $('#aiFallbackNote')?.classList.add('hidden');
      statusLine('Riwayat dibersihkan','info');
    });

    // Chat form
    $('#aiChatForm')?.addEventListener('submit', e=>{
      e.preventDefault();
      if(busy) return;
      const val = $('#aiUserInput').value.trim();
      if(!val) return;
      $('#aiUserInput').value='';
      pushMessage('user', val);
      askAI(val);
    });

    // Quick examples
    buildExamples();
    fillPanel();
    toggleFabVisibility(true);
  }

  function toggleFabVisibility(show){
    const fab = $('#fabAI');
    if(fab){
      fab.classList.toggle('hidden', !show);
    }
  }

  function fillPanel(){
    $('#aiApiKey') && ($('#aiApiKey').value = settings.apiKey);
    $('#aiModelSelect') && ($('#aiModelSelect').value = settings.model);
    $('#aiAnswerMode') && ($('#aiAnswerMode').value = settings.mode);
    $('#aiContextPrefix') && ($('#aiContextPrefix').value = settings.context);
  }

  function savePanelSettings(){
    settings.apiKey = $('#aiApiKey')?.value.trim() || '';
    settings.model  = $('#aiModelSelect')?.value || DEFAULTS.model;
    settings.mode   = $('#aiAnswerMode')?.value || 'short';
    settings.context= $('#aiContextPrefix')?.value.trim() || DEFAULTS.context;
    saveSettings();
    $('#aiModelBadge') && ($('#aiModelBadge').textContent = settings.model);
    toast('Pengaturan AI disimpan','success');
  }

  function buildExamples(){
    const wrap = $('#aiQuickExamples');
    if(!wrap) return;
    wrap.innerHTML = EXAMPLES.map(q=> `<div class="ai-chip" data-ai-example="${escapeHtml(q)}">${escapeHtml(q)}</div>`).join('');
    wrap.querySelectorAll('[data-ai-example]').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        openModal();
        const q = ch.getAttribute('data-ai-example');
        pushMessage('user', q);
        askAI(q);
      });
    });
  }

  function escapeHtml(s=''){
    return s.replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  function openModal(){
    isOpen = true;
    $('#aiChatModal')?.classList.add('show');
    $('#aiUserInput')?.focus();
    $('#aiModelBadge') && ($('#aiModelBadge').textContent = settings.model);
    renderHistory();
  }

  function closeModal(){
    isOpen = false;
    $('#aiChatModal')?.classList.remove('show');
  }

  function pushMessage(role,text, model){
    history.push({role,text,model});
    // Trim (max 14 messages stored)
    if(history.length>28) history = history.slice(history.length-28);
    renderHistory();
  }

  function renderHistory(){
    const box = $('#aiChatHistory');
    if(!box) return;
    box.innerHTML = history.map(h=>{
      return `<div class="ai-msg ${h.role==='user'?'user':'ai'}">
        <div class="ai-bubble">${escapeHtml(h.text)}</div>
        ${h.model? `<div class="ai-meta">${escapeHtml(h.model)}</div>`:''}
      </div>`;
    }).join('') || `<div class="small muted" style="opacity:.7;">Mulai tanya apa saja seputar mutu ikan...</div>`;
    box.scrollTop = box.scrollHeight;
  }

  function statusLine(text,type='info'){
    const el = $('#aiStatusText');
    if(!el) return;
    el.textContent = text;
    el.style.color =
      type==='error' ? '#dc2626' :
      type==='warn'  ? '#f59e0b' :
      type==='ok'    ? '#059669' :
      'hsl(var(--accent)/0.9)';
  }

  function toast(msg,type='info',dur=2500){
    if(window.App && typeof App.toast==='function') App.toast(msg,type,dur);
    else console.log('[AI TOAST]',msg);
  }

  function setPanelStatus(txt){
    const el = $('#aiPanelStatus');
    if(el) el.textContent = txt;
  }

  function localFallback(q){
    for(const f of LOCAL_FAQ){
      if(f.k.test(q)) return f.a + ' (fallback lokal)';
    }
    return 'Maaf, sistem gagal terhubung ke model. Prinsip umum: nilai kesegaran ikan dari mata, insang, bau, tekstur, dan lendir. (fallback lokal).';
  }

  async function testConnection(){
    try {
      const reply = await requestGroq([{role:'user',content:'Halo sebutkan satu ciri ikan segar.'}], true);
      return !!reply;
    }catch{ return false; }
  }

  function buildMessages(userText){
    const ctx = settings.context;
    const modeInstr = settings.mode==='detail'
      ? 'Jawab detail, terstruktur poin penting, tetap relevan.'
      : 'Jawab singkat & jelas.';
    // Ambil 3 pasang terakhir
    const recent = history.slice(-6).map(h=> ({role:h.role==='assistant'?'assistant':'user', content:h.text}));
    return [
      {role:'system', content: `${ctx} ${modeInstr}`},
      ...recent,
      {role:'user', content:userText}
    ];
  }

  async function askAI(question){
    if(!settings.apiKey){
      pushMessage('assistant','API Key belum diset. Buka panel AI dan isi dulu.','system');
      statusLine('API key kosong','warn');
      return;
    }
    busy = true;
    statusLine('Menghubungi model...','info');
    const thinkingId = `__thinking_${Date.now()}`;
    pushMessage('assistant','... mengetik ...');
    try {
      const messages = buildMessages(question);
      const reply = await requestGroq(messages,false);
      // Ganti bubble terakhir (placeholder)
      history = history.map((m,i)=> i===history.length-1? {...m, text: reply || '(kosong)', model: settings.model } : m);
      statusLine('Selesai','ok');
      $('#aiFallbackNote')?.classList.add('hidden');
    } catch(err){
      // Replace placeholder
      history = history.map((m,i)=> i===history.length-1? {...m, text: localFallback(question), model: 'fallback'} : m);
      statusLine('Fallback lokal','warn');
      const note = $('#aiFallbackNote');
      note && (note.textContent = 'Fallback digunakan: '+ (err.message||'gagal'));
      note && note.classList.remove('hidden');
    } finally {
      busy=false;
      renderHistory();
    }
  }

  async function requestGroq(messages, silent){
    const controller = new AbortController();
    const t = setTimeout(()=> controller.abort(), 30000);
    try {
      const res = await fetch('https://api.groq.com/openai/v1/chat/completions',{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer '+settings.apiKey
        },
        body: JSON.stringify({
          model: settings.model,
          messages,
          max_tokens: settings.mode==='detail'? 650: 350,
          temperature: 0.6,
          stream:false
        }),
        signal: controller.signal
      });
      const json = await res.json();
      if(!res.ok) throw new Error(json.error?.message || res.statusText);
      const txt = json.choices?.[0]?.message?.content?.trim();
      if(!txt) throw new Error('Jawaban kosong');
      if(!silent) $('#aiModelBadge') && ($('#aiModelBadge').textContent = settings.model);
      return txt;
    } catch(err){
      if(!silent) console.warn('[AI ERROR]',err);
      throw err;
    } finally {
      clearTimeout(t);
    }
  }

  function attachNavHook(){
    // Jika nav button sudah dimasukkan manual, tombol akan otomatis bekerja karena App.showView membaca data-view
    // Pastikan ketika view "ai-assistant" ditampilkan, panel terisi
    const observer = new MutationObserver(()=> {
      const navBtn = document.querySelector('.nav button[data-view="ai-assistant"]');
      if(navBtn && !navBtn.dataset.aiBound){
        navBtn.dataset.aiBound = '1';
        navBtn.addEventListener('click', ()=>{
          fillPanel();
        });
      }
    });
    observer.observe(document.body,{childList:true, subtree:true});
  }

  // Init sequence
  waitForApp(()=>{
    attachNavHook();
    initUIBindings();
    // Jika user sudah login (App.state.currentUser) baru tampilkan FAB
    setTimeout(()=>{
      if(window.App?.state?.currentUser){
        toggleFabVisibility(true);
      }
    },0);
  });

})();

/* ========= WELCOME MODAL LOGIC ========= */
function showWelcomeModalOnce(){
  try {
    // Flag lokal (per browser). Jika ingin per user di server, bisa simpan di Firestore user profile.
    const hidden = localStorage.getItem('hideWelcomeModal') === '1';
    if(hidden) return;
    const modal = document.getElementById('welcomeModal');
    if(!modal) return;
    // Tampilkan hanya jika user sudah login & berada di dashboard (panggil setelah initLoggedIn).
    modal.classList.add('show');
    feather.replace();
  } catch(e){
    console.warn('Welcome modal error:', e);
  }
}

function hideWelcomeModal(savePreference){
  const modal = document.getElementById('welcomeModal');
  if(!modal) return;
  if(savePreference){
    localStorage.setItem('hideWelcomeModal','1');
  }
  modal.classList.remove('show');
}

// Binding event untuk tombol modal (dipanggil sekali saat init)
function bindWelcomeModalEvents(){
  const c = document.getElementById('welcomeCloseBtn');
  const ok = document.getElementById('welcomeOkBtn');
  const setBtn = document.getElementById('welcomeSettingsBtn');
  const modal = document.getElementById('welcomeModal');

  if(c) c.addEventListener('click', ()=> hideWelcomeModal(
    document.getElementById('welcomeDontShow')?.checked
  ));
  if(ok) ok.addEventListener('click', ()=> hideWelcomeModal(
    document.getElementById('welcomeDontShow')?.checked
  ));
  if(setBtn) setBtn.addEventListener('click', ()=>{
    hideWelcomeModal(document.getElementById('welcomeDontShow')?.checked);
    // Buka langsung view settings
    if(window.App && typeof App.showView==='function'){
      App.showView('settings');
      App.toast('Buka Pengaturan','info',1400);
    }
  });
  if(modal){
    modal.addEventListener('click', e=>{
      if(e.target===modal){
        hideWelcomeModal(document.getElementById('welcomeDontShow')?.checked);
      }
    });
  }
}


  /* ------------------ PUBLIC API ------------------ */
    const PublicAPI = {
    state,
    showView,
    applyI18n,
    toast,
    rebuildCharts,
    updateProfileStats   
  };


  // Jalankan
  init();
  return PublicAPI;
})();

</script>
<script>
/* ========== HACCP / CCP MODULE ========== */
(function(){
  if(!window.App || !firebase) {
    console.warn('HACCP Module: App atau Firebase belum siap.');
    return;
  }
  const db = firebase.firestore();
  const HACCP = {
    state: {
      master: [],
      checks: [],
      filter: { from:'', to:'', ccpId:'' }
    },
    init(){
      this.cacheEls();
      this.bind();
      this.loadMaster();
      this.loadChecksRealtime();
      this.fillFilterSelects();
      console.log('[HACCP] initialized');
    },
    cacheEls(){
      this.el = {
        ccpMasterList: document.getElementById('ccpMasterList'),
        ccpAddBtn: document.getElementById('ccpAddBtn'),
        ccpSelect: document.getElementById('ccpSelect'),
        ccpForm: document.getElementById('ccpCheckForm'),
        ccpObserved: document.getElementById('ccpObserved'),
        ccpDate: document.getElementById('ccpDate'),
        ccpAction: document.getElementById('ccpAction'),
        ccpNotes: document.getElementById('ccpNotes'),
        ccpFormAlert: document.getElementById('ccpFormAlert'),
        historyBody: document.getElementById('ccpHistoryBody'),
        historyEmpty: document.getElementById('ccpHistoryEmpty'),
        filterFrom: document.getElementById('ccpFilterDateFrom'),
        filterTo: document.getElementById('ccpFilterDateTo'),
        filterSelect: document.getElementById('ccpFilterSelect'),
        filterApply: document.getElementById('ccpFilterApply'),
        filterClear: document.getElementById('ccpFilterClear'),
        refreshBtn: document.getElementById('haccpRefreshBtn'),
        exportCsv: document.getElementById('haccpExportCsv'),
        formReset: document.getElementById('ccpFormReset')
      };
      if(this.el.ccpDate) this.el.ccpDate.value = new Date().toISOString().split('T')[0];
    },
    bind(){
      this.el.ccpAddBtn && (this.el.ccpAddBtn.onclick = ()=> this.promptAddMaster());
      this.el.ccpForm && (this.el.ccpForm.onsubmit = e=>{
        e.preventDefault();
        this.submitCheck();
      });
      this.el.formReset && (this.el.formReset.onclick = ()=> this.resetForm());
      this.el.filterApply && (this.el.filterApply.onclick = ()=> this.renderHistory());
      this.el.filterClear && (this.el.filterClear.onclick = ()=> {
        this.state.filter = {from:'',to:'',ccpId:''};
        this.el.filterFrom.value='';
        this.el.filterTo.value='';
        this.el.filterSelect.value='';
        this.renderHistory();
      });
      this.el.refreshBtn && (this.el.refreshBtn.onclick = ()=> {
        this.loadMaster();
        this.renderHistory(true);
        App.toast('HACCP disegarkan','info');
      });
      this.el.exportCsv && (this.el.exportCsv.onclick = ()=> this.exportCsv());
    },
    fillFilterSelects(){
      const opts = ['<option value="">Semua CCP</option>', ...this.state.master.map(m=> `<option value="${m.id}">${this.escape(m.name)}</option>`)].join('');
      if(this.el.ccpSelect) this.el.ccpSelect.innerHTML = '<option value="" disabled selected>Pilih...</option>'+ this.state.master.map(m=> `<option value="${m.id}">${this.escape(m.name)}</option>`).join('');
      if(this.el.filterSelect) this.el.filterSelect.innerHTML = opts;
    },
    escape(s=''){ return s.toString().replace(/[<>"&]/g,c=>({'<':'&lt;','>':'&gt;','"':'&quot;','&':'&amp;'}[c])); },
    async loadMaster(){
      const snap = await db.collection('metaCCP').orderBy('name').get();
      this.state.master = snap.docs.map(d=> ({id:d.id,...d.data()}));
      this.renderMaster();
      this.fillFilterSelects();
    },
    loadChecksRealtime(){
      // Real-time (bisa dibatasi misal 500 terakhir)
      db.collection('ccpChecks').orderBy('createdAt','desc').limit(500)
        .onSnapshot(snap=>{
          this.state.checks = snap.docs.map(d=> ({id:d.id,...d.data()}));
          this.renderHistory();
        });
    },
    renderMaster(){
      const wrap = this.el.ccpMasterList;
      if(!wrap) return;
      if(!this.state.master.length){
        wrap.innerHTML = '<div class="small muted">Belum ada CCP. Tambahkan.</div>';
        return;
      }
      wrap.innerHTML = this.state.master.map(m=> `
        <div class="haccp-master-item" data-ccp-id="${m.id}">
          <div>
            <div style="font-weight:700;font-size:.58rem;">${this.escape(m.name)}</div>
            <div class="haccp-master-meta">
              <span class="ccp-tag">${this.escape(m.parameter||'-')}</span>
              <span class="ccp-tag">Limit: ${m.limitMin??'-'} â€“ ${m.limitMax??'-'} ${this.escape(m.unit||'')}</span>
              <span class="ccp-tag">${this.escape(m.frequency||'')}</span>
            </div>
            <div style="margin-top:.3rem;font-size:.48rem;opacity:.8;">
              Koreksi: ${this.escape(m.correctiveTemplate||'-')}
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:.35rem;">
            <button class="ccp-action-btn" data-edit-ccp="${m.id}">
              <i data-feather="edit-2" width="11"></i>
            </button>
            <button class="ccp-action-btn" data-del-ccp="${m.id}" style="background:linear-gradient(135deg,#ef4444,#b91c1c);">
              <i data-feather="trash" width="11"></i>
            </button>
          </div>
        </div>
      `).join('');
      feather.replace();
      wrap.querySelectorAll('[data-del-ccp]').forEach(b=>{
        b.onclick = ()=> this.deleteMaster(b.getAttribute('data-del-ccp'));
      });
      wrap.querySelectorAll('[data-edit-ccp]').forEach(b=>{
        b.onclick = ()=> this.editMasterPrompt(b.getAttribute('data-edit-ccp'));
      });
    },
    promptAddMaster(){
      if(!App.state.currentUser) return App.toast('Login dulu','warn');
      const name = prompt('Nama CCP (Contoh: Suhu Penyimpanan Ikan)?');
      if(!name) return;
      const parameter = prompt('Parameter (misal: Suhu)') || '';
      const limitMin = prompt('Limit Minimum (kosongkan jika tidak ada)');
      const limitMax = prompt('Limit Maksimum (kosongkan jika tidak ada)');
      const unit     = prompt('Satuan (Â°C / ppm / dll)') || '';
      const freq     = prompt('Frekuensi (Harian / Tiap Batch / etc)') || '';
      const corr     = prompt('Template Tindakan Koreksi') || '';
      this.addMaster({
        name: name.trim(),
        parameter: parameter.trim(),
        limitMin: limitMin===''? null: parseFloat(limitMin),
        limitMax: limitMax===''? null: parseFloat(limitMax),
        unit: unit.trim(),
        frequency: freq.trim(),
        correctiveTemplate: corr.trim()
      });
    },
    async addMaster(data){
      try{
        await db.collection('metaCCP').add({
          ...data,
          createdBy: App.state.currentUser.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        App.toast('CCP ditambahkan','success');
        this.loadMaster();
      }catch(err){
        App.toast('Gagal tambah CCP','danger');
        console.error(err);
      }
    },
    editMasterPrompt(id){
      const m = this.state.master.find(x=> x.id===id);
      if(!m) return;
      const name = prompt('Nama CCP:', m.name) || m.name;
      const parameter = prompt('Parameter:', m.parameter||'') || m.parameter;
      const limitMin = prompt('Limit Min (kosong utk null):', m.limitMin??'');
      const limitMax = prompt('Limit Max (kosong utk null):', m.limitMax??'');
      const unit     = prompt('Satuan:', m.unit||'') || m.unit;
      const freq     = prompt('Frekuensi:', m.frequency||'') || m.frequency;
      const corr     = prompt('Template Koreksi:', m.correctiveTemplate||'') || m.correctiveTemplate;
      this.updateMaster(id,{
        name: name.trim(),
        parameter: parameter.trim(),
        limitMin: limitMin===''? null: parseFloat(limitMin),
        limitMax: limitMax===''? null: parseFloat(limitMax),
        unit: unit.trim(),
        frequency: freq.trim(),
        correctiveTemplate: corr.trim()
      });
    },
    async updateMaster(id,data){
      try{
        await db.collection('metaCCP').doc(id).update({
          ...data,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        App.toast('CCP diperbarui','success');
        this.loadMaster();
      }catch(err){
        App.toast('Gagal update CCP','danger');
      }
    },
    deleteMaster(id){
      App.state.userProfile?.role!=='Admin' && App.state.userProfile?.role!=='Petugas Pasar'
        ? App.toast('Tidak berhak hapus (demo)','warn')
        : App.Modal?.open // jika mau reuse modal global (tidak ada expose). Pakai confirm sederhana:
      ;
      if(!confirm('Hapus CCP ini?')) return;
      db.collection('metaCCP').doc(id).delete()
        .then(()=> App.toast('CCP dihapus','success'))
        .catch(()=> App.toast('Gagal hapus','danger'));
    },
    resetForm(){
      if(this.el.ccpObserved) this.el.ccpObserved.value='';
      if(this.el.ccpAction) this.el.ccpAction.value='';
      if(this.el.ccpNotes) this.el.ccpNotes.value='';
    },
    submitCheck(){
      if(!App.state.currentUser) return App.toast('Login dulu','warn');
      const ccpId = this.el.ccpSelect.value;
      if(!ccpId){ this.formAlert('danger','CCP belum dipilih'); return; }
      const cc = this.state.master.find(m=> m.id===ccpId);
      if(!cc){ this.formAlert('danger','Master CCP tidak ditemukan'); return; }
      const obsVal = parseFloat(this.el.ccpObserved.value);
      if(isNaN(obsVal)){ this.formAlert('danger','Nilai tidak valid'); return; }
      const dateStr = this.el.ccpDate.value || new Date().toISOString().split('T')[0];
      const dOnly = new Date(dateStr+'T00:00:00');
      let status = 'OK';
      if((cc.limitMin!==null && obsVal < cc.limitMin) || (cc.limitMax!==null && obsVal > cc.limitMax)){
        status = 'OUT';
      }
      const actionTxt = this.el.ccpAction.value.trim();
      if(status==='OUT' && !actionTxt){
        this.formAlert('warn','OUT OF LIMIT. Harus isi tindakan koreksi.');
        return;
      }
      db.collection('ccpChecks').add({
        ccpId: cc.id,
        ccpName: cc.name,
        parameter: cc.parameter,
        unit: cc.unit || '',
        limitMin: cc.limitMin,
        limitMax: cc.limitMax,
        observedValue: obsVal,
        status,
        actionTaken: actionTxt,
        notes: this.el.ccpNotes.value.trim(),
        date: dOnly,
        userId: App.state.currentUser.uid,
        userName: App.state.userProfile?.name || 'User',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(()=>{
        this.formAlert('success','Monitoring disimpan');
        this.resetForm();
      }).catch(e=>{
        console.error(e);
        this.formAlert('danger','Gagal simpan');
      });
    },
    formAlert(type,msg){
      if(!this.el.ccpFormAlert) return;
      this.el.ccpFormAlert.innerHTML = `
        <div class="alert ${type}">
          <i data-feather="${type==='success'?'check-circle':type==='danger'?'alert-triangle':'info'}" width="13"></i>
          <span>${msg}</span>
        </div>`;
      feather.replace();
      setTimeout(()=> {
        this.el.ccpFormAlert.innerHTML='';
      },3800);
    },
    renderHistory(noFilterMsg){
      const body = this.el.historyBody;
      const empty = this.el.historyEmpty;
      if(!body) return;
      let data = [...this.state.checks];
      // Filters
      const from = this.el.filterFrom.value;
      const to   = this.el.filterTo.value;
      const ccpId= this.el.filterSelect.value;
      if(from){
        const fd = new Date(from+'T00:00:00');
        data = data.filter(r=> r.date && r.date.toDate && r.date.toDate() >= fd);
      }
      if(to){
        const td = new Date(to+'T23:59:59');
        data = data.filter(r=> r.date && r.date.toDate && r.date.toDate() <= td);
      }
      if(ccpId) data = data.filter(r=> r.ccpId===ccpId);

      if(!data.length){
        body.innerHTML='';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      body.innerHTML = data.map(r=>{
        const limitTxt = `${r.limitMin??'-'} â€“ ${r.limitMax??'-'} ${this.escape(r.unit||'')}`;
        return `
          <tr>
            <td>${r.date? (r.date.toDate? r.date.toDate(): r.date).toLocaleDateString('id-ID'):''}</td>
            <td>${this.escape(r.ccpName||'')}</td>
            <td>${this.escape(r.parameter||'')}</td>
            <td>${r.observedValue}</td>
            <td>${limitTxt}</td>
            <td>
              <span class="${r.status==='OK'?'haccp-status-ok':'haccp-status-out'}">${r.status}</span>
            </td>
            <td style="max-width:180px;">${this.escape(r.actionTaken||'-')}</td>
            <td style="font-size:.5rem;">${this.escape(r.userName||'')}</td>
            <td>
              ${ (App.state.userProfile?.role==='Admin' || App.state.userProfile?.role==='Petugas Pasar' || r.userId===App.state.currentUser?.uid)
                ? `<button class="outline small" data-del-check="${r.id}" title="Hapus"><i data-feather="trash" width="11"></i></button>`:''
              }
            </td>
          </tr>
        `;
      }).join('');
      feather.replace();
      body.querySelectorAll('[data-del-check]').forEach(btn=>{
        btn.onclick = ()=> this.deleteCheck(btn.getAttribute('data-del-check'));
      });
    },
    deleteCheck(id){
      if(!confirm('Hapus monitoring ini?')) return;
      db.collection('ccpChecks').doc(id).delete()
        .then(()=> App.toast('Monitoring dihapus','success'))
        .catch(()=> App.toast('Gagal hapus','danger'));
    },
    exportCsv(){
      if(!this.state.checks.length) return App.toast('Tidak ada data','warn');
      const lines = [
        ['Tanggal','CCP','Parameter','Observed','LimitMin','LimitMax','Unit','Status','Action','User']
      ];
      this.state.checks.forEach(r=>{
        const d = r.date? (r.date.toDate? r.date.toDate(): r.date): null;
        lines.push([
          d? d.toISOString().split('T')[0]:'-',
          r.ccpName||'',
          r.parameter||'',
          r.observedValue,
          r.limitMin??'',
          r.limitMax??'',
          r.unit||'',
          r.status,
          (r.actionTaken||'').replace(/"/g,'""'),
          r.userName||''
        ]);
      });
      const csv = lines.map(row=> row.map(v=> `"${v}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download='haccp_ccp_checks.csv';
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href),1200);
      App.toast('CSV HACCP diekspor','success');
    }
  };

  // Inisialisasi ketika user sudah login (App.init memanggil modul setelah ready)
  // Agar aman, tunggu sedikit
  setTimeout(()=> {
    HACCP.init();
    // Tambah ke App agar bisa diakses: App.haccp
    App.haccp = HACCP;
  }, 1200);
})();
</script>
<script>
/* ==========================================================
   MICRO-LEARNING MODULE
   Fitur:
   - Daftar modul singkat
   - Navigasi slide
   - Quiz pilihan ganda
   - Simpan progress (localStorage + update user achievements)
   - Award lencana "Quality Steward" saat semua quiz lulus
   ========================================================== */
(function(){
  if(!window.App || !firebase) {
    console.warn('[MicroLearning] App belum siap');
    return;
  }
  const db = firebase.firestore();

  // --------- KONFIGURASI MODUL ----------
  const modules = [
    {
      id:'mod1',
      title:'Dasar Mutu Ikan Segar',
      duration:'Â±2 mnt',
      slides:[
        { h:'Tujuan Penilaian', b:'Menilai kesegaran untuk memastikan keamanan konsumsi dan nilai ekonomi optimal.\nParameter organoleptik utama: Mata, Insang, Bau, Tekstur, Lendir/Kulit.' },
        { h:'Mata & Insang', b:'Mata segar: cembung dan jernih.\nInsang: merah cerah, lendir bening.\nPerubahan cepat: mata menjadi datar/keruh, insang kecoklatan.' },
        { h:'Bau & Tekstur', b:'Bau segar: laut / amis lembut.\nBau asam tajam = degradasi.\nTekstur segar: elastis kembali cepat saat ditekan.' }
      ],
      quiz:{
        pass:80,
        questions:[
          {
            q:'Ciri mata ikan segar yang benar:',
            options:['Cekung & keruh','Cembung & jernih','Cekung & jernih'],
            answer:1
          },
          {
            q:'Bau ikan menurun mutu ditandai:',
            options:['Amis ringan alami','Netral laut','Asam tajam menyengat'],
            answer:2
          },
          {
            q:'Tekstur segar saat ditekan:',
            options:['Tidak kembali','Kembali cepat','Retak'],
            answer:1
          }
        ]
      }
    },
    {
      id:'mod2',
      title:'Indikasi Keamanan (Formalin/Boraks)',
      duration:'Â±2 mnt',
      slides:[
        { h:'Formalin', b:'Indikasi lapangan (tidak konklusif):\nInsang terlalu pucat keabu-abuan, bau kimia menyengat.\nPerlu uji cepat untuk konfirmasi.' },
        { h:'Boraks', b:'Daging terlalu kenyal elastis tidak wajar & sulit robek.\nLendir cenderung berkurang, warna bisa lebih cerah.\nButuh uji kit untuk validasi.' },
        { h:'Catatan', b:'Semua indikasi = observasi awal. Gunakan istilah "indikasi" sampai bukti laboratorium ada.' }
      ],
      quiz:{
        pass:80,
        questions:[
          {
            q:'Indikasi formalin yang sering diamati:',
            options:['Insang merah cerah','Bau kimia tajam','Mata cembung jernih'],
            answer:1
          },
          {
            q:'Daging sangat kenyal elastis â†’ indikasi:',
            options:['Boraks','Formalin','Busuk lanjut'],
            answer:0
          }
        ]
      }
    },
    {
      id:'mod3',
      title:'Penanganan & Suhu',
      duration:'Â±2 mnt',
      slides:[
        { h:'Suhu Ideal', b:'Rantai dingin 0â€“4Â°C memperlambat pertumbuhan bakteri & oksidasi.\nGunakan es bersih & tiriskan lelehan.' },
        { h:'Higiene', b:'Gunakan permukaan bersih, cegah kontaminasi silang.\nPisahkan ikan rusak dari ikan segar.' },
        { h:'Ringkasan', b:'Kontrol suhu + higiene dasar = perpanjang masa kesegaran & kurangi risiko keamanan.' }
      ],
      quiz:{
        pass:80,
        questions:[
          {
            q:'Rentang suhu ideal ikan segar:',
            options:['10â€“15Â°C','5â€“8Â°C','0â€“4Â°C'],
            answer:2
          },
          {
            q:'Tujuan pemisahan ikan rusak:',
            options:['Agar tampak banyak','Cegah kontaminasi silang','Mengurangi es'],
            answer:1
          }
        ]
      }
    }
  ];

  // ------------- STATE LOKAL --------------
  const ML = {
    active:null,
    slideIndex:0,
    progress: loadProgress(),  // { modId: { slideIndex, quizPassed } }
  };

  function saveProgress(){
    localStorage.setItem('mlProgress_v1', JSON.stringify(ML.progress));
  }
  function loadProgress(){
    try { return JSON.parse(localStorage.getItem('mlProgress_v1')||'{}'); }
    catch { return {}; }
  }

  // Integrasi ke App.state
  App.state.microLearning.progress = ML.progress;

  // ------------- RENDER LIST MODUL --------------
  function renderModuleList(){
    const wrap = $('#mlModuleList');
    if(!wrap) return;
    wrap.innerHTML = modules.map(m=>{
      const pr = ML.progress[m.id] || {};
      const passed = pr.quizPassed;
      return `
        <div class="micro-module-item ${ML.active===m.id?'active':''}" data-ml-open="${m.id}">
          <div style="font-weight:700;">${escapeHtml(m.title)}</div>
          <div style="display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.3rem;">
            <span class="tag"><i data-feather="clock" width="11"></i>${m.duration}</span>
            ${passed? '<span class="tag micro-badge-pass"><i data-feather="check" width="11"></i>Lulus</span>':''}
          </div>
        </div>
      `;
    }).join('');
    feather.replace();
    $all('[data-ml-open]').forEach(el=>{
      el.onclick = ()=> openModule(el.getAttribute('data-ml-open'));
    });
  }

  // ------------- OPEN MODULE --------------
  function openModule(id){
    ML.active = id;
    const pr = ML.progress[id] || { slideIndex:0, quizPassed:false };
    ML.slideIndex = pr.slideIndex || 0;
    hideAllStages();
    $('#mlStageSlides')?.classList.remove('hidden');
    renderModuleList();
    renderSlide();
  }

  function hideAllStages(){
    $('#mlStageIdle')?.classList.add('hidden');
    $('#mlStageSlides')?.classList.add('hidden');
    $('#mlStageQuiz')?.classList.add('hidden');
  }

  // ------------- RENDER SLIDE --------------
  function renderSlide(){
    const mod = modules.find(m=> m.id===ML.active);
    if(!mod) return;
    const slide = mod.slides[ML.slideIndex];
    $('#mlSlideTitle').textContent = slide.h;
    $('#mlSlideBody').textContent  = slide.b;
    $('#mlSlideCounter').textContent = (ML.slideIndex+1)+'/'+mod.slides.length;
    const pct = ((ML.slideIndex+1)/mod.slides.length)*100;
    $('#mlSlideBar').style.width = pct+'%';
    feather.replace();
  }

  // ------------- NAV SLIDE --------------
  function nextSlide(){
    const mod = modules.find(m=> m.id===ML.active);
    if(!mod) return;
    if(ML.slideIndex < mod.slides.length-1){
      ML.slideIndex++;
      storeSlideIndex();
      renderSlide();
    } else {
      // selesai slide -> kuis
      openQuiz();
    }
  }
  function prevSlide(){
    if(ML.slideIndex>0){
      ML.slideIndex--;
      storeSlideIndex();
      renderSlide();
    }
  }
  function storeSlideIndex(){
    ML.progress[ML.active] = ML.progress[ML.active] || {};
    ML.progress[ML.active].slideIndex = ML.slideIndex;
    saveProgress();
    App.state.microLearning.progress = ML.progress;
  }

  // ------------- QUIZ --------------
  function openQuiz(){
    hideAllStages();
    $('#mlStageQuiz')?.classList.remove('hidden');
    const mod = modules.find(m=> m.id===ML.active);
    $('#mlQuizModuleTitle').textContent = mod.title;
    $('#mlQuizResult').textContent = '';
    $('#mlQuizStatus').textContent = `Lulus: â‰¥${mod.quiz.pass}%`;
    renderQuizQuestions();
  }

  function renderQuizQuestions(){
    const mod = modules.find(m=> m.id===ML.active);
    const wrap = $('#mlQuizQuestions');
    const pr = ML.progress[ML.active] || {};
    // reset jawaban sementara
    pr.quizAnswers = pr.quizAnswers || {};
    wrap.innerHTML = mod.quiz.questions.map((q,qi)=> `
      <div class="micro-question" data-q="${qi}">
        <h4>Q${qi+1}. ${escapeHtml(q.q)}</h4>
        <div class="micro-options">
          ${q.options.map((opt,oi)=> `
            <div class="micro-option ${pr.quizAnswers[qi]===oi?'active':''}" data-opt="${qi}__${oi}">
              <span style="font-weight:700;">${String.fromCharCode(65+oi)}.</span>
              <span>${escapeHtml(opt)}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `).join('');
    feather.replace();
    $all('[data-opt]').forEach(el=>{
      el.onclick = ()=>{
        const [qIdx, oIdx] = el.getAttribute('data-opt').split('__').map(Number);
        pr.quizAnswers[qIdx] = oIdx;
        ML.progress[ML.active] = pr;
        saveProgress();
        // re-render hanya blok itu
        renderQuizQuestions();
      };
    });
  }

  function submitQuiz(){
    const mod = modules.find(m=> m.id===ML.active);
    const pr = ML.progress[ML.active] || {};
    const answers = pr.quizAnswers || {};
    let correct=0;
    mod.quiz.questions.forEach((q,i)=>{
      if(answers[i] === q.answer) correct++;
    });
    const score = (correct / mod.quiz.questions.length)*100;
    const pass = score >= mod.quiz.pass;
    pr.quizPassed = pass;
    ML.progress[ML.active] = pr;
    saveProgress();
    App.state.microLearning.progress = ML.progress;

    // Tandai UI
    showQuizResult(score, correct, mod.quiz.questions.length, pass);
    highlightQuizAnswers(mod, answers);

    if(pass){
      checkAllPassedAndAward();
    }
    renderModuleList();
  }

  function highlightQuizAnswers(mod, answers){
    // Tambahkan kelas correct/wrong
    mod.quiz.questions.forEach((q,i)=>{
      q.options.forEach((_,oi)=>{
        const el = document.querySelector(`.micro-option[data-opt="${i}__${oi}"]`);
        if(!el) return;
        if(oi===q.answer) el.classList.add('correct');
        else if(answers[i]===oi) el.classList.add('wrong');
      });
    });
  }

  function showQuizResult(score, correct, total, pass){
    const el = $('#mlQuizResult');
    el.innerHTML = `
      Skor: <strong>${score.toFixed(1)}%</strong> (${correct}/${total} benar) â€¢ Status: 
      ${pass
        ? '<span class="micro-finish-badge"><i data-feather="check" width="12"></i>LULUS</span>'
        : '<span class="micro-finish-badge" style="background:linear-gradient(135deg,#f59e0b,#d97706);"><i data-feather="alert-triangle" width="12"></i>ULANGI</span>'
      }
      ${pass? '\nLanjutkan modul lain untuk mencapai semua kelulusan.':''}
    `;
    feather.replace();
  }

  // ------------- AWARD --------------
  function checkAllPassedAndAward(){
    const allPassed = modules.every(m=> (ML.progress[m.id] && ML.progress[m.id].quizPassed));
    if(!allPassed) return;
    if(App.state.microLearning.allPassed) return; // sudah
    App.state.microLearning.allPassed = true;

    // Update achievements langsung (jika belum ada)
    if(!(App.state.userProfile?.achievements && App.state.userProfile.achievements['quality_steward'])){
      db.collection('users').doc(App.state.userProfile.id).update({
        'achievements.quality_steward': firebase.firestore.FieldValue.serverTimestamp()
      }).then(()=>{
        App.toast('Lencana "Quality Steward" diraih!','success');
        // Paksa refresh tampilan profil dan stats
        if(App.updateProfileStats) App.updateProfileStats();
      }).catch(()=> App.toast('Gagal update lencana','danger'));
    }
  }

  // ------------- RESET PROGRESS --------------
  function resetProgress(){
    if(!confirm('Reset semua progres micro-learning?')) return;
    ML.progress = {};
    saveProgress();
    App.state.microLearning.progress = ML.progress;
    App.state.microLearning.allPassed = false;
    App.toast('Progress direset','info');
    hideAllStages();
    $('#mlStageIdle')?.classList.remove('hidden');
    renderModuleList();
    if(App.updateProfileStats) App.updateProfileStats();
  }

  // ------------- HELPERS --------------
  const $  = sel=> document.querySelector(sel);
  const $all = sel=> Array.from(document.querySelectorAll(sel));
  function escapeHtml(s=''){ return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

  // ------------- EVENT BIND --------------
  function bindEvents(){
    $('#mlNextSlide')?.addEventListener('click', nextSlide);
    $('#mlPrevSlide')?.addEventListener('click', prevSlide);
    $('#mlExitModule')?.addEventListener('click', ()=>{
      hideAllStages();
      $('#mlStageIdle')?.classList.remove('hidden');
      ML.active=null;
      renderModuleList();
    });
    $('#mlSubmitQuiz')?.addEventListener('click', submitQuiz);
    $('#mlBackToSlides')?.addEventListener('click', ()=>{
      hideAllStages();
      $('#mlStageSlides')?.classList.remove('hidden');
    });
    $('#mlResetProgress')?.addEventListener('click', resetProgress);
  }

  // ------------- INIT --------------
  function init(){
    renderModuleList();
    bindEvents();
  }

  // Tunda sedikit agar view sudah ada di DOM
  setTimeout(init, 600);
})();
</script>
</body>
</html>
          