<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Pencatatan & Monitoring Mutu Ikan Segar - Makassar</title>
<meta name="description" content="Aplikasi pencatatan dan monitoring mutu ikan segar di pasar tradisional Kota Makassar (Single File App)">
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- External Libraries (CDN) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root {
  --accent: 210 100% 50%;
  --radius: 20px;
  --glass-bg: 220 25% 12%;
  --glass-alpha: 0.55;
  --transition: 0.25s cubic-bezier(.4,.0,.2,1);
  --sidebar-width: 250px;
  --danger: #ef4444;
  --warn: #f59e0b;
  --ok: #10b981;
  --info: #3b82f6;
  --font-sans: 'Quicksand', system-ui, sans-serif;
  --gradient-accent: linear-gradient(135deg, hsl(var(--accent)/0.95), hsl(var(--accent)/0.55));
  --space-1: .25rem;
  --space-2: .5rem;
  --space-3: .75rem;
  --space-4: 1rem;
  --space-5: 1.25rem;
  --space-6: 1.75rem;
  --ease-spring: cubic-bezier(.34,1.56,.64,1);
  --font-base: 15px;
  --panel-gap: 1.35rem;
  --layout-max: 1480px;
  --panel-padding: 1.15rem 1.15rem 1.3rem;
  --gradient-bg: radial-gradient(circle at 35% 15%, hsl(var(--accent)/0.22), transparent 70%),
    radial-gradient(circle at 85% 75%, hsl(var(--accent)/0.15), transparent 65%),
    linear-gradient(160deg, hsl(var(--accent)/0.08), transparent 70%);
  --topbar-height: 66px;
}
[data-theme="light"] {
  --glass-bg: 220 40% 98%;
  --glass-alpha: 0.68;
  --text-color: 220 25% 15%;
  --text-dim: 220 15% 42%;
  --bg: 220 35% 97%;
  --panel-border: 220 20% 82%;
  --shadow: 220 40% 30%;
}
[data-theme="dark"] {
  --text-color: 0 0% 100%;
  --text-dim: 220 10% 70%;
  --bg: 220 18% 8%;
  --panel-border: 220 15% 30%;
  --shadow: 220 70% 2%;
}

* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; }
body {
  margin:0;
  font-family: var(--font-sans);
  background: var(--gradient-bg), hsl(var(--bg));
  color: hsl(var(--text-color));
  line-height:1.45;
  -webkit-font-smoothing: antialiased;
  font-size: var(--font-base);
  transition: background .6s ease, font-size .4s;
}

h1,h2,h3,h4 { font-weight:600; margin:0 0 var(--space-3); }
p { margin:0 0 var(--space-4); }
main.content > section { max-width: var(--layout-max); margin: 0 auto; width:100%; }

a { color:hsl(var(--accent)/0.9); text-decoration:none; outline:none; }
a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
  outline:2px solid hsl(var(--accent)/0.8);
  outline-offset:2px;
  border-radius:6px;
  transition:outline-color .25s;
}

button {
  font-family:inherit;
  cursor:pointer;
  border:none;
  background: var(--gradient-accent);
  color:#fff;
  padding:.7rem 1rem;
  font-size:.79rem;
  border-radius:14px;
  display:inline-flex;
  gap:.5rem;
  align-items:center;
  font-weight:600;
  letter-spacing:.3px;
  transition: transform .45s var(--ease-spring), background .4s, box-shadow .45s;
  box-shadow:0 6px 18px -4px hsl(var(--accent)/0.55), 0 2px 4px -1px hsl(var(--accent)/0.3);
  position:relative;
  overflow:hidden;
  line-height:1.1;
}
button::before {
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(60deg,rgba(255,255,255,.2),transparent 65%);
  opacity:0;
  transition:opacity .4s;
}
button:hover::before { opacity:1; }
button:hover { transform:translateY(-3px); }
button:active { transform:translateY(0) scale(.97); }

button.outline {
  background:hsl(var(--accent)/0.07);
  border:1px solid hsl(var(--accent)/0.5);
  color:hsl(var(--accent)/0.95);
  box-shadow:none;
}
button.outline:hover { background:hsl(var(--accent)/0.18); }

button.ghost {
  background:hsl(var(--accent)/0.09);
  color:hsl(var(--accent)/0.95);
  box-shadow:none;
}
button.ghost:hover { background:hsl(var(--accent)/0.16); }

button.danger {
  background:linear-gradient(135deg,#ef4444,#b91c1c);
  box-shadow:0 6px 18px -4px rgba(239,68,68,0.55);
}

button.small { padding:.45rem .65rem; font-size:.62rem; border-radius:10px; }

input, select, textarea {
  width:100%;
  border:1px solid hsl(var(--panel-border)/0.55);
  background:hsl(var(--glass-bg)/0.55);
  color:hsl(var(--text-color));
  backdrop-filter: blur(22px) saturate(1.3);
  -webkit-backdrop-filter: blur(22px) saturate(1.3);
  padding:.55rem .75rem;
  font-size:.74rem;
  border-radius:12px;
  outline:none;
  transition:border-color .35s, box-shadow .35s, background .35s;
}
input:focus, select:focus, textarea:focus {
  border-color:hsl(var(--accent)/0.9);
  box-shadow:0 0 0 3px hsl(var(--accent)/0.35);
  background:hsl(var(--glass-bg)/0.7);
}

label {
  font-size:.58rem;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.55px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.4rem;
  margin-bottom:.35rem;
  color:hsl(var(--text-dim));
}

.small { font-size:.7rem; color:hsl(var(--text-dim)); }
.xsmall { font-size:.58rem; }
.muted { opacity:.75; }

.hidden { display:none !important; }
.flex { display:flex; }
.col { flex-direction:column; }
.center { align-items:center; justify-content:center; }
.gap { gap:1rem; }
.gap-s { gap:.5rem; }

.container-auth {
  max-width:520px;
  margin: clamp(2rem,6vh,4rem) auto;
  padding:2.35rem 2.2rem 2.6rem;
  background:linear-gradient(150deg, hsl(var(--glass-bg)/var(--glass-alpha)), hsl(var(--glass-bg)/calc(var(--glass-alpha) + .1)));
  border:1px solid hsl(var(--panel-border)/0.55);
  backdrop-filter:blur(30px) saturate(1.4);
  -webkit-backdrop-filter:blur(30px) saturate(1.4);
  border-radius:40px;
  box-shadow:0 8px 34px -12px rgba(0,0,0,.55), 0 0 0 1px hsl(var(--panel-border)/0.35), inset 0 0 0 1px hsl(var(--accent)/0.08);
  position:relative;
  overflow:hidden;
  animation: cardEnter .9s var(--ease-spring);
}

@keyframes cardEnter {
  from { transform:translateY(18px) scale(.96); opacity:0; }
  to { transform:translateY(0) scale(1); opacity:1; }
}

/* Lite mode */
body.lite-mode .panel,
body.lite-mode .sidebar,
body.lite-mode .topbar,
body.lite-mode .container-auth,
body.lite-mode .table-wrapper,
body.lite-mode .dropdown {
  backdrop-filter:none !important;
  -webkit-backdrop-filter:none !important;
  background:hsl(var(--glass-bg)/0.96) !important;
}
body.lite-mode .panel { box-shadow:0 4px 14px -6px rgba(0,0,0,.25), 0 0 0 1px hsl(var(--panel-border)/0.4);}
body.lite-mode .sidebar { box-shadow:4px 0 16px -8px rgba(0,0,0,.35);}
body.lite-mode #loadingOverlay { backdrop-filter:none; -webkit-backdrop-filter:none; }
body.lite-mode .indicator::before { display:none; }
body.lite-mode .avatar, body.lite-mode .logo-circle { box-shadow:0 4px 12px -6px rgba(0,0,0,.35); }
body.lite-mode #appModal .modal-box { backdrop-filter:none; -webkit-backdrop-filter:none; }

.logo-circle {
  width:62px; height:62px;
  border-radius:20px;
  background:var(--gradient-accent);
  display:grid; place-items:center;
  color:#fff; font-weight:700; font-size:1.1rem; letter-spacing:.9px;
  box-shadow:0 10px 20px -6px hsl(var(--accent)/0.55);
  margin-bottom:.85rem;
  position:relative;
  overflow:hidden;
}
.logo-circle::after {
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(circle at 30% 30%,rgba(255,255,255,.35),transparent 60%),
    linear-gradient(to bottom,rgba(255,255,255,.15),transparent 70%);
  mix-blend-mode:overlay;
}

.glow {
  position:absolute; inset:0;
  background:
    radial-gradient(circle at 20% 15%, hsl(var(--accent)/0.28), transparent 60%),
    radial-gradient(circle at 80% 70%, hsl(var(--accent)/0.25), transparent 65%);
  pointer-events:none;
  mix-blend-mode:screen;
  opacity:.5;
  animation: subtlePulse 6s ease-in-out infinite;
}
@keyframes subtlePulse {
  0%,100% { transform:scale(1); opacity:.45; }
  50% { transform:scale(1.04); opacity:.62; }
}

.switch-auth {
  display:flex;
  gap:.6rem;
  margin-top:.9rem;
  flex-wrap:wrap;
  font-size:.75rem;
  align-items:center;
}

.alert {
  padding:.75rem .9rem;
  border-radius:16px;
  margin-bottom:1rem;
  font-size:.62rem;
  font-weight:600;
  display:flex;
  gap:.55rem;
  align-items:center;
  line-height:1.25;
  position:relative;
  backdrop-filter: blur(14px) saturate(1.2);
  -webkit-backdrop-filter: blur(14px) saturate(1.2);
  animation: fadeIn .5s ease;
}
.alert.info { background:hsl(var(--accent)/0.18); color:hsl(var(--accent)/1); }
.alert.danger { background:rgba(239,68,68,.18); color:var(--danger); }
.alert.success { background:rgba(16,185,129,.20); color:var(--ok); }
.alert.warn { background:rgba(245,158,11,.20); color:var(--warn); }

.layout {
  display:flex;
  min-height:100dvh;
  width:100%;
  overflow:hidden;
  position:relative;
}

.sidebar {
  width:var(--sidebar-width);
  background:linear-gradient(160deg,hsl(var(--glass-bg)/0.78), hsl(var(--glass-bg)/0.58));
  backdrop-filter:blur(36px) saturate(1.5);
  -webkit-backdrop-filter:blur(36px) saturate(1.5);
  border-right:1px solid hsl(var(--panel-border)/0.5);
  display:flex; flex-direction:column;
  padding:1rem 1rem 1.4rem;
  position:relative;
  transition: transform .55s var(--ease-spring);
  box-shadow:8px 0 28px -14px rgba(0,0,0,.55);
  z-index:130;
}

.sidebar-header { display:flex; align-items:center; gap:.7rem; margin-bottom:1.1rem; padding:.25rem .25rem .3rem; }
.sidebar-header h2 { font-size:.92rem; letter-spacing:.6px; line-height:1.1; margin:0; }

.nav {
  display:flex;
  flex-direction:column;
  gap:.35rem;
  flex:1;
  overflow-y:auto;
  padding-right:.25rem;
  scrollbar-width:thin;
}
.nav button {
  justify-content:flex-start;
  background:linear-gradient(to right, hsl(var(--accent)/0.0), hsl(var(--accent)/0.0));
  border:1px solid hsl(var(--panel-border)/0.25);
  color:hsl(var(--text-dim));
  font-weight:500;
  padding:.65rem .7rem;
  border-radius:16px;
  gap:.65rem;
  position:relative;
  box-shadow:none;
  font-size:.64rem;
  letter-spacing:.4px;
  transition: background .45s, color .45s, transform .55s var(--ease-spring), box-shadow .45s;
}
.nav button:hover {
  background:hsl(var(--accent)/0.20);
  color:hsl(var(--accent)/1);
  transform:translateX(4px);
}
.nav button.active {
  background:var(--gradient-accent);
  color:#fff;
  box-shadow:0 10px 26px -10px hsl(var(--accent)/0.65);
  border-color:transparent;
  transform:translateX(0);
}

.sidebar-footer {
  margin-top:.9rem;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  font-size:.6rem;
  color:hsl(var(--text-dim));
}

.main {
  flex:1;
  display:flex;
  flex-direction:column;
  min-width:0;
  position:relative;
  animation: mainReveal .65s var(--ease-spring);
}
@keyframes mainReveal {
  from { opacity:0; transform:translateY(14px); }
  to { opacity:1; transform:translateY(0); }
}

.topbar {
  position: fixed;
  left:var(--sidebar-width);
  right:0;
  height:var(--topbar-height);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:.75rem clamp(.75rem,1.4vw,1.15rem);
  z-index:120;
  background:linear-gradient(to bottom, hsl(var(--glass-bg)/0.92), hsl(var(--glass-bg)/0.60));
  backdrop-filter: blur(28px) saturate(1.35);
  -webkit-backdrop-filter: blur(28px) saturate(1.35);
  border-bottom:1px solid hsl(var(--panel-border)/0.55);
  box-shadow:0 4px 20px -10px rgba(0,0,0,.35);
}

.content {
  padding-top: calc(var(--topbar-height) + 1rem);
}

@media (max-width:1080px){
  .topbar { left:0; }
}
.topbar .group-inline { display:flex; align-items:center; gap:.65rem; flex-wrap:wrap; }

.search-box {
  display:flex;
  align-items:center;
  background:hsl(var(--glass-bg)/0.7);
  border:1px solid hsl(var(--panel-border)/0.6);
  padding:.4rem .65rem;
  gap:.45rem;
  border-radius:14px;
  width:100%;
  max-width:340px;
  position:relative;
  backdrop-filter:blur(22px);
  -webkit-backdrop-filter:blur(22px);
  transition: box-shadow .45s, border-color .45s;
}
.search-box:focus-within {
  border-color:hsl(var(--accent)/0.9);
  box-shadow:0 0 0 3px hsl(var(--accent)/0.35);
}
.search-box input {
  background:transparent;
  padding:.3rem 0;
  border:none;
  font-size:.68rem;
  flex:1;
}

.lang-pill {
  background:hsl(var(--accent)/0.15);
  color:hsl(var(--accent)/0.95);
  padding:.38rem .65rem;
  border-radius:14px;
  font-size:.58rem;
  font-weight:700;
  letter-spacing:.6px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:.35rem;
  transition:background .4s, transform .45s var(--ease-spring);
  border:1px solid hsl(var(--accent)/0.4);
}
.lang-pill:hover { background:hsl(var(--accent)/0.28); transform:translateY(-3px); }

.avatar {
  width:40px;
  height:40px;
  border-radius:16px;
  background: linear-gradient(135deg,hsl(var(--accent)/0.3),hsl(var(--accent)/0.5));
  display:grid;
  place-items:center;
  color:#fff;
  font-weight:600;
  font-size:.78rem;
  position:relative;
  overflow:hidden;
  cursor:pointer;
  border:1px solid hsl(var(--panel-border)/0.45);
  box-shadow:0 6px 18px -8px rgba(0,0,0,.55);
  transition: transform .45s var(--ease-spring), box-shadow .45s;
}
.avatar:hover { transform:translateY(-3px); box-shadow:0 10px 28px -12px rgba(0,0,0,.6); }
.avatar img { width:100%; height:100%; object-fit:cover; display:block; }

.dropdown {
  position:absolute;
  top:110%;
  right:0;
  background:linear-gradient(145deg, hsl(var(--glass-bg)/0.95), hsl(var(--glass-bg)/0.78));
  backdrop-filter: blur(30px) saturate(1.4);
  -webkit-backdrop-filter: blur(30px) saturate(1.4);
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:20px;
  min-width:240px;
  display:none;
  flex-direction:column;
  padding:.5rem;
  box-shadow:0 20px 48px -18px rgba(0,0,0,0.55);
  z-index:200;
  animation: dropdownPop .55s var(--ease-spring);
}
@keyframes dropdownPop {
  from { transform:translateY(12px) scale(.94); opacity:0; }
  to { transform:translateY(0) scale(1); opacity:1; }
}
.dropdown.show { display:flex; }
.dropdown button {
  background:transparent;
  border:1px solid transparent;
  box-shadow:none;
  padding:.6rem .65rem;
  border-radius:14px;
  color:hsl(var(--text-dim));
  font-size:.62rem;
  gap:.55rem;
  justify-content:flex-start;
  font-weight:600;
  letter-spacing:.4px;
  transition: background .4s, color .4s;
}
.dropdown button:hover {
  background:hsl(var(--accent)/0.25);
  color:hsl(var(--accent)/1);
}

.content {
  padding: 1.15rem clamp(.8rem, 1.4vw, 1.25rem) 2.2rem;
  flex:1;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:1.9rem;
  scroll-behavior:smooth;
  position:relative;
}

.grid { display:grid; gap:1.15rem; }

.cards-analytics { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

.panel {
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.66), hsl(var(--glass-bg)/0.48));
  backdrop-filter:blur(38px) saturate(1.55);
  -webkit-backdrop-filter:blur(38px) saturate(1.55);
  border:1px solid hsl(var(--panel-border)/0.65);
  border-radius:34px;
  padding:var(--panel-padding);
  position:relative;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  gap:.9rem;
  box-shadow:0 8px 30px -14px rgba(0,0,0,0.6), 0 0 0 1px hsl(var(--panel-border)/0.35), inset 0 0 0 1px hsl(var(--accent)/0.08);
  animation: panelIn .6s var(--ease-spring);
}
.panel.compact { padding:1rem 1.05rem 1.15rem; }
@keyframes panelIn {
  from { opacity:0; transform:translateY(14px); }
  to { opacity:1; transform:translateY(0); }
}

.panel:hover {
  box-shadow:0 14px 34px -16px rgba(0,0,0,0.65), 0 0 0 1px hsl(var(--panel-border)/0.42), inset 0 0 0 1px hsl(var(--accent)/0.08);
}

.panel.bento { min-height:240px; }

.panel-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1rem;
  flex-wrap:wrap;
  padding-bottom:.45rem;
  border-bottom:1px solid hsl(var(--panel-border)/0.4);
  margin:-.3rem -1.3rem .6rem;
  padding: .7rem 1.3rem .55rem;
  position:relative;
}
.panel-header h3 {
  font-size:.74rem;
  text-transform:uppercase;
  letter-spacing:.75px;
  font-weight:700;
  color:hsl(var(--text-dim));
  margin:0;
  display:flex;
  gap:.5rem;
  align-items:center;
}

.badge {
  display:inline-flex;
  align-items:center;
  gap:.35rem;
  background:hsl(var(--accent)/0.18);
  color:hsl(var(--accent)/0.95);
  padding:.35rem .6rem;
  border-radius:999px;
  font-size:.55rem;
  font-weight:700;
  letter-spacing:.55px;
  text-transform:uppercase;
  box-shadow:0 4px 10px -4px hsl(var(--accent)/0.5);
}

.table-wrapper {
  width:100%;
  overflow:auto;
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:24px;
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.40), hsl(var(--glass-bg)/0.30));
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  max-height:560px;
  position:relative;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:.62rem;
  min-width:1400px;
}

thead {
  background:linear-gradient(90deg,hsl(var(--accent)/0.40), hsl(var(--accent)/0.30));
  color:#fff;
}
thead th {
  text-align:left;
  padding:.6rem .65rem;
  font-weight:600;
  letter-spacing:.45px;
  position:sticky;
  top:0;
  backdrop-filter:blur(12px);
  z-index:2;
}

tbody tr {
  border-bottom:1px solid hsl(var(--panel-border)/0.35);
  transition: background .45s, transform .45s;
  animation: rowIn .55s ease;
}
@keyframes rowIn {
  from { opacity:0; transform:translateY(6px); }
  to { opacity:1; transform:translateY(0); }
}
tbody tr:hover { background:hsl(var(--accent)/0.12); }

tbody tr.flash-new { animation: flashRow 2.1s ease; }
@keyframes flashRow {
  0% { background:hsl(var(--accent)/0.7); color:#fff; }
  35% { background:hsl(var(--accent)/0.35); }
  65% { background:hsl(var(--accent)/0.15); }
  100% { background:transparent; }
}

td {
  padding:.55rem .6rem;
  vertical-align:top;
  line-height:1.2;
}

.actions { display:flex; gap:.3rem; flex-wrap:wrap; }

.status-dot {
  width:11px; height:11px;
  border-radius:6px;
  background:gray;
  box-shadow:0 0 0 3px rgba(255,255,255,0.06);
  position:relative;
}
.status-dot::after {
  content:"";
  position:absolute; inset:-4px;
  border-radius:inherit;
  background:currentColor;
  opacity:0;
  animation:pulse 2.6s ease-in-out infinite;
}
@keyframes pulse {
  0%,100% { transform:scale(1); opacity:.18; }
  50% { transform:scale(1.6); opacity:0; }
}

.status-good { background:var(--ok); color:var(--ok); }
.status-warn { background:var(--warn); color:var(--warn); }
.status-bad { background:var(--danger); color:var(--danger); }

.inline { display:inline-flex; align-items:center; gap:.35rem; }

.form-grid {
  display:grid;
  gap:.95rem;
  grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  align-items:start;
}

.divider {
  height:1px;
  background:linear-gradient(to right, transparent, hsl(var(--panel-border)/0.9), transparent);
  margin:.9rem 0 1.2rem;
}

.toggle-group { display:flex; gap:.45rem; flex-wrap:wrap; }

.toggle-chip {
  padding:.42rem .75rem;
  background:hsl(var(--accent)/0.16);
  color:hsl(var(--accent)/0.95);
  font-size:.55rem;
  letter-spacing:.55px;
  font-weight:700;
  border-radius:14px;
  cursor:pointer;
  user-select:none;
  border:1px solid hsl(var(--accent)/0.0);
  transition: background .45s, transform .55s var(--ease-spring), color .45s, box-shadow .45s;
  position:relative;
}
.toggle-chip::after {
  content:"";
  position:absolute; inset:0;
  box-shadow:0 4px 14px -5px hsl(var(--accent)/0.55);
  opacity:0;
  border-radius:inherit;
  transition:opacity .45s;
}
.toggle-chip.active, .toggle-chip:hover {
  background:var(--gradient-accent);
  color:#fff;
  transform:translateY(-3px);
}
.toggle-chip.active::after, .toggle-chip:hover::after { opacity:1; }

.inline-field { display:flex; flex-direction:column; gap:.3rem; }

footer.app {
  padding:1rem 1.4rem;
  font-size:.55rem;
  text-align:center;
  color:hsl(var(--text-dim));
  opacity:.9;
  letter-spacing:.4px;
}

.indicators {
  display:grid;
  gap:.8rem;
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
  margin-top:.2rem;
}
.indicators .indicator {
  position:relative;
  background:linear-gradient(150deg,hsl(var(--accent)/0.20), hsl(var(--accent)/0.08));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:20px;
  padding:.75rem .85rem .95rem;
  display:flex;
  flex-direction:column;
  gap:.4rem;
  font-variant-numeric: tabular-nums;
  isolation:isolate;
  transition:transform .55s var(--ease-spring), box-shadow .55s;
  overflow:hidden;
}
.indicator::before {
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(circle at 35% 20%, hsl(var(--accent)/0.45), transparent 65%),
    radial-gradient(circle at 80% 75%, hsl(var(--accent)/0.35), transparent 70%);
  mix-blend-mode:overlay;
  opacity:.35;
  pointer-events:none;
  animation: indicatorGlow 7s linear infinite;
}
@keyframes indicatorGlow {
  0% { transform:translateX(-10%) scale(1); }
  50% { transform:translateX(10%) scale(1.02); }
  100% { transform:translateX(-10%) scale(1); }
}
.indicator:hover {
  transform:translateY(-5px);
  box-shadow:0 14px 34px -16px rgba(0,0,0,0.65), 0 6px 14px -4px hsl(var(--accent)/0.45);
}
.indicator h4 {
  margin:0;
  font-size:.5rem;
  letter-spacing:.7px;
  text-transform:uppercase;
  color:hsl(var(--text-dim));
  font-weight:800;
  display:flex;
  align-items:center;
  gap:.35rem;
}
.indicator .val {
  font-size:1.65rem;
  font-weight:700;
  line-height:1;
  letter-spacing:.5px;
  color:hsl(var(--text-color));
}
.indicator .trend {
  font-size:.5rem;
  font-weight:700;
  letter-spacing:.55px;
  padding:.3rem .55rem;
  border-radius:10px;
  background:hsl(var(--accent)/0.30);
  color:#fff;
  align-self:flex-start;
  box-shadow:0 4px 12px -6px hsl(var(--accent)/0.55);
}

.chart-container { position:relative; width:100%; height:250px; }

.badge-role {
  background:hsl(var(--accent)/0.30);
  color:#fff;
  border-radius:12px;
  padding:.35rem .6rem;
  font-size:.55rem;
  letter-spacing:.65px;
  font-weight:700;
  text-transform:uppercase;
  box-shadow:0 4px 12px -6px hsl(var(--accent)/0.55);
}

.preference-grid {
  display:grid;
  gap:1.1rem;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  align-items:start;
}

.color-palette {
  display:flex;
  gap:.45rem;
  flex-wrap:wrap;
}
.color-swatch {
  width:36px; height:36px;
  border-radius:12px;
  cursor:pointer;
  position:relative;
  box-shadow:0 0 0 1px hsl(var(--panel-border)/0.6), 0 6px 14px -6px rgba(0,0,0,0.6);
  transition:transform .55s var(--ease-spring), box-shadow .55s, filter .55s;
  overflow:hidden;
}
.color-swatch:hover { transform:translateY(-6px) rotate(-4deg); }
.color-swatch.active {
  transform:translateY(-3px) scale(1.05);
  box-shadow:0 10px 26px -12px hsl(var(--accent)/0.65), 0 0 0 2px rgba(255,255,255,.45);
}
.color-swatch.active::after {
  content:"✓";
  position:absolute; inset:0;
  display:grid; place-items:center;
  color:#fff;
  font-size:.95rem;
  font-weight:700;
  text-shadow:0 2px 6px rgba(0,0,0,0.5);
}

.toggle {
  display:inline-flex;
  align-items:center;
  gap:.45rem;
  background:hsl(var(--accent)/0.26);
  color:#fff;
  padding:.5rem .8rem;
  font-size:.55rem;
  border-radius:16px;
  cursor:pointer;
  font-weight:800;
  letter-spacing:.55px;
  user-select:none;
  box-shadow:0 8px 20px -8px hsl(var(--accent)/0.55);
  transition: background .45s, transform .55s var(--ease-spring);
  position:relative;
  overflow:hidden;
  text-transform:uppercase;
}
.toggle::before {
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(90deg,rgba(255,255,255,.25),transparent 60%);
  opacity:0;
  transition:opacity .55s;
}
.toggle:hover::before { opacity:.9; }
.toggle:hover { transform:translateY(-3px); }

.responsive-hide { display:none; }

#appModal, #userProfileModal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
  z-index:10000;
  display:none;
  align-items:center;
  justify-content:center;
  padding:1.5rem;
}
#appModal.show, #userProfileModal.show { display:flex; }
#appModal .modal-box, #userProfileModal .modal-box {
  width:100%;
  max-width:420px;
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.92),hsl(var(--glass-bg)/0.72));
  border:1px solid hsl(var(--panel-border)/0.55);
  backdrop-filter:blur(30px) saturate(1.4);
  -webkit-backdrop-filter:blur(30px) saturate(1.4);
  border-radius:28px;
  padding:1.2rem 1.35rem 1.4rem;
  display:flex;
  flex-direction:column;
  gap:.9rem;
  animation: modalIn .55s var(--ease-spring);
  position:relative;
  box-shadow:0 18px 46px -18px rgba(0,0,0,.65), 0 0 0 1px hsl(var(--panel-border)/0.35);
}
@keyframes modalIn {
  from {opacity:0;transform:translateY(18px) scale(.94);}
  to {opacity:1;transform:translateY(0) scale(1);}
}
.modal-actions { display:flex; gap:.6rem; flex-wrap:wrap; justify-content:flex-end; }
.modal-title { font-size:.8rem; font-weight:700; letter-spacing:.6px; display:flex; gap:.5rem; align-items:center; }
.modal-text { font-size:.65rem; line-height:1.4; color:hsl(var(--text-dim)); }

#recordDetailModal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px);
  z-index:10050;
  display:none;
  align-items:center;
  justify-content:center;
  padding:1.2rem;
}
#recordDetailModal.show { display:flex; }
#recordDetailModal .detail-box {
  width:100%;
  max-width:640px;
  background:linear-gradient(150deg,hsl(var(--glass-bg)/0.92), hsl(var(--glass-bg)/0.78));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:30px;
  padding:1.3rem 1.4rem 1.5rem;
  display:flex;
  flex-direction:column;
  gap:.9rem;
  max-height:85vh;
  overflow:auto;
  animation: modalIn .55s var(--ease-spring);
  position:relative;
}
#recordDetailModal .close-btn {
  position:absolute;
  top:.65rem;
  right:.65rem;
  background:hsl(var(--accent)/0.18);
  border:1px solid hsl(var(--panel-border)/0.5);
  color:#fff;
  padding:.4rem .55rem;
  border-radius:12px;
  cursor:pointer;
  font-size:.55rem;
  display:inline-flex;
  gap:.35rem;
  align-items:center;
  transition:background .4s;
}
#recordDetailModal .close-btn:hover { background:hsl(var(--accent)/0.35); }
.detail-grid {
  display:grid;
  gap:.65rem;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  font-size:.55rem;
  line-height:1.35;
}
.detail-grid div {
  background:hsl(var(--accent)/0.12);
  padding:.55rem .65rem .6rem;
  border-radius:14px;
  border:1px solid hsl(var(--panel-border)/0.5);
  display:flex;
  flex-direction:column;
  gap:.25rem;
}
.detail-label {
  font-size:.48rem;
  letter-spacing:.55px;
  font-weight:700;
  text-transform:uppercase;
  color:hsl(var(--text-dim));
}
.detail-image {
  max-width:100%;
  border-radius:18px;
  border:1px solid hsl(var(--panel-border)/0.55);
  box-shadow:0 6px 18px -8px rgba(0,0,0,.5);
  object-fit:cover;
  display:block;
  margin-top:.35rem;
}

/* Sosial */
.social-container {
  display:grid;
  gap:1.2rem;
  grid-template-columns: minmax(0,1fr) 320px;
}
@media (max-width:980px){
  .social-container { grid-template-columns:1fr; }
}
.social-form {
  background:linear-gradient(150deg,hsl(var(--accent)/0.16),hsl(var(--accent)/0.08));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.9rem 1rem 1.05rem;
  border-radius:24px;
  display:flex;
  flex-direction:column;
  gap:.6rem;
}
.social-form textarea {
  resize:vertical;
  min-height:90px;
  font-size:.65rem;
}
.social-form .actions {
  display:flex;
  gap:.55rem;
  flex-wrap:wrap;
  justify-content:space-between;
}
.social-feed {
  display:flex;
  flex-direction:column;
  gap:.8rem;
  max-height:640px;
  overflow:auto;
  padding-right:.3rem;
}
.social-post {
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.65),hsl(var(--glass-bg)/0.50));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:24px;
  padding:.85rem .95rem 1rem;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  font-size:.6rem;
  position:relative;
  animation: fadeIn .55s var(--ease-spring);
}
.social-post-header {
  display:flex;
  align-items:center;
  gap:.55rem;
  font-weight:700;
  letter-spacing:.4px;
}
.social-post-role {
  background:hsl(var(--accent)/0.25);
  padding:.2rem .5rem;
  border-radius:10px;
  font-size:.48rem;
  font-weight:700;
  letter-spacing:.4px;
}
.social-post-time {
  font-size:.48rem;
  color:hsl(var(--text-dim));
  margin-left:auto;
}
.social-post-content {
  font-size:.62rem;
  line-height:1.4;
  white-space:pre-wrap;
  word-break:break-word;
}
.social-post-image {
  max-width:100%;
  max-height:320px;
  border-radius:18px;
  object-fit:cover;
  border:1px solid hsl(var(--panel-border)/0.55);
  box-shadow:0 6px 16px -8px rgba(0,0,0,.45);
}
.social-post-actions {
  display:flex;
  gap:.5rem;
  flex-wrap:wrap;
  margin-top:.2rem;
}
.social-users {
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.66), hsl(var(--glass-bg)/0.50));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:24px;
  padding:.95rem 1rem 1.1rem;
  display:flex;
  flex-direction:column;
  gap:.6rem;
  max-height:640px;
  overflow:auto;
}
.social-user-item {
  display:flex;
  gap:.6rem;
  align-items:flex-start;
  background:hsl(var(--accent)/0.15);
  padding:.55rem .65rem .6rem;
  border-radius:16px;
  font-size:.55rem;
  line-height:1.25;
  border:1px solid hsl(var(--panel-border)/0.55);
  cursor:pointer;
  transition:background .35s;
}
.social-user-item:hover { background:hsl(var(--accent)/0.22); }
.social-user-item .avatar-mini {
  width:38px; height:38px;
  border-radius:14px;
  background:linear-gradient(135deg,hsl(var(--accent)/0.35),hsl(var(--accent)/0.55));
  display:grid; place-items:center;
  color:#fff;
  font-weight:700;
  font-size:.7rem;
  position:relative;
  overflow:hidden;
  flex-shrink:0;
}
.social-user-item .avatar-mini img {
  width:100%; height:100%; object-fit:cover;
}

/* Reactions & Comments */
.social-post-reactions {
  display:flex;
  gap:.45rem;
  flex-wrap:wrap;
  font-size:.55rem;
  margin-top:.2rem;
}
.reaction-btn {
  background:hsl(var(--accent)/0.22);
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.3rem .55rem;
  border-radius:14px;
  font-size:.55rem;
  display:inline-flex;
  gap:.35rem;
  align-items:center;
  cursor:pointer;
  font-weight:600;
  letter-spacing:.4px;
  transition:background .35s, transform .45s var(--ease-spring);
}
.reaction-btn.active {
  background:var(--gradient-accent);
  color:#fff;
  box-shadow:0 6px 18px -8px hsl(var(--accent)/0.55);
  transform:translateY(-2px);
}
.reaction-btn:hover { background:hsl(var(--accent)/0.32); }
.comments-box {
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.75), hsl(var(--glass-bg)/0.60));
  border:1px solid hsl(var(--panel-border)/0.55);
  border-radius:18px;
  padding:.65rem .7rem .75rem;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  font-size:.55rem;
  margin-top:.5rem;
  max-height:260px;
  overflow:auto;
}
.comment-item {
  background:hsl(var(--accent)/0.16);
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.45rem .55rem .5rem;
  border-radius:14px;
  display:flex;
  gap:.55rem;
  line-height:1.3;
  position:relative;
}
.comment-item .del-comment-btn {
  position:absolute;
  top:.3rem;
  right:.35rem;
  background:rgba(0,0,0,.25);
  color:#fff;
  border:none;
  font-size:.48rem;
  padding:.15rem .35rem;
  border-radius:8px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:.2rem;
}
.comment-form {
  display:flex;
  gap:.4rem;
  flex-wrap:wrap;
  margin-top:.35rem;
}
.comment-form textarea {
  flex:1;
  min-height:52px;
  font-size:.55rem;
  resize:vertical;
}
.comment-meta {
  font-size:.42rem;
  opacity:.75;
  display:flex;
  gap:.35rem;
}

/* Quality indicator list refined */
#qualityIndicatorList {
  display:flex;
  flex-direction:column;
  gap:.45rem;
  max-height:360px;
  overflow:auto;
  padding-right:.4rem;
  scrollbar-width:thin;
}
#qualityIndicatorList::-webkit-scrollbar {
  width:9px;
}
#qualityIndicatorList::-webkit-scrollbar-thumb {
  background:linear-gradient(180deg,hsl(var(--accent)/0.4),hsl(var(--accent)/0.55));
  border-radius:10px;
  border:2px solid transparent;
  background-clip:content-box;
}
.quality-item {
  display:grid;
  grid-template-columns: 16px 1fr;
  gap:.6rem;
  background:hsl(var(--accent)/0.11);
  padding:.55rem .65rem .6rem;
  border-radius:16px;
  border:1px solid hsl(var(--panel-border)/0.45);
  animation:fadeScale .45s var(--ease-spring);
  position:relative;
  cursor:pointer;
  font-size:.53rem;
  line-height:1.35;
}
.quality-item:hover { background:hsl(var(--accent)/0.18); }
.quality-item:active { transform:scale(.98); }
.quality-meta {
  display:flex;
  flex-wrap:wrap;
  gap:.25rem .45rem;
  margin-top:.25rem;
  font-size:.46rem;
  letter-spacing:.4px;
  text-transform:uppercase;
  font-weight:700;
  color:hsl(var(--text-dim));
}
.quality-hazard-flag {
  display:inline-flex;
  background:#dc2626;
  color:#fff;
  padding:.18rem .45rem;
  border-radius:10px;
  font-size:.46rem;
  font-weight:700;
  letter-spacing:.4px;
  align-items:center;
  gap:.25rem;
}
.quality-hazard-flag.safe {
  background:#059669;
}
.quality-score {
  position:absolute;
  top:.45rem;
  right:.55rem;
  background:hsl(var(--accent)/0.75);
  color:#fff;
  font-size:.48rem;
  padding:.25rem .45rem;
  border-radius:10px;
  font-weight:700;
  letter-spacing:.5px;
  box-shadow:0 4px 10px -5px hsl(var(--accent)/0.55);
}

.fade-scale { animation: fadeScale .55s var(--ease-spring); }
@keyframes fadeScale { from { opacity:0; transform:scale(.94); } to { opacity:1; transform:scale(1); } }

.slide-in-up { animation: slideInUp .6s var(--ease-spring); }
@keyframes slideInUp {
  from { opacity:0; transform:translateY(18px); }
  to { opacity:1; transform:translateY(0); }
}

.notice {
  font-size:.55rem;
  background:hsl(var(--accent)/0.18);
  color:hsl(var(--accent)/1);
  padding:.45rem .6rem;
  border-radius:12px;
  font-weight:600;
  letter-spacing:.4px;
  display:inline-flex;
  gap:.3rem;
  align-items:center;
}

body.font-small { --font-base: 14px; }
body.font-medium { --font-base: 15px; }
body.font-large { --font-base: 17px; }

.hazard-badge {
  display:inline-flex;
  align-items:center;
  gap:.3rem;
  background:linear-gradient(135deg,#dc2626,#b91c1c);
  color:#fff;
  padding:.3rem .55rem;
  border-radius:11px;
  font-size:.5rem;
  font-weight:700;
  letter-spacing:.4px;
  box-shadow:0 4px 12px -6px rgba(220,38,38,0.6);
}
.hazard-badge.safe {
  background:linear-gradient(135deg,#059669,#10b981);
  box-shadow:0 4px 12px -6px rgba(5,150,105,.55);
}
.hazard-chip {
  background:hsl(var(--accent)/0.2);
  color:hsl(var(--accent)/0.95);
  font-size:.5rem;
  padding:.3rem .55rem;
  border-radius:10px;
  display:inline-flex;
  gap:.3rem;
  align-items:center;
  font-weight:600;
  letter-spacing:.4px;
  margin:.2rem .25rem .2rem 0;
  cursor:pointer;
  transition:background .4s, transform .5s var(--ease-spring);
}
.hazard-chip.active {
  background:linear-gradient(135deg,#dc2626,#991b1b);
  color:#fff;
  transform:translateY(-3px);
  box-shadow:0 6px 18px -8px rgba(220,38,38,0.6);
}

@media (max-width:1080px) {
  .sidebar {
    position:fixed;
    inset:0 auto 0 0;
    transform:translateX(-100%);
    max-width:84%;
  }
  .sidebar.open { transform:translateX(0); }
  .main { margin-left:0; }
  .responsive-hide { display:inline-flex; }
  .indicators { grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); }
  main.content { padding:1rem .9rem 2.2rem; }
}
@media (max-width:780px){
  table { font-size:.56rem; min-width:1100px; }
  .panel { border-radius:28px; }
  .indicators .indicator { padding:.65rem .7rem .8rem; }
}
@media (max-width:640px) {
  .content { padding:.85rem .75rem 3.8rem; gap:1.4rem; }
  .panel { border-radius:24px; padding:1rem .95rem 1.15rem; }
  .container-auth { margin-left:13px;margin-right:13px;padding:2rem 1.25rem 2.1rem; border-radius:30px; }
  .topbar { padding:.6rem .75rem; }
  .search-box { max-width:100%; }
  .chart-container { height:220px; }
  .indicators { grid-template-columns:repeat(2,minmax(0,1fr)); }
  .indicator { min-width:0; }
  .form-grid { grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:.75rem; }
  .panel-header { margin:-.2rem -1rem .5rem; padding:.65rem 1rem .55rem; }
  .preference-grid { grid-template-columns:1fr; }
  #fishImagePreview img { max-height:180px; }
  .hazard-chip { font-size:.48rem; }
  .social-container { grid-template-columns:1fr; }
}

::-webkit-scrollbar { width:10px; height:10px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb {
  background:linear-gradient(180deg,hsl(var(--accent)/0.32), hsl(var(--accent)/0.45));
  border-radius:10px;
  border:2px solid transparent;
  background-clip:content-box;
  transition:background .45s;
}
::-webkit-scrollbar-thumb:hover {
  background:linear-gradient(180deg,hsl(var(--accent)/0.55), hsl(var(--accent)/0.65));
}

.fade-in { animation: fade .6s ease; }
@keyframes fade { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

.view-transition-enter { animation: viewEnter .55s var(--ease-spring); }
@keyframes viewEnter {
  from { opacity:0; transform:translateY(18px) scale(.96); }
  to { opacity:1; transform:translateY(0) scale(1); }
}

#loadingOverlay {
  position:fixed; inset:0;
  display:grid; place-items:center;
  background:linear-gradient(135deg, hsl(var(--accent)/0.35), hsl(var(--glass-bg)/0.94));
  backdrop-filter:blur(34px) saturate(1.3);
  -webkit-backdrop-filter:blur(34px) saturate(1.3);
  z-index:9999;
  color:#fff;
  font-size:.85rem;
  flex-direction:column;
  gap:1.1rem;
  letter-spacing:.45px;
}

.spinner {
  width:60px; height:60px;
  border:6px solid hsl(var(--accent)/0.25);
  border-top-color:#fff;
  border-radius:50%;
  animation: spin 1s linear infinite;
  filter:drop-shadow(0 4px 12px hsl(var(--accent)/0.6));
}
@keyframes spin { to { transform: rotate(360deg); } }

.inline-editable {
  cursor:text;
  padding:.25rem .4rem;
  border-radius:8px;
  transition:background .35s;
}
.inline-editable:hover { background:hsl(var(--accent)/0.22); }

.meta {
  font-size:.52rem;
  letter-spacing:.5px;
  color:hsl(var(--text-dim));
  text-transform:uppercase;
  font-weight:600;
}

.empty-state {
  text-align:center;
  padding:2rem 1rem;
  font-size:.72rem;
  color:hsl(var(--text-dim));
  display:flex;
  flex-direction:column;
  gap:1rem;
  animation: fade .6s ease;
}

.inline-stat {
  display:inline-flex;
  align-items:center;
  gap:.4rem;
  background:hsl(var(--accent)/0.28);
  padding:.3rem .55rem;
  border-radius:10px;
  font-size:.52rem;
  font-weight:700;
  letter-spacing:.55px;
  color:#fff;
  text-transform:uppercase;
  box-shadow:0 4px 12px -5px hsl(var(--accent)/0.55);
}

.badge-soft {
  display:inline-flex;
  padding:.35rem .6rem;
  background:hsl(var(--accent)/0.2);
  border-radius:12px;
  font-size:.55rem;
  font-weight:600;
  letter-spacing:.5px;
  color:hsl(var(--accent)/0.95);
  gap:.3rem;
}

.section-subtitle {
  font-size:.58rem;
  text-transform:uppercase;
  font-weight:800;
  letter-spacing:.55px;
  color:hsl(var(--text-dim));
  margin:0 0 .4rem;
}

/* Toast */
#toastContainer {
  position: fixed;
  top: 1rem;
  right: 1rem;
  width: clamp(240px, 28vw, 360px);
  display: flex;
  flex-direction: column;
  gap: .65rem;
  z-index: 4000;
  pointer-events: none;
}
.toast {
  --toast-tone: var(--accent);
  position: relative;
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  gap: .6rem;
  padding: .75rem .85rem .75rem .8rem;
  border-radius: 25px;
  background: linear-gradient(135deg, hsl(var(--toast-tone) / 0.90), hsl(var(--toast-tone) / 0.68));
  color: #fff;
  font-size: .63rem;
  font-weight: 600;
  letter-spacing: .3px;
  line-height: 1.35;
  box-shadow: 0 6px 18px -8px rgba(0,0,0,.35),
              0 0 0 1px hsl(var(--toast-tone) / 0.40);
  border: 1px solid hsl(var(--toast-tone) / 0.55);
  overflow: hidden;
  pointer-events: auto;
  opacity: 0;
  transform: translateY(-8px) scale(.95);
  animation: toastEnter .55s cubic-bezier(.34,1.56,.64,1) forwards;
  backdrop-filter: blur(10px) saturate(1.2);
  -webkit-backdrop-filter: blur(10px) saturate(1.2);
}
.toast::before {
  content:"";
  position:absolute;
  top:0; left:0; bottom:0;
  width:4px;
  background:linear-gradient(180deg,
     hsl(var(--toast-tone) / 1),
     hsl(var(--toast-tone) / 0.55)
  );
  border-radius:4px 0 0 4px;
}
.toast button.toast-close {
  background: rgba(255,255,255,.18);
  border: none;
  color: #fff;
  width: 26px;
  height: 26px;
  display: inline-flex;
  align-items:center;
  justify-content:center;
  border-radius: 8px;
  cursor: pointer;
  transition: background .3s;
  padding:0;
}
.toast button.toast-close:hover { background: rgba(255,255,255,.32); }
.toast[data-type="success"] { --toast-tone:  140 65% 42%; }
.toast[data-type="danger"]  { --toast-tone:  0 72% 52%; }
.toast[data-type="warn"]    { --toast-tone:  38 92% 50%; }
.toast[data-type="info"]    { --toast-tone:  var(--accent); }
@keyframes toastEnter {
  to { opacity:1; transform: translateY(0) scale(1); }
}
@keyframes toastExit {
  to { opacity:0; transform: translateY(-10px) scale(.92); }
}
[data-theme="dark"] .toast {
  box-shadow: 0 10px 28px -12px rgba(0,0,0,.7),
              0 0 0 1px hsl(var(--toast-tone) / 0.45);
}
@media (max-width:640px) {
  #toastContainer {
    top:.75rem;
    right:.55rem;
    left:.55rem;
    width:auto;
  }
}
.image-preview {
  display:flex;
  flex-direction:column;
  gap:.4rem;
  font-size:.55rem;
  color:hsl(var(--text-dim));
  margin-top:.3rem;
}
.image-preview canvas, .image-preview img {
  max-width:100%;
  border-radius:12px;
  box-shadow:0 4px 18px -8px rgba(0,0,0,.5);
  border:1px solid hsl(var(--panel-border)/0.55);
}

.btn-mini-inline {
  background:hsl(var(--accent)/0.3);
  border:none;
  color:#fff;
  padding:.25rem .5rem;
  border-radius:8px;
  font-size:.5rem;
  font-weight:700;
  letter-spacing:.4px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:.3rem;
  box-shadow:0 4px 10px -5px hsl(var(--accent)/0.5);
  transition:background .4s, transform .45s var(--ease-spring);
}
.btn-mini-inline:hover { background:hsl(var(--accent)/0.5); transform:translateY(-3px); }
.container-auth .logo-circle { margin-left:auto; margin-right:auto; }
.tag-badge {
  background:hsl(var(--accent)/0.25);
  color:#fff;
  padding:.25rem .55rem;
  font-size:.48rem;
  border-radius:10px;
  font-weight:700;
  letter-spacing:.45px;
  display:inline-flex;
  gap:.35rem;
  align-items:center;
}

/* FAB */
.fab {
  position:fixed;
  bottom:1.35rem;
  right:1.25rem;
  width:62px;
  height:62px;
  border-radius:22px;
  background:var(--gradient-accent);
  color:#fff;
  display:grid;
  place-items:center;
  font-weight:700;
  font-size:.75rem;
  box-shadow:0 14px 36px -12px hsl(var(--accent)/0.65), 0 4px 8px -3px hsl(var(--accent)/0.5);
  z-index:300;
  border:1px solid hsl(var(--panel-border)/0.45);
  cursor:pointer;
  transition:transform .55s var(--ease-spring), box-shadow .55s;
}
.fab:hover {
  transform:translateY(-6px) scale(1.04);
}
.fab:active {
  transform:translateY(-1px) scale(.97);
}

/* Pagination & Selection */
.table-footer {
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  align-items:center;
  gap:.8rem;
  margin-top:.65rem;
  font-size:.55rem;
  background:linear-gradient(145deg,hsl(var(--glass-bg)/0.55),hsl(var(--glass-bg)/0.40));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.55rem .85rem;
  border-radius:18px;
}
.table-footer select {
  max-width:110px;
  font-size:.55rem;
  padding:.3rem .45rem;
}
.pagination-controls {
  display:flex;
  align-items:center;
  gap:.45rem;
  flex-wrap:wrap;
}
.pagination-controls button {
  padding:.4rem .65rem;
  font-size:.55rem;
  border-radius:10px;
}
#selectionInfo {
  font-weight:600;
  letter-spacing:.4px;
  display:flex;
  gap:.5rem;
  align-items:center;
}
.select-all-wrap {
  display:flex;
  align-items:center;
  gap:.3rem;
  font-size:.48rem;
  font-weight:600;
  letter-spacing:.4px;
  text-transform:uppercase;
}

/* User profile modal (other users) */
#userProfileModal .modal-box {
  max-width:480px;
}
.user-profile-body {
  display:flex;
  flex-direction:column;
  gap:.65rem;
  font-size:.6rem;
}
.user-profile-body .avatar {
  width:86px;
  height:86px;
  font-size:1.35rem;
  border-radius:24px;
}
.user-profile-stats {
  display:flex;
  flex-wrap:wrap;
  gap:.4rem;
  margin-top:.45rem;
}
/* ---- Organoleptic Tool Styles ---- */
.org-criteria-grid {
  display:grid;
  gap:1rem;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  margin-top:.5rem;
}
.org-criterion {
  background:linear-gradient(150deg,hsl(var(--accent)/0.18),hsl(var(--accent)/0.10));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.75rem .85rem .85rem;
  border-radius:22px;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  position:relative;
  overflow:hidden;
  font-size:.58rem;
}
.org-criterion h4 {
  margin:0;
  font-size:.56rem;
  letter-spacing:.5px;
  text-transform:uppercase;
  font-weight:700;
  color:hsl(var(--text-dim));
  display:flex;
  gap:.4rem;
  align-items:center;
}
.org-options {
  display:flex;
  flex-direction:column;
  gap:.4rem;
  max-height:240px;
  overflow:auto;
  padding-right:.35rem;
}
.org-option {
  background:hsl(var(--accent)/0.15);
  border:1px solid hsl(var(--panel-border)/0.5);
  padding:.45rem .5rem .5rem;
  border-radius:14px;
  cursor:pointer;
  display:flex;
  flex-direction:column;
  gap:.25rem;
  transition:background .4s, transform .45s var(--ease-spring), box-shadow .45s;
  position:relative;
  font-size:.53rem;
  line-height:1.3;
}
.org-option:hover {
  background:hsl(var(--accent)/0.25);
  transform:translateY(-3px);
  box-shadow:0 6px 16px -8px hsl(var(--accent)/0.55);
}
.org-option.active {
  background:var(--gradient-accent);
  color:#fff;
  box-shadow:0 10px 28px -12px hsl(var(--accent)/0.65);
}
.org-option .score-badge {
  position:absolute;
  top:.4rem;
  right:.45rem;
  background:hsl(var(--accent)/0.85);
  color:#fff;
  font-size:.48rem;
  padding:.2rem .45rem;
  border-radius:10px;
  font-weight:700;
  letter-spacing:.5px;
  box-shadow:0 4px 10px -5px hsl(var(--accent)/0.55);
}
.org-result-box {
  background:linear-gradient(150deg,hsl(var(--accent)/0.18),hsl(var(--accent)/0.08));
  border:1px solid hsl(var(--panel-border)/0.55);
  padding:.9rem 1rem 1.1rem;
  border-radius:24px;
  margin-top:.35rem;
  display:flex;
  flex-direction:column;
  gap:.35rem;
}
@media (max-width:640px){
  .org-criteria-grid { grid-template-columns:1fr; }
}

</style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div id="loadingText">Memuat aplikasi....</div>
</div>

<div id="toastContainer"></div>

<!-- Modal (global confirm/info) -->
<div id="appModal" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-title" id="modalTitle">
      <i data-feather="help-circle" width="18"></i>
      <span>Konfirmasi</span>
    </div>
    <div class="modal-text" id="modalMessage">Yakin?</div>
    <div id="modalExtra"></div>
    <div class="modal-actions">
      <button class="outline small" id="modalCancelBtn">
        <i data-feather="x" width="13"></i> <span id="modalCancelText">Batal</span>
      </button>
      <button class="danger small" id="modalOkBtn">
        <i data-feather="check" width="13"></i> <span id="modalOkText">Ya</span>
      </button>
    </div>
  </div>
</div>

<!-- Modal profil pengguna lain -->
<div id="userProfileModal" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-title">
      <i data-feather="user" width="18"></i>
      <span id="userProfileModalTitle">Profil Pengguna</span>
    </div>
    <div id="userProfileContent" class="user-profile-body">
      <!-- Filled dynamically -->
    </div>
    <div class="modal-actions">
      <button class="outline small" id="closeUserProfileModal">
        <i data-feather="x" width="13"></i> Tutup
      </button>
    </div>
  </div>
</div>

<!-- Detail Record Modal -->
<div id="recordDetailModal" aria-hidden="true">
  <div class="detail-box">
    <button class="close-btn" id="closeRecordDetail">
      <i data-feather="x" width="12"></i> Tutup
    </button>
    <div style="display:flex;flex-direction:column;gap:.35rem;">
      <div style="font-size:.75rem;font-weight:700;letter-spacing:.55px;display:flex;align-items:center;gap:.45rem;">
        <i data-feather="file-text" width="16"></i>
        <span id="detailTitle">Detail Data</span>
      </div>
      <div id="detailStatusBadges" style="display:flex;flex-wrap:wrap;gap:.4rem;"></div>
    </div>
    <div class="detail-grid" id="detailGrid"></div>
    <div id="detailImageWrapper"></div>
    <div id="detailHazardsWrapper"></div>
  </div>
</div>

<!-- AUTH SCREENS -->
<div id="authView" class="fade-in">
  <div class="container-auth" id="loginContainer">
    <div class="glow"></div>
    <div class="logo-circle">MMIS</div>
    <h2 data-i18n="app_title">Monitoring Mutu Ikan Segar</h2>
    <p class="muted" data-i18n="app_subtitle">Sistem Informasi Pasar Tradisional Kota Makassar</p>
    <div id="authAlert"></div>
    <form id="loginForm" autocomplete="on">
      <div class="inline-field">
        <label data-i18n="email">Email</label>
        <input type="email" id="loginEmail" required placeholder="email@gmail.com" autocomplete="email" />
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div class="inline-field">
        <label data-i18n="password">Kata Sandi</label>
        <input type="password" id="loginPassword" required placeholder="••••••••" autocomplete="current-password" />
      </div><small style="opacity:0;font-size:0.8px">sk</small>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.35rem;gap:.7rem;">
        <button type="submit" style="flex:1;" id="btnLogin">
          <i data-feather="log-in" width="16"></i>
          <span data-i18n="login">Masuk</span>
        </button>
        <div style="flex:1;text-align:right;">
          <a href="#" id="linkForgot" style="font-size:.6rem;font-weight:700;letter-spacing:.55px;" data-i18n="forgot_password">Lupa kata sandi?</a>
        </div>
      </div>
    </form>
    <div class="switch-auth">
      <span data-i18n="no_account">Belum punya akun?</span>
      <a href="#" id="showRegister" data-i18n="register_now">Daftar sekarang</a>
    </div>
    <div style="margin-top:.9rem;display:flex;gap:.6rem;flex-wrap:wrap;">
      <button class="outline small" type="button" id="quickDemoAdmin"><i data-feather="user-check" width="14"></i> Demo Admin</button>
      <button class="outline small" type="button" id="quickDemoUser"><i data-feather="user" width="14"></i> Demo Mahasiswa</button>
    </div>
    <div class="switch-auth" style="margin-top:1.05rem;">
      <span class="small">© <span id="year"></span> MMIS - Kota Makassar</span>
    </div>
  </div>

  <div class="container-auth hidden" id="registerContainer">
    <div class="glow"></div>
    <div class="logo-circle">MMIS</div>
    <h2 data-i18n="register_account">Registrasi Akun</h2>
    <p class="muted" data-i18n="register_subtitle">Buat akun baru untuk mulai mencatat data mutu ikan.</p>
    <div id="registerAlert"></div>
    <form id="registerForm" autocomplete="on">
      <div class="inline-field">
        <label data-i18n="full_name">Nama Lengkap</label>
        <input id="regName" required placeholder="Nama lengkap" />
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div class="inline-field">
        <label data-i18n="email">Email</label>
        <input type="email" id="regEmail" required placeholder="email@gmail.com" autocomplete="email" />
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div class="inline-field">
        <label data-i18n="password">Kata Sandi</label>
        <input type="password" id="regPassword" required minlength="6" placeholder="Minimal 6 karakter" autocomplete="new-password"/>
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div class="inline-field">
        <label data-i18n="confirm_password">Konfirmasi Kata Sandi</label>
        <input type="password" id="regConfirmPassword" required placeholder="Ulangi kata sandi" autocomplete="new-password"/>
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div class="inline-field">
        <label data-i18n="role">Peran</label>
        <select id="regRole" required>
          <option value="Mahasiswa">Mahasiswa</option>
          <option value="Petugas Pasar">Petugas Pasar</option>
          <option value="Dosen">Dosen/Pembimbing</option>
        </select>
      </div>
      <small style="opacity:0;font-size:0.8px">sk</small>
      <div id="regExtraFields" class="slide-in-up"></div>
      <button type="submit" style="width:100%;margin-top:.55rem;">
        <i data-feather="user-plus" width="16"></i>
        <span data-i18n="create_account">Buat Akun</span>
      </button>
    </form>
    <div class="switch-auth">
      <span data-i18n="have_account">Sudah punya akun?</span>
      <a href="#" id="showLogin" data-i18n="login">Masuk</a>
    </div>
  </div>

  <div class="container-auth hidden" id="forgotContainer">
    <div class="glow"></div>
    <div class="logo-circle">MMIS</div>
    <h2 data-i18n="reset_password">Reset Kata Sandi</h2>
    <p class="muted" data-i18n="reset_subtitle">Masukkan email anda untuk menerima link reset.</p>
    <div id="forgotAlert"></div>
    <form id="forgotForm">
      <div class="inline-field">
        <label data-i18n="email">Email</label>
        <input type="email" id="forgotEmail" required placeholder="you@example.com">
      </div>
      <button type="submit" style="width:100%;margin-top:.6rem;">
        <i data-feather="mail" width="16"></i>
        <span data-i18n="send_reset_link">Kirim Link Reset</span>
      </button>
    </form>
    <div class="switch-auth">
      <a href="#" id="backToLogin" data-i18n="back_login">Kembali ke Login</a>
    </div>
  </div>
</div>

<!-- APP LAYOUT -->
<div id="appLayout" class="layout hidden">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo-circle" style="width:48px;height:48px;font-size:.85rem;letter-spacing:.8px;">MMIS</div>
      <h2>
        <span style="display:block;">Mutu Ikan</span>
        <span style="font-weight:400;opacity:.7;font-size:.55rem;letter-spacing:.5px;">Makassar</span>
      </h2>
      <button class="ghost responsive-hide" id="closeSidebar" style="margin-left:auto;padding:.5rem .55rem;">
        <i data-feather="x" width="16"></i>
      </button>
    </div>
    <div class="nav" id="navMenu">
      <button data-view="dashboard" class="active">
        <i data-feather="activity" width="18"></i>
        <span data-i18n="dashboard">Dashboard</span>
      </button>
      <button data-view="data">
        <i data-feather="database" width="18"></i>
        <span data-i18n="data_records">Data Mutu</span>
      </button>
      <button data-view="form">
        <i data-feather="edit-3" width="18"></i>
        <span data-i18n="input_form">Input Data</span>
      </button>
      <button data-view="organoleptic-tool">
  <i data-feather="sliders" width="18"></i>
  <span>Tool Organoleptik</span>
</button>
      <button data-view="reports">
        <i data-feather="bar-chart-2" width="18"></i>
        <span data-i18n="reports">Laporan</span>
      </button>
      <button data-view="settings">
        <i data-feather="settings" width="18"></i>
        <span data-i18n="settings">Pengaturan</span>
      </button>
      <button data-view="profile">
        <i data-feather="user" width="18"></i>
        <span data-i18n="profile">Profil</span>
      </button>
      <button data-view="safety">
        <i data-feather="shield" width="18"></i>
        <span data-i18n="safety">Keamanan</span>
      </button>
      <button data-view="sosial">
        <i data-feather="users" width="18"></i>
        <span data-i18n="social">Sosial</span>
      </button>
      <button data-view="about">
        <i data-feather="info" width="18"></i>
        <span>Tentang</span>
      </button>
    </div>
    <div class="sidebar-footer">
      <div id="sidebarUserInfo" style="font-size:.55rem;line-height:1.25;"></div>
      <div style="display:flex;gap:.5rem;">
        <button class="outline" id="btnLogout" style="flex:1;justify-content:center;">
          <i data-feather="log-out" width="14"></i>
          <span data-i18n="logout">Keluar</span>
        </button>
      </div>
      <div style="text-align:center;margin-top:.35rem;">
        <span class="muted" style="font-size:.5rem;">v1.6.0 Single File • Skripsi</span>
      </div>
    </div>
  </aside>

  <div class="main">
    <div style="padding:20px; opacity:0">dk</div>
    <div class="topbar">
      <div class="group-inline">
        <button class="ghost responsive-hide" id="openSidebar" style="padding:.5rem .55rem;">
          <i data-feather="menu" width="18"></i>
        </button>
        <div class="toggle" id="toggleMyData" data-state="all" title="Tampilkan data saya / semua">
          <i data-feather="toggle-right" width="14"></i>
          <span id="toggleMyDataLabel">Semua Data</span>
        </div>
        <div class="lang-pill" id="btnLang">
          <i data-feather="globe" width="14"></i>
          <span id="langLabel">ID</span>
        </div>
      </div>
      <div class="group-inline">
        <button class="ghost" id="btnToggleTheme" title="Mode Gelap/Terang">
          <i data-feather="moon" width="16"></i>
        </button>
        
        <div style="position:relative;">
          <div class="avatar" id="avatarBtn">
            <span id="avatarInitial">U</span>
            <img id="avatarImg" alt="avatar" class="hidden" />
          </div>
          <div class="dropdown" id="userDropdown">
            <button data-dropdown="profile">
              <i data-feather="user" width="15"></i>
              <span data-i18n="profile">Profil</span>
            </button>
            <button data-dropdown="settings">
              <i data-feather="settings" width="15"></i>
              <span data-i18n="settings">Pengaturan</span>
            </button>
            <button data-dropdown="reports">
              <i data-feather="bar-chart-2" width="15"></i>
              <span data-i18n="reports">Laporan</span>
            </button>
            <div style="height:1px;background:hsl(var(--panel-border)/0.55);margin:.4rem 0;"></div>
            <button id="logoutDropdownBtn">
              <i data-feather="log-out" width="15"></i>
              <span data-i18n="logout">Keluar</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <main class="content">

      <!-- DASHBOARD -->
      <section id="view-dashboard" class="fade-in view-transition-enter">
        <div class="panel bento" style="padding-bottom:.9rem;">
          <div class="panel-header">
            <h3><i data-feather="activity" width="14"></i><span data-i18n="dashboard_overview">Ringkasan Mutu Terkini</span></h3>
            <div style="display:flex;align-items:center;gap:.55rem;flex-wrap:wrap;">
              <div class="toggle-group">
                <div class="toggle-chip active" data-dash-filter="today">Hari Ini</div>
                <div class="toggle-chip" data-dash-filter="7d">7 Hari</div>
                <div class="toggle-chip" data-dash-filter="30d">30 Hari</div>
                <div class="toggle-chip" data-dash-filter="all">Semua</div>
              </div>
              <button class="ghost small" id="btnRefreshDashboard" title="Segarkan Dashboard">
                <i data-feather="refresh-cw" width="14"></i>
              </button>
            </div>
          </div>
          <div class="indicators" id="dashboardIndicators">
            <div class="indicator">
              <h4 data-i18n="total_records">Total Data</h4>
              <div class="val" id="indTotal">0</div>
              <div class="trend" id="indTotalTrend">0%</div>
            </div>
            <div class="indicator">
              <h4 data-i18n="avg_score">Rata-rata Skor</h4>
              <div class="val" id="indAvg">-</div>
              <div class="trend" id="indAvgTrend">0%</div>
            </div>
            <div class="indicator">
              <h4 data-i18n="good_quality">Mutu Baik</h4>
              <div class="val" id="indGood">0</div>
              <div class="trend" id="indGoodTrend">0%</div>
            </div>
            <div class="indicator">
              <h4 data-i18n="warning_quality">Mutu Sedang</h4>
              <div class="val" id="indWarn">0</div>
              <div class="trend" id="indWarnTrend">0%</div>
            </div>
            <div class="indicator">
              <h4 data-i18n="bad_quality">Mutu Buruk</h4>
              <div class="val" id="indBad">0</div>
              <div class="trend" id="indBadTrend">0%</div>
            </div>
            <div class="indicator">
              <h4 data-i18n="hazard_flagged">Indikasi Bahaya</h4>
              <div class="val" id="indHazard">0</div>
              <div class="trend" id="indHazardTrend">0%</div>
            </div>
          </div>
        </div>
        <div style="opacity:0">sk</div>
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(360px,1fr));">
          <div class="panel bento">
            <div class="panel-header">
              <h3><i data-feather="bar-chart-2" width="14"></i><span data-i18n="chart_comparison">Perbandingan Mutu per Pasar</span></h3>
              <div style="display:flex;gap:.35rem;">
                <button class="ghost small btn-refresh-chart" id="refreshCharts1" title="Segarkan">
                  <i data-feather="refresh-cw" width="13"></i>
                </button>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="chartComparison"></canvas>
            </div>
          </div>

          <div class="panel bento">
            <div class="panel-header">
              <h3><i data-feather="trending-up" width="14"></i><span data-i18n="chart_trend">Tren Skor Waktu</span></h3>
              <div style="display:flex;gap:.35rem;">
                <button class="ghost small btn-refresh-chart" id="refreshCharts2">
                  <i data-feather="refresh-cw" width="13"></i>
                </button>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="chartTrend"></canvas>
            </div>
          </div>

          <div class="panel bento">
            <div class="panel-header">
              <h3><i data-feather="pie-chart" width="14"></i><span data-i18n="chart_pie">Proporsi Jenis Ikan</span></h3>
              <div style="display:flex;gap:.35rem;">
                <button class="ghost small btn-refresh-chart" id="refreshCharts3">
                  <i data-feather="refresh-cw" width="13"></i>
                </button>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="chartPie"></canvas>
            </div>
          </div>

          <div class="panel bento">
            <div class="panel-header">
              <h3><i data-feather="thermometer" width="14"></i><span data-i18n="quality_indicators">Indikator Mutu</span></h3>
              <div class="toggle-group" style="font-size:.5rem;">
                <div class="toggle-chip active" data-quality-filter="all">Semua</div>
                <div class="toggle-chip" data-quality-filter="baik">Baik</div>
                <div class="toggle-chip" data-quality-filter="sedang">Sedang</div>
                <div class="toggle-chip" data-quality-filter="buruk">Buruk</div>
              </div>
            </div>
            <div id="qualityIndicatorList"></div>
          </div>
        </div>
      </section>

      <!-- DATA TABLE -->
      <section id="view-data" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="database" width="14"></i><span data-i18n="data_mutu_list">Data Mutu Ikan</span></h3>
            <div style="display:flex;gap:.4rem;flex-wrap:wrap;">
              <div class="search-box">
                <i data-feather="search" width="15" class="muted"></i>
                <input id="globalSearch" placeholder="Cari data ikan..." autocomplete="off">
              </div>
              <button class="ghost small" id="btnExportCSV"><i data-feather="download-cloud" width="13"></i> CSV</button>
              <button class="ghost small" id="btnExportExcel"><i data-feather="grid" width="13"></i> Excel</button>
              <button class="ghost small" id="btnExportPDF"><i data-feather="file-text" width="13"></i> PDF</button>
              <button class="ghost small" id="btnPrint"><i data-feather="printer" width="13"></i> Print</button>
            </div>
          </div>
          <div class="form-grid" style="margin-bottom:.75rem;">
            <div>
              <label data-i18n="filter_fish">Jenis Ikan</label>
              <select id="filterFish"></select>
            </div>
            <div>
              <label data-i18n="filter_market">Pasar</label>
              <select id="filterMarket"></select>
            </div>
            <div>
              <label data-i18n="filter_date">Tanggal</label>
              <input type="date" id="filterDate" />
            </div>
            <div>
              <label data-i18n="filter_text">Cari (bau / warna)</label>
              <input id="filterText" placeholder="Kata kunci">
            </div>
          </div>
          <div class="table-wrapper">
            <table id="dataTable">
              <thead>
                <tr>
                  <th>
                    <div class="select-all-wrap">
                      <input type="checkbox" id="selectAllPage">
                      <span>Pilih</span>
                    </div>
                  </th>
                  <th data-i18n="th_no">No</th>
                  <th data-i18n="th_date">Tanggal</th>
                  <th data-i18n="th_fish">Jenis Ikan</th>
                  <th data-i18n="th_market">Pasar</th>
                  <th data-i18n="th_organoleptic">Organoleptik</th>
                  <th data-i18n="th_smell">Bau</th>
                  <th data-i18n="th_texture">Tekstur</th>
                  <th data-i18n="th_color">Warna</th>
                  <th data-i18n="th_hazard">Keamanan</th>
                  <th data-i18n="th_image">Gambar</th>
                  <th data-i18n="th_score_status">Status</th>
                  <th data-i18n="th_user">Pengguna</th>
                  <th data-i18n="th_actions">Aksi</th>
                </tr>
              </thead>
              <tbody id="dataTableBody"></tbody>
            </table>
          </div>
          <div id="dataEmptyState" class="empty-state hidden">
            <i data-feather="inbox" width="38"></i>
            <div data-i18n="empty_data">Belum ada data. Silakan input.</div>
          </div>

          <div class="table-footer">
            <div style="display:flex;align-items:center;gap:.65rem;flex-wrap:wrap;">
              <label style="display:flex;align-items:center;gap:.35rem;">
                <span>Per halaman</span>
                <select id="perPageSelect">
                  <option value="10">10</option>
                  <option value="25" selected>25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </label>
              <div id="selectionInfo">0 dipilih</div>
            </div>
            <div class="pagination-controls">
              <button class="outline small" id="prevPage"><i data-feather="chevron-left" width="12"></i>Prev</button>
              <span id="pageInfo" style="font-weight:700;">Hal 1/1</span>
              <button class="outline small" id="nextPage">Next<i data-feather="chevron-right" width="12"></i></button>
            </div>
          </div>
        </div>
      </section>

      <!-- FORM INPUT -->
      <section id="view-form" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
          	<button class="ghost small" id="btnOpenOrgTool">
  <i data-feather="sliders" width="13"></i> Tool Skor
</button>
            <h3><i data-feather="edit-3" width="14"></i><span data-i18n="input_new_data">Input Data Mutu Baru</span></h3>
            <div style="display:flex;gap:.4rem;">
              <button class="ghost small" id="btnResetForm"><i data-feather="refresh-cw" width="13"></i> Reset</button>
            </div>
          </div>
          <form id="fishForm" autocomplete="off">
            <input type="hidden" id="recordId">
            <div class="form-grid">
              <div>
                <label data-i18n="fish_type">Jenis Ikan</label>
                <input list="fishTypeList" id="fishTypeInput" placeholder="Ketik atau pilih..." required>
                <datalist id="fishTypeList"></datalist>
              </div>
              <div>
                <label data-i18n="market_location">Lokasi Pasar</label>
                <input list="marketList" id="marketInput" placeholder="Ketik atau pilih..." required>
                <datalist id="marketList"></datalist>
              </div>
              <div>
                <label data-i18n="organoleptic_score">Skor Organoleptik (1-9)</label>
                <input type="number" id="organoleptic" min="1" max="9" required placeholder="1-9">
              </div>
              <div>
                <label data-i18n="smell">Bau</label>
                <input id="smell" required placeholder="Segar / agak amis">
              </div>
              <div>
                <label data-i18n="texture">Tekstur</label>
                <input id="texture" required placeholder="Kenyal / lembek">
              </div>
              <div>
                <label data-i18n="color">Warna</label>
                <input id="colorField" required placeholder="Cerah / pucat">
              </div>
              <div>
                <label data-i18n="date_auto">Tanggal (otomatis)</label>
                <input id="dateAuto" disabled>
              </div>
              <div id="studentFieldWrapper" class="hidden">
                <label data-i18n="student_id">NIM Mahasiswa</label>
                <input id="studentNIMForm" disabled placeholder="NIM Anda">
              </div>
              <div>
                <label data-i18n="food_safety">Keamanan Pangan (Opsional)</label>
                <div id="hazardChips" style="display:flex;flex-wrap:wrap;"></div>
                <textarea id="hazardNotes" placeholder="Catatan indikasi (misal: bau bahan kimia, tekstur aneh)..." style="margin-top:.4rem;height:68px;resize:vertical;"></textarea>
              </div>
              <div>
                <label>Foto Ikan (Opsional)</label>
                <input type="file" id="fishImage" accept="image/*">
                <div id="fishImagePreview" class="image-preview"></div>
              </div>
            </div>
            <div class="divider"></div>
            <div style="display:flex;gap:.65rem;flex-wrap:wrap;">
              <button type="submit" id="submitDataBtn">
                <i data-feather="save" width="14"></i>
                <span data-i18n="save_data">Simpan Data</span>
              </button>
              <button type="button" class="outline" id="cancelEditBtn" style="display:none;">
                <i data-feather="x-circle" width="14"></i>
                <span data-i18n="cancel_edit">Batal Edit</span>
              </button>
            </div>
            <div id="formAlert" style="margin-top:.65rem;"></div>
          </form>
          <div style="margin-top:.95rem;">
            <p class="xsmall muted">
              Tips: Ketik langsung Jenis Ikan / Pasar untuk menambahkan otomatis saat simpan (jika belum ada). Gunakan penilaian objektif keamanan (indikasi Boraks/Formalin hanya jika ada bukti uji cepat).
            </p>
          </div>
        </div>
      </section>

      <!-- REPORTS -->
      <section id="view-reports" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="file-text" width="14"></i><span data-i18n="reports_export">Laporan & Export</span></h3>
            <div style="display:flex;gap:.4rem;flex-wrap:wrap;">
              <button class="ghost small" id="repExportPDF"><i data-feather="file" width="13"></i> PDF</button>
              <button class="ghost small" id="repExportCSV"><i data-feather="download" width="13"></i> CSV</button>
              <button class="ghost small" id="repPrint"><i data-feather="printer" width="13"></i> Print</button>
            </div>
          </div>
          <p class="small" data-i18n="reports_desc">Pilih rentang data dan ekspor laporan yang berisi grafik dan tabel.</p>
          <div class="form-grid">
            <div>
              <label data-i18n="from_date">Dari Tanggal</label>
              <input type="date" id="reportFrom">
            </div>
            <div>
              <label data-i18n="to_date">Sampai Tanggal</label>
              <input type="date" id="reportTo">
            </div>
            <div>
              <label data-i18n="report_scope">Ruang Lingkup</label>
              <select id="reportScope">
                <option value="all">Semua Data</option>
                <option value="mine">Data Saya</option>
              </select>
            </div>
            <div>
              <label data-i18n="report_fish_type">Jenis Ikan (Opsional)</label>
              <select id="reportFish"></select>
            </div>
          </div>
          <div style="margin-top:.9rem;display:flex;gap:.55rem;flex-wrap:wrap;">
            <button id="btnGenerateReport">
              <i data-feather="file-text" width="14"></i>
              <span data-i18n="generate_report">Generate Laporan</span>
            </button>
            <button class="outline" id="btnClearReport">
              <i data-feather="trash-2" width="14"></i>
              <span data-i18n="clear_report">Bersihkan</span>
            </button>
          </div>
          <div class="divider" style="margin-top:1.1rem;"></div>
          <div id="reportResult" class="fade-in"></div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="view-settings" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="settings" width="14"></i><span data-i18n="settings_pref">Pengaturan & Preferensi</span></h3>
          </div>
          <div class="preference-grid">
            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="appearance">Tampilan</h4>
              <div style="display:flex;flex-direction:column;gap:.7rem;">
                <div>
                  <label data-i18n="theme_mode">Mode Tema</label>
                  <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
                    <button class="outline small" id="prefLight"><i data-feather="sun" width="13"></i>Light</button>
                    <button class="outline small" id="prefDark"><i data-feather="moon" width="13"></i>Dark</button>
                  </div>
                </div>
                <div>
                  <label data-i18n="accent_color">Warna Aksen</label>
                  <div class="color-palette" id="accentPalette"></div>
                </div>
                <div>
                  <label data-i18n="layout_style">Gaya Layout</label>
                  <select id="layoutStyle">
                    <option value="grid">Grid (Default)</option>
                    <option value="list">List / Kompak</option>
                  </select>
                </div>
                <div>
                  <label>Ukuran Font</label>
                  <select id="fontSizeSelect">
                    <option value="small">Kecil</option>
                    <option value="medium" selected>Normal</option>
                    <option value="large">Besar</option>
                  </select>
                </div>
                <div>
                  <label data-i18n="lite_mode">Mode Lite (Tanpa Blur)</label>
                  <button class="outline small" id="toggleLiteMode"><i data-feather="zap" width="13"></i><span id="liteModeLabel">Aktifkan</span></button>
                </div>
                <div>
                  <label data-i18n="language">Bahasa</label>
                  <select id="languageSelect">
                    <option value="id">Indonesia</option>
                    <option value="en">English</option>
                  </select>
                </div>
                <div>
                  <label data-i18n="last_login">Login Terakhir</label>
                  <input id="lastLoginField" disabled>
                </div>
                <div>
                  <label data-i18n="created_at">Dibuat</label>
                  <input id="createdAtField" disabled>
                </div>
              </div>
            </div>

            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="account_info">Info Akun</h4>
              <div id="settingsUserInfo" style="font-size:.64rem;line-height:1.55;"></div>
              <div style="margin-top:.6rem;display:flex;flex-wrap:wrap;gap:.45rem;">
                <button class="ghost small" id="btnResendVerification"><i data-feather="mail" width="13"></i><span data-i18n="resend_verif">Kirim Ulang Verifikasi</span></button>
                <button class="ghost small" id="btnRefreshUser"><i data-feather="refresh-cw" width="13"></i><span data-i18n="refresh">Refresh</span></button>
              </div>
              <div id="verifyAlert" style="margin-top:.55rem;"></div>
            </div>

            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="role_mgmt">Manajemen Peran</h4>
              <p class="small" data-i18n="role_mgmt_desc">Hanya admin dapat mengubah peran pengguna lain. (Client-side demonstrasi)</p>
              <div id="roleMgmt" class="small" style="display:flex;flex-direction:column;gap:.5rem;"></div>
              <div id="adminUserDelete" class="small" style="margin-top:.6rem;"></div>
            </div>

            <div class="panel compact">
              <h4 class="section-subtitle">Preferensi Default Input</h4>
              <div class="small muted" style="margin-bottom:.45rem;">Atur nilai bawaan untuk Form Input.</div>
              <div style="display:grid;gap:.65rem;">
                <div>
                  <label data-i18n="default_fish_type">Default Jenis Ikan</label>
                  <select id="prefDefaultFish"></select>
                </div>
                <div>
                  <label data-i18n="default_market">Default Pasar</label>
                  <select id="prefDefaultMarket"></select>
                </div>
                <button class="outline small" id="btnSavePreferences"><i data-feather="save" width="13"></i> Simpan Preferensi</button>
                <div id="prefAlert"></div>
              </div>
            </div>

            <div class="panel compact">
              <h4 class="section-subtitle" data-i18n="danger_zone">Zona Berbahaya</h4>
              <p class="small" data-i18n="delete_account_warn">Penghapusan akun akan menghapus data profil (tidak menghapus histori data). (Demo)</p>
              <button class="danger small" id="btnDeleteAccount"><i data-feather="user-x" width="13"></i><span data-i18n="delete_account">Hapus Akun</span></button>
              <div id="deleteAccountAlert" style="margin-top:.55rem;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="view-profile" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="user" width="14"></i><span data-i18n="profile_manage">Profil Pengguna</span></h3>
            <div style="display:flex;gap:.4rem;">
              <button class="ghost small" id="btnRefreshProfile" title="Refresh Profil"><i data-feather="refresh-cw" width="13"></i></button>
            </div>
          </div>
          <div style="display:flex;gap:1.6rem;flex-wrap:wrap;">
            <div style="flex:0 0 190px;display:flex;flex-direction:column;align-items:center;gap:.85rem;">
              <div class="avatar" style="width:125px;height:125px;border-radius:38px;font-size:2.1rem;" id="profileAvatar">
                <span id="profileAvatarInitial">U</span>
                <img id="profileAvatarImg" alt="avatar" class="hidden">
              </div>
              <input type="file" id="profilePhotoInput" accept="image/*" style="display:none;">
              <button class="outline small" id="btnChangePhoto" style="width:100%;justify-content:center;">
                <i data-feather="image" width="13"></i><span data-i18n="change_photo">Ganti Foto</span>
              </button>
              <button class="outline small" id="btnRemovePhoto" style="width:100%;justify-content:center;">
                <i data-feather="trash" width="13"></i><span data-i18n="remove_photo">Hapus Foto</span>
              </button>
              <button class="ghost small" id="btnSendPasswordReset">
                <i data-feather="lock" width="13"></i> Reset Password
              </button>
            </div>
            <div style="flex:1;min-width:280px;">
              <form id="profileForm">
                <div class="form-grid">
                  <div>
                    <label data-i18n="full_name">Nama Lengkap</label>
                    <input id="profName" required>
                  </div>
                  <div>
                    <label>Email</label>
                    <input id="profEmail" disabled>
                  </div>
                  <div>
                    <label data-i18n="role">Peran</label>
                    <select id="profRole" disabled>
                      <option>Admin</option>
                      <option>Mahasiswa</option>
                      <option>Dosen</option>
                      <option>Petugas Pasar</option>
                    </select>
                  </div>
                  <div>
                    <label data-i18n="email_verified">Email Terverifikasi</label>
                    <input id="profVerified" disabled>
                  </div>
                  <div id="profFieldStudent" class="hidden">
                    <label data-i18n="student_id">NIM Mahasiswa</label>
                    <input id="profStudentId" placeholder="NIM">
                  </div>
                  <div id="profFieldLecturer" class="hidden">
                    <label data-i18n="lecturer_id">NIP Dosen</label>
                    <input id="profLecturerId" placeholder="NIP">
                  </div>
                  <div id="profFieldOfficer" class="hidden">
                    <label data-i18n="officer_id">ID Petugas</label>
                    <input id="profOfficerId" placeholder="ID Petugas">
                  </div>
                </div>
                <div class="divider"></div>
                <div class="form-grid" style="margin-top:-.25rem;">
                  <div>
                    <label>Ganti Email Baru</label>
                    <input id="changeEmailField" placeholder="email baru">
                  </div>
                  <div style="display:flex;align-items:flex-end;gap:.5rem;">
                    <button type="button" class="outline small" id="btnChangeEmail" style="margin-top:.95rem;">
                      <i data-feather="mail" width="12"></i> Ganti Email
                    </button>
                  </div>
                  <div>
                    <label>Password Baru</label>
                    <input id="changePasswordField" type="password" placeholder="password baru">
                  </div>
                  <div>
                    <label>Konfirmasi Password</label>
                    <input id="changePasswordConfirm" type="password" placeholder="ulangi password">
                  </div>
                  <div style="display:flex;align-items:flex-end;">
                    <button type="button" class="outline small" id="btnChangePassword" style="margin-top:.95rem;">
                      <i data-feather="lock" width="12"></i> Ganti Password
                    </button>
                  </div>
                </div>
                <div class="divider"></div>
                <div style="display:flex;gap:.65rem;flex-wrap:wrap;">
                  <button type="submit" class="small">
                    <i data-feather="save" width="13"></i>
                    <span data-i18n="update_profile">Update Profil</span>
                  </button>
                  <button type="button" class="outline small" id="btnSendVerifyProfile">
                    <i data-feather="mail" width="13"></i>
                    <span data-i18n="send_verification">Kirim Verifikasi</span>
                  </button>
                </div>
                <div id="profileAlert" style="margin-top:.6rem;"></div>
              </form>
              <div class="divider"></div>
              <div id="profileStats" class="fade-scale" style="display:flex;flex-direction:column;gap:.6rem;">
                <div style="font-size:.58rem;font-weight:800;letter-spacing:.55px;text-transform:uppercase;color:hsl(var(--text-dim));">Statistik Kontribusi</div>
                <div style="display:flex;flex-wrap:wrap;gap:.5rem;" id="profileStatsBadges"></div>
                <button class="outline small" id="btnRefreshStats"><i data-feather="bar-chart-2" width="13"></i> Perbarui Statistik</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SAFETY -->
      <section id="view-safety" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="shield" width="14"></i><span data-i18n="safety_section">Keamanan Pangan</span></h3>
          </div>
          <p class="small" data-i18n="safety_intro">
            Bagian ini menjelaskan indikator keamanan ikan segar di pasar tradisional. Indikasi bahan berbahaya seperti Boraks, Formalin,
            Pewarna Tekstil (Rhodamin B), atau Pengawet berlebih harus dicatat jika ada bukti visual / uji cepat.
          </p>
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;">
            <div class="panel compact">
              <h4 class="section-subtitle">Indikator Umum</h4>
              <ul style="margin:0;padding-left:1.05rem;font-size:.58rem;line-height:1.5;">
                <li>Daging ikan terlalu kenyal / elastis tidak wajar → indikasi Boraks.</li>
                <li>Warna insang pucat keabu-abuan tanpa bau amis alami → indikasi Formalin.</li>
                <li>Warna daging sangat mencolok (merah muda cerah / kuning terang) → pewarna tekstil.</li>
                <li>Bau menyengat kimia (bukan bau laut/amis ringan)</li>
                <li>Mata ikan keruh & cekung + lendir berlebih → mutu turun.</li>
              </ul>
            </div>
            <div class="panel compact">
              <h4 class="section-subtitle">Rekomendasi</h4>
              <ul style="margin:0;padding-left:1.05rem;font-size:.58rem;line-height:1.5;">
                <li>Lakukan uji cepat formalin/boraks bila tersedia.</li>
                <li>Catat hanya "indikasi" jika tanpa uji laboratorium.</li>
                <li>Gunakan kolom catatan untuk deskripsi temuan.</li>
                <li>Laporkan ke otoritas bila indikasi kuat berulang.</li>
              </ul>
            </div>
            <div class="panel compact">
              <h4 class="section-subtitle">Status Keamanan</h4>
              <div style="display:flex;flex-direction:column;gap:.4rem;font-size:.58rem;">
                <div><span class="hazard-badge safe"><i data-feather="shield" width="11"></i>Aman</span> Tidak ada indikasi bahan berbahaya.</div>
                <div><span class="hazard-badge"><i data-feather="alert-triangle" width="11"></i>Perhatian</span> Ada indikasi awal, perlu verifikasi.</div>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="small muted">
            Disclaimer: Data keamanan pada aplikasi ini bersifat indikatif (observasi lapangan) dan bukan hasil uji laboratorium resmi.
          </div>
        </div>
      </section>

      <!-- SOSIAL -->
      <section id="view-sosial" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="users" width="14"></i><span data-i18n="social_feed_title">Sosial & Aktivitas Pengguna</span></h3>
          </div>
          <p class="small" data-i18n="social_intro">
            Bagian ini menampilkan daftar pengguna, posting singkat, reaksi, dan komentar. Klik avatar/nama untuk melihat profil.
          </p>
          <div class="social-container">
            <div style="display:flex;flex-direction:column;gap:1rem;">
              <div class="social-form" id="socialFormWrapper">
                <div style="font-size:.6rem;font-weight:700;letter-spacing:.55px;display:flex;align-items:center;gap:.45rem;">
                  <i data-feather="edit-3" width="14"></i>
                  <span data-i18n="create_post">Buat Post</span>
                </div>
                <textarea id="socialPostContent" maxlength="800" placeholder="Tulis sesuatu..."></textarea>
                <div style="display:flex;gap:.55rem;flex-wrap:wrap;">
                  <input type="file" id="socialPostImage" accept="image/*" style="font-size:.55rem;">
                  <div id="socialImagePreview" style="font-size:.5rem;color:hsl(var(--text-dim));"></div>
                </div>
                <div class="actions">
                  <button id="btnSubmitPost" class="small">
                    <i data-feather="send" width="13"></i>
                    <span data-i18n="post_now">Kirim</span>
                  </button>
                  <button type="button" id="btnClearPost" class="outline small">
                    <i data-feather="x-circle" width="13"></i>
                    <span data-i18n="clear">Bersih</span>
                  </button>
                </div>
                <div id="socialPostAlert"></div>
              </div>
              <div style="font-size:.58rem;font-weight:800;letter-spacing:.55px;text-transform:uppercase;color:hsl(var(--text-dim));display:flex;align-items:center;gap:.4rem;">
                <i data-feather="message-circle" width="14"></i><span data-i18n="recent_posts">Posting Terbaru</span>
              </div>
              <div class="social-feed" id="socialFeed"></div>
              <div id="socialEmpty" class="small muted hidden" style="text-align:center;padding:1.2rem .6rem;">
                <i data-feather="inbox" width="22"></i> <span data-i18n="no_posts">Belum ada posting.</span>
              </div>
            </div>
            <div class="social-users" id="socialUsers">
              <div style="display:flex;align-items:center;gap:.45rem;font-weight:700;font-size:.6rem;letter-spacing:.55px;">
                <i data-feather="user" width="14"></i>
                <span data-i18n="users_list">Daftar Pengguna</span>
              </div>
              <div id="socialUsersList" style="display:flex;flex-direction:column;gap:.55rem;"></div>
            </div>
          </div>
        </div>
      </section>

<section id="view-organoleptic-tool" class="hidden fade-in">
  <div class="panel">
    <div class="panel-header">
      <h3>
        <i data-feather="sliders" width="14"></i>
        <span>Tool Perhitungan Organoleptik</span>
      </h3>
      <div style="display:flex;gap:.4rem;flex-wrap:wrap;">
        <select id="orgStandardSelect" style="max-width:160px;">
          <option value="sni2013">SNI 2013</option>
          <option value="sni2021">SNI 2021</option>
        </select>
        <button class="ghost small" id="btnResetOrgTool">
          <i data-feather="refresh-cw" width="13"></i> Reset
        </button>
        <button class="ghost small" id="btnBackToForm">
          <i data-feather="corner-up-left" width="13"></i> Kembali Form
        </button>
      </div>
    </div>

    <p class="small" style="margin-top:-.35rem;">
      Pilih standar (SNI 2013 / SNI 2021), kemudian pilih deskripsi kondisi tiap parameter. Skor total dihitung otomatis (rata-rata / atau ambil skor terendah—dapat diubah sesuai kebijakan). 
      Klik "Terapkan ke Form Input" untuk mengisi otomatis field Organoleptik (skor) dan beberapa deskripsi (Bau, Tekstur, Warna) berdasarkan pilihan.
    </p>

    <div class="divider"></div>

    <div id="orgCriteriaContainer" class="org-criteria-grid"></div>

    <div class="divider"></div>

    <div class="org-result-box">
      <div style="display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;">
        <div>
          <div class="meta">Metode Agregasi</div>
          <select id="orgAggregateMethod" style="min-width:160px;">
            <option value="average">Rata-rata (Mean)</option>
            <option value="min">Skor Terendah (Conservative)</option>
            <option value="median">Median</option>
          </select>
        </div>
        <div>
          <div class="meta">Skor Akhir</div>
          <div id="orgFinalScore" class="inline-stat">-</div>
        </div>
        <div>
          <div class="meta">Status</div>
          <div id="orgFinalStatus" class="inline-stat">-</div>
        </div>
      </div>
      <div style="margin-top:.65rem;display:flex;gap:.55rem;flex-wrap:wrap;">
        <button id="btnApplyOrgScore">
          <i data-feather="check" width="14"></i> Terapkan ke Form Input
        </button>
        <button class="outline" id="btnCopyOrgSummary">
          <i data-feather="clipboard" width="14"></i> Salin Ringkasan
        </button>
      </div>
      <div id="orgSummary" class="small muted" style="margin-top:.55rem;white-space:pre-wrap;"></div>
      <div class="small" style="margin-top:.75rem;">
        <strong>Catatan:</strong> Deskripsi standar disederhanakan untuk contoh. Silakan sesuaikan dengan dokumen resmi SNI.
      </div>
    </div>
  </div>
</section>

      <!-- ABOUT -->
      <section id="view-about" class="hidden fade-in">
        <div class="panel">
          <div class="panel-header">
            <h3><i data-feather="info" width="14"></i><span>Tentang Aplikasi</span></h3>
          </div>
          <p class="small">
            Aplikasi single-file ini dikembangkan untuk skripsi:
            <strong>"Pengembangan Sistem Informasi Berbasis Website untuk Pencatatan dan Monitoring Mutu Ikan Segar di Pasar Tradisional Kota Makassar"</strong>.
          </p>
          <p class="small">
            Fitur: Auth Firebase, Role-based Access, CRUD Data Mutu, Dashboard, Export, Chart.js, i18n, Dark/Light Mode, Glassmorphism,
            Preferensi Default, Input Dinamis, Upload Gambar, Statistik, Toast, Aksen & Font, Keamanan Pangan, Detail Modal,
            Feed Sosial + Reaksi + Komentar + Modal Profil, Pagination & Seleksi Tabel, FAB Input Cepat.
          </p>
          <p class="small">
            Catatan Keamanan: Gunakan Firestore Security Rules untuk enforcement role di server. Kode ini contoh client-side.
          </p>
          <details style="margin-top:1rem;">
            <summary style="cursor:pointer;font-size:.6rem;font-weight:800;letter-spacing:.5px;">Contoh Firestore Security Rules (Konseptual)</summary>
<pre class="small" style="white-space:pre-wrap;background:hsl(var(--accent)/0.18);padding:.7rem .85rem;border-radius:14px;line-height:1.35;">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function userRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    match /users/{uid} {
      allow read: if isSignedIn();
      allow create: if request.auth.uid == uid;
      allow update: if request.auth.uid == uid || userRole() == 'Admin';
      allow delete: if userRole() == 'Admin';
    }
    match /fishQuality/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        userRole() in ['Admin','Petugas Pasar'] ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isSignedIn() && (
        userRole() == 'Admin' ||
        (userRole() == 'Petugas Pasar' && resource.data.userId == request.auth.uid)
      );
    }
    match /socialPosts/{p} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update,delete: if isSignedIn() && (
        request.auth.uid == resource.data.userId || userRole() == 'Admin'
      );
    }
    match /socialPosts/{p}/comments/{c} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow delete: if isSignedIn() && (
        request.auth.uid == resource.data.userId || userRole() == 'Admin'
      );
    }
  }
}
</pre>
          </details>
        </div>
      </section>

    </main>

    <footer class="app">
      <span id="footerInfo">© <span id="year2"></span> Sistem Mutu Ikan Segar - Single File App</span>
    </footer>
  </div>
</div>

<!-- Floating Action Button -->
<button id="fabInputData" class="fab" title="Input Data">
  <i data-feather="plus" width="22"></i>
</button>

<script>
/* ============================================================
   APP.JS (Refactor + Enhancements v1.6.0)
   Tambahan v1.6.0:
   - Reaksi (Like/Dislike) & Komentar Sosial
   - Modal Profil Pengguna lain
   - Pagination & Seleksi Tabel Data
   - FAB tombol cepat ke Input Data
   - Perbaikan bug minor & penataan ulang
   ============================================================ */

const firebaseConfig = {
  apiKey: "AIzaSyAxMT-bM6FEPrD-o3I2G-VHdZP7hxhj0uo",
  authDomain: "femmeiacloth-finance.firebaseapp.com",
  projectId: "femmeiacloth-finance",
  storageBucket: "femmeiacloth-finance.appspot.com",
  messagingSenderId: "517478386163",
  appId: "1:517478386163:web:51028f5841baa311126a86",
  measurementId: "G-K4L516Q54R"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

window.App = (()=> {

  const state = {
    currentUser: null,
    userProfile: null,
    fishData: [],
    filteredData: [],
    charts: {},
    myDataOnly: false,
    qualityFilter: 'all',
    lang: localStorage.getItem('lang') || 'id',
    accent: localStorage.getItem('accent') || '210 100% 50%',
    layoutStyle: localStorage.getItem('layoutStyle') || 'grid',
    dashRange: 'today',
    roleOptions: ['Admin','Mahasiswa','Dosen','Petugas Pasar'],
    fishTypes: [],
    markets: [],
    lastAddedId: null,
    metadataUnsub: { fish:null, markets:null, data:null, social:null },
    formImageData: null,
    fontSize: localStorage.getItem('fontSize') || 'medium',
    liteMode: localStorage.getItem('liteMode') === '1',
    hazardList: ['Boraks','Formalin','Pewarna Tekstil','Pengawet Berlebih','Lainnya'],
    formHazards: [],
    debounceTimers: {},
    chartBuildTimer: null,
    table: {
      page: 1,
      perPage: 25,
      selected: new Set()
    },
    social: {
      posts: [],
      imageData: null,
      usersCache: [],
      commentUnsubs: {},
      openComments: new Set()
    }
  };

  const defaultFishTypes = ["Ikan Kembung","Ikan Bandeng","Ikan Nila","Tuna Kecil"];
  const defaultMarkets   = ["Pasar Terong","Pasar Pa’baeng-baeng","Pasar Maricaya","Pasar Panakkukang"];

  const i18n = {
    id: {
      app_title:"Monitoring Mutu Ikan Segar", app_subtitle:"Sistem Informasi Pasar Tradisional Kota Makassar",
      email:"Email", password:"Kata Sandi", confirm_password:"Konfirmasi Kata Sandi", login:"Masuk",
      register_now:"Daftar sekarang", no_account:"Belum punya akun?", have_account:"Sudah punya akun?",
      forgot_password:"Lupa kata sandi?", register_account:"Registrasi Akun",
      register_subtitle:"Buat akun baru untuk mulai mencatat data mutu ikan.",
      create_account:"Buat Akun", reset_password:"Reset Kata Sandi", reset_subtitle:"Masukkan email anda untuk menerima link reset.",
      send_reset_link:"Kirim Link Reset", back_login:"Kembali ke Login", full_name:"Nama Lengkap", role:"Peran",
      dashboard:"Dashboard", data_records:"Data Mutu", input_form:"Input Data", reports:"Laporan",
      settings:"Pengaturan", profile:"Profil", logout:"Keluar", dashboard_overview:"Ringkasan Mutu Terkini",
      total_records:"Total Data", avg_score:"Rata-rata Skor", good_quality:"Mutu Baik", warning_quality:"Mutu Sedang",
      bad_quality:"Mutu Buruk", chart_comparison:"Perbandingan Mutu per Pasar", chart_trend:"Tren Skor Waktu",
      chart_pie:"Proporsi Jenis Ikan", quality_indicators:"Indikator Mutu", data_mutu_list:"Data Mutu Ikan",
      filter_fish:"Filter Jenis Ikan", filter_market:"Filter Pasar", filter_date:"Filter Tanggal",
      filter_text:"Filter Teks", th_no:"No", th_date:"Tanggal", th_fish:"Jenis Ikan", th_market:"Pasar",
      th_organoleptic:"Organoleptik", th_smell:"Bau", th_texture:"Tekstur", th_color:"Warna", th_image:"Gambar",
      th_hazard:"Keamanan", th_score_status:"Status", th_user:"Pengguna", th_actions:"Aksi",
      empty_data:"Belum ada data. Silakan input.", input_new_data:"Input Data Mutu Baru", fish_type:"Jenis Ikan",
      market_location:"Lokasi Pasar", organoleptic_score:"Skor Organoleptik (1-9)", smell:"Bau", texture:"Tekstur",
      color:"Warna", date_auto:"Tanggal (otomatis)", save_data:"Simpan Data", cancel_edit:"Batal Edit",
      reports_export:"Laporan & Export", reports_desc:"Pilih rentang data dan ekspor laporan yang berisi grafik dan tabel.",
      from_date:"Dari Tanggal", to_date:"Sampai Tanggal", report_scope:"Ruang Lingkup", report_fish_type:"Jenis Ikan (Opsional)",
      generate_report:"Generate Laporan", clear_report:"Bersihkan", settings_pref:"Pengaturan & Preferensi",
      appearance:"Tampilan", theme_mode:"Mode Tema", accent_color:"Warna Aksen", layout_style:"Gaya Layout",
      language:"Bahasa", account_info:"Info Akun", resend_verif:"Kirim Ulang Verifikasi",
      refresh:"Refresh", role_mgmt:"Manajemen Peran",
      role_mgmt_desc:"Hanya admin dapat mengubah peran pengguna lain. (Client-side demonstrasi)",
      danger_zone:"Zona Berbahaya", delete_account_warn:"Penghapusan akun akan menghapus data profil (tidak menghapus histori data). (Demo)",
      delete_account:"Hapus Akun", profile_manage:"Profil Pengguna", change_photo:"Ganti Foto",
      remove_photo:"Hapus Foto", update_profile:"Update Profil", send_verification:"Kirim Verifikasi",
      email_verified:"Email Terverifikasi", student_id:"NIM Mahasiswa", lecturer_id:"NIP Dosen",
      officer_id:"ID Petugas", default_fish_type:"Default Jenis Ikan", default_market:"Default Pasar",
      hazard_flagged:"Indikasi Bahaya", safety:"Keamanan", safety_section:"Keamanan Pangan",
      safety_intro:"Indikator keamanan ikan segar untuk mendeteksi indikasi bahan berbahaya.",
      food_safety:"Keamanan Pangan", lite_mode:"Mode Lite (Tanpa Blur)",
      social:"Sosial", social_feed_title:"Sosial & Aktivitas Pengguna", social_intro:"Bagian ini menampilkan daftar pengguna dan posting singkat (mirip feed). Anda dapat memposting update singkat.",
      create_post:"Buat Post", post_now:"Kirim", clear:"Bersih", recent_posts:"Posting Terbaru", no_posts:"Belum ada posting.",
      users_list:"Daftar Pengguna", last_login:"Login Terakhir", created_at:"Dibuat", detail:"Detail", view_detail:"Lihat Detail"
    },
    en: {
      app_title:"Fresh Fish Quality Monitoring", app_subtitle:"Information System for Traditional Markets in Makassar",
      email:"Email", password:"Password", confirm_password:"Confirm Password", login:"Login",
      register_now:"Register now", no_account:"Don't have an account?", have_account:"Already have an account?",
      forgot_password:"Forgot password?", register_account:"Register Account",
      register_subtitle:"Create a new account to start recording fish quality data.",
      create_account:"Create Account", reset_password:"Reset Password", reset_subtitle:"Enter your email to receive a reset link.",
      send_reset_link:"Send Reset Link", back_login:"Back to Login", full_name:"Full Name", role:"Role",
      dashboard:"Dashboard", data_records:"Quality Data", input_form:"Input Data", reports:"Reports",
      settings:"Settings", profile:"Profile", logout:"Logout", dashboard_overview:"Latest Quality Overview",
      total_records:"Total Records", avg_score:"Average Score", good_quality:"Good Quality", warning_quality:"Medium Quality",
      bad_quality:"Bad Quality", chart_comparison:"Quality Comparison per Market", chart_trend:"Score Trend Over Time",
      chart_pie:"Fish Type Proportion", quality_indicators:"Quality Indicators", data_mutu_list:"Fish Quality Data",
      filter_fish:"Filter Fish Type", filter_market:"Filter Market", filter_date:"Filter Date",
      filter_text:"Filter Text", th_no:"No", th_date:"Date", th_fish:"Fish Type", th_market:"Market",
      th_organoleptic:"Organoleptic", th_smell:"Smell", th_texture:"Texture", th_color:"Color", th_image:"Image",
      th_hazard:"Safety", th_score_status:"Status", th_user:"User", th_actions:"Actions",
      empty_data:"No data yet. Please input.", input_new_data:"Input New Quality Data",
      fish_type:"Fish Type", market_location:"Market Location", organoleptic_score:"Organoleptic Score (1-9)",
      smell:"Smell", texture:"Texture", color:"Color", date_auto:"Date (auto)", save_data:"Save Data",
      cancel_edit:"Cancel Edit", reports_export:"Reports & Export",
      reports_desc:"Choose a date range and export report containing charts and tables.",
      from_date:"From Date", to_date:"To Date", report_scope:"Scope", report_fish_type:"Fish Type (Optional)",
      generate_report:"Generate Report", clear_report:"Clear", settings_pref:"Settings & Preferences",
      appearance:"Appearance", theme_mode:"Theme Mode", accent_color:"Accent Color", layout_style:"Layout Style",
      language:"Language", account_info:"Account Info", resend_verif:"Resend Verification",
      refresh:"Refresh", role_mgmt:"Role Management",
      role_mgmt_desc:"Only admin can change other user roles. (Client-side demo)",
      danger_zone:"Danger Zone", delete_account_warn:"Account deletion removes profile (history remains). (Demo)",
      delete_account:"Delete Account", profile_manage:"User Profile", change_photo:"Change Photo",
      remove_photo:"Remove Photo", update_profile:"Update Profile", send_verification:"Send Verification",
      email_verified:"Email Verified", student_id:"Student ID", lecturer_id:"Lecturer ID",
      officer_id:"Officer ID", default_fish_type:"Default Fish Type", default_market:"Default Market",
      hazard_flagged:"Hazard Flagged", safety:"Safety", safety_section:"Food Safety",
      safety_intro:"Food safety indicators to detect potential hazardous additives.",
      food_safety:"Food Safety", lite_mode:"Lite Mode (No Blur)",
      social:"Social", social_feed_title:"Social & User Activity", social_intro:"This section shows the user list and short posts (feed). You can post quick updates.",
      create_post:"Create Post", post_now:"Post", clear:"Clear", recent_posts:"Recent Posts", no_posts:"No posts yet.",
      users_list:"Users List", last_login:"Last Login", created_at:"Created", detail:"Detail", view_detail:"View Detail"
    }
  };

  const $    = sel => document.querySelector(sel);
  const $all = sel => Array.from(document.querySelectorAll(sel));
  <!-- === LANJUTAN SCRIPT DARI BARIS TERPUTUS === -->

  const sanitize = s => (s||'').toString().replace(/[<>]/g,'');
  const clamp = (n,min,max)=> Math.max(min,Math.min(max,n));
  const isoDateOnly = d => {
    const dt = (d instanceof Date)? d : new Date(d);
    return dt.toISOString().split('T')[0];
  };
  const formatDate = ts => {
    if(!ts) return '-';
    const d = ts instanceof Date ? ts : (ts.toDate? ts.toDate(): new Date(ts));
    return d.toLocaleDateString(state.lang==='en'?'en-US':'id-ID',{year:'numeric',month:'2-digit',day:'2-digit'});
  };
  const formatDateTime = ts => {
    if(!ts) return '-';
    const d = ts instanceof Date ? ts : (ts.toDate? ts.toDate(): new Date(ts));
    return d.toLocaleString(state.lang==='en'?'en-US':'id-ID',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
  };
  const average = arr => !arr.length?0: arr.reduce((a,b)=>a+b,0)/arr.length;
  const nowDateInput = ()=> new Date().toISOString().split('T')[0];
  const debounce = (key, fn, delay=300)=>{
    clearTimeout(state.debounceTimers[key]);
    state.debounceTimers[key] = setTimeout(fn, delay);
  };

  function toast(msg,type='info',timeout=4000){
    const c = $('#toastContainer'); if(!c) return;
    const div = document.createElement('div');
    div.className = 'toast';
    div.dataset.type = type;
    const icon = type==='success'?'check-circle': type==='danger'?'alert-triangle': type==='warn'?'alert-octagon':'info';
    div.innerHTML = `
      <i data-feather="${icon}" width="14"></i>
      <span style="flex:1;">${msg}</span>
      <button class="toast-close"><i data-feather="x" width="14"></i></button>
    `;
    c.appendChild(div);
    feather.replace();
    let closing=false;
    let timer = setTimeout(close, timeout);
    function close(){
      if(closing) return;
      closing=true;
      div.style.animation='toastExit .5s ease forwards';
      setTimeout(()=> div.remove(),480);
    }
    div.querySelector('.toast-close').onclick = ()=> { clearTimeout(timer); close(); };
    div.addEventListener('mouseenter',()=> clearTimeout(timer));
    div.addEventListener('mouseleave',()=> timer=setTimeout(close,timeout));
  }

  function showAlert(targetId,type,msg,timeout=5000){
    const el = typeof targetId==='string'? document.getElementById(targetId): targetId;
    if(!el) return;
    el.innerHTML = `
      <div class="alert ${type}">
        <i data-feather="${type==='danger'?'alert-triangle':type==='success'?'check-circle': type==='warn'?'alert-octagon':'info'}" width="14"></i>
        <span style="flex:1;">${msg}</span>
        <button style="background:transparent;border:none;color:inherit;cursor:pointer;padding:.2rem .35rem;" onclick="this.closest('.alert').remove();">
          <i data-feather="x" width="12"></i>
        </button>
      </div>`;
    feather.replace();
    if(timeout) setTimeout(()=> el.firstElementChild && el.firstElementChild.remove(), timeout);
  }

  function download(filename, content, type='text/plain'){
    const blob = new Blob([content],{type});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1200);
  }

  /* Modal System */
  const Modal = {
    open({
      title='Konfirmasi',
      message='Yakin?',
      icon='help-circle',
      confirmText='Ya',
      cancelText='Batal',
      confirmType='danger',
      extraHTML='',
      onConfirm=()=>{},
      onCancel=()=>{}
    }={}){
      const wrap = $('#appModal');
      if(!wrap) return;
      $('#modalTitle').innerHTML = `<i data-feather="${icon}" width="18"></i><span>${title}</span>`;
      $('#modalMessage').textContent = message;
      $('#modalOkText').textContent = confirmText;
      $('#modalCancelText').textContent = cancelText;
      $('#modalExtra').innerHTML = extraHTML;
      const okBtn = $('#modalOkBtn');
      okBtn.className = confirmType==='danger'?'danger small':'small';
      wrap.classList.add('show');
      feather.replace();

      function cleanup(){
        wrap.classList.remove('show');
        okBtn.onclick = null;
        $('#modalCancelBtn').onclick = null;
        wrap.removeEventListener('click', outside);
      }
      function outside(e){
        if(e.target===wrap){ cleanup(); onCancel(); }
      }

      okBtn.onclick = ()=> { cleanup(); onConfirm(); };
      $('#modalCancelBtn').onclick = ()=> { cleanup(); onCancel(); };
      wrap.addEventListener('click', outside);
    }
  };

  /* i18n */
  function applyI18n(){
    const dict = i18n[state.lang] || i18n.id;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      if(dict[key]) el.textContent = dict[key];
    });
    document.documentElement.lang = state.lang;
    localStorage.setItem('lang', state.lang);
    const lbl = $('#toggleMyDataLabel');
    if(lbl) lbl.textContent = state.myDataOnly
      ? (state.lang==='en'?'My Data':'Data Saya')
      : (state.lang==='en'?'All Data':'Semua Data');
    const langLabel = $('#langLabel'); if(langLabel) langLabel.textContent = state.lang.toUpperCase();
    const liteLbl = $('#liteModeLabel');
    if(liteLbl){
      liteLbl.textContent = state.liteMode
        ? (state.lang==='en'?'Disable':'Nonaktifkan')
        : (state.lang==='en'?'Enable':'Aktifkan');
    }
  }

  function applyFontSize(size){
    let px = 15;
    if(size==='small') px = 14;
    else if(size==='large') px = 17;
    document.documentElement.style.setProperty('--font-base', px+'px');
    localStorage.setItem('fontSize', size);
    state.fontSize = size;
    const select = $('#fontSizeSelect');
    if(select) select.value = size;
  }

  function buildAccentPalette(){
    const palette = [
      '210 100% 50%','260 83% 60%','340 82% 52%','14 90% 57%',
      '122 39% 49%','190 90% 45%','45 100% 51%','0 84% 56%',
      '280 95% 55%','200 80% 55%','150 65% 45%','25 95% 55%'
    ];
    const wrap = $('#accentPalette');
    if(!wrap) return;
    wrap.innerHTML = palette.map(c=> `
      <div class="color-swatch ${c===state.accent?'active':''}" data-accent="${c}" style="background:hsl(${c});"></div>
    `).join('');
    $all('.color-swatch').forEach(sw=>{
      sw.addEventListener('click', ()=>{
        state.accent = sw.getAttribute('data-accent');
        document.documentElement.style.setProperty('--accent', state.accent);
        localStorage.setItem('accent', state.accent);
        buildAccentPalette();
        rebuildCharts();
        toast(state.lang==='en'?'Accent updated':'Aksen diperbarui','success',1800);
      });
    });
  }

  function renderHazardChips(){
    const wrap = $('#hazardChips');
    if(!wrap) return;
    wrap.innerHTML = state.hazardList.map(h=> `
      <div class="hazard-chip ${state.formHazards.includes(h)?'active':''}" data-hazard="${h}">
        <i data-feather="alert-triangle" width="10"></i>${h}
      </div>
    `).join('') +
    `<div style="flex-basis:100%;font-size:.48rem;color:hsl(var(--text-dim));margin-top:.25rem;">Klik untuk toggle indikasi</div>`;
    $all('.hazard-chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        const v = ch.getAttribute('data-hazard');
        if(state.formHazards.includes(v)){
          state.formHazards = state.formHazards.filter(x=> x!==v);
        } else state.formHazards.push(v);
        renderHazardChips();
      });
    });
    feather.replace();
  }

  function computeQualityStatus(score){
    if(score>=7) return { label:'Baik', cls:'status-good' };
    if(score>=4) return { label:'Sedang', cls:'status-warn' };
    return { label:'Buruk', cls:'status-bad' };
  }
  function computeSafetyStatus(record){
    return (record.hazards||[]).length
      ? { label:'Perhatian', safe:false }
      : { label:'Aman', safe:true };
  }

  function generateTableData(records){
    const header = ["Tanggal","Jenis Ikan","Pasar","Organoleptik","Bau","Tekstur","Warna","Keamanan","HazardList","Gambar","Status","User","UID","ID"];
    const body = records.map(r=>{
      const safety = computeSafetyStatus(r);
      return [
        formatDate(r.date || r.createdAt),
        r.fishType,
        r.market,
        r.organoleptic,
        r.smell,
        r.texture,
        r.color,
        safety.label,
        (r.hazards||[]).join('|'),
        r.image?'YA':'-',
        computeQualityStatus(r.organoleptic).label,
        r.userName,
        r.userId,
        r.id
      ];
    });
    return [header,...body];
  }

  /* ===================== FILTER & PAGINATION ===================== */
  function applyFilters(){
    const fish = $('#filterFish')?.value || '';
    const market = $('#filterMarket')?.value || '';
    const date = $('#filterDate')?.value || '';
    const text = ($('#filterText')?.value || '').toLowerCase();
    const globalText = ($('#globalSearch')?.value || '').toLowerCase();

    let data = state.fishData.filter(r=>{
      if(state.myDataOnly && r.userId !== state.currentUser?.uid) return false;
      if(fish && r.fishType !== fish) return false;
      if(market && r.market !== market) return false;
      if(date && isoDateOnly(r.date)!==date) return false;
      if(text && ![r.smell,r.texture,r.color,r.fishType,r.market,(r.hazardNotes||''),(r.hazards||[]).join(' ')].some(v=> (v||'').toLowerCase().includes(text))) return false;
      if(globalText && ![r.smell,r.texture,r.color,r.fishType,r.market,r.userName,(r.hazardNotes||''),(r.hazards||[]).join(' ')].some(v=> (v||'').toLowerCase().includes(globalText))) return false;
      return true;
    });

    state.filteredData = data;
    resetToFirstPage();
    renderTable();
    updateQualityList();
  }

  function getPagedData(){
    const { page, perPage } = state.table;
    const start = (page-1)*perPage;
    return state.filteredData.slice(start, start+perPage);
  }

  function resetToFirstPage(){
    state.table.page = 1;
  }

  function updatePaginationInfo(){
    const pageInfo = $('#pageInfo');
    if(!pageInfo) return;
    const total = state.filteredData.length;
    const perPage = state.table.perPage;
    const pages = Math.max(1, Math.ceil(total/perPage));
    if(state.table.page > pages) state.table.page = pages;
    pageInfo.textContent = `Hal ${pages?state.table.page:0}/${pages}`;
  }

  function updateSelectionInfo(){
    const el = $('#selectionInfo');
    if(!el) return;
    el.textContent = `${state.table.selected.size} dipilih`;
  }

  function toggleSelectAllCurrentPage(checked){
    const paged = getPagedData();
    paged.forEach(r=>{
      if(checked) state.table.selected.add(r.id);
      else state.table.selected.delete(r.id);
    });
    updateSelectionInfo();
    renderTable(); // re-render to update checkbox state
  }

  /* ===================== DYNAMIC OPTIONS ===================== */
  function populateDynamic(){
    const dFish = $('#fishTypeList');
    const dMarket = $('#marketList');
    const filterFish = $('#filterFish');
    const filterMarket = $('#filterMarket');
    const reportFish = $('#reportFish');
    const prefFish = $('#prefDefaultFish');
    const prefMarket = $('#prefDefaultMarket');

    if(dFish) dFish.innerHTML = state.fishTypes.map(f=> `<option value="${sanitize(f)}"></option>`).join('');
    if(dMarket) dMarket.innerHTML = state.markets.map(m=> `<option value="${sanitize(m)}"></option>`).join('');

    if(filterFish) filterFish.innerHTML = ['<option value="">Semua</option>', ...state.fishTypes.map(f=> `<option>${sanitize(f)}</option>`)].join('');
    if(filterMarket) filterMarket.innerHTML = ['<option value="">Semua</option>', ...state.markets.map(m=> `<option>${sanitize(m)}</option>`)].join('');
    if(reportFish) reportFish.innerHTML = ['<option value="">Semua</option>', ...state.fishTypes.map(f=> `<option>${sanitize(f)}</option>`)].join('');

    if(prefFish) prefFish.innerHTML = ['<option value="">(Kosong)</option>', ...state.fishTypes.map(f=> `<option ${state.userProfile?.defaultFishType===f?'selected':''}>${sanitize(f)}</option>`)].join('');
    if(prefMarket) prefMarket.innerHTML = ['<option value="">(Kosong)</option>', ...state.markets.map(m=> `<option ${state.userProfile?.defaultMarket===m?'selected':''}>${sanitize(m)}</option>`)].join('');

    if(!$('#recordId')?.value){
      if(state.userProfile?.defaultFishType && state.fishTypes.includes(state.userProfile.defaultFishType)){
        $('#fishTypeInput').value = state.userProfile.defaultFishType;
      }
      if(state.userProfile?.defaultMarket && state.markets.includes(state.userProfile.defaultMarket)){
        $('#marketInput').value = state.userProfile.defaultMarket;
      }
    }
  }

  /* ===================== DASHBOARD TRENDS ===================== */
  function startOfDay(d){
    const x = new Date(d);
    x.setHours(0,0,0,0);
    return x;
  }
  function getPeriod(range, records){
    const today = startOfDay(new Date());
    let current = [];
    let previous = [];
    const dayMs = 86400000;

    if(range === 'today'){
      const yesterday = new Date(today.getTime()-dayMs);
      current  = records.filter(r => startOfDay(r.date).getTime() === today.getTime());
      previous = records.filter(r => startOfDay(r.date).getTime() === yesterday.getTime());
    } else if(range === '7d'){
      const startCurrent = new Date(today.getTime() - 6*dayMs);
      const endCurrent   = today;
      const endPrev      = new Date(startCurrent.getTime() - dayMs);
      const startPrev    = new Date(endPrev.getTime() - 6*dayMs);
      current  = records.filter(r => {
        const d = startOfDay(r.date);
        return d >= startCurrent && d <= endCurrent;
      });
      previous = records.filter(r => {
        const d = startOfDay(r.date);
        return d >= startPrev && d <= endPrev;
      });
    } else if(range === '30d'){
      const startCurrent = new Date(today.getTime() - 29*dayMs);
      const endCurrent   = today;
      const endPrev      = new Date(startCurrent.getTime() - dayMs);
      const startPrev    = new Date(endPrev.getTime() - 29*dayMs);
      current  = records.filter(r => {
        const d = startOfDay(r.date);
        return d >= startCurrent && d <= endCurrent;
      });
      previous = records.filter(r => {
        const d = startOfDay(r.date);
        return d >= startPrev && d <= endPrev;
      });
    } else {
      if(records.length === 0){
        return { current:[], previous:[] };
      }
      const sorted = [...records].sort((a,b)=> a.date - b.date);
      const earliest = startOfDay(sorted[0].date);
      const latest   = startOfDay(sorted[sorted.length -1].date);
      current = records.slice();
      const spanDays = Math.max(1, Math.ceil((latest - earliest)/dayMs) + 1);
      const prevEnd   = new Date(earliest.getTime() - dayMs);
      const prevStart = new Date(prevEnd.getTime() - (spanDays-1)*dayMs);
      previous = records.filter(r => {
        const d = startOfDay(r.date);
        return d >= prevStart && d <= prevEnd;
      });
    }
    return { current, previous };
  }
  function calcTrend(curVal, prevVal){
    if(prevVal === 0 && curVal === 0) return { value:0, text:'0%' };
    if(prevVal === 0 && curVal > 0)   return { value:100, text:'+100%' };
    const diffPct = ((curVal - prevVal)/prevVal)*100;
    return {
      value: diffPct,
      text: (diffPct>0? '+' : '') + diffPct.toFixed(1) + '%'
    };
  }
  function formatTrend(tr){
    const v = tr.value;
    let arrow = '▬';
    if(v > 0.5) arrow = '▲';
    else if(v < -0.5) arrow = '▼';
    return `${arrow} ${tr.text}`;
  }
  function updateDashboard(){
    const base = state.myDataOnly
      ? state.fishData.filter(r=> r.userId === state.currentUser?.uid)
      : state.fishData.slice();

    const { current, previous } = getPeriod(state.dashRange, base);

    const totalCur = current.length;
    const totalPrev= previous.length;
    const avgCur = totalCur ? average(current.map(r=> r.organoleptic)) : 0;
    const avgPrev= totalPrev ? average(previous.map(r=> r.organoleptic)) : 0;
    const goodCur = current.filter(r=> r.organoleptic >= 7).length;
    const goodPrev= previous.filter(r=> r.organoleptic >= 7).length;
    const warnCur = current.filter(r=> r.organoleptic >= 4 && r.organoleptic < 7).length;
    const warnPrev= previous.filter(r=> r.organoleptic >= 4 && r.organoleptic < 7).length;
    const badCur  = current.filter(r=> r.organoleptic < 4).length;
    const badPrev = previous.filter(r=> r.organoleptic < 4).length;
    const hazCur  = current.filter(r=> (r.hazards||[]).length).length;
    const hazPrev = previous.filter(r=> (r.hazards||[]).length).length;

    setText('#indTotal', totalCur);
    setText('#indAvg', totalCur ? avgCur.toFixed(2) : '-');
    setText('#indGood', goodCur);
    setText('#indWarn', warnCur);
    setText('#indBad', badCur);
    setText('#indHazard', hazCur);

    setText('#indTotalTrend', formatTrend(calcTrend(totalCur,totalPrev)));
    setText('#indAvgTrend',   formatTrend(calcTrend(avgCur,avgPrev)));
    setText('#indGoodTrend',  formatTrend(calcTrend(goodCur,goodPrev)));
    setText('#indWarnTrend',  formatTrend(calcTrend(warnCur,warnPrev)));
    setText('#indBadTrend',   formatTrend(calcTrend(badCur,badPrev)));
    setText('#indHazardTrend',formatTrend(calcTrend(hazCur,hazPrev)));
  }

  function setText(sel,val){ const el=$(sel); if(el) el.textContent=val; }
  function setVal(sel,val){ const el=$(sel); if(el) el.value=val; }
  function setHTML(sel, html){ const el=$(sel); if(el) el.innerHTML=html; }

  function rebuildCharts(){
    clearTimeout(state.chartBuildTimer);
    state.chartBuildTimer = setTimeout(buildCharts, 250);
  }
  function filterByDashRange(records){
    const now = new Date();
    if(state.dashRange==='today') return records.filter(r=> isoDateOnly(r.date)===isoDateOnly(now));
    if(state.dashRange==='7d'){
      const c = new Date(); c.setDate(c.getDate()-7);
      return records.filter(r=> r.date>=c);
    }
    if(state.dashRange==='30d'){
      const c = new Date(); c.setDate(c.getDate()-30);
      return records.filter(r=> r.date>=c);
    }
    return records;
  }

  function buildCharts(){
    if(!$('#chartComparison')) return;
    const accent = state.accent;
    const base = state.myDataOnly
      ? state.fishData.filter(r=> r.userId===state.currentUser?.uid)
      : state.fishData.slice();
    const data = filterByDashRange(base);

    const markets = state.markets.length? state.markets: defaultMarkets;
    const marketAvg = markets.map(m=>{
      const subset = data.filter(r=> r.market===m);
      return subset.length? average(subset.map(r=> r.organoleptic)).toFixed(2):0;
    });
    if(!state.charts.comparison){
      state.charts.comparison = new Chart($('#chartComparison'),{
        type:'bar',
        data:{
          labels:markets,
          datasets:[{
            label:'Rata-rata Skor',
            data:marketAvg,
            backgroundColor: marketAvg.map(()=> `hsl(${accent}/0.65)`),
            borderRadius:8,
            borderSkipped:false
          }]
        },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,suggestedMax:9}} }
      });
    } else {
      state.charts.comparison.data.labels = markets;
      state.charts.comparison.data.datasets[0].data = marketAvg;
      state.charts.comparison.data.datasets[0].backgroundColor = marketAvg.map(()=> `hsl(${accent}/0.65)`);
      state.charts.comparison.update();
    }

    const byDate = {};
    data.forEach(r=>{
      const d = isoDateOnly(r.date);
      byDate[d] = byDate[d] || [];
      byDate[d].push(r.organoleptic);
    });
    const labels = Object.keys(byDate).sort((a,b)=> new Date(a)-new Date(b));
    const values = labels.map(d=> average(byDate[d]).toFixed(2));
    if(!state.charts.trend){
      state.charts.trend = new Chart($('#chartTrend'),{
        type:'line',
        data:{
          labels,
          datasets:[{
            label:'Skor',
            data:values,
            borderColor:`hsl(${accent}/0.95)`,
            backgroundColor:`hsl(${accent}/0.30)`,
            fill:true,
            tension:.35,
            pointRadius:4,
            pointBackgroundColor:`hsl(${accent}/0.95)`
          }]
        },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,suggestedMax:9}} }
      });
    } else {
      state.charts.trend.data.labels = labels;
      state.charts.trend.data.datasets[0].data = values;
      state.charts.trend.update();
    }

    const fishTypes = state.fishTypes.length? state.fishTypes: defaultFishTypes;
    const fishCounts = fishTypes.map(f=> data.filter(r=> r.fishType===f).length);
    if(!state.charts.pie){
      state.charts.pie = new Chart($('#chartPie'),{
        type:'pie',
        data:{
          labels:fishTypes,
          datasets:[{
            data:fishCounts,
            backgroundColor: fishTypes.map((_,i)=> `hsl(${accent}/${0.9 - i*0.08})`)
          }]
        },
        options:{ responsive:true, maintainAspectRatio:false }
      });
    } else {
      state.charts.pie.data.labels = fishTypes;
      state.charts.pie.data.datasets[0].data = fishCounts;
      state.charts.pie.data.datasets[0].backgroundColor = fishTypes.map((_,i)=> `hsl(${accent}/${0.9 - i*0.08})`);
      state.charts.pie.update();
    }
  }

  /* ===================== QUALITY LIST ===================== */
  function updateQualityList(){
    const container = $('#qualityIndicatorList');
    if(!container) return;
    const subset = state.filteredData
      .filter(r=>{
        if(state.qualityFilter==='all') return true;
        const st = computeQualityStatus(r.organoleptic).label;
        if(state.qualityFilter==='baik') return st==='Baik';
        if(state.qualityFilter==='sedang') return st==='Sedang';
        if(state.qualityFilter==='buruk') return st==='Buruk';
        return true;
      })
      .slice(0,100);

    container.innerHTML = subset.map(r=>{
      const st = computeQualityStatus(r.organoleptic);
      const safety = computeSafetyStatus(r);
      return `
        <div class="quality-item" data-q-detail="${r.id}" title="Klik untuk detail">
          <div class="status-dot ${st.cls}"></div>
          <div>
            <div style="font-weight:700;letter-spacing:.4px;">${sanitize(r.fishType)}</div>
            <div style="font-size:.5rem;opacity:.75;">${sanitize(r.market)} • ${formatDate(r.date)} • Org ${r.organoleptic}</div>
            <div style="margin-top:.25rem;">${sanitize(r.smell)}, ${sanitize(r.texture)}, ${sanitize(r.color)}</div>
            <div class="quality-meta">
              <span class="quality-hazard-flag ${safety.safe?'safe':''}">
                <i data-feather="${safety.safe?'shield':'alert-triangle'}" width="10"></i>${safety.safe?'Aman':'Indikasi'}
              </span>
              ${r.image? `<span class="tag-badge"><i data-feather="image" width="10"></i>Img</span>`:''}
              <span class="tag-badge" style="background:hsl(var(--accent)/0.35)">${st.label}</span>
            </div>
            <div class="quality-score">${r.organoleptic}</div>
          </div>
        </div>
      `;
    }).join('') || '<div class="small muted">Tidak ada data.</div>';

    feather.replace();
    $all('[data-q-detail]').forEach(el=>{
      el.onclick = ()=> openRecordDetail(el.getAttribute('data-q-detail'));
    });
  }

  /* ===================== DETAIL DATA MODAL ===================== */
  function openRecordDetail(id){
    const rec = state.fishData.find(r=> r.id===id);
    if(!rec) return toast('Data tidak ditemukan','warn');
    const modal = $('#recordDetailModal');
    const grid = $('#detailGrid');
    const badges = $('#detailStatusBadges');
    const imgWrap = $('#detailImageWrapper');
    const hazWrap = $('#detailHazardsWrapper');

    const q = computeQualityStatus(rec.organoleptic);
    const s = computeSafetyStatus(rec);

    badges.innerHTML = `
      <span class="badge-soft"><i data-feather="calendar" width="11"></i>${formatDate(rec.date)}</span>
      <span class="badge-soft"><i data-feather="trending-up" width="11"></i>${rec.organoleptic}</span>
      <span class="badge-soft"><i data-feather="${s.safe?'shield':'alert-triangle'}" width="11"></i>${s.safe?'Aman':'Indikasi'}</span>
      <span class="badge-soft"><i data-feather="activity" width="11"></i>${q.label}</span>
    `;

    grid.innerHTML = `
      <div>
        <span class="detail-label">Jenis Ikan</span>
        <span>${sanitize(rec.fishType)}</span>
      </div>
      <div>
        <span class="detail-label">Pasar</span>
        <span>${sanitize(rec.market)}</span>
      </div>
      <div>
        <span class="detail-label">Organoleptik</span>
        <span>${rec.organoleptic}</span>
      </div>
      <div>
        <span class="detail-label">Bau</span>
        <span>${sanitize(rec.smell)}</span>
      </div>
      <div>
        <span class="detail-label">Tekstur</span>
        <span>${sanitize(rec.texture)}</span>
      </div>
      <div>
        <span class="detail-label">Warna</span>
        <span>${sanitize(rec.color)}</span>
      </div>
      <div>
        <span class="detail-label">User</span>
        <span>${sanitize(rec.userName)}</span>
      </div>
      <div>
        <span class="detail-label">User ID</span>
        <span style="font-size:.48rem;word-break:break-all;">${rec.userId}</span>
      </div>
      <div>
        <span class="detail-label">Catatan Bahaya</span>
        <span>${sanitize(rec.hazardNotes||'-')}</span>
      </div>
      <div>
        <span class="detail-label">Updated</span>
        <span>${rec.updatedAt? formatDateTime(rec.updatedAt):'-'}</span>
      </div>
    `;

    if(rec.image){
      imgWrap.innerHTML = `
        <div style="margin-top:.35rem;">
          <span class="detail-label">Gambar</span>
          <img src="${rec.image}" alt="img" class="detail-image">
        </div>
      `;
    } else imgWrap.innerHTML='';

    if((rec.hazards||[]).length){
      hazWrap.innerHTML = `
        <div style="display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.35rem;">
          ${(rec.hazards||[]).map(h=> `<span class="tag-badge"><i data-feather="alert-triangle" width="10"></i>${sanitize(h)}</span>`).join('')}
        </div>
      `;
    } else hazWrap.innerHTML='';

    modal.classList.add('show');
    feather.replace();
  }
  $('#closeRecordDetail')?.addEventListener('click', ()=> $('#recordDetailModal')?.classList.remove('show'));
  $('#recordDetailModal')?.addEventListener('click', e=>{
    if(e.target.id==='recordDetailModal') e.currentTarget.classList.remove('show');
  });

  /* ===================== TABLE RENDER ===================== */
  function renderTable(){
    const tbody = $('#dataTableBody');
    if(!tbody) return;
    tbody.innerHTML='';
    const role = state.userProfile?.role || 'Mahasiswa';

    if(!state.filteredData.length){
      $('#dataEmptyState')?.classList.remove('hidden');
    } else $('#dataEmptyState')?.classList.add('hidden');

    updatePaginationInfo();

    const pageData = getPagedData();

    const allOnPageSelected = pageData.every(r=> state.table.selected.has(r.id)) && pageData.length>0;
    const selectAllPageCb = $('#selectAllPage');
    if(selectAllPageCb) selectAllPageCb.checked = allOnPageSelected;

    pageData.forEach((r,i)=>{
      const st = computeQualityStatus(r.organoleptic);
      const safety = computeSafetyStatus(r);
      const canEdit = (r.userId===state.currentUser?.uid) || ['Admin','Petugas Pasar'].includes(role);
      const canDelete = role==='Admin' || (role==='Petugas Pasar' && r.userId===state.currentUser?.uid);
      const hazardBadge = safety.safe
        ? `<span class="hazard-badge safe"><i data-feather="shield" width="10"></i>Aman</span>`
        : `<span class="hazard-badge"><i data-feather="alert-triangle" width="10"></i>Perhatian</span>`;
      const tr = document.createElement('tr');
      const globalIndex = (state.table.page-1)*state.table.perPage + i + 1;
      tr.innerHTML = `
        <td>
          <input type="checkbox" data-row-select="${r.id}" ${state.table.selected.has(r.id)?'checked':''} />
        </td>
        <td>${globalIndex}</td>
        <td>${formatDate(r.date)}</td>
        <td>${sanitize(r.fishType)}</td>
        <td>${sanitize(r.market)}</td>
        <td>${r.organoleptic}</td>
        <td>${sanitize(r.smell)}</td>
        <td>${sanitize(r.texture)}</td>
        <td>${sanitize(r.color)}</td>
        <td style="min-width:120px;">
          ${hazardBadge}
          ${(r.hazards||[]).length? `<div style="margin-top:.25rem;font-size:.45rem;">${r.hazards.map(h=> `<span style="display:inline-block;background:hsl(var(--accent)/0.2);padding:.15rem .4rem;border-radius:8px;margin:1px 2px;">${sanitize(h)}</span>`).join('')}</div>`:''}
        </td>
        <td>${r.image? `<button class="outline small" data-view-img="${r.id}" title="Lihat Gambar"><i data-feather="image" width="11"></i></button>`:'-'}</td>
        <td>
          <div class="inline">
            <div class="status-dot ${st.cls}"></div>
            <span style="font-size:.5rem;font-weight:700;">${st.label}</span>
          </div>
        </td>
        <td style="font-size:.5rem;cursor:pointer;" data-open-user="${r.userId}" title="Lihat Profil">
          ${sanitize(r.userName)}<br><span class="muted">${r.userId.substring(0,6)}...</span>
        </td>
        <td>
          <div class="actions">
            <button class="outline small" data-detail="${r.id}" title="Detail">
              <i data-feather="eye" width="11"></i>
            </button>
            ${canEdit? `<button class="outline small" data-edit="${r.id}" title="Edit"><i data-feather="edit-2" width="11"></i></button>`:''}
            ${canDelete? `<button class="outline danger small" data-del="${r.id}" title="Hapus"><i data-feather="trash" width="11"></i></button>`:''}
          </div>
        </td>
      `;
      if(r.id===state.lastAddedId){
        tr.classList.add('flash-new');
        setTimeout(()=> tr.classList.remove('flash-new'),2500);
      }
      tbody.appendChild(tr);
    });

    feather.replace();

    $all('[data-edit]').forEach(btn=> btn.onclick = ()=> enterEdit(btn.getAttribute('data-edit')));
    $all('[data-del]').forEach(btn=> btn.onclick = ()=> confirmDelete(btn.getAttribute('data-del')));
    $all('[data-view-img]').forEach(btn=> btn.onclick = ()=> viewImage(btn.getAttribute('data-view-img')));
    $all('[data-detail]').forEach(btn=> btn.onclick = ()=> openRecordDetail(btn.getAttribute('data-detail')));
    $all('[data-row-select]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const id = cb.getAttribute('data-row-select');
        if(cb.checked) state.table.selected.add(id);
        else state.table.selected.delete(id);
        updateSelectionInfo();
      });
    });
    $all('[data-open-user]').forEach(cell=>{
      cell.addEventListener('click', ()=>{
        openOtherUserProfile(cell.getAttribute('data-open-user'));
      });
    });

    updateSelectionInfo();
  }

  function enterEdit(id){
    const rec = state.fishData.find(r=> r.id===id);
    if(!rec) return;
    setVal('#recordId', rec.id);
    setVal('#fishTypeInput', rec.fishType);
    setVal('#marketInput', rec.market);
    setVal('#organoleptic', rec.organoleptic);
    setVal('#smell', rec.smell);
    setVal('#texture', rec.texture);
    setVal('#colorField', rec.color);
    setVal('#hazardNotes', rec.hazardNotes || '');
    state.formHazards = [...(rec.hazards||[])];
    renderHazardChips();
    if(rec.image){
      state.formImageData = rec.image;
      $('#fishImagePreview').innerHTML = `<img src="${rec.image}" alt="fish">`;
    } else {
      state.formImageData = null;
      $('#fishImagePreview').innerHTML='';
    }
    $('#submitDataBtn span').textContent = state.lang==='en'?'Update Data':'Update Data';
    $('#cancelEditBtn').style.display='inline-flex';
    showView('form');
    toast(state.lang==='en'?'Edit mode':'Mode edit data','info',2200);
  }

  function confirmDelete(id){
    Modal.open({
      title:'Hapus Data',
      message:'Yakin menghapus data ini?',
      icon:'trash-2',
      confirmText:'Hapus',
      onConfirm: async ()=>{
        try{
          await db.collection('fishQuality').doc(id).delete();
          toast('Data dihapus','success');
          state.table.selected.delete(id);
          updateSelectionInfo();
        }catch(err){
          toast('Gagal hapus','danger');
        }
      }
    });
  }

  function viewImage(id){
    const rec = state.fishData.find(r=> r.id===id);
    if(!rec || !rec.image) return toast('Gambar tidak ada','warn');
    let modalImg = $('#imgModal');
    if(!modalImg){
      modalImg = document.createElement('div');
      modalImg.id='imgModal';
      modalImg.style.cssText='position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);z-index:5000;padding:1rem;';
      modalImg.innerHTML = `
        <div style="background:#fff;max-width:92%;max-height:90%;border-radius:20px;position:relative;padding:1rem 1.2rem 1.2rem;display:flex;flex-direction:column;gap:.6rem;">
          <button id="closeImgModal" class="outline small" style="position:absolute;top:.5rem;right:.5rem;"><i data-feather="x" width="14"></i></button>
          <div style="font-size:.6rem;font-weight:700;letter-spacing:.5px;">Gambar</div>
            <img id="imgModalPic" src="${rec.image}" style="max-width:100%;max-height:70vh;border-radius:10px;object-fit:contain;">
          <div id="imgModalCaption" style="font-size:.55rem;opacity:.7;">${sanitize(rec.fishType)} - ${sanitize(rec.market)}</div>
        </div>
      `;
      document.body.appendChild(modalImg);
      feather.replace();
      modalImg.addEventListener('click', e=> { if(e.target===modalImg) modalImg.remove(); });
      $('#closeImgModal').onclick = ()=> modalImg.remove();
    } else {
      $('#imgModalPic').src = rec.image;
      $('#imgModalCaption').textContent = `${rec.fishType} - ${rec.market}`;
      modalImg.style.display='flex';
    }
  }

  function resetForm(){
    setVal('#recordId','');
    setVal('#fishTypeInput', state.userProfile?.defaultFishType || '');
    setVal('#marketInput', state.userProfile?.defaultMarket || '');
    ['#organoleptic','#smell','#texture','#colorField','#hazardNotes'].forEach(sel=> setVal(sel,''));
    state.formImageData = null;
    state.formHazards = [];
    renderHazardChips();
    const img = $('#fishImage'); if(img) img.value='';
    const prev = $('#fishImagePreview'); if(prev) prev.innerHTML='';
    $('#submitDataBtn span').textContent = state.lang==='en'?'Save Data':'Simpan Data';
    $('#cancelEditBtn').style.display='none';
    setVal('#dateAuto', nowDateInput());
  }

  /* ===================== FIRESTORE: USER PROFILE ===================== */
  async function loadUserProfile(uid){
    const doc = await db.collection('users').doc(uid).get();
    if(doc.exists){
      state.userProfile = { id:doc.id, ...doc.data() };
    } else {
      state.userProfile = {
        id: uid,
        name: state.currentUser.displayName || 'Pengguna',
        email: state.currentUser.email,
        role:'Mahasiswa',
        studentId:'', lecturerId:'', officerId:'',
        defaultFishType:'', defaultMarket:'',
        photo:'',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        emailVerified: state.currentUser.emailVerified,
        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection('users').doc(uid).set(state.userProfile);
    }
  }

  function subscribeMetadata(){
    state.metadataUnsub.fish = db.collection('metaFishTypes').orderBy('name','asc')
      .onSnapshot(snap=>{
        const names = new Set(defaultFishTypes);
        snap.docs.forEach(d=> names.add(d.data().name));
        state.fishTypes = Array.from(names).sort();
        populateDynamic();
      });
    state.metadataUnsub.markets = db.collection('metaMarkets').orderBy('name','asc')
      .onSnapshot(snap=>{
        const names = new Set(defaultMarkets);
        snap.docs.forEach(d=> names.add(d.data().name));
        state.markets = Array.from(names).sort();
        populateDynamic();
      });
  }

  function subscribeData(){
    if(state.metadataUnsub.data) state.metadataUnsub.data();
    state.metadataUnsub.data = db.collection('fishQuality')
      .orderBy('createdAt','desc')
      .onSnapshot(snap=>{
        const oldIds = new Set(state.fishData.map(r=> r.id));
        state.fishData = snap.docs.map(d=>{
          const data = d.data();
            return {
              id: d.id,
              ...data,
              hazards: data.hazards || [],
              hazardNotes: data.hazardNotes || '',
              date: data.date
                ? (data.date.toDate ? data.date.toDate(): data.date)
                : (data.createdAt? (data.createdAt.toDate? data.createdAt.toDate(): data.createdAt): new Date()),
              updatedAt: data.updatedAt? (data.updatedAt.toDate? data.updatedAt.toDate(): data.updatedAt): null
            };
        });
        snap.docChanges().forEach(ch=>{
          if(ch.type==='added' && !oldIds.has(ch.doc.id)){
            state.lastAddedId = ch.doc.id;
          }
        });
        applyFilters();
        updateDashboard();
        rebuildCharts();
      });
  }

  /* ===================== SOSIAL: POSTS, REACTIONS, COMMENTS ===================== */
  function subscribeSocial(){
    if(state.metadataUnsub.social) state.metadataUnsub.social();
    state.metadataUnsub.social = db.collection('socialPosts')
      .orderBy('createdAt','desc')
      .limit(200)
      .onSnapshot(snap=>{
        state.social.posts = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
        renderSocialFeed();
      });
  }

  async function loadSocialUsers(){
    const snap = await db.collection('users').orderBy('name').get();
    state.social.usersCache = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
    renderSocialUsers();
  }

  function renderSocialUsers(){
    const wrap = $('#socialUsersList');
    if(!wrap) return;
    wrap.innerHTML = state.social.usersCache.map(u=> `
      <div class="social-user-item" data-view-user="${u.id}" title="Klik untuk lihat profil">
        <div class="avatar-mini">
          ${u.photo? `<img src="${u.photo}" alt="">` : sanitize((u.name||'U').substring(0,1).toUpperCase())}
        </div>
        <div style="flex:1;">
          <div style="font-weight:700;">${sanitize(u.name||'')}</div>
          <div style="font-size:.46rem;opacity:.8;">${sanitize(u.email||'')}</div>
          <div style="margin-top:.25rem;">
            <span class="social-post-role">${sanitize(u.role||'')}</span>
          </div>
        </div>
      </div>
    `).join('') || '<div class="small muted">Tidak ada pengguna.</div>';
    feather.replace();
    $all('[data-view-user]').forEach(el=>{
      el.addEventListener('click', ()=> openOtherUserProfile(el.getAttribute('data-view-user')));
    });
  }

  function renderSocialFeed(){
    const feed = $('#socialFeed');
    const empty = $('#socialEmpty');
    if(!feed) return;
    if(!state.social.posts.length){
      empty?.classList.remove('hidden');
      feed.innerHTML='';
      return;
    }
    empty?.classList.add('hidden');

    feed.innerHTML = state.social.posts.map(p=>{
      const likes = (p.likes||[]).length;
      const dislikes = (p.dislikes||[]).length;
      const userLiked = state.currentUser && (p.likes||[]).includes(state.currentUser.uid);
      const userDisliked = state.currentUser && (p.dislikes||[]).includes(state.currentUser.uid);
      const commentsOpen = state.social.openComments.has(p.id);
      const commentCount = p.commentCount || 0;
      return `
        <div class="social-post" data-post-id="${p.id}">
          <div class="social-post-header">
            <div style="display:flex;align-items:center;gap:.45rem;cursor:pointer;" data-view-user="${p.userId}">
              <div style="width:34px;height:34px;border-radius:12px;overflow:hidden;background:linear-gradient(135deg,hsl(var(--accent)/0.3),hsl(var(--accent)/0.5));display:grid;place-items:center;font-size:.65rem;color:#fff;font-weight:700;">
                ${p.userPhoto? `<img src="${p.userPhoto}" style="width:100%;height:100%;object-fit:cover;">` : sanitize((p.userName||'U').substring(0,1).toUpperCase())}
              </div>
              <div>
                <div style="font-size:.58rem;font-weight:700;">${sanitize(p.userName||'')}</div>
                <div style="font-size:.45rem;opacity:.75;">${sanitize(p.userRole||'')}</div>
              </div>
            </div>
            <div class="social-post-time">${p.createdAt? formatDateTime(p.createdAt): ''}</div>
          </div>
          <div class="social-post-content">${sanitize(p.content||'')}</div>
          ${p.image? `<img class="social-post-image" src="${p.image}" alt="post-img">`:''}
          <div class="social-post-reactions">
            <button class="reaction-btn ${userLiked?'active':''}" data-like="${p.id}">
              👍 <span>${likes}</span>
            </button>
            <button class="reaction-btn ${userDisliked?'active':''}" data-dislike="${p.id}">
              👎 <span>${dislikes}</span>
            </button>
            <button class="reaction-btn" data-toggle-comments="${p.id}">
              💬 <span>${commentCount}</span>
            </button>
            <button class="reaction-btn" data-open-detail-post="${p.refRecordId||''}" ${p.refRecordId?'':'disabled'} style="${p.refRecordId?'':'opacity:.4;cursor:not-allowed;'}">
              <i data-feather="file-text" width="11"></i>
            </button>
            ${(state.currentUser && (p.userId===state.currentUser.uid || state.userProfile?.role==='Admin')) ?
              `<button class="reaction-btn" data-del-post="${p.id}" style="background:linear-gradient(135deg,#ef4444,#b91c1c);color:#fff;">
                 <i data-feather="trash" width="11"></i>
               </button>` : ''
            }
          </div>
          <div id="comments_${p.id}" class="${commentsOpen?'':'hidden'}"></div>
        </div>
      `;
    }).join('');
    feather.replace();

    // Bind profile view
    $all('[data-view-user]').forEach(el=>{
      el.addEventListener('click', e=>{
        e.stopPropagation();
        openOtherUserProfile(el.getAttribute('data-view-user'));
      });
    });

    // Delete post
    $all('[data-del-post]').forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute('data-del-post');
        Modal.open({
          title:'Hapus Post',
          message:'Yakin hapus posting ini?',
          icon:'trash',
          confirmText:'Hapus',
          onConfirm: async ()=>{
            try{
              await db.collection('socialPosts').doc(id).delete();
              toast('Post dihapus','success');
            }catch{
              toast('Gagal hapus','danger');
            }
          }
        });
      };
    });
    // Open record detail link
    $all('[data-open-detail-post]').forEach(b=>{
      b.onclick = ()=>{
        const rid = b.getAttribute('data-open-detail-post');
        if(rid) openRecordDetail(rid);
      };
    });
    // Like / dislike
    $all('[data-like]').forEach(btn=>{
      btn.onclick = ()=> toggleReaction(btn.getAttribute('data-like'),'like');
    });
    $all('[data-dislike]').forEach(btn=>{
      btn.onclick = ()=> toggleReaction(btn.getAttribute('data-dislike'),'dislike');
    });
    // Comments toggle
    $all('[data-toggle-comments]').forEach(btn=>{
      btn.onclick = ()=> toggleCommentsBox(btn.getAttribute('data-toggle-comments'));
    });

    // Render already open comments
    state.social.openComments.forEach(id=> renderCommentsBox(id));
  }

  async function toggleReaction(postId, type){
    if(!state.currentUser) return toast('Harus login','warn');
    const ref = db.collection('socialPosts').doc(postId);
    try{
      await db.runTransaction(async tx=>{
        const snap = await tx.get(ref);
        if(!snap.exists) return;
        const data = snap.data();
        const uid = state.currentUser.uid;
        let likes = data.likes||[];
        let dislikes = data.dislikes||[];
        if(type==='like'){
          if(likes.includes(uid)){
            likes = likes.filter(x=> x!==uid);
          } else {
            likes.push(uid);
            dislikes = dislikes.filter(x=> x!==uid);
          }
        } else {
          if(dislikes.includes(uid)){
            dislikes = dislikes.filter(x=> x!==uid);
          } else {
            dislikes.push(uid);
            likes = likes.filter(x=> x!==uid);
          }
        }
        tx.update(ref,{ likes, dislikes });
      });
    }catch(err){
      toast('Gagal reaksi','danger');
    }
  }

  function toggleCommentsBox(postId){
    if(state.social.openComments.has(postId)){
      state.social.openComments.delete(postId);
      unsubscribeComments(postId);
      renderSocialFeed(); // re-render hides box
    } else {
      state.social.openComments.add(postId);
      renderSocialFeed(); // will show container
      subscribeComments(postId);
    }
  }

  function subscribeComments(postId){
    unsubscribeComments(postId);
    const ref = db.collection('socialPosts').doc(postId).collection('comments').orderBy('createdAt','asc');
    const unsub = ref.onSnapshot(snap=>{
      const comments = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
      renderComments(postId, comments);
      // update commentCount in post doc
      db.collection('socialPosts').doc(postId).update({ commentCount: comments.length }).catch(()=>{});
    });
    state.social.commentUnsubs[postId] = unsub;
  }

  function unsubscribeComments(postId){
    if(state.social.commentUnsubs[postId]){
      state.social.commentUnsubs[postId]();
      delete state.social.commentUnsubs[postId];
    }
  }

  function renderCommentsBox(postId){
    // Called after re-render feed
    subscribeComments(postId);
  }

  function renderComments(postId, comments){
    const box = $('#comments_'+postId);
    if(!box) return;
    const canComment = !!state.currentUser;
    box.classList.remove('hidden');
    box.innerHTML = `
      <div class="comments-box">
        <div style="font-size:.52rem;font-weight:700;letter-spacing:.4px;display:flex;align-items:center;gap:.4rem;">
          <i data-feather="message-square" width="11"></i> Komentar
        </div>
        <div id="commentList_${postId}" style="display:flex;flex-direction:column;gap:.45rem;">
          ${
            comments.map(c=> {
              const own = state.currentUser && c.userId===state.currentUser.uid;
              const canDel = own || state.userProfile?.role==='Admin';
              return `
                <div class="comment-item">
                  <div style="width:28px;height:28px;border-radius:9px;overflow:hidden;background:linear-gradient(135deg,hsl(var(--accent)/0.3),hsl(var(--accent)/0.5));display:grid;place-items:center;font-size:.55rem;color:#fff;font-weight:700;">
                    ${c.userPhoto? `<img src="${c.userPhoto}" style="width:100%;height:100%;object-fit:cover;">` : sanitize((c.userName||'U').substring(0,1).toUpperCase())}
                  </div>
                  <div style="flex:1;">
                    <div style="font-weight:700;font-size:.52rem;">${sanitize(c.userName||'')}</div>
                    <div style="font-size:.55rem;line-height:1.35;margin-top:.15rem;white-space:pre-wrap;">${sanitize(c.content||'')}</div>
                    <div class="comment-meta">
                      <span>${c.createdAt? formatDateTime(c.createdAt):''}</span>
                    </div>
                  </div>
                  ${canDel? `<button class="del-comment-btn" data-del-comment="${postId}|${c.id}" title="Hapus"><i data-feather="x" width="10"></i></button>`:''}
                </div>
              `;
            }).join('')
          }
          ${comments.length===0? `<div class="small muted" style="text-align:center;">Belum ada komentar.</div>`:''}
        </div>
        ${canComment? `
          <form class="comment-form" data-comment-form="${postId}">
            <textarea placeholder="Tulis komentar..." maxlength="400" required></textarea>
            <button class="outline small" type="submit" style="align-self:flex-end;">
              <i data-feather="send" width="11"></i>
            </button>
          </form>
        `: `<div class="small muted">Login untuk berkomentar.</div>`}
      </div>
    `;
    feather.replace();

    // Bind delete comment
    $all('[data-del-comment]').forEach(btn=>{
      btn.onclick = ()=>{
        const [pid,cid] = btn.getAttribute('data-del-comment').split('|');
        Modal.open({
          title:'Hapus Komentar',
          message:'Yakin menghapus komentar?',
          icon:'trash',
          confirmText:'Hapus',
          onConfirm: async ()=>{
            try{
              await db.collection('socialPosts').doc(pid).collection('comments').doc(cid).delete();
              toast('Komentar dihapus','success');
            }catch{
              toast('Gagal hapus komentar','danger');
            }
          }
        });
      };
    });

    // Bind add comment
    const form = box.querySelector(`[data-comment-form="${postId}"]`);
    if(form){
      form.onsubmit = async e=>{
        e.preventDefault();
        if(!state.currentUser) return toast('Login dulu','warn');
        const ta = form.querySelector('textarea');
        const content = ta.value.trim();
        if(!content) return;
        try{
          await db.collection('socialPosts').doc(postId).collection('comments').add({
            content,
            userId: state.userProfile.id,
            userName: state.userProfile.name,
            userPhoto: state.userProfile.photo || '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          ta.value='';
          toast('Komentar ditambahkan','success');
        }catch{
          toast('Gagal komentar','danger');
        }
      };
    }
  }

  function bindSocialForm(){
    $('#socialPostImage')?.addEventListener('change', async e=>{
      const file = e.target.files[0];
      if(!file){ state.social.imageData=null; $('#socialImagePreview').textContent=''; return; }
      try{
        state.social.imageData = await compressImage(file,900);
        $('#socialImagePreview').innerHTML = `<span style="color:var(--ok);font-weight:600;">Gambar siap (${Math.round(state.social.imageData.length/1024)} KB)</span>
          <button type="button" class="btn-mini-inline" id="btnRemoveSocialImg"><i data-feather="x" width="10"></i>Hapus</button>`;
        $('#btnRemoveSocialImg').onclick = ()=>{
          state.social.imageData=null;
          $('#socialPostImage').value='';
          $('#socialImagePreview').innerHTML='';
        };
        feather.replace();
      }catch{
        toast('Gagal proses gambar','danger');
      }
    });
    $('#btnClearPost')?.addEventListener('click', ()=>{
      $('#socialPostContent').value='';
      $('#socialPostImage').value='';
      state.social.imageData=null;
      $('#socialImagePreview').innerHTML='';
    });
    $('#btnSubmitPost')?.addEventListener('click', async ()=>{
      const content = $('#socialPostContent')?.value.trim();
      if(!content) return showAlert('socialPostAlert','warn','Konten kosong');
      if(!state.currentUser) return toast('Harus login','warn');
      try{
        await db.collection('socialPosts').add({
          content,
          image: state.social.imageData || '',
          userId: state.userProfile.id,
          userName: state.userProfile.name,
          userRole: state.userProfile.role,
          userPhoto: state.userProfile.photo || '',
          refRecordId: '',
          likes:[],
          dislikes:[],
          commentCount:0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        $('#socialPostContent').value='';
        state.social.imageData=null;
        $('#socialPostImage').value='';
        $('#socialImagePreview').innerHTML='';
        toast('Post dikirim','success');
      }catch(err){
        showAlert('socialPostAlert','danger','Gagal: '+err.message);
        toast('Gagal kirim','danger');
      }
    });
  }

  /* ===================== OTHER USER PROFILE MODAL ===================== */
  async function openOtherUserProfile(uid){
    if(!uid) return;
    try{
      const doc = await db.collection('users').doc(uid).get();
      if(!doc.exists) return toast('User tidak ditemukan','warn');
      const u = doc.data();
      const modal = $('#userProfileModal');
      const c = $('#userProfileContent');
      c.innerHTML = `
        <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
          <div class="avatar" style="width:86px;height:86px;border-radius:24px;font-size:1.6rem;">
            ${u.photo? `<img src="${u.photo}" alt="pfp" style="object-fit:cover;width:100%;height:100%;">`: sanitize((u.name||'U').substring(0,1).toUpperCase())}
          </div>
          <div style="flex:1;min-width:150px;">
            <div style="font-size:.85rem;font-weight:700;letter-spacing:.5px;">${sanitize(u.name||'')}</div>
            <div style="font-size:.55rem;opacity:.8;margin-top:.2rem;">${sanitize(u.email||'')}</div>
            <div style="margin-top:.4rem;">
              <span class="badge-role" style="background:hsl(var(--accent)/0.45)">${sanitize(u.role||'')}</span>
            </div>
          </div>
        </div>
        <div style="font-size:.55rem;display:flex;flex-direction:column;gap:.35rem;margin-top:.4rem;">
          <div><strong>Created:</strong> ${u.createdAt? formatDateTime(u.createdAt):'-'}</div>
          <div><strong>Last Login:</strong> ${u.lastLogin? formatDateTime(u.lastLogin):'-'}</div>
          ${u.studentId? `<div><strong>NIM:</strong> ${sanitize(u.studentId)}</div>`:''}
          ${u.lecturerId? `<div><strong>NIP:</strong> ${sanitize(u.lecturerId)}</div>`:''}
          ${u.officerId? `<div><strong>ID Petugas:</strong> ${sanitize(u.officerId)}</div>`:''}
          <div><strong>Email Verified:</strong> ${u.emailVerified?'Ya':'Belum'}</div>
        </div>
      `;
      modal.classList.add('show');
      feather.replace();
    }catch{
      toast('Gagal memuat profil','danger');
    }
  }
  $('#closeUserProfileModal')?.addEventListener('click', ()=> $('#userProfileModal')?.classList.remove('show'));
  $('#userProfileModal')?.addEventListener('click', e=>{
    if(e.target.id==='userProfileModal') e.currentTarget.classList.remove('show');
  });

  /* ===================== ADDING NEW FISH/MARKET META ===================== */
  async function addNewFishType(name){
    name = (name||'').trim();
    if(!name || state.fishTypes.includes(name)) return;
    try {
      await db.collection('metaFishTypes').add({
        name,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: state.currentUser.uid
      });
      toast('Jenis ikan ditambahkan','success');
    } catch { toast('Gagal tambah ikan','danger'); }
  }
  async function addNewMarket(name){
    name = (name||'').trim();
    if(!name || state.markets.includes(name)) return;
    try {
      await db.collection('metaMarkets').add({
        name,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: state.currentUser.uid
      });
      toast('Pasar ditambahkan','success');
    } catch { toast('Gagal tambah pasar','danger'); }
  }

  function refreshUserUI(){
    const u = state.userProfile || {};
    if($('#avatarInitial')) $('#avatarInitial').textContent = (u.name||'U').substring(0,1).toUpperCase();
    if(u.photo){
      $('#avatarImg')?.classList.remove('hidden');
      $('#avatarImg').src = u.photo;
      $('#avatarInitial')?.classList.add('hidden');
    } else {
      $('#avatarImg')?.classList.add('hidden');
      $('#avatarInitial')?.classList.remove('hidden');
    }
    const sideInfo = $('#sidebarUserInfo');
    if(sideInfo){
      sideInfo.innerHTML = `
        <div style="font-weight:700;">${sanitize(u.name||'')}</div>
        <div style="font-size:.48rem;letter-spacing:.5px;">${sanitize(u.email||'')}</div>
        <div class="badge-role" style="margin-top:.3rem;">${sanitize(u.role||'')}</div>
        <div style="margin-top:.3rem;font-size:.48rem;">Verif: ${u.emailVerified?'Ya':'Belum'}</div>
      `;
    }
    const setInfo = $('#settingsUserInfo');
    if(setInfo){
      setInfo.innerHTML = `
        <strong>${sanitize(u.name||'')}</strong><br>
        ${sanitize(u.email||'')}<br>
        Role: <span class="inline-stat">${sanitize(u.role||'')}</span><br>
        Email Verified: <span class="inline-stat">${u.emailVerified?'YES':'NO'}</span><br>
        ${u.studentId? 'NIM: '+sanitize(u.studentId)+'<br>':''}
        ${u.lecturerId? 'NIP: '+sanitize(u.lecturerId)+'<br>':''}
        ${u.officerId? 'ID: '+sanitize(u.officerId)+'<br>':''}
      `;
    }
    setVal('#profName', u.name||'');
    setVal('#profEmail', u.email||'');
    setVal('#profRole', u.role||'Mahasiswa');
    setVal('#profVerified', u.emailVerified? 'Ya':'Belum');
    setVal('#profStudentId', u.studentId||'');
    setVal('#profLecturerId', u.lecturerId||'');
    setVal('#profOfficerId', u.officerId||'');

    toggle('#profFieldStudent', u.role!=='Mahasiswa');
    toggle('#profFieldLecturer', u.role!=='Dosen');
    toggle('#profFieldOfficer', u.role!=='Petugas Pasar');

    if(u.photo){
      $('#profileAvatarImg')?.classList.remove('hidden');
      if($('#profileAvatarImg')) $('#profileAvatarImg').src = u.photo;
      $('#profileAvatarInitial')?.classList.add('hidden');
    } else {
      $('#profileAvatarImg')?.classList.add('hidden');
      $('#profileAvatarInitial')?.classList.remove('hidden');
      if($('#profileAvatarInitial')) $('#profileAvatarInitial').textContent = (u.name||'U').substring(0,1).toUpperCase();
    }

    if(u.role==='Mahasiswa'){
      toggle('#studentFieldWrapper', false);
      setVal('#studentNIMForm', u.studentId||'');
    } else toggle('#studentFieldWrapper', true);

    if($('#lastLoginField')) $('#lastLoginField').value = u.lastLogin
      ? formatDateTime(u.lastLogin)
      : '-';
    if($('#createdAtField')) $('#createdAtField').value = u.createdAt
      ? formatDateTime(u.createdAt)
      : '-';

    populateDynamic();
    updateProfileStats();
    if(u.role==='Admin'){
      loadAllUsersForRoleManagement();
      loadAllUsersForDeletion();
    } else {
      const r = $('#roleMgmt');
      if(r) r.innerHTML = '<em class="muted" style="font-size:.55rem;">Hanya Admin.</em>';
      const d = $('#adminUserDelete');
      if(d) d.innerHTML='';
    }
    feather.replace();
  }

  function toggle(sel, hidden){
    const el = $(sel);
    if(el) el.classList.toggle('hidden', hidden);
  }

  async function loadAllUsersForRoleManagement(){
    if(state.userProfile?.role!=='Admin') return;
    const snap = await db.collection('users').orderBy('name').get();
    const html = snap.docs.map(d=>{
      const u = d.data();
      return `
        <div style="display:flex;align-items:center;gap:.55rem;background:hsl(var(--accent)/0.12);padding:.5rem .55rem;border:1px solid hsl(var(--panel-border)/0.4);border-radius:14px;">
          <div style="flex:1;min-width:110px;cursor:pointer;" data-view-user="${d.id}">
            <strong style="font-size:.52rem;">${sanitize(u.name||'')}</strong><br>
            <span style="font-size:.45rem;">${sanitize(u.email||'')}</span>
          </div>
          <select data-user-role="${d.id}" style="font-size:.5rem;padding:.3rem .4rem;border-radius:10px;">
            ${state.roleOptions.map(r=> `<option ${u.role===r?'selected':''}>${r}</option>`).join('')}
          </select>
          <button class="outline small" data-user-update-role="${d.id}" style="padding:.35rem .5rem;">
            <i data-feather="save" width="11"></i>
          </button>
        </div>
      `;
    }).join('');
    const container = $('#roleMgmt');
    if(container){
      container.innerHTML = html || '<em class="muted">Tidak ada pengguna.</em>';
      feather.replace();
      $all('[data-user-update-role]').forEach(btn=>{
        btn.onclick = async ()=>{
          const uid = btn.getAttribute('data-user-update-role');
          const sel = document.querySelector(`[data-user-role="${uid}"]`);
          const role = sel.value;
          if(uid===state.currentUser.uid && role!=='Admin'){
            toast('Tidak bisa turunkan role sendiri','warn');
            return;
          }
          try{
            await db.collection('users').doc(uid).update({
              role,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            toast('Role diperbarui','success');
            if(uid===state.currentUser.uid){
              await loadUserProfile(uid);
              refreshUserUI();
            }
          }catch{
            toast('Gagal update role','danger');
          }
        };
      });
      $all('[data-view-user]').forEach(el=>{
        el.addEventListener('click', ()=> openOtherUserProfile(el.getAttribute('data-view-user')));
      });
    }
  }

  async function loadAllUsersForDeletion(){
    if(state.userProfile?.role!=='Admin') return;
    const snap = await db.collection('users').orderBy('name').get();
    const html = '<div style="font-weight:700;font-size:.55rem;margin-bottom:.3rem;">Hapus Akun (Admin)</div>' +
      snap.docs.filter(d=> d.id!==state.currentUser.uid).map(d=>{
        const u = d.data();
        return `
          <div style="display:flex;align-items:center;gap:.5rem;background:hsl(var(--accent)/0.1);padding:.45rem .55rem;border-radius:12px;border:1px solid hsl(var(--panel-border)/0.4);">
            <div style="flex:1;cursor:pointer;" data-view-user="${d.id}">
              <strong style="font-size:.5rem;">${sanitize(u.name||'')}</strong><br>
              <span style="font-size:.45rem;">${sanitize(u.email||'')}</span>
            </div>
            <button class="danger small" data-del-user="${d.id}" style="padding:.35rem .55rem;">
              <i data-feather="user-x" width="11"></i>
            </button>
          </div>
        `;
      }).join('');
    const container = $('#adminUserDelete');
    if(container){
      container.innerHTML = html;
      feather.replace();
      $all('[data-del-user]').forEach(btn=>{
        btn.onclick = ()=>{
          const uid = btn.getAttribute('data-del-user');
          Modal.open({
            title:'Hapus Akun',
            message:'Hapus akun ini (profil)?',
            icon:'user-x',
            confirmText:'Hapus',
            onConfirm: async ()=>{
              try{
                await db.collection('users').doc(uid).delete();
                toast('Akun dihapus','success');
                loadAllUsersForDeletion();
                loadAllUsersForRoleManagement();
              }catch{
                toast('Gagal hapus akun','danger');
              }
            }
          });
        };
      });
      $all('[data-view-user]').forEach(el=>{
        el.addEventListener('click', ()=> openOtherUserProfile(el.getAttribute('data-view-user')));
      });
    }
  }

  function updateProfileStats(){
    if(!state.userProfile) return;
    const myData = state.fishData.filter(r=> r.userId===state.userProfile.id);
    const total = myData.length;
    const avg = total? average(myData.map(r=> r.organoleptic)).toFixed(2):'-';
    const g = myData.filter(r=> r.organoleptic>=7).length;
    const m = myData.filter(r=> r.organoleptic>=4 && r.organoleptic<7).length;
    const b = myData.filter(r=> r.organoleptic<4).length;
    const hz= myData.filter(r=> (r.hazards||[]).length).length;
    const badges=[];
    if(total) badges.push({icon:'check-circle', text:`${total} Input`});
    if(g) badges.push({icon:'smile', text:`${g} Baik`});
    if(m) badges.push({icon:'alert-triangle', text:`${m} Sedang`});
    if(b) badges.push({icon:'x-octagon', text:`${b} Buruk`});
    if(hz) badges.push({icon:'shield-off', text:`${hz} Indikasi`});
    if(avg!=='-') badges.push({icon:'bar-chart-2', text:`Avg ${avg}`});
    const wrap = $('#profileStatsBadges');
    if(wrap){
      wrap.innerHTML = badges.map(b=> `
        <span class="badge-soft">
          <i data-feather="${b.icon}" width="11"></i>${b.text}
        </span>
      `).join('') || '<span class="small muted">Belum ada statistik.</span>';
      feather.replace();
    }
  }

  /* ===================== AUTH LISTENER ===================== */
  auth.onAuthStateChanged(async user=>{
    if(user){
      state.currentUser = user;
      try{
        await db.collection('users').doc(user.uid).set({
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        },{merge:true});
      }catch{}
      await loadUserProfile(user.uid);
      subscribeMetadata();
      subscribeData();
      subscribeSocial();
      loadSocialUsers();
      initLoggedIn();
    } else {
      cleanupSubs();
      state.currentUser = null;
      state.userProfile = null;
      state.fishData = [];
      state.filteredData = [];
      toggleViewAuth(true);
    }
    feather.replace();
    setTimeout(()=> $('#loadingOverlay')?.style && ($('#loadingOverlay').style.display='none'), 400);
  });

  function cleanupSubs(){
    Object.values(state.metadataUnsub).forEach(unsub=>{
      if(typeof unsub==='function') unsub();
    });
    Object.values(state.social.commentUnsubs).forEach(unsub=>{
      if(typeof unsub==='function') unsub();
    });
    state.metadataUnsub = {fish:null, markets:null, data:null, social:null};
    state.social.commentUnsubs = {};
  }

  function toggleViewAuth(showAuth){
    const authView = $('#authView');
    const appLayout = $('#appLayout');
    if(showAuth){
      authView?.classList.remove('hidden');
      appLayout?.classList.add('hidden');
    } else {
      authView?.classList.add('hidden');
      appLayout?.classList.remove('hidden');
    }
  }

  function initLoggedIn(){
    toggleViewAuth(false);
    refreshUserUI();
    resetForm();
    updateDashboard();
    updateQualityList();
    rebuildCharts();
  }

  /* ===================== FORM SUBMIT ===================== */
  async function submitForm(){
    if(!state.currentUser) return;
    const id = $('#recordId')?.value;
    const fishType = $('#fishTypeInput')?.value.trim();
    const market   = $('#marketInput')?.value.trim();
    const organoleptic = clamp(parseInt($('#organoleptic')?.value),1,9);
    const smell    = $('#smell')?.value.trim();
    const texture  = $('#texture')?.value.trim();
    const color    = $('#colorField')?.value.trim();
    const hazardNotes = $('#hazardNotes')?.value.trim();
    const hazards  = [...state.formHazards];
    if(!fishType || !market || !organoleptic || !smell || !texture || !color){
      showAlert('formAlert','danger','Field wajib belum lengkap.');
      toast('Lengkapi data','warn');
      return;
    }
    if(!state.fishTypes.includes(fishType)) addNewFishType(fishType);
    if(!state.markets.includes(market)) addNewMarket(market);

    const payload = {
      fishType, market, organoleptic, smell, texture, color,
      image: state.formImageData || '',
      userId: state.currentUser.uid,
      userName: state.userProfile?.name || 'User',
      hazards, hazardNotes,
      date: new Date(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try{
      if(id){
        const rec = state.fishData.find(r=> r.id===id);
        const role = state.userProfile.role;
        if(role==='Dosen') return showAlert('formAlert','warn','Role Dosen tidak bisa edit (demo).');
        if(rec && rec.userId !== state.currentUser.uid && !['Admin','Petugas Pasar'].includes(role)){
          return showAlert('formAlert','danger','Tidak berhak edit.');
        }
        await db.collection('fishQuality').doc(id).update(payload);
        toast('Data diperbarui','success');
        showAlert('formAlert','success','Data diperbarui.');
      } else {
        const ref = await db.collection('fishQuality').add({
          ...payload,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        state.lastAddedId = ref.id;
        toast('Data tersimpan','success');
        showAlert('formAlert','success','Data tersimpan.');
      }
      resetForm();
    }catch(err){
      toast('Gagal simpan','danger');
      showAlert('formAlert','danger','Error: '+err.message);
    }
  }

  /* ===================== EXPORTS ===================== */
  function toCSV(rows){
    return rows.map(r=> r.map(v=> `"${(v??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  }
  function exportCSV(records, filename='mutu_ikan.csv'){
    const rows = generateTableData(records);
    download(filename,toCSV(rows),'text/csv;charset=utf-8;');
    toast('CSV diekspor','success');
  }
  function exportExcel(records){
    const rows = generateTableData(records);
    const html = '<table>'+ rows.map(r=> '<tr>'+ r.map(c=> `<td>${c}</td>`).join('') + '</tr>').join('') +'</table>';
    const blob = new Blob([`\ufeff${html}`],{type:'application/vnd.ms-excel'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download='mutu_ikan.xls';
    a.click();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1200);
    toast('Excel diekspor','success');
  }
  async function exportPDF(records, includeCharts=true){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','pt','a4');
    const margin=40;
    let y=margin;
    doc.setFontSize(14);
    doc.text('Laporan Mutu Ikan Segar', margin,y); y+=20;
    doc.setFontSize(9);
    doc.text(`Tanggal Generate: ${formatDate(new Date())}`, margin,y); y+=12;
    doc.text(`Total Data: ${records.length}`, margin,y); y+=14;
    const good = records.filter(r=> r.organoleptic>=7).length;
    const medium = records.filter(r=> r.organoleptic>=4 && r.organoleptic<7).length;
    const bad = records.filter(r=> r.organoleptic<4).length;
    const hazardCount = records.filter(r=> (r.hazards||[]).length).length;
    doc.text(`Mutu Baik: ${good} | Sedang: ${medium} | Buruk: ${bad} | Indikasi Bahaya: ${hazardCount}`, margin, y); y+=16;

    if(includeCharts && state.charts.comparison){
      const charts = [
        { canvas: $('#chartComparison'), title:'Perbandingan Mutu Pasar' },
        { canvas: $('#chartTrend'), title:'Tren Skor' },
        { canvas: $('#chartPie'), title:'Proporsi Jenis Ikan' }
      ];
      for(const ch of charts){
        try{
          const img = ch.canvas.toDataURL('image/png',1.0);
          doc.setFontSize(10);
          doc.text(ch.title, margin,y); y+=8;
          doc.addImage(img,'PNG',margin,y,520,190,null,'FAST');
          y+=200;
          if(y>760){ doc.addPage(); y=margin; }
        }catch{}
      }
    }
    const rows = generateTableData(records);
    if(y>700){ doc.addPage(); y=margin; }
    doc.setFontSize(12); doc.text('Tabel Data', margin,y); y+=10;
    doc.setFontSize(7);
    const colWidths=[55,60,60,45,60,60,50,55,65,45,50,60,40,30];
    doc.setFont(undefined,'bold');
    let x=margin;
    rows[0].forEach((h,i)=> {
      doc.text(String(h).substring(0,16), x, y);
      x+= colWidths[i]||40;
    });
    doc.setFont(undefined,'normal');
    y+=10;
    for(let i=1;i<rows.length;i++){
      x=margin;
      if(y>790){ doc.addPage(); y=margin; }
      rows[i].forEach((cell,ci)=>{
        doc.text(String(cell).substring(0,16), x,y);
        x+= colWidths[ci]||40;
      });
      y+=10;
    }
    doc.save('laporan_mutu.pdf');
    toast('PDF diekspor','success');
  }

  /* ===================== IMAGE COMPRESS ===================== */
  function compressImage(file, maxW=1000){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = e=>{
        const img = new Image();
        img.onload = ()=>{
          const scale = Math.min(1, maxW/img.width);
          const canvas = document.createElement('canvas');
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img,0,0,canvas.width,canvas.height);
          resolve(canvas.toDataURL('image/jpeg',0.8));
        };
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  /* ===================== VIEW SWITCHING ===================== */
  function showView(view){
    $all('[id^="view-"]').forEach(sec=> sec.classList.add('hidden'));
    const section = $('#view-'+view);
    if(section){
      section.classList.remove('hidden');
      section.classList.add('view-transition-enter');
      setTimeout(()=> section.classList.remove('view-transition-enter'),600);
    }
    $all('.nav button').forEach(b=> b.classList.remove('active'));
    const navBtn = document.querySelector(`.nav button[data-view="${view}"]`);
    navBtn?.classList.add('active');
    smoothScrollTop();
    feather.replace();
  }
  function smoothScrollTop(){
    const content = document.querySelector('.content');
    if(content) content.scrollTo({top:0,behavior:'smooth'});
  }

  function bindAuthSwitches(){
    $('#showRegister')?.addEventListener('click', e=>{
      e.preventDefault();
      toggleAuth('register');
    });
    $('#showLogin')?.addEventListener('click', e=>{
      e.preventDefault();
      toggleAuth('login');
    });
    $('#linkForgot')?.addEventListener('click', e=>{
      e.preventDefault();
      toggleAuth('forgot');
    });
    $('#backToLogin')?.addEventListener('click', e=>{
      e.preventDefault();
      toggleAuth('login');
    });
  }
  function toggleAuth(page){
    $('#loginContainer')?.classList.add('hidden');
    $('#registerContainer')?.classList.add('hidden');
    $('#forgotContainer')?.classList.add('hidden');
    if(page==='login') $('#loginContainer')?.classList.remove('hidden');
    else if(page==='register') $('#registerContainer')?.classList.remove('hidden');
    else if(page==='forgot') $('#forgotContainer')?.classList.remove('hidden');
  }

  function bindNavigation(){
    $all('.nav button, .dropdown button[data-dropdown]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const view = btn.getAttribute('data-view') || btn.getAttribute('data-dropdown');
        if(!view) return;
        showView(view);
        $('#sidebar')?.classList.remove('open');
      });
    });
    $('#openSidebar')?.addEventListener('click', ()=> $('#sidebar')?.classList.add('open'));
    $('#closeSidebar')?.addEventListener('click', ()=> $('#sidebar')?.classList.remove('open'));
    $('#avatarBtn')?.addEventListener('click', ()=> $('#userDropdown')?.classList.toggle('show'));
    document.addEventListener('click', e=>{
      if(!$('#userDropdown')?.contains(e.target) && !$('#avatarBtn')?.contains(e.target)){
        $('#userDropdown')?.classList.remove('show');
      }
    });
    // FAB
    $('#fabInputData')?.addEventListener('click', ()=>{
      showView('form');
      toast('Input Data','info',1200);
    });
  }

  function bindThemeLang(){
    $('#btnToggleTheme')?.addEventListener('click', ()=>{
      const root = document.documentElement;
      const cur = root.getAttribute('data-theme')==='dark'?'light':'dark';
      root.setAttribute('data-theme',cur);
      localStorage.setItem('theme',cur);
      toast('Tema: '+(cur==='dark'?'Gelap':'Terang'),'info',1800);
    });
    (function initTheme(){
      const saved = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', saved);
    })();
    $('#btnLang')?.addEventListener('click', ()=>{
      state.lang = state.lang==='id'?'en':'id';
      applyI18n();
      toast('Bahasa: '+ (state.lang==='id'?'Indonesia':'English'),'info',1800);
    });
    $('#languageSelect')?.addEventListener('change', e=>{
      state.lang = e.target.value;
      applyI18n();
      toast('Bahasa diubah','success');
    });

    $('#prefLight')?.addEventListener('click', ()=>{
      document.documentElement.setAttribute('data-theme','light');
      localStorage.setItem('theme','light');
      toast('Tema terang','info');
    });
    $('#prefDark')?.addEventListener('click', ()=>{
      document.documentElement.setAttribute('data-theme','dark');
      localStorage.setItem('theme','dark');
      toast('Tema gelap','info');
    });

    document.documentElement.style.setProperty('--accent', state.accent);
    if(state.layoutStyle==='list') document.body.classList.add('layout-list');
    if(state.liteMode) document.body.classList.add('lite-mode');
    applyFontSize(state.fontSize);

    $('#fontSizeSelect')?.addEventListener('change', e=>{
      applyFontSize(e.target.value);
      toast('Ukuran font diperbarui','success');
    });
    $('#layoutStyle')?.addEventListener('change', e=>{
      state.layoutStyle = e.target.value;
      localStorage.setItem('layoutStyle', state.layoutStyle);
      document.body.classList.toggle('layout-list', state.layoutStyle==='list');
      toast('Layout: '+state.layoutStyle,'info');
    });

    $('#toggleLiteMode')?.addEventListener('click', ()=>{
      state.liteMode = !state.liteMode;
      document.body.classList.toggle('lite-mode', state.liteMode);
      localStorage.setItem('liteMode', state.liteMode?'1':'0');
      applyI18n();
      toast('Lite Mode: '+(state.liteMode?'ON':'OFF'),'info');
    });
  }

  function bindFilters(){
    ['filterFish','filterMarket','filterDate','filterText','globalSearch'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', ()=> debounce('filter', applyFilters, 250));
    });
  }

  function bindHazardsAndImage(){
    $('#fishImage')?.addEventListener('change', async e=>{
      const file = e.target.files[0];
      if(!file){ state.formImageData=null; $('#fishImagePreview').innerHTML=''; return; }
      try{
        const base64 = await compressImage(file);
        state.formImageData = base64;
        $('#fishImagePreview').innerHTML = `
          <img src="${base64}" alt="fish">
          <div style="margin-top:.4rem;">
            <button type="button" class="btn-mini-inline" id="btnRemoveFishImg"><i data-feather="trash" width="10"></i>Hapus</button>
          </div>
        `;
        $('#btnRemoveFishImg').onclick = ()=>{
          state.formImageData=null;
          $('#fishImage').value='';
          $('#fishImagePreview').innerHTML='';
        };
        feather.replace();
      }catch{
        toast('Gagal proses gambar','danger');
      }
    });
  }

  function bindForm(){
    $('#fishForm')?.addEventListener('submit', e=>{
      e.preventDefault();
      submitForm();
    });
    $('#btnResetForm')?.addEventListener('click', ()=>{
      resetForm();
      showAlert('formAlert','info','Form direset',2000);
    });
    $('#cancelEditBtn')?.addEventListener('click', ()=>{
      resetForm();
      toast('Batal edit','info');
    });
  }

  function bindDashQualityButtons(){
    $all('[data-quality-filter]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $all('[data-quality-filter]').forEach(b=> b.classList.remove('active'));
        btn.classList.add('active');
        state.qualityFilter = btn.getAttribute('data-quality-filter');
        updateQualityList();
        toast('Filter mutu: '+state.qualityFilter,'info',1400);
      });
    });
    $all('[data-dash-filter]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $all('[data-dash-filter]').forEach(b=> b.classList.remove('active'));
        btn.classList.add('active');
        state.dashRange = btn.getAttribute('data-dash-filter');
        updateDashboard();
        rebuildCharts();
      });
    });
    $('#btnRefreshDashboard')?.addEventListener('click', ()=>{
      updateDashboard();
      rebuildCharts();
      updateQualityList();
      toast('Dashboard disegarkan','success');
    });
    $('#toggleMyData')?.addEventListener('click', ()=>{
      state.myDataOnly = !state.myDataOnly;
      $('#toggleMyData').setAttribute('data-state', state.myDataOnly?'mine':'all');
      applyI18n();
      applyFilters();
      updateDashboard();
      toast(state.myDataOnly?'Data Saya':'Semua Data','info');
    });
  }

  function bindExports(){
    $('#btnExportCSV')?.addEventListener('click', ()=> exportCSV(state.filteredData));
    $('#repExportCSV')?.addEventListener('click', ()=> exportCSV(state.filteredData,'laporan_mutu.csv'));
    $('#btnExportExcel')?.addEventListener('click', ()=> exportExcel(state.filteredData));
    $('#btnExportPDF')?.addEventListener('click', ()=> exportPDF(state.filteredData));
    $('#repExportPDF')?.addEventListener('click', ()=> exportPDF(state.filteredData));
    $('#btnPrint')?.addEventListener('click', ()=> { window.print(); toast('Mencetak...','info'); });
    $('#repPrint')?.addEventListener('click', ()=> { window.print(); toast('Mencetak...','info'); });
  }

  function bindReportGenerate(){
    $('#btnGenerateReport')?.addEventListener('click', ()=>{
      const from = $('#reportFrom')?.value;
      const to   = $('#reportTo')?.value;
      const scope= $('#reportScope')?.value;
      const fish = $('#reportFish')?.value;
      let recs = [...state.fishData];
      if(scope==='mine') recs = recs.filter(r=> r.userId===state.currentUser?.uid);
      if(fish) recs = recs.filter(r=> r.fishType===fish);
      if(from){
        const fd = new Date(from);
        recs = recs.filter(r=> r.date >= fd);
      }
      if(to){
        const td = new Date(to);
        td.setHours(23,59,59,999);
        recs = recs.filter(r=> r.date <= td);
      }
      const rows = generateTableData(recs);
      const html = `
        <div style="font-size:.65rem;font-weight:700;margin-bottom:.45rem;">Hasil Laporan (${recs.length} data)</div>
        <div style="overflow:auto;max-height:320px;border:1px solid hsl(var(--panel-border)/0.4);border-radius:14px;">
          <table style="width:100%;border-collapse:collapse;font-size:.52rem;min-width:1000px;">
            <thead style="background:hsl(var(--accent)/0.35);color:#fff;">
              <tr>${rows[0].map(h=> `<th style="padding:.4rem .5rem;text-align:left;">${h}</th>`).join('')}</tr>
            </thead>
            <tbody>
              ${rows.slice(1).map(r=> `<tr>${r.map(c=> `<td style="padding:.38rem .5rem;border-bottom:1px solid hsl(var(--panel-border)/0.25);">${c}</td>`).join('')}</tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;
      setHTML('#reportResult', html);
      feather.replace();
      toast('Laporan digenerate','success');
    });
    $('#btnClearReport')?.addEventListener('click', ()=>{
      setHTML('#reportResult','');
      ['#reportFrom','#reportTo','#reportFish'].forEach(sel=> setVal(sel,''));
      setVal('#reportScope','all');
      toast('Filter laporan dibersihkan','info');
    });
  }

  function bindProfileActions(){
    $('#profileForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const name = $('#profName')?.value.trim();
      if(!name) return showAlert('profileAlert','danger','Nama wajib.');
      const studentId = $('#profStudentId')?.value.trim() || '';
      const lecturerId= $('#profLecturerId')?.value.trim() || '';
      const officerId = $('#profOfficerId')?.value.trim() || '';
      try{
        await db.collection('users').doc(state.currentUser.uid).update({
          name, studentId, lecturerId, officerId,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await state.currentUser.updateProfile({ displayName:name });
        showAlert('profileAlert','success','Profil diperbarui.');
        toast('Profil diperbarui','success');
        await loadUserProfile(state.currentUser.uid);
        refreshUserUI();
      }catch(err){
        showAlert('profileAlert','danger','Gagal: '+err.message);
        toast('Gagal update profil','danger');
      }
    });
    $('#btnChangeEmail')?.addEventListener('click', async ()=>{
      const newEmail = $('#changeEmailField')?.value.trim();
      if(!newEmail) return toast('Email kosong','warn');
      try{
        await state.currentUser.updateEmail(newEmail);
        await db.collection('users').doc(state.currentUser.uid).update({
          email:newEmail,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        toast('Email diperbarui','success');
        showAlert('profileAlert','success','Email diubah.');
        await loadUserProfile(state.currentUser.uid);
        refreshUserUI();
      }catch(err){
        showAlert('profileAlert','danger','Gagal: '+err.message);
        toast('Gagal ganti email','danger');
      }
    });
    $('#btnChangePassword')?.addEventListener('click', async ()=>{
      const p1 = $('#changePasswordField')?.value;
      const p2 = $('#changePasswordConfirm')?.value;
      if(!p1 || p1.length<6) return toast('Password minimal 6','warn');
      if(p1!==p2) return toast('Konfirmasi tidak cocok','danger');
      try{
        await state.currentUser.updatePassword(p1);
        toast('Password diperbarui','success');
        showAlert('profileAlert','success','Password diperbarui.');
        setVal('#changePasswordField','');
        setVal('#changePasswordConfirm','');
      }catch(err){
        showAlert('profileAlert','danger','Gagal: '+err.message);
        toast('Gagal ganti password','danger');
      }
    });
    $('#btnSendVerifyProfile')?.addEventListener('click', async ()=>{
      if(state.currentUser.emailVerified){
        toast('Sudah terverifikasi','info');
        return showAlert('profileAlert','info','Email sudah terverifikasi.');
      }
      try{
        await state.currentUser.sendEmailVerification();
        toast('Verifikasi dikirim','success');
        showAlert('profileAlert','success','Email verifikasi dikirim.');
      }catch(err){
        showAlert('profileAlert','danger','Gagal: '+err.message);
        toast('Gagal kirim verifikasi','danger');
      }
    });
    $('#btnSendPasswordReset')?.addEventListener('click', async ()=>{
      if(!state.userProfile?.email) return;
      try{
        await auth.sendPasswordResetEmail(state.userProfile.email);
        toast('Email reset dikirim','success');
        showAlert('profileAlert','success','Reset password terkirim.');
      }catch(err){
        showAlert('profileAlert','danger','Gagal: '+err.message);
        toast('Gagal reset','danger');
      }
    });
    $('#btnRefreshUser')?.addEventListener('click', async ()=>{
      await state.currentUser.reload();
      await loadUserProfile(state.currentUser.uid);
      refreshUserUI();
      toast('User direfresh','success');
    });
    $('#btnRefreshProfile')?.addEventListener('click', async ()=>{
      await state.currentUser.reload();
      await loadUserProfile(state.currentUser.uid);
      refreshUserUI();
      toast('Profil direfresh','success');
    });
    $('#btnChangePhoto')?.addEventListener('click', ()=> $('#profilePhotoInput')?.click());
    $('#profilePhotoInput')?.addEventListener('change', async e=>{
      const file = e.target.files[0];
      if(!file) return;
      try{
        const base64 = await compressImage(file,800);
        await db.collection('users').doc(state.currentUser.uid).update({
          photo: base64,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        toast('Foto diperbarui','success');
        showAlert('profileAlert','success','Foto diperbarui.');
        await loadUserProfile(state.currentUser.uid);
        refreshUserUI();
      }catch(err){
        toast('Gagal update foto','danger');
        showAlert('profileAlert','danger','Gagal: '+err.message);
      }
    });
    $('#btnRemovePhoto')?.addEventListener('click', ()=>{
      Modal.open({
        title:'Hapus Foto',
        message:'Hapus foto profil?',
        icon:'trash',
        confirmText:'Hapus',
        onConfirm: async ()=>{
          try{
            await db.collection('users').doc(state.currentUser.uid).update({
              photo:'',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            toast('Foto dihapus','success');
            showAlert('profileAlert','success','Foto dihapus.');
            await loadUserProfile(state.currentUser.uid);
            refreshUserUI();
          }catch(err){
            toast('Gagal hapus foto','danger');
            showAlert('profileAlert','danger','Gagal: '+err.message);
          }
        }
      });
    });

    $('#btnSavePreferences')?.addEventListener('click', async ()=>{
      const defFish = $('#prefDefaultFish')?.value || '';
      const defMarket = $('#prefDefaultMarket')?.value || '';
      try{
        await db.collection('users').doc(state.currentUser.uid).update({
          defaultFishType: defFish,
          defaultMarket: defMarket,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        toast('Preferensi disimpan','success');
        showAlert('prefAlert','success','Preferensi disimpan.');
        await loadUserProfile(state.currentUser.uid);
        refreshUserUI();
      }catch(err){
        showAlert('prefAlert','danger','Gagal: '+err.message);
        toast('Gagal simpan preferensi','danger');
      }
    });

    $('#btnRefreshStats')?.addEventListener('click', updateProfileStats);

    $('#btnDeleteAccount')?.addEventListener('click', ()=>{
      Modal.open({
        title:'Hapus Akun',
        message:'Hapus profil Anda? (Demo, data mutu tidak dihapus)',
        icon:'user-x',
        confirmText:'Hapus',
        onConfirm: async ()=>{
          try{
            await db.collection('users').doc(state.currentUser.uid).delete();
            await state.currentUser.delete();
            toast('Akun dihapus','success');
          }catch(err){
            toast('Gagal hapus akun','danger');
            showAlert('deleteAccountAlert','danger','Gagal: '+err.message);
          }
        }
      });
    });
  }

  function bindAuthForms(){
    $('#loginForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const email = $('#loginEmail')?.value.trim();
      const pass  = $('#loginPassword')?.value;
      if(!email || !pass) return;
      showAlert('authAlert','info','Memproses login...');
      try{
        await auth.signInWithEmailAndPassword(email,pass);
        toast('Login sukses','success');
      }catch(err){
        showAlert('authAlert','danger','Login gagal: '+err.message);
        toast('Login gagal','danger');
      }
    });
    $('#registerForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const name = $('#regName')?.value.trim();
      const email= $('#regEmail')?.value.trim();
      const pass = $('#regPassword')?.value;
      const pass2= $('#regConfirmPassword')?.value;
      const roleSel = $('#regRole')?.value;
      const studentId = $('#regStudentId')?.value?.trim() || '';
      const lecturerId= $('#regLecturerId')?.value?.trim() || '';
      const officerId = $('#regOfficerId')?.value?.trim() || '';
      if(!name||!email||!pass) return showAlert('registerAlert','danger','Isi semua field.');
      if(pass!==pass2) return showAlert('registerAlert','danger','Konfirmasi tidak cocok.');
      showAlert('registerAlert','info','Memproses registrasi...');
      try{
        const cred = await auth.createUserWithEmailAndPassword(email,pass);
        const role = roleSel === 'Admin' ? 'Mahasiswa' : roleSel;
        await db.collection('users').doc(cred.user.uid).set({
          name,email,role,
          studentId: role==='Mahasiswa'? studentId:'',
          lecturerId: role==='Dosen'? lecturerId:'',
          officerId: role==='Petugas Pasar'? officerId:'',
          defaultFishType:'', defaultMarket:'',
          photo:'',
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          emailVerified: cred.user.emailVerified
        });
        await cred.user.updateProfile({ displayName:name });
        await cred.user.sendEmailVerification();
        showAlert('registerAlert','success','Registrasi berhasil. Cek email.');
        toast('Registrasi berhasil','success');
        setTimeout(()=> toggleAuth('login'),1200);
      }catch(err){
        showAlert('registerAlert','danger','Gagal: '+err.message);
        toast('Registrasi gagal','danger');
      }
    });
    $('#forgotForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const email = $('#forgotEmail')?.value.trim();
      if(!email) return;
      showAlert('forgotAlert','info','Mengirim link reset...');
      try{
        await auth.sendPasswordResetEmail(email);
        showAlert('forgotAlert','success','Email reset terkirim.');
        toast('Email reset terkirim','success');
      }catch(err){
        showAlert('forgotAlert','danger','Gagal: '+err.message);
        toast('Reset gagal','danger');
      }
    });
    $('#regRole')?.addEventListener('change', renderExtraFields);
    renderExtraFields();
  }

  function renderExtraFields(){
    const role = $('#regRole')?.value;
    const c = $('#regExtraFields');
    if(!c) return;
    let html='';
    if(role==='Mahasiswa'){
      html = `<div class="inline-field slide-in-up">
        <label data-i18n="student_id">${state.lang==='en'?'Student ID':'NIM Mahasiswa'}</label>
        <input id="regStudentId" placeholder="${state.lang==='en'?'Student ID':'NIM'}">
      </div>`;
    } else if(role==='Dosen'){
      html = `<div class="inline-field slide-in-up">
        <label data-i18n="lecturer_id">${state.lang==='en'?'Lecturer ID':'NIP Dosen'}</label>
        <input id="regLecturerId" placeholder="NIP">
      </div>`;
    } else if(role==='Petugas Pasar'){
      html = `<div class="inline-field slide-in-up">
        <label data-i18n="officer_id">${state.lang==='en'?'Officer ID':'ID Petugas'}</label>
        <input id="regOfficerId" placeholder="ID Petugas">
      </div>`;
    }
    c.innerHTML = html;
    feather.replace();
  }

  function bindLogout(){
    $('#btnLogout')?.addEventListener('click', ()=> auth.signOut());
    $('#logoutDropdownBtn')?.addEventListener('click', ()=> auth.signOut());
  }

  function bindDemoAccounts(){
    $('#quickDemoAdmin')?.addEventListener('click', ()=> loginDemo('admin_demo@example.com','Admin Demo','Admin','ADM-DEMO'));
    $('#quickDemoUser')?.addEventListener('click', ()=> loginDemo('user_demo@example.com','Mahasiswa Demo','Mahasiswa',''));
  }

  async function loginDemo(email,name,role,officer){
    showAlert('authAlert','info','Masuk akun demo...');
    try{
      try{
        await auth.signInWithEmailAndPassword(email,'password123');
      }catch{
        const cred = await auth.createUserWithEmailAndPassword(email,'password123');
        await db.collection('users').doc(cred.user.uid).set({
          name,email,role,
          studentId: role==='Mahasiswa'?'D1234567':'',
          lecturerId:'',
          officerId: officer || '',
          defaultFishType:'', defaultMarket:'',
          photo:'',
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          emailVerified: cred.user.emailVerified
        });
        await cred.user.updateProfile({ displayName:name });
      }
      toast('Masuk demo '+role,'success');
    }catch(err){
      showAlert('authAlert','danger','Gagal demo: '+err.message);
      toast('Gagal demo','danger');
    }
  }

  function bindPaginationControls(){
    $('#perPageSelect')?.addEventListener('change', e=>{
      state.table.perPage = parseInt(e.target.value,10)||25;
      resetToFirstPage();
      renderTable();
    });
    $('#prevPage')?.addEventListener('click', ()=>{
      if(state.table.page>1){
        state.table.page--;
        renderTable();
      }
    });
    $('#nextPage')?.addEventListener('click', ()=>{
      const total = state.filteredData.length;
      const pages = Math.max(1, Math.ceil(total/state.table.perPage));
      if(state.table.page < pages){
        state.table.page++;
        renderTable();
      }
    });
    $('#selectAllPage')?.addEventListener('change', e=>{
      toggleSelectAllCurrentPage(e.target.checked);
    });
  }

  function bindMisc(){
    renderHazardChips();
    bindSocialForm();
  }

  const PublicAPI = {
    state,
    showView,
    applyI18n,
    toast,
    rebuildCharts
  };

  function init(){
    setText('#year', new Date().getFullYear());
    setText('#year2', new Date().getFullYear());
    setVal('#dateAuto', nowDateInput());
    applyI18n();
    buildAccentPalette();
    bindAuthSwitches();
    bindAuthForms();
    bindNavigation();
    bindThemeLang();
    bindFilters();
    bindHazardsAndImage();
    bindForm();
    bindDashQualityButtons();
    bindExports();
    bindReportGenerate();
    bindProfileActions();
    bindLogout();
    bindDemoAccounts();
    bindPaginationControls();
    bindMisc();
    initOrganolepticTool();
    feather.replace();
    window.addEventListener('load', ()=>{
      setTimeout(()=> $('#loadingOverlay')?.style && ($('#loadingOverlay').style.display='none'), 1200);
    });
  }
/* ===== Organoleptic Tool Data & Functions (SNI 2013 & 2021) ===== */
const organolepticStandards = {
  sni2013: {
    label: 'SNI 2013',
    ref: 'SNI 2729:2013 (Contoh / Ringkasan)',
    criteria: {
      "Mata": [
        {score:9, desc:"Cembung, kornea jernih, pupil hitam mengkilat"},
        {score:7, desc:"Sedikit kurang cembung, kornea agak keruh"},
        {score:5, desc:"Datar, kornea keruh keputihan"},
        {score:3, desc:"Sedikit cekung, pupil pudar"},
        {score:1, desc:"Cekung, kornea keruh tebal, pupil abu-abu"}
      ],
      "Insang": [
        {score:9, desc:"Merah cerah, segar, lendir bening, bau segar laut"},
        {score:7, desc:"Merah ke arah merah muda, lendir agak meningkat"},
        {score:5, desc:"Merah pucat / kecoklatan, lendir keruh"},
        {score:3, desc:"Coklat pucat, lendir kental, bau agak asam"},
        {score:1, desc:"Coklat keabu-abuan, lendir tebal, bau busuk"}
      ],
      "Bau": [
        {score:9, desc:"Segar spesifik ikan, tidak asing"},
        {score:7, desc:"Segar menurun sedikit, masih alami"},
        {score:5, desc:"Sedikit amis tajam / netral"},
        {score:3, desc:"Amis kuat / agak asam"},
        {score:1, desc:"Busuk, asam menyengat, tidak layak"}
      ],
      "Daging / Tekstur": [
        {score:9, desc:"Elastis padat, kembali cepat saat ditekan"},
        {score:7, desc:"Cukup elastis, sedikit lambat kembali"},
        {score:5, desc:"Kurang elastis, agak lunak"},
        {score:3, desc:"Lunak, bekas tekan menetap lama"},
        {score:1, desc:"Sangat lembek, tidak kembali"}
      ],
      "Kulit / Warna": [
        {score:9, desc:"Cerlang, mengkilat, lendir jernih tipis"},
        {score:7, desc:"Agak kurang cerah, lendir meningkat sedikit"},
        {score:5, desc:"Agak kusam, lendir keruh"},
        {score:3, desc:"Kusam, lendir keruh tebal"},
        {score:1, desc:"Sangat kusam, lendir tebal kental"}
      ]
    }
  },
  sni2021: {
    label: 'SNI 2021',
    ref: 'SNI Revisi 2021 (Contoh / Ringkasan)',
    criteria: {
      "Mata": [
        {score:9, desc:"Cembung penuh, bening, refleksi baik"},
        {score:8, desc:"Cembung, sedikit redup"},
        {score:6, desc:"Mulai datar, kornea agak keruh"},
        {score:4, desc:"Datar/cekung ringan, keruh"},
        {score:2, desc:"Cekung jelas, keruh pekat"},
        {score:1, desc:"Cekung parah, hancur / buram"}
      ],
      "Insang": [
        {score:9, desc:"Merah terang, lembab segar, bau laut"},
        {score:8, desc:"Merah agak muda, bau normal"},
        {score:6, desc:"Merah pucat, lendir mulai keruh"},
        {score:4, desc:"Coklat kemerahan, lendir keruh kental"},
        {score:2, desc:"Coklat keabu-abuan, bau kurang sedap"},
        {score:1, desc:"Abu / coklat kusam, bau busuk"}
      ],
      "Aroma Umum": [
        {score:9, desc:"Segar spesifik, alami"},
        {score:8, desc:"Segar normal menurun sedikit"},
        {score:6, desc:"Netral / amis ringan"},
        {score:4, desc:"Amis kuat / agak asam"},
        {score:2, desc:"Asam tajam / hampir busuk"},
        {score:1, desc:"Busuk jelas"}
      ],
      "Tekstur": [
        {score:9, desc:"Padat elastis optimum"},
        {score:8, desc:"Padat, sedikit menurun"},
        {score:6, desc:"Agak lunak"},
        {score:4, desc:"Lunak, bekas tekan lambat hilang"},
        {score:2, desc:"Lunak sekali"},
        {score:1, desc:"Hancur / lembek"}
      ],
      "Kulit / Permukaan": [
        {score:9, desc:"Cerlang, lendir jernih tipis"},
        {score:8, desc:"Agak kurang cerah"},
        {score:6, desc:"Kusam ringan, lendir meningkat"},
        {score:4, desc:"Kusam, lendir keruh"},
        {score:2, desc:"Sangat kusam, lendir tebal"},
        {score:1, desc:"Kering / berlendir rusak"}
      ],
      "Perut / Abdomen": [
        {score:9, desc:"Utuh rapat normal"},
        {score:8, desc:"Utuh, sedikit lembut"},
        {score:6, desc:"Sedikit buncit / lepas ringan"},
        {score:4, desc:"Agak pecah / lunak"},
        {score:2, desc:"Pecah sebagian"},
        {score:1, desc:"Pecah rusak parah"}
      ]
    }
  }
};

const organolepticToolState = {
  standard: 'sni2013',
  selections: {}, // {criterion: score}
};

function buildOrganolepticCriteria(){
  const wrap = document.getElementById('orgCriteriaContainer');
  if(!wrap) return;
  const std = organolepticStandards[organolepticToolState.standard];
  const crits = std.criteria;
  wrap.innerHTML = Object.keys(crits).map(crit=>{
    const opts = crits[crit].map(o=>{
      const active = organolepticToolState.selections[crit] === o.score;
      return `
        <div class="org-option ${active?'active':''}" data-org-opt="${crit}__${o.score}">
          <div class="score-badge">${o.score}</div>
          <div style="font-weight:600;">${o.desc.split('.')[0]}</div>
          <div style="opacity:.85;">${o.desc}</div>
        </div>
      `;
    }).join('');
    return `
      <div class="org-criterion">
        <h4><i data-feather="bookmark" width="11"></i>${crit}</h4>
        <div class="org-options">${opts}</div>
      </div>
    `;
  }).join('') || '<div class="empty-state">Tidak ada kriteria.</div>';
  feather.replace();
  document.querySelectorAll('[data-org-opt]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const [crit, score] = el.getAttribute('data-org-opt').split('__');
      organolepticToolState.selections[crit] = parseInt(score,10);
      buildOrganolepticCriteria();
      computeOrganolepticResult();
    });
  });
  computeOrganolepticResult();
}

function computeOrganolepticResult(){
  const scores = Object.values(organolepticToolState.selections);
  let final = '-';
  const method = document.getElementById('orgAggregateMethod')?.value || 'average';
  if(scores.length){
    if(method==='average'){
      final = (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(2);
    } else if(method==='min'){
      final = Math.min(...scores).toFixed(2);
    } else if(method==='median'){
      const sorted=[...scores].sort((a,b)=>a-b);
      const mid = Math.floor(sorted.length/2);
      final = (sorted.length%2? sorted[mid] : (sorted[mid-1]+sorted[mid])/2).toFixed(2);
    }
  }
  const boxScore = document.getElementById('orgFinalScore');
  const boxStatus= document.getElementById('orgFinalStatus');
  if(boxScore) boxScore.textContent = final;
  let status='-';
  if(final!=='-'){
    const f = parseFloat(final);
    if(f>=7) status='Baik';
    else if(f>=4) status='Sedang';
    else status='Buruk';
  }
  if(boxStatus) boxStatus.textContent = status;
  buildSummary();
}

function buildSummary(){
  const std = organolepticStandards[organolepticToolState.standard];
  const summaryEl = document.getElementById('orgSummary');
  if(!summaryEl) return;
  const lines = [`Standar: ${std.label}`,`Ref: ${std.ref}`,'Pilihan:'];
  Object.keys(organolepticToolState.selections).forEach(k=>{
    lines.push(`- ${k}: ${organolepticToolState.selections[k]}`);
  });
  lines.push(`Skor Akhir: ${document.getElementById('orgFinalScore')?.textContent || '-'}`);
  lines.push(`Status: ${document.getElementById('orgFinalStatus')?.textContent || '-'}`);
  summaryEl.textContent = lines.join('\n');
}

function resetOrganolepticTool(){
  organolepticToolState.selections = {};
  buildOrganolepticCriteria();
}

function applyOrganolepticToForm(){
  const finalScore = document.getElementById('orgFinalScore')?.textContent;
  if(!finalScore || finalScore==='-'){
    App.toast('Belum ada skor untuk diterapkan','warn');
    return;
  }
  // Isi skor organoleptik
  const organolepticInput = document.getElementById('organoleptic');
  if(organolepticInput){
    organolepticInput.value = Math.round(parseFloat(finalScore));
  }
  // Ambil beberapa deskripsi representatif (heuristik)
  // Bau -> kriteria bernama Bau atau Aroma Umum
  const std = organolepticStandards[organolepticToolState.standard];
  const pick = (nameList)=> {
    for(const n of nameList){
      if(organolepticToolState.selections[n]){
        const arr = std.criteria[n];
        const sc = organolepticToolState.selections[n];
        const opt = arr.find(o=>o.score===sc);
        return opt? opt.desc : '';
      }
    }
    return '';
  };
  const smellDesc = pick(['Bau','Aroma Umum']);
  const textureDesc = pick(['Daging / Tekstur','Tekstur']);
  const colorDesc = pick(['Kulit / Warna','Kulit / Permukaan']);
  if(smellDesc && document.getElementById('smell')) document.getElementById('smell').value = smellDesc.split('.')[0];
  if(textureDesc && document.getElementById('texture')) document.getElementById('texture').value = textureDesc.split('.')[0];
  if(colorDesc && document.getElementById('colorField')) document.getElementById('colorField').value = colorDesc.split('.')[0];
  App.toast('Skor & deskripsi diterapkan ke Form','success');
  App.showView('form');
  setTimeout(()=> window.scrollTo({top:0,behavior:'smooth'}),150);
}

function initOrganolepticTool(){
  const stdSelect = document.getElementById('orgStandardSelect');
  if(stdSelect){
    stdSelect.addEventListener('change', e=>{
      organolepticToolState.standard = e.target.value;
      resetOrganolepticTool();
    });
  }
  document.getElementById('btnResetOrgTool')?.addEventListener('click', ()=>{
    resetOrganolepticTool();
    App.toast('Tool direset','info');
  });
  document.getElementById('btnApplyOrgScore')?.addEventListener('click', applyOrganolepticToForm);
  document.getElementById('btnCopyOrgSummary')?.addEventListener('click', ()=>{
    const txt = document.getElementById('orgSummary')?.textContent || '';
    if(!txt) return App.toast('Ringkasan kosong','warn');
    navigator.clipboard.writeText(txt).then(()=> App.toast('Ringkasan disalin','success'))
      .catch(()=> App.toast('Gagal menyalin','danger'));
  });
  document.getElementById('orgAggregateMethod')?.addEventListener('change', computeOrganolepticResult);
  document.getElementById('btnBackToForm')?.addEventListener('click', ()=> App.showView('form'));
  document.getElementById('btnOpenOrgTool')?.addEventListener('click', ()=>{
    App.showView('organoleptic-tool');
  });
  // Build awal
  buildOrganolepticCriteria();
}

  init();
  return PublicAPI;
})();
</script>
</body>
</html>