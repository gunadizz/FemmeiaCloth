<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.5">
  <title>FemmeiaCloth Finance Tracker</title>
  <meta name="description" content="Aplikasi pencatat keuangan untuk FemmeiaCloth">
  <meta name="theme-color" content="#333333">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/gunadizz/FemmeiaCloth/refs/heads/main/IMG_3593.jpeg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root {

      --primary-bg: #ffffff;
      --secondary-bg: rgba(255, 255, 255, 0.5);
      --border-color: rgba(0, 0, 0, 0.3);
      --text-color: #333333;
      --accent-light: #e0e0e0;
      --accent-mid: #666666;
      --accent-dark: #1f2937;
      --success-color: #00b894;
      --danger-color: #d63031;
      --shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      --button-shadow: 0 6px 12px rgba(102, 102, 102, 0.4);
      --button-shadow-hover: 0 8px 16px rgba(102, 102, 102, 0.6);
      --radius: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Quicksand', 'Inter', sans-serif;
    }

    body {
      background-color: var(--primary-bg);
      color: var(--text-color);
      min-height: 100vh;
      background-image: radial-gradient(circle at 50% 50%, rgba(102, 102, 102, 0.2), transparent 60%);
      overflow-x: hidden;
    }

    /* Scattered Shapes */
    .scattered-shapes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: -1;
      pointer-events: none;
    }

    .scattered-shape {
      position: absolute;
      background: transparent;
      border: 2px solid var(--accent-mid);
      opacity: 0.5;
      animation: float 6s ease-in-out infinite;
    }

    .circle1 { width: 60px; height: 60px; border-radius:50%; top: 10%; left: 5%; animation-delay: 0s; }
    .circle2 { width: 40px; height: 40px; border-radius:50%; top: 60%; right: 10%; animation-delay: 2s; }
    .circle3 { width: 80px; height: 80px; border-radius:50%; bottom: 20%; left: 15%; animation-delay: 4s; }
    .circle4 { width: 50px; height: 50px; border-radius:50%; bottom: 10%; right: 20%; animation-delay: 1s; }
    .square1 { width: 50px; height: 50px; top: 30%; left: 50%; animation-delay: 3s; }
    .square2 { width: 70px; height: 70px; bottom: 40%; right: 30%; animation-delay: 5s; }
    .triangle1 { width: 0; height: 0; border-left: 30px solid transparent; border-right: 30px solid transparent; border-bottom: 52px solid var(--accent-mid); top: 20%; left: 80%; animation-delay: 2.5s; }
    .triangle2 { width: 0; height: 0; border-left: 40px solid transparent; border-right: 40px solid transparent; border-bottom: 69px solid var(--accent-mid); bottom: 30%; left: 25%; animation-delay: 4.5s; }
    .diamond1 { width:40px; height:40px; transform: rotate(45deg); top: 50%; left: 10%; animation-delay: 1.5s; }
    .diamond2 { width:60px; height:60px; transform: rotate(45deg); bottom: 15%; right: 15%; animation-delay: 3.5s; }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 25px;
    }

    header {
      background-color: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      padding: 15px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      text-align: center;
      position: sticky;
      top: 25px;
      z-index: 100;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid rgba(102, 102, 102, 0.1);
    }

    h1 {
      font-weight: 700;
      color: var(--accent-dark);
      margin-bottom: 10px;
      font-size: 2.2rem;
      letter-spacing: 0.5px;
    }

    .main-content {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 30px;
      padding: 0 15px;
    }

    @media (min-width: 768px) {
      .main-content {
        grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
      }
    }

    .card {
      background-color: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(20px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 30px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(102, 102, 102, 0.1);
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }

    .card h2 {
      margin-bottom: 20px;
      color: var(--accent-dark);
      font-weight: 600;
      border-bottom: 2px solid rgba(102, 102, 102, 0.15);
      padding-bottom: 12px;
      font-size: 1.6rem;
      letter-spacing: 0.3px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.7);
    }

    input, select, textarea {
      width: 100%;
      padding: 14px;
      border: 1px solid rgba(102, 102, 102, 0.2);
      border-radius: var(--radius);
      font-size: 16px;
      transition: border 0.3s ease, box-shadow 0.3s ease;
      box-sizing: border-box;
      outline: none;
      background: rgba(255, 255, 255, 0.8);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-mid);
      box-shadow: 0 0 0 2px rgba(102, 102, 102, 0.2);
    }

    .suggestions {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(15px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      width: calc(100% - 40px);
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      box-shadow: var(--shadow);
    }

    .suggestion-item {
      padding: 14px;
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 15px;
    }

    .suggestion-item:hover {
      background-color: rgba(102, 102, 102, 0.1);
    }

    button, .saldoawal-container button {
      background: #1f2937;
      box-shadow: var(--button-shadow);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
      margin-top: 15px;
      margin-bottom: 15px;
      margin-right: 0;
      margin-left: 0;
      width: 100%;
      display: block;
      font-size: 16px;
    }

    button:hover, .saldoawal-container button:hover {
      background: #1f2937;
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(102, 102, 102, 0.5);
    }

    .btn-export {
      background: linear-gradient(135deg, #00b894, #00a383);
      box-shadow: 0 6px 12px rgba(0, 184, 148, 0.4);
      margin-right: 15px;
      width: auto;
      padding: 12px 24px;
    }

    .btn-export:hover {
      background: linear-gradient(135deg, #00a383, #008c6e);
      box-shadow: 0 8px 16px rgba(0, 184, 148, 0.6);
    }

    .btn-print {
      background: linear-gradient(135deg, #00b894, #00a383);
      box-shadow: 0 6px 12px rgba(0, 184, 148, 0.4);
      width: auto;
      margin-top: 25px;
      padding: 12px 24px;
    }

    .btn-print:hover {
      background: linear-gradient(135deg, #00a383, #008c6e);
      box-shadow: 0 8px 16px rgba(0, 184, 148, 0.6);
    }

    .summary-container {
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
      margin-bottom: 25px;
    }

    .summary-box {
      flex: 1;
      min-width: 250px;
      padding: 25px;
      border-radius: var(--radius);
      text-align: center;
      box-shadow: var(--shadow);
      background-color: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(15px);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid rgba(102, 102, 102, 0.1);
    }

    .summary-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    }

    .income-box {
      background-color: rgba(0, 184, 148, 0.1);
      border: 1px solid rgba(0, 184, 148, 0.2);
    }

    .expense-box {
      background-color: rgba(214, 48, 49, 0.1);
      border: 1px solid rgba(214, 48, 49, 0.2);
    }

    .summary-box h3 {
      font-size: 16px;
      margin-bottom: 12px;
      color: rgba(0, 0, 0, 0.6);
      font-weight: 500;
    }

    .summary-box p {
      font-size: 26px;
      font-weight: 700;
      color: var(--text-color);
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid rgba(102, 102, 102, 0.15);
    }

    th {
      background-color: rgba(102, 102, 102, 0.07);
      font-weight: 600;
      color: var(--accent-dark);
      font-size: 14px;
    }

    td {
      font-size: 14px;
      color: var(--text-color);
    }

    tr:hover {
      background-color: rgba(102, 102, 102, 0.03);
    }

    .alert {
      position: fixed;
      top: 25px;
      right: 25px;
      padding: 16px 24px;
      border-radius: var(--radius);
      background-color: var(--success-color);
      color: white;
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
      opacity: 0;
      transition: opacity 0.4s, transform 0.4s;
      z-index: 999;
      font-size: 14px;
      max-width: 350px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .alert.show {
      opacity: 1;
      transform: translateX(0);
    }

    .export-buttons, .backup-restore, .modal-buttons {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      margin-top: 10px;
      justify-content: flex-end;
    }

    .chart-container {
      position: relative;
      height: 280px;
      margin-top: 25px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 12px;
    }

    .loader {
      border: 4px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top: 4px solid var(--accent-mid);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 25px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .btn-delete {
      background-color: #d63031;
      color: white;
      border: none;
      border-radius: 10%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin: 0 auto;
      transition: background-color 0.2s ease, transform 0.2s;
      box-shadow: 0 3px 10px #33445B;
    }

    .btn-delete:hover {
      background-color: #b52c2c;
      transform: scale(1.1);
    }

    .date-header {
      background-color: rgba(102, 102, 102, 0.08);
      padding: 12px 18px;
      margin-top: 30px;
      font-weight: 600;
      color: var(--accent-dark);
      border-radius: var(--radius) var(--radius) 0 0;
      font-size: 16px;
    }

    .date-header:first-child {
      margin-top: 0;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(15px);
      border-radius: var(--radius);
      padding: 25px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      text-align: center;
      border: 1px solid rgba(102, 102, 102, 0.1);
    }

    .modal-title {
      margin-bottom: 20px;
      color: var(--text-color);
      font-weight: 600;
      font-size: 18px;
    }

    .offline-indicator {
      position: fixed;
      bottom: 25px;
      left: 25px;
      background-color: var(--danger-color);
      color: white;
      padding: 12px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: none;
      font-size: 14px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px 0;
    }

    .filter-container input, .filter-container select {
      max-width: 200px;
      padding: 12px 14px;
      font-size: 14px;
    }

    .saldoawal-container {
      margin-top: 15px;
      margin-bottom: 5px;
    }

    .user-info {
      margin-bottom: 15px;
      font-size: 15px;
      color: rgba(0, 0, 0, 0.6);
      padding: 10px;
      background: rgba(102, 102, 102, 0.05);
      border-radius: 8px;
    }

    .pw-section {
      margin-bottom: 15px;
    }

    .logout-btn {
      background: linear-gradient(135deg, #d63031, #b52c2c);
      box-shadow: 0 6px 12px rgba(214, 48, 49, 0.4);
      padding: 12px 24px;
      width: auto;
      margin: 0 auto;
      border-radius: 50px;
    }

    .logout-btn:hover {
      background: linear-gradient(135deg, #b52c2c, #9e2526);
      box-shadow: 0 8px 16px rgba(214, 48, 49, 0.6);
      transform: translateY(-3px);
    }

    .product-item-group {
        display: grid;
        grid-template-columns: 3fr 1.5fr 2fr 0.5fr; /* Product, Qty, Price, Delete Btn */
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
        border: 1px solid var(--border-color);
        padding: 10px;
        border-radius: var(--radius);
        background-color: rgba(255, 255, 255, 0.7);
    }

    .product-item-group label {
        display: none; /* Hide individual labels, use a common label above */
    }

    .product-item-group input,
    .product-item-group select {
        margin-bottom: 0; /* Remove default form-group margin */
    }

    .product-item-group .btn-delete {
        width: 32px;
        height: 32px;
        padding: 0;
        margin: 0;
        font-size: 18px;
        border-radius: 50%; /* Make it round */
        background-color: #d63031;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: none; /* Remove button shadow */
    }

    .product-item-group .btn-delete:hover {
        background-color: #b52c2c;
        transform: scale(1.1);
    }

    .add-product-btn {
        background-color: #00b894;
        margin-top: 10px;
        width: auto;
        padding: 10px 20px;
        border-radius: 8px;
        display: inline-block; /* Allow it to be smaller */
        box-shadow: var(--button-shadow);
    }

    .add-product-btn:hover {
        background-color: #00a383;
        transform: translateY(-3px);
        box-shadow: var(--button-shadow-hover);
    }

    .status-button {
        background-color: #00b894;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        transition: background-color 0.2s ease;
    }

    .status-button.lunas {
        background-color: #00b894;
    }

    .status-button.belum-lunas {
        background-color: #d63031;
    }

    .status-button:hover {
        opacity: 0.8;
    }

    .product-input-section {
        margin-bottom: 20px;
        border: 1px solid rgba(102, 102, 102, 0.15);
        border-radius: var(--radius);
        padding: 15px;
        background: rgba(255, 255, 255, 0.5);
    }

    .product-input-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--accent-dark);
        font-size: 1.2rem;
        border-bottom: 1px solid rgba(102, 102, 102, 0.1);
        padding-bottom: 10px;
    }

    .product-input-section .total-harga-display {
        text-align: right;
        font-size: 1.2em;
        font-weight: 600;
        color: var(--accent-dark);
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px dashed var(--accent-light);
    }

    @media (max-width: 480px) {
        .product-item-group {
            grid-template-columns: 1fr; /* Stack elements on small screens */
            gap: 5px;
        }
        .product-item-group .btn-delete {
            width: 100%;
            border-radius: var(--radius);
        }
    }

/* CSS untk tab-tab ringkasan */
.summary-tabs {
    display: flex;
    justify-content: center; /* Pusatkan tab */
    margin-bottom: 25px;
    background-color: rgba(255, 255, 255, 0.8); /* Background sedikit transparan */
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 10px;
    gap: 10px; /* Jarak antar tombol */
    border: 1px solid rgba(102, 102, 102, 0.1);
}

.summary-tab-button {
    background: none;
    border: none;
    padding: 12px 20px;
    cursor: pointer;
    font-weight: 600;
    color: var(--accent-mid);
    transition: all 0.3s ease;
    border-radius: 8px; /* Sudut sedikit membulat */
    font-size: 1rem;
    flex-grow: 1; /* Agar tombol mengisi ruang */
    text-align: center;
    position: relative; /* Untuk pseudo-element */
    overflow: hidden; /* Untuk efek hover */
}

.summary-tab-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, var(--success-color), #00a383); /* Gradien hijau */
    transform: translateX(-100%);
    transition: transform 0.3s ease-out;
    z-index: -1;
    opacity: 0.1; /* Sedikit transparan */
}

.summary-tab-button.active {
    color: white; /* Teks putih saat aktif */
    background: linear-gradient(45deg, var(--success-color), #00a383); /* Gradien hijau penuh */
    box-shadow: 0 4px 10px rgba(0, 184, 148, 0.3);
    transform: translateY(-2px); /* Sedikit naik */
}

.summary-tab-button:not(.active):hover {
    color: var(--accent-dark); /* Teks lebih gelap saat hover tapi tidak aktif */
    background-color: rgba(102, 102, 102, 0.05); /* Background abu-abu muda saat hover */
    transform: translateY(-2px);
}

.summary-tab-button:not(.active):hover::before {
    transform: translateX(0);
    opacity: 0.2; /* Lebih terlihat saat hover */
}

/* Media query untuk tampilan mobile */
@media (max-width: 600px) {
    .summary-tabs {
        flex-direction: column; /* Tumpuk tombol di layar kecil */
        padding: 10px;
        gap: 8px;
    }
    .summary-tab-button {
        padding: 10px 15px;
        font-size: 0.9rem;
    }
}

    .invoice-status-label {
        position: absolute;
        top: 20px; /* Adjust as needed */
        right: 20px; /* Adjust as needed */
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: bold;
        color: white;
        font-size: 1.1em;
        text-transform: uppercase;
        z-index: 10; /* Ensure it's above other elements */
    }

    .invoice-status-label.lunas {
        background-color: #00b894; /* Green */
    }

    .invoice-status-label.belum-lunas {
        background-color: #d63031; /* Red */
    }

  /* Styling untk halaman autentikasi */
    .auth-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, rgba(102, 102, 102, 0.2), rgba(102, 102, 102, 0.1));
    }

    .auth-card {
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      border-radius: var(--radius);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      padding: 35px;
      width: 90%;
      max-width: 480px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .auth-card h2 {
      font-size: 2.2rem;
      color: var(--accent-dark);
      margin-bottom: 25px;
      font-weight: 700;
    }

    .auth-form-group {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      text-align: left;
    }

    .auth-form-group label {
      width: 30%;
      margin-bottom: 0;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.7);
    }

    .auth-form-group input {
      width: 70%;
      padding: 14px;
      border: 1px solid rgba(102, 102, 102, 0.2);
      border-radius: var(--radius);
      font-size: 16px;
      transition: border 0.3s ease, box-shadow 0.3s ease;
      box-sizing: border-box;
      outline: none;
      background: rgba(255, 255, 255, 0.8);
    }

    .auth-form-group input:focus {
      outline: none;
      border-color: var(--accent-mid);
      box-shadow: 0 0 0 2px rgba(102, 102, 102, 0.2);
    }

    @media (max-width: 400px) {
      .auth-form-group {
        flex-direction: column;
        align-items: flex-start;
      }
      .auth-form-group label {
        width: 100%;
        margin-bottom: 8px;
      }
      .auth-form-group input {
        width: 100%;
      }
    }

    .auth-button {
      background: #1f2937;
      box-shadow: var(--button-shadow);
      color: white;
      border: none;
      padding: 16px 30px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 25px;
      width: 100%;
      display: inline-block;
      box-shadow: 0 12px 19px rgba(0, 0, 0, 0.2);
    }

    .auth-button:hover {
      transform: translateY(-3px);
      background: #1f2937;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
    }

    .auth-button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
    }

    .auth-link {
      color: var(--accent-mid);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      display: inline-block;
      margin-top: 12px;
      font-size: 14px;
    }

    .auth-link:hover {
      color: var(--accent-dark);
    }

    .auth-divider {
      margin: 25px 0;
      display: flex;
      align-items: center;
      color: var(--accent-mid);
      font-size: 14px;
    }

    .auth-divider::before, .auth-divider::after {
      content: "";
      flex: 1;
      border-bottom: 1px solid var(--accent-light);
    }

    .auth-divider::before {
      margin-right: 12px;
    }

    .auth-divider::after {
      margin-left: 12px;
    }

    /* Animasi untk tombol login */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.5); }
      70% { box-shadow: 0 0 0 15px rgba(0, 184, 148, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .auth-button.loading {
      background: transparent;
      border: 2px solid var(--accent-mid);
      color: var(--accent-dark);
      animation: pulse 1.5s infinite;
      cursor: not-allowed;
    }

    .auth-form {
      animation: fadeIn 0.5s ease-out;
    }

    .auth-card {
      animation: fadeIn 0.7s ease-out;
    }
    
    .product-input-section {
        margin-bottom: 20px;
        border: 1px solid rgba(102, 102, 102, 0.15);
        border-radius: var(--radius);
        padding: 15px;
        background: rgba(255, 255, 255, 0.5);
    }

    .product-input-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--accent-dark);
        font-size: 1.2rem;
        border-bottom: 1px solid rgba(102, 102, 102, 0.1);
        padding-bottom: 10px;
    }

    .product-input-section .total-harga-display {
        text-align: right;
        font-size: 1.2em;
        font-weight: 600;
        color: var(--accent-dark);
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px dashed var(--accent-light);
    }

/* CSS untk tab-tab ringkasan */
.summary-tabs {
    display: flex;
    justify-content: center; /* Pusatkan tab */
    margin-bottom: 25px;
    background-color: rgba(255, 255, 255, 0.8); /* Background sedikit transparan */
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 10px;
    gap: 10px; /* Jarak antar tombol */
    border: 1px solid rgba(102, 102, 102, 0.1);
}

.summary-tab-button {
    background: none;
    border: none;
    padding: 12px 20px;
    cursor: pointer;
    font-weight: 600;
    color: var(--accent-mid);
    transition: all 0.3s ease;
    border-radius: 8px; /* Sudut sedikit membulat */
    font-size: 1rem;
    flex-grow: 1; /* Agar tombol mengisi ruang */
    text-align: center;
    position: relative; /* Untuk pseudo-element */
    overflow: hidden; /* Untuk efek hover */
}

.summary-tab-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, var(--success-color), #00a383); /* Gradien hijau */
    transform: translateX(-100%);
    transition: transform 0.3s ease-out;
    z-index: -1;
    opacity: 0.1; /* Sedikit transparan */
}

.summary-tab-button.active {
    color: white; /* Teks putih saat aktif */
    background: linear-gradient(45deg, var(--success-color), #00a383); /* Gradien hijau penuh */
    box-shadow: 0 4px 10px rgba(0, 184, 148, 0.3);
    transform: translateY(-2px); /* Sedikit naik */
}

.summary-tab-button:not(.active):hover {
    color: var(--accent-dark); /* Teks lebih gelap saat hover tapi tidak aktif */
    background-color: rgba(102, 102, 102, 0.05); /* Background abu-abu muda saat hover */
    transform: translateY(-2px);
}

.summary-tab-button:not(.active):hover::before {
    transform: translateX(0);
    opacity: 0.2; /* Lebih terlihat saat hover */
}

/* Media query untuk tampilan mobile */
@media (max-width: 600px) {
    .summary-tabs {
        flex-direction: column; /* Tumpuk tombol di layar kecil */
        padding: 10px;
        gap: 8px;
    }
    .summary-tab-button {
        padding: 10px 15px;
        font-size: 0.9rem;
    }
}

    .invoice-status-label {
        position: absolute;
        top: 20px; /* Adjust as needed */
        right: 20px; /* Adjust as needed */
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: bold;
        color: white;
        font-size: 1.1em;
        text-transform: uppercase;
        z-index: 10; /* Ensure it's above other elements */
    }

    .invoice-status-label.lunas {
        background-color: #00b894; /* Green */
    }

    .invoice-status-label.belum-lunas {
        background-color: #d63031; /* Red */
    }

    /* Styling untuk tombol Admin Produk */
    .admin-button {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background-color: var(--accent-dark);
        color: white;
        width: 50px; /* Ukuran lebih kecil */
        height: 50px; /* Ukuran lebih kecil */
        border-radius: 50%; /* Bentuk bulat */
        font-weight: 600;
        box-shadow: var(--shadow);
        cursor: pointer;
        z-index: 999;
        transition: all 0.3s ease;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em; /* Ukuran ikon/teks di dalam tombol */
        line-height: 1; /* Untuk centering vertikal */
        padding: 0; /* Hapus padding default */
    }

    .admin-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.2);
    }

    /* Styling untuk modal Admin */
    .admin-modal-content {
        max-width: 600px;
        padding: 30px;
    }

    .admin-modal-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--accent-light);
    }

    .admin-modal-tab-button {
        flex: 1;
        padding: 12px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: var(--accent-mid);
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
    }

    .admin-modal-tab-button.active {
        color: var(--accent-dark);
        border-bottom-color: var(--accent-dark);
    }

    .admin-modal-tab-button:hover:not(.active) {
        color: var(--text-color);
    }

    .admin-modal-tab-content {
        display: none;
    }

    .admin-modal-tab-content.active {
        display: block;
    }

    .admin-modal-list {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 20px;
        border: 1px solid var(--accent-light);
        border-radius: var(--radius);
        padding: 10px;
    }

    .admin-modal-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px dashed var(--accent-light);
    }

    .admin-modal-list-item:last-child {
        border-bottom: none;
    }

    .admin-modal-list-item span {
        flex-grow: 1;
        text-align: left;
        padding-right: 10px;
    }

    .admin-modal-list-item .actions button {
        margin-left: 10px;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8em;
        width: auto;
        margin-top: 0;
        margin-bottom: 0;
    }

    .admin-modal-list-item .actions .btn-edit {
        background-color: #007bff; /* Blue for edit */
    }

    .admin-modal-list-item .actions .btn-edit:hover {
        background-color: #0056b3;
    }

    .admin-modal-list-item .actions .btn-delete {
        background-color: #d63031; /* Red for delete */
    }

    .admin-modal-list-item .actions .btn-delete:hover {
        background-color: #b52c2c;
    }

    .admin-modal-form {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--accent-light);
    }

    .admin-modal-form .form-group {
        margin-bottom: 15px;
    }

    .admin-modal-form button {
        width: auto;
        padding: 10px 20px;
        margin-top: 10px;
    }

    .admin-modal-form .btn-add {
        background-color: var(--success-color);
    }

    .admin-modal-form .btn-add:hover {
        background-color: #00a383;
    }

    .admin-modal-form .btn-update {
        background-color: #007bff;
    }

    .admin-modal-form .btn-update:hover {
        background-color: #0056b3;
    }

    .admin-modal-form .btn-cancel {
        background-color: var(--accent-mid);
        margin-left: 10px;
    }

    .admin-modal-form .btn-cancel:hover {
        background-color: #555;
    }

    .product-item-group .product-name-display {
        font-weight: 500;
        color: var(--accent-dark);
    }

    .product-item-group .product-price-display {
        color: var(--accent-mid);
        font-size: 0.9em;
    }

  </style>
</head>
<body>
  <!-- Halaman autentikasi -->
  <div id="authContainer" class="auth-container">
    <div class="auth-card">
      <h2>Selamat Datang di FemmeiaCloth Finance Tracker</h2>
      <div id="loginForm" class="auth-form">
        <div class="auth-form-group">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="Masukkan Email" required>
        </div>
        <div class="auth-form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Masukkan Password" required>
        </div>
        <button id="btnLogin" type="button" class="auth-button">Login</button>
        <p style="text-align: center; margin-top: 15px;">
          <a href="#" id="forgotPassword" class="auth-link">Lupa Password?</a>
        </p>
        <div class="auth-divider">atau</div>
        <p style="text-align: center;">
          <a href="#" id="showRegister" class="auth-link">Daftar Akun Baru</a>
        </p>
      </div>
      <div id="registerForm" style="display: none;" class="auth-form">
        <div class="auth-form-group">
          <label for="regEmail">Email</label>
          <input type="email" id="regEmail" placeholder="Masukkan Email" required>
        </div>
        <div class="auth-form-group">
          <label for="regPassword">Password</label>
          <input type="password" id="regPassword" placeholder="Masukkan Password (min. 6 karakter)" required>
        </div>
        <div class="auth-form-group">
          <label for="confirmPassword">Konfirmasi</label>
          <input type="password" id="confirmPassword" placeholder="Konfirmasi Password" required>
        </div>
        <button id="btnRegister" type="button" class="auth-button">Daftar</button>
        <p style="text-align: center; margin-top: 15px;">
          <a href="#" id="showLogin" class="auth-link">Sudah punya akun? Login</a>
        </p>
      </div>
      <div id="resetPasswordForm" style="display: none;" class="auth-form">
        <div class="auth-form-group">
          <label for="resetEmail">Email</label>
          <input type="email" id="resetEmail" placeholder="Masukkan Email untuk Reset Password" required>
        </div>
        <button id="btnResetPassword" type="button" class="auth-button">Kirim Link Reset Password</button>
        <p style="text-align: center; margin-top: 15px;">
          <a href="#" id="showLoginFormReset" class="auth-link">Kembali ke Login</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Halaman aplikasi utama -->
  <div id="appContainer" class="container" style="display: none;">
    <!-- Scattered Shapes Background -->
    <div class="scattered-shapes" aria-hidden="true">
      <div class="scattered-shape circle1"></div>
      <div class="scattered-shape circle2"></div>
      <div class="scattered-shape circle3"></div>
      <div class="scattered-shape circle4"></div>
      <div class="scattered-shape square1"></div>
      <div class="scattered-shape square2"></div>
      <div class="scattered-shape triangle1"></div>
      <div class="scattered-shape triangle2"></div>
      <div class="scattered-shape diamond1"></div>
      <div class="scattered-shape diamond2"></div>
    </div>

    <header>
      <h1>FemmeiaCloth Finance Tracker</h1>
    </header>

    <div class="main-content">
      <div class="card">
        <h2>Input Transaksi</h2>
        <form id="formTransaksi" autocomplete="off">
          <div class="form-group" style="position: relative;">
            <label for="pembeli">Nama Pelanggan/Pembeli</label>
            <input type="text" id="pembeli" placeholder="Nama Pelanggan (Opsional)">
          </div>

          <div class="product-input-section">
            <h3>Detail Produk</h3>
            <div id="productItemsContainer">
              <!-- Product items will be added here dynamically -->
            </div>
            <button type="button" id="addProductItemBtn" class="add-product-btn">Tambah Produk</button>
            <div id="overallTotalDisplay" class="total-harga-display">Total Transaksi: Rp 0</div>
          </div>

          <div class="form-group">
            <label for="jenis">Jenis Transaksi</label>
            <select id="jenis" required>
              <option value="">Pilih Jenis Transaksi</option>
              <option value="pemasukan">Pemasukan (Penjualan)</option>
              <option value="pengeluaran">Pengeluaran (Biaya)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="statusPembayaran">Status Pembayaran</label>
            <select id="statusPembayaran" required>
              <option value="lunas">Lunas</option>
              <option value="belumLunas">Belum Lunas (Piutang)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="kategori">Kategori</label>
            <select id="kategori" required>
              <option value="">Pilih Kategori</option>
              <option value="Penjualan Online">Penjualan Online</option>
              <option value="Penjualan Offline">Penjualan Offline</option>
              <option value="Bahan Baku">Bahan Baku (Kain, label, aksesoris hijab)</option>
              <option value="Operasional">Operasional</option>
              <option value="Promosi">Promosi</option>
              <option value="Lainnya">Lainnya</option>
            </select>
          </div>
          <div class="form-group">
            <label for="catatan">Catatan (Opsional)</label>
            <textarea id="catatan" rows="3"></textarea>
          </div>
          <button type="submit">Simpan Transaksi</button>
        </form>
        <div class="saldoawal-container">
            <label for="saldoAwal">Saldo Awal Bulan (Rp):</label>
            <input type="number" id="saldoAwal" min="0" placeholder="Misal: 5000000" style="margin-bottom:8px;"/>
            <button type="button" id="simpanSaldoAwal">Simpan Saldo Awal</button>
        </div>
      </div>

      <div class="card">
        <h2>Ringkasan</h2>
        <div class="summary-tabs">
            <button class="summary-tab-button active" data-period="all">ALL</button>
            <button class="summary-tab-button" data-period="weekly">Minggu Ini</button>
            <button class="summary-tab-button" data-period="monthly">Bulan Ini</button>
        </div>
        <div id="summaryContent">
            <div class="summary-container">
                <div class="summary-box income-box">
                    <h3>Total Pemasukan</h3>
                    <p id="totalMasuk">Rp 0</p>
                </div>
                <div class="summary-box expense-box">
                    <h3>Total Pengeluaran</h3>
                    <p id="totalKeluar">Rp 0</p>
                </div>
                <div class="summary-box">
                    <h3>Total Piutang</h3>
                    <p id="totalPiutang">Rp 0</p>
                </div>
                <div class="summary-box">
                    <h3>Saldo Bersih</h3>
                    <p id="saldoBersih">Rp 0</p>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="grafik"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="grafikBulanan"></canvas>
            </div>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <h2>Generate Invoice</h2>
        <div class="form-group">
          <label for="selectTransaction">Pilih Transaksi</label>
          <select id="selectTransaction" required>
            <option value="">-- Pilih Transaksi untuk Invoice --</option>
          </select>
        </div>
        <div id="invoicePreview" style="display: none;">
          <div class="invoice-container">
            <!-- Invoice Status Label will be inserted here dynamically -->
            <div class="invoice-header">
              <img src="https://raw.githubusercontent.com/gunadizz/FemmeiaCloth/refs/heads/main/IMG_3593.jpeg" alt="Logo FemmeiaCloth, merepresentasikan the brand identity" style="width: 80px; height: auto; margin-bottom: 10px;" />
              <h1>FemmeiaCloth</h1>
              <p>Tamalanrea, Makassar, Indonesia</p>
              <p>Email: femmeiacloth@gmail.com | Phone: +6285341899229</p>
            </div>

            <!-- Invoice Title & Date -->
            <div class="invoice-details">
              <h3>INVOICE</h3>
              <div style="text-align: right;">
                <p><strong>Tanggal:</strong> <span id="invoiceDate">--</span></p>
                <p><strong>Nomor Invoice:</strong> <span id="invoiceNumber">--</span></p>
              </div>
            </div>

            <!-- Bill To Section -->
            <div class="invoice-buyer">
              <h4>Ditagih Kepada:</h4>
              <p><span id="invoiceBuyer">Pelanggan</span></p>
            </div>

            <!-- Items Table -->
            <table class="invoice-table">
              <thead>
                <tr>
                  <th style="width: 5%;">No.</th>
                  <th style="width: 45%;">Produk</th>
                  <th style="width: 10%; text-align: center;">Jumlah</th>
                  <th style="width: 20%; text-align: right;">Harga Satuan</th>
                  <th style="width: 25%; text-align: right;">Subtotal</th>
                </tr>
              </thead>
              <tbody id="invoiceItems">
                <!-- Item akan diisi secara dinamis melalui JavaScript -->
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="4" style="text-align: right;">Total:</td>
                  <td style="text-align: right;"><span id="invoiceTotal">Rp 0</span></td>
                </tr>
              </tfoot>
            </table>

            <!-- Thank You Note -->
            <div class="invoice-thankyou">
              <p>Terima kasih atas kepercayaan Anda kepada FemmeiaCloth.</p>
              <p>Kami berharap dapat melayani Anda kembali di masa depan.</p>
            </div>

            <!-- Footer -->
            <div class="invoice-footer">
              <p>Invoice ini dibuat pada <span id="printDate">--</span></p>
            </div>
          </div>
          <button id="btnExportInvoicePDF" class="btn-print">Export Invoice ke PDF</button>
        </div>
        <p id="noInvoiceMessage" style="text-align: center; color: rgba(0, 0, 0, 0.6); margin-top: 20px;">Pilih transaksi untuk melihat preview invoice.</p>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <h2>Riwayat Transaksi</h2>
        <div class="backup-restore">
          <button id="backupJSON" class="btn-export">Backup JSON</button>
          <input type="file" id="restoreJSON" accept=".json" style="display:none;">
          <button id="restoreJSONBtn" class="btn-export">Restore JSON</button>
        </div>
        <div class="filter-container">
          <input type="text" id="filterProduk" placeholder="Cari Produk/Catatan">
          <select id="filterJenis">
            <option value="">Semua Jenis</option>
            <option value="pemasukan">Pemasukan</option>
            <option value="pengeluaran">Pengeluaran</option>
          </select>
          <select id="filterKategori">
            <option value="">Semua Kategori</option>
            <option value="Penjualan Online">Penjualan Online</option>
            <option value="Penjualan Offline">Penjualan Offline</option>
            <option value="Bahan Baku">Bahan Baku</option>
            <option value="Operasional">Operasional</option>
            <option value="Promosi">Promosi</option>
            <option value="Lainnya">Lainnya</option>
          </select>
          <select id="filterStatusPembayaran">
            <option value="">Semua Status</option>
            <option value="lunas">Lunas</option>
            <option value="belumLunas">Belum Lunas</option>
          </select>
          <input type="date" id="filterTglMulai">
          <span style="font-size:13px;color:#888;">s/d</span>
          <input type="date" id="filterTglAkhir">
          <button id="btnFilter" type="button" style="width:auto;">Cari</button>
          <button id="btnResetFilter" type="button" style="width:auto;">Reset</button>
        </div>
        <div class="export-buttons">
          <button id="exportCSV" class="btn-export">Export CSV</button>
          <button id="exportPDF" class="btn-export">Export PDF</button>
        </div>
        <div class="table-container" id="transactionTableContainer"></div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <h2>Manajemen Akun</h2>
        <div class="user-info" id="userInfo"></div>
        <div class="pw-section">
          <input type="password" id="newPassword" placeholder="Password Baru">
          <button id="btnChangePassword">Ganti Password</button>
        </div>
        <button class="logout-btn" id="btnLogout">Logout</button>
      </div>
    </div>
  </div>

  <div id="loginAlert" class="alert"></div>
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">Yakin ingin menghapus transaksi ini?</h3>
      <div class="modal-buttons">
        <button style="background:#000;color:#fff;box-shadow:none;width:auto;" id="cancelDelete" class="btn-cancel">Batal</button>
        <button style="width:auto;" id="confirmDelete" class="btn-confirm">Hapus</button>
      </div>
    </div>
  </div>
  <div id="offlineIndicator" class="offline-indicator">
    Anda sedang offline. Beberapa fitur mungkin tidak tersedia.
  </div>

  <!-- Tombol Admin Produk -->
  <button id="adminProductBtn" class="admin-button">⚙️</button>

  <!-- Modal Admin Produk -->
  <div id="adminModal" class="modal">
    <div class="modal-content admin-modal-content">
      <h3 class="modal-title">Manajemen Produk & Kategori</h3>
      <div class="admin-modal-tabs">
        <button class="admin-modal-tab-button active" data-tab="kategori">Kategori</button>
        <button class="admin-modal-tab-button" data-tab="produk">Produk</button>
      </div>

      <div id="kategoriTabContent" class="admin-modal-tab-content active">
        <div class="admin-modal-form">
          <div class="form-group">
            <label for="inputKategori">Nama Kategori</label>
            <input type="text" id="inputKategori" placeholder="Contoh: Hijab">
          </div>
          <button id="addKategoriBtn" class="btn-add">Tambah Kategori</button>
        </div>
        <div class="admin-modal-list">
          <h4>Daftar Kategori:</h4>
          <div id="kategoriList">
            <!-- Kategori items will be loaded here -->
          </div>
        </div>
      </div>

      <div id="produkTabContent" class="admin-modal-tab-content">
        <div class="admin-modal-form">
          <input type="hidden" id="editProductId">
          <div class="form-group">
            <label for="inputNamaProduk">Nama Produk</label>
            <input type="text" id="inputNamaProduk" placeholder="Contoh: Hijab Paris">
          </div>
          <div class="form-group">
            <label for="inputHargaProduk">Harga</label>
            <input type="number" id="inputHargaProduk" min="0" placeholder="Contoh: 35000">
          </div>
          <div class="form-group">
            <label for="selectKategoriProduk">Kategori</label>
            <select id="selectKategoriProduk">
              <option value="">Pilih Kategori</option>
              <!-- Kategori options will be loaded here -->
            </select>
          </div>
          <button id="addProdukBtn" class="btn-add">Tambah Produk</button>
          <button id="updateProdukBtn" class="btn-update" style="display:none;">Update Produk</button>
          <button id="cancelEditProdukBtn" class="btn-cancel" style="display:none;">Batal</button>
        </div>
        <div class="admin-modal-list">
          <h4>Daftar Produk:</h4>
          <div id="produkList">
            <!-- Produk items will be loaded here -->
          </div>
        </div>
      </div>
      <div class="modal-buttons" style="justify-content: center;">
        <button id="closeAdminModalBtn" class="btn-cancel">Tutup</button>
      </div>
    </div>
  </div>


  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, enableIndexedDbPersistence, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, updatePassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyDVRX1ExILdGhsqsaOcmyOix00PZYMHh04",
      authDomain: "femmeiadev.firebaseapp.com",
      projectId: "femmeiadev",
      storageBucket: "femmeiadev.firebasestorage.app",
      messagingSenderId: "214287674772",
      appId: "1:214287674772:web:4c455b47d3dec899687381",
      measurementId: "G-0ER8S6EFL2"
    };


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code === 'failed-precondition') {
        console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
      } else if (err.code === 'unimplemented') {
        console.log('The current browser does not support all of the features required to enable persistence');
      }
    });

    // UI Helper
    function showAlert(message, isError = false) {
      const alert = document.getElementById("loginAlert");
      alert.textContent = message;
      alert.style.backgroundColor = isError ? "var(--danger-color)" : "var(--success-color)";
      alert.classList.add("show");
      setTimeout(() => { alert.classList.remove("show"); }, 3000);
    }
    function formatRupiah(angka) {
      return "Rp " + new Intl.NumberFormat('id-ID').format(angka);
    }
    function formatDateIndonesian(date) {
      const options = { day: 'numeric', month: 'long', year: 'numeric' };
      return date.toLocaleDateString('id-ID', options);
    }
    function groupTransactionsByDate(transactions) {
      const grouped = {};
      transactions.forEach(transaction => {
        const dateStr = formatDateIndonesian(transaction.tanggal);
        if (!grouped[dateStr]) grouped[dateStr] = [];
        grouped[dateStr].push(transaction);
      });
      return grouped;
    }
    // Kategori List
    const kategoriList = [
      "Penjualan Online", "Penjualan Offline", "Bahan Baku", "Operasional", "Promosi", "Lainnya"
    ];

    const productItemsContainer = document.getElementById("productItemsContainer");
    const addProductItemBtn = document.getElementById("addProductItemBtn");
    const overallTotalDisplay = document.getElementById("overallTotalDisplay");

    function createProductItemRow() {
        const productItemGroup = document.createElement("div");
        productItemGroup.classList.add("product-item-group");

        const productSelect = document.createElement("select");
        productSelect.classList.add("product-select");
        productSelect.required = true;
        productSelect.innerHTML = '<option value="">Pilih Produk</option>';
        // Populate product options from Firestore
        loadProductsToDropdown(productSelect);

        const quantityInput = document.createElement("input");
        quantityInput.type = "number";
        quantityInput.classList.add("quantity-input");
        quantityInput.min = "1";
        quantityInput.value = "1";
        quantityInput.required = true;
        quantityInput.placeholder = "Jumlah";

        const priceDisplay = document.createElement("input"); // Changed to input for display
        priceDisplay.type = "text";
        priceDisplay.classList.add("item-price-display");
        priceDisplay.readOnly = true;
        priceDisplay.value = formatRupiah(0); // Initial display
        priceDisplay.placeholder = "Harga Satuan";

        const deleteButton = document.createElement("button");
        deleteButton.type = "button";
        deleteButton.classList.add("btn-delete");
        deleteButton.textContent = "X";
        deleteButton.onclick = () => {
            productItemGroup.remove();
            updateOverallTotalDisplay(); // Update total after removing a row
        };

        productItemGroup.appendChild(productSelect);
        productItemGroup.appendChild(quantityInput);
        productItemGroup.appendChild(priceDisplay);
        productItemGroup.appendChild(deleteButton);
        productItemsContainer.appendChild(productItemGroup);

        // Event listeners for changes
        productSelect.addEventListener("change", () => {
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const pricePerUnit = selectedOption.dataset.price ? parseInt(selectedOption.dataset.price) : 0;
            priceDisplay.value = formatRupiah(pricePerUnit); // Update individual price display
            updateOverallTotalDisplay();
        });
        quantityInput.addEventListener("input", updateOverallTotalDisplay);

        updateOverallTotalDisplay(); // Initial update for the new row
    }

    addProductItemBtn.addEventListener("click", createProductItemRow);

    // Initial product item row on load
    createProductItemRow();

    function updateOverallTotalDisplay() {
        let totalOverall = 0;
        const productItemRows = productItemsContainer.querySelectorAll(".product-item-group");

        productItemRows.forEach(row => {
            const productSelect = row.querySelector(".product-select");
            const quantityInput = row.querySelector(".quantity-input");
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const pricePerUnit = selectedOption.dataset.price ? parseInt(selectedOption.dataset.price) : 0;
            const quantity = parseInt(quantityInput.value) || 0;

            totalOverall += (pricePerUnit * quantity);
        });

        overallTotalDisplay.textContent = `Total Transaksi: ${formatRupiah(totalOverall)}`;
    }

    // Saldo Awal
    let saldoAwal = 0;
    async function loadSaldoAwal() {
      try {
        const now = new Date();
        const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
        const saldoDoc = await getDoc(doc(db, "saldoAwal", ym));
        saldoAwal = saldoDoc.exists() ? saldoDoc.data().saldo : 0;
        document.getElementById("saldoAwal").value = saldoAwal || "";
      } catch {}
    }
    document.getElementById("simpanSaldoAwal").onclick = async function() {
      const val = parseInt(document.getElementById("saldoAwal").value, 10) || 0;
      const now = new Date();
      const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
      try {
        await setDoc(doc(db, "saldoAwal", ym), { saldo: val });
        saldoAwal = val;
        renderSummary();
        showAlert("Saldo awal berhasil disimpan!");
      } catch (e) {
        showAlert("Gagal menyimpan saldo awal: " + e.message, true);
      }
    };

    // Firebase Transaction Logic
    let transactions = [];
    let filteredTransactions = [];
    let currentSummaryPeriod = 'all'; // 'all', 'weekly', 'monthly'

    // Auth State Listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Pengguna sudah login, tampilkan aplikasi utama
        document.getElementById("authContainer").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        showUserInfo();
        loadSaldoAwal();
        loadTransactions();
        loadKategoriProduk(); // Load categories for admin modal
        loadProduk(); // Load products for admin modal
      } else {
        // Pengguna belum login, tampilkan halaman login
        document.getElementById("authContainer").style.display = "flex";
        document.getElementById("appContainer").style.display = "none";
      }
    });

    // Login Function
    document.getElementById("btnLogin").onclick = async function() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const loginBtn = document.getElementById("btnLogin");
      if (!email || !password) {
        showAlert("Email dan Password harus diisi!", true);
        return;
      }
      loginBtn.classList.add("loading");
      loginBtn.disabled = true;
      loginBtn.textContent = "Memproses...";
      try {
        await signInWithEmailAndPassword(auth, email, password);
        showAlert("Berhasil login!");
        setTimeout(() => {
          loginBtn.classList.remove("loading");
          loginBtn.disabled = false;
          loginBtn.textContent = "Login";
        }, 1500);
      } catch (error) {
        showAlert("Gagal login: " + error.message, true);
        loginBtn.classList.remove("loading");
        loginBtn.disabled = false;
        loginBtn.textContent = "Login";
      }
    };

    // Register Function
    document.getElementById("btnRegister").onclick = async function() {
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value.trim();
      const confirmPassword = document.getElementById("confirmPassword").value.trim();
      const registerBtn = document.getElementById("btnRegister");
      if (!email || !password || !confirmPassword) {
        showAlert("Semua field harus diisi!", true);
        return;
      }
      if (password !== confirmPassword) {
        showAlert("Password dan konfirmasi password tidak cocok!", true);
        return;
      }
      if (password.length < 6) {
        showAlert("Password minimal 6 karakter!", true);
        return;
      }
      registerBtn.classList.add("loading");
      registerBtn.disabled = true;
      registerBtn.textContent = "Mendaftar...";
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await sendEmailVerification(userCredential.user);
        showAlert("Berhasil mendaftar! Silakan cek email Anda untuk verifikasi.");
        setTimeout(() => {
          document.getElementById("registerForm").style.display = "none";
          document.getElementById("loginForm").style.display = "block";
          registerBtn.classList.remove("loading");
          registerBtn.disabled = false;
          registerBtn.textContent = "Daftar";
        }, 1500);
      } catch (error) {
        showAlert("Gagal mendaftar: " + error.message, true);
        registerBtn.classList.remove("loading");
        registerBtn.disabled = false;
        registerBtn.textContent = "Daftar";
      }
    };

    // Reset Password Function
    document.getElementById("btnResetPassword").onclick = async function() {
      const email = document.getElementById("resetEmail").value.trim();
      const resetBtn = document.getElementById("btnResetPassword");
      if (!email) {
        showAlert("Email harus diisi!", true);
        return;
      }
      resetBtn.classList.add("loading");
      resetBtn.disabled = true;
      resetBtn.textContent = "Mengirim...";
      try {
        await sendPasswordResetEmail(auth, email);
        showAlert("Link reset password telah dikirim ke email Anda!");
        setTimeout(() => {
          document.getElementById("resetPasswordForm").style.display = "none";
          document.getElementById("loginForm").style.display = "block";
          resetBtn.classList.remove("loading");
          resetBtn.disabled = false;
          resetBtn.textContent = "Kirim Link Reset Password";
        }, 1500);
      } catch (error) {
        showAlert("Gagal mengirim link reset: " + error.message, true);
        resetBtn.classList.remove("loading");
        resetBtn.disabled = false;
        resetBtn.textContent = "Kirim Link Reset Password";
      }
    };

    // Toggle between login, register, and reset password forms
    document.getElementById("showRegister").onclick = function() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("registerForm").style.display = "block";
    };
    document.getElementById("showLogin").onclick = function() {
      document.getElementById("registerForm").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
    };
    document.getElementById("forgotPassword").onclick = function() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("resetPasswordForm").style.display = "block";
    };
    document.getElementById("showLoginFormReset").onclick = function() {
      document.getElementById("resetPasswordForm").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
    };

    // Hitung saldo pemasukan berjalan (pengeluaran mengurangi pemasukan)
    function computeSummaryFromList(list) {
        let pemasukan = 0, pengeluaran = 0, piutang = 0;
        list.sort((a, b) => a.tanggal - b.tanggal);
        list.forEach(tx => {
            if (tx.jenis === "pemasukan") {
                if (tx.statusPembayaran === "lunas") {
                    pemasukan += tx.total;
                } else { // belumLunas
                    piutang += tx.total;
                }
            } else { // pengeluaran
                pengeluaran += tx.total;
            }
        });
        return { pemasukan, pengeluaran, piutang };
    }

    // Filter
    const filterState = {
      produk: "",
      jenis: "",
      kategori: "",
      statusPembayaran: "",
      tglMulai: "",
      tglAkhir: ""
    };
    document.getElementById("btnFilter").onclick = function() {
      filterState.produk = document.getElementById("filterProduk").value.trim().toLowerCase();
      filterState.jenis = document.getElementById("filterJenis").value;
      filterState.kategori = document.getElementById("filterKategori").value;
      filterState.statusPembayaran = document.getElementById("filterStatusPembayaran").value;
      filterState.tglMulai = document.getElementById("filterTglMulai").value;
      filterState.tglAkhir = document.getElementById("filterTglAkhir").value;
      renderTransactionTable();
    };
    document.getElementById("btnResetFilter").onclick = function() {
      document.getElementById("filterProduk").value = "";
      document.getElementById("filterJenis").value = "";
      document.getElementById("filterKategori").value = "";
      document.getElementById("filterStatusPembayaran").value = "";
      document.getElementById("filterTglMulai").value = "";
      document.getElementById("filterTglAkhir").value = "";
      filterState.produk = "";
      filterState.jenis = "";
      filterState.kategori = "";
      filterState.statusPembayaran = "";
      filterState.tglMulai = "";
      filterState.tglAkhir = "";
      renderTransactionTable();
    };

    function filterTransactions() {
      let list = [...transactions];
      if (filterState.produk) {
        const val = filterState.produk;
        list = list.filter(tx =>
          (tx.items && tx.items.some(item => item.namaProduk.toLowerCase().includes(val))) ||
          (tx.produk && tx.produk.toLowerCase().includes(val)) || // Fallback for old data
          (tx.catatan && tx.catatan.toLowerCase().includes(val))
        );
      }
      if (filterState.jenis) list = list.filter(tx => tx.jenis === filterState.jenis);
      if (filterState.kategori) list = list.filter(tx => tx.kategori === filterState.kategori);
      if (filterState.statusPembayaran) list = list.filter(tx => tx.statusPembayaran === filterState.statusPembayaran);
      if (filterState.tglMulai) {
        const tglMulai = new Date(filterState.tglMulai);
        list = list.filter(tx => tx.tanggal >= tglMulai);
      }
      if (filterState.tglAkhir) {
        const tglAkhir = new Date(filterState.tglAkhir);
        tglAkhir.setHours(23,59,59,999);
        list = list.filter(tx => tx.tanggal <= tglAkhir);
      }
      return list;
    }

    // Load
    async function loadTransactions() {
      try {
        const q = query(collection(db, "transactions"), orderBy("tanggal", "asc"));
        const querySnapshot = await getDocs(q);
        transactions = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          // Adapt old data format to new 'items' array format
          if (data.produk && !data.items) {
              data.items = [{
                  namaProduk: data.produk,
                  jumlah: data.jumlah || 1,
                  hargaSatuan: data.harga || (data.total / (data.jumlah || 1)) // Calculate hargaSatuan if not present
              }];
              // Remove old single product fields if they exist
              delete data.produk;
              delete data.jumlah;
              delete data.harga;
          }
          transactions.push({
            id: doc.id,
            ...data,
            tanggal: data.tanggal.toDate() // Convert timestamp to Date object
          });
        });
        renderSummary();
        renderTransactionTable();
        renderInvoiceDropdown();
      } catch (error) {
        showAlert("Gagal memuat transaksi: " + error.message, true);
      }
    }

    // Render
    function renderSummary() {
        let currentTransactions = [];
        const now = new Date();

        if (currentSummaryPeriod === 'all') {
            currentTransactions = transactions;
        } else if (currentSummaryPeriod === 'weekly') {
            const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            const endOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 6, 23, 59, 59, 999);
            currentTransactions = transactions.filter(tx => tx.tanggal >= startOfWeek && tx.tanggal <= endOfWeek);
        } else if (currentSummaryPeriod === 'monthly') {
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            currentTransactions = transactions.filter(tx => tx.tanggal >= startOfMonth && tx.tanggal <= endOfMonth);
        }

        const { pemasukan, pengeluaran, piutang } = computeSummaryFromList(currentTransactions);
        document.getElementById("totalMasuk").textContent = formatRupiah(pemasukan);
        document.getElementById("totalKeluar").textContent = formatRupiah(pengeluaran);
        document.getElementById("totalPiutang").textContent = formatRupiah(piutang);
        const saldoBersih = (saldoAwal || 0) + pemasukan - pengeluaran - piutang;
        document.getElementById("saldoBersih").textContent = formatRupiah(saldoBersih);

        renderChart(pemasukan, pengeluaran, piutang);
        renderMonthlyChart();
    }

    // Summary Tab Buttons
    document.querySelectorAll('.summary-tab-button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.summary-tab-button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            currentSummaryPeriod = this.dataset.period;
            renderSummary();
        });
    });


    function renderTransactionTable() {
      filteredTransactions = filterTransactions();
      const container = document.getElementById("transactionTableContainer");
      container.innerHTML = "";
      if (filteredTransactions.length === 0) {
        container.innerHTML = `<p style="text-align: center; padding: 20px;">Belum ada data transaksi</p>`;
        return;
      }

      const grouped = groupTransactionsByDate(filteredTransactions.slice().sort((a, b) => b.tanggal - a.tanggal));
      for (const [dateStr, dateTransactions] of Object.entries(grouped)) {
        const dateHeader = document.createElement("div");
        dateHeader.className = "date-header";
        dateHeader.textContent = dateStr;
        container.appendChild(dateHeader);

        const table = document.createElement("table");
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Produk</th>
                    <th>Pembeli</th>
                    <th>Jumlah</th>
                    <th>Harga Satuan</th>
                    <th>Total</th>
                    <th>Jenis</th>
                    <th>Status</th>
                    <th>Kategori</th>
                    <th>Catatan</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");
        dateTransactions.forEach(tx => {
            // Safely get product names and total quantity/price for display
            const productNames = tx.items ? tx.items.map(item => item.namaProduk).join(', ') : tx.produk || 'N/A';
            const totalQuantity = tx.items ? tx.items.reduce((sum, item) => sum + item.jumlah, 0) : tx.jumlah || 0;
            const totalHargaSatuanDisplay = tx.items ? formatRupiah(tx.items.reduce((sum, item) => sum + item.hargaSatuan, 0) / tx.items.length || 0) : formatRupiah(tx.harga || 0); // Avg or single price

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${productNames}</td>
                <td>${tx.pembeli || "-"}</td>
                <td>${totalQuantity}</td>
                <td>${totalHargaSatuanDisplay}</td>
                <td>${formatRupiah(tx.total)}</td>
                <td>${tx.jenis === "pemasukan" ? "Pemasukan" : "Pengeluaran"}</td>
                <td>
                    <button class="status-button ${tx.statusPembayaran === 'lunas' ? 'lunas' : 'belum-lunas'}" data-id="${tx.id}" data-status="${tx.statusPembayaran}">
                        ${tx.statusPembayaran === 'lunas' ? 'Lunas' : 'Belum Lunas'}
                    </button>
                </td>
                <td>${tx.kategori || "-"}</td>
                <td>${tx.catatan || "-"}</td>
                <td>
                    <button class="btn-delete" data-id="${tx.id}">X</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        container.appendChild(table);
      }
      document.querySelectorAll(".btn-delete").forEach(button => {
        button.addEventListener("click", function() {
          const transactionId = this.dataset.id;
          showDeleteConfirmation(transactionId);
        });
      });

      document.querySelectorAll(".status-button").forEach(button => {
        button.addEventListener("click", async function() {
          const transactionId = this.dataset.id;
          const currentStatus = this.dataset.status;
          const newStatus = currentStatus === "lunas" ? "belumLunas" : "lunas";

          try {
            await updateDoc(doc(db, "transactions", transactionId), {
              statusPembayaran: newStatus
            });
            showAlert("Status pembayaran berhasil diperbarui!");
            loadTransactions(); // Reload to reflect changes
          } catch (error) {
            showAlert("Gagal memperbarui status: " + error.message, true);
          }
        });
      });
    }

    // Fungsi untuk mengisi dropdown produk di form transaksi
    async function loadProductsToDropdown(selectElement) {
        selectElement.innerHTML = '<option value="">Pilih Produk</option>';
        try {
            const q = query(collection(db, "produk"), orderBy("nama", "asc"));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const option = document.createElement("option");
                option.value = doc.id; // Use doc.id as value
                option.textContent = `${data.nama} (${formatRupiah(data.harga)})`;
                option.dataset.price = data.harga; // Store price in dataset
                selectElement.appendChild(option);
            });
        } catch (error) {
            console.error("Error loading products for dropdown:", error);
            showAlert("Gagal memuat daftar produk.", true);
        }
    }

    // Form submit
    document.getElementById("formTransaksi").addEventListener("submit", async function(e) {
      e.preventDefault();

      const pembeli = document.getElementById("pembeli").value.trim();
      const jenis = document.getElementById("jenis").value;
      const statusPembayaran = document.getElementById("statusPembayaran").value;
      const kategori = document.getElementById("kategori").value;
      const catatan = document.getElementById("catatan").value.trim();
      const tanggal = new Date();

      const productItemRows = productItemsContainer.querySelectorAll(".product-item-group");
      const items = [];
      let totalTransaksi = 0;

      let isValid = true;
      productItemRows.forEach(row => {
          const productSelect = row.querySelector(".product-select");
          const quantityInput = row.querySelector(".quantity-input");
          
          const selectedOption = productSelect.options[productSelect.selectedIndex];
          const productId = selectedOption.value;
          const namaProduk = selectedOption.textContent.split(' (')[0]; // Extract name from textContent
          const hargaSatuan = selectedOption.dataset.price ? parseInt(selectedOption.dataset.price) : 0;
          const jumlah = parseInt(quantityInput.value) || 0;

          if (!productId || jumlah <= 0 || hargaSatuan <= 0) {
              isValid = false;
              return;
          }

          items.push({
              productId: productId,
              namaProduk: namaProduk,
              jumlah: jumlah,
              hargaSatuan: hargaSatuan
          });
          totalTransaksi += (jumlah * hargaSatuan);
      });

      if (!isValid || items.length === 0 || !jenis || !kategori || !statusPembayaran) {
          showAlert("Mohon lengkapi semua field yang wajib diisi (Produk, Jumlah, Jenis, Kategori, Status Pembayaran)!", true);
          return;
      }

      try {
        const docRef = await addDoc(collection(db, "transactions"), {
          pembeli,
          items: items, // Store as array of objects
          total: totalTransaksi,
          jenis,
          statusPembayaran,
          kategori,
          catatan,
          tanggal
        });
        showAlert("Transaksi berhasil disimpan!");
        this.reset();
        // Clear dynamic product rows and add one default
        productItemsContainer.innerHTML = '';
        createProductItemRow();
        loadTransactions(); // Reload to reflect changes
      } catch (error) {
        showAlert("Gagal menyimpan transaksi: " + error.message, true);
      }
    });

    // Delete confirmation
    let deleteTransactionId = null;
    function showDeleteConfirmation(id) {
      deleteTransactionId = id;
      document.getElementById("confirmModal").style.display = "flex";
    }
    document.getElementById("cancelDelete").addEventListener("click", function() {
      document.getElementById("confirmModal").style.display = "none";
      deleteTransactionId = null;
    });
    document.getElementById("confirmDelete").addEventListener("click", async function() {
      if (deleteTransactionId) {
        try {
          await deleteDoc(doc(db, "transactions", deleteTransactionId));
          transactions = transactions.filter(tx => tx.id !== deleteTransactionId);
          showAlert("Transaksi berhasil dihapus!");
          renderSummary();
          renderTransactionTable();
          renderInvoiceDropdown();
        } catch (error) {
          showAlert("Gagal menghapus transaksi: " + error.message, true);
        } finally {
          document.getElementById("confirmModal").style.display = "none";
          deleteTransactionId = null;
        }
      }
    });

    // User Info and Logout
    document.getElementById("btnLogout").addEventListener("click", async function() {
      try {
        await signOut(auth);
        showAlert("Berhasil logout!");
        window.location.reload();
      } catch (error) {
        showAlert("Gagal logout: " + error.message, true);
      }
    });
    document.getElementById("btnChangePassword").addEventListener("click", async function() {
      const newPwd = document.getElementById("newPassword").value.trim();
      if (newPwd.length < 6) {
        showAlert("Password minimal 6 karakter!", true);
        return;
      }
      try {
        await updatePassword(auth.currentUser, newPwd);
        showAlert("Password berhasil diubah!");
        document.getElementById("newPassword").value = "";
      } catch (error) {
        showAlert("Gagal mengubah password: " + error.message, true);
      }
    });
    function showUserInfo() {
      const user = auth.currentUser;
      document.getElementById("userInfo").innerHTML = user ?
        `Login sebagai: <strong>${user.email}</strong>` : "";
    }

    // Offline Indicator
    window.addEventListener('offline', () => {
      document.getElementById('offlineIndicator').style.display = 'block';
    });
    window.addEventListener('online', () => {
      document.getElementById('offlineIndicator').style.display = 'none';
    });

    // Backup & Restore
    document.getElementById("backupJSON").onclick = function() {
      const backupData = { transactions: transactions };
      const blob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `femmeiatracker_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    };
    document.getElementById("restoreJSONBtn").onclick = function() {
      document.getElementById("restoreJSON").click();
    };
    document.getElementById("restoreJSON").onchange = function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.transactions && Array.isArray(data.transactions)) {
            // Clear existing data (optional, or merge)
            // For simplicity, we'll replace existing data
            transactions = data.transactions.map(tx => ({
                ...tx,
                tanggal: new Date(tx.tanggal), // Convert timestamp back to Date object
                // Ensure 'items' array exists for restored data
                items: tx.items || (tx.produk ? [{ namaProduk: tx.produk, jumlah: tx.jumlah || 1, hargaSatuan: tx.harga || tx.total }] : [])
            }));
            showAlert("Data berhasil direstore!");
            renderSummary();
            renderTransactionTable();
            renderInvoiceDropdown();
          } else {
            showAlert("Format file tidak valid!", true);
          }
        } catch (error) {
          showAlert("Gagal restore data: " + error.message, true);
        }
      };
      reader.readAsText(file);
    };

    // Export to CSV
    document.getElementById("exportCSV").onclick = function() {
      if (filteredTransactions.length === 0) {
        showAlert("Tidak ada data untuk diekspor!", true);
        return;
      }
      const rows = [
        ["Tanggal","Pembeli","Produk","Jumlah","Harga Satuan","Total","Jenis","Status Pembayaran","Kategori","Catatan"].join(","),
        ...filteredTransactions.map(tx => {
          // Handle multi-item products for CSV
          const productDetails = tx.items ? tx.items.map(item => `${item.namaProduk} (${item.jumlah}x @${item.hargaSatuan})`).join('; ') : `${tx.produk || 'N/A'} (${tx.jumlah || 1}x @${tx.harga || tx.total})`;
          const totalQuantity = tx.items ? tx.items.reduce((sum, item) => sum + item.jumlah, 0) : tx.jumlah || 0;
          const totalHargaSatuan = tx.items ? tx.items.reduce((sum, item) => sum + item.hargaSatuan, 0) : tx.harga || tx.total;

          return [
            formatDateIndonesian(tx.tanggal),
            `"${tx.pembeli || "-"}"`,
            `"${productDetails}"`,
            totalQuantity,
            totalHargaSatuan,
            tx.total,
            tx.jenis === "pemasukan" ? "Pemasukan" : "Pengeluaran",
            tx.statusPembayaran === "lunas" ? "Lunas" : "Belum Lunas",
            `"${tx.kategori || "-"}"`,
            `"${tx.catatan || "-"}"`
          ].join(",");
        })
      ];
      const blob = new Blob([rows.join("\n")], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `femmeiatracker_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };

    // Export to PDF (design ulang dengan tampilan modern dan rapi)
    async function loadJsPDF() {
      return new Promise((resolve, reject) => { // Added reject here
        if (window.jspdf && window.jspdf.jsPDF) { // Check for both window.jspdf and its jsPDF property
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    document.getElementById("exportPDF").onclick = async function() {
      if (filteredTransactions.length === 0) {
        showAlert("Tidak ada data untuk diekspor!", true);
        return;
      }
      try {
        await loadJsPDF();
        // Correctly access the jsPDF constructor
        const { jsPDF } = window.jspdf; 
        const doc = new jsPDF({
          orientation: 'landscape', // Menggunakan orientasi landscape untuk tabel yang lebih lebar
          unit: 'mm'
        });
        const pageHeight = doc.internal.pageSize.getHeight();
        const pageWidth = doc.internal.pageSize.getWidth();
        const marginX = 15;
        const marginY = 15;
        let yPos = marginY;

        // Fungsi untuk menambahkan header di setiap halaman
        function addHeader() {
          doc.setFillColor(245, 245, 245); // Lighter background
          doc.rect(0, 0, pageWidth, 18, 'F');
          doc.setFontSize(16);
          doc.setTextColor(0, 0, 0);
          doc.text('FemmeiaCloth - Laporan Riwayat Transaksi', pageWidth / 2, 11, { align: 'center' });
          doc.setFontSize(10);
          doc.setTextColor(100, 100, 100);
          doc.text(`Tanggal Cetak: ${formatDateIndonesian(new Date())}`, pageWidth - marginX - 50, 11);
          yPos = marginY + 20;
        }

        // Fungsi untuk menambahkan footer di setiap halaman
        function addFooter(pageNumber, totalPages) {
          doc.setFontSize(9);
          doc.setTextColor(100, 100, 100);
          doc.text(`Halaman ${pageNumber} dari ${totalPages}`, pageWidth / 2, pageHeight - marginY, { align: 'center' });
          doc.text('Email: femmeiacloth@gmail.com | Phone: +6285341899229', pageWidth / 2, pageHeight - marginY + 5, { align: 'center' });
        }

        // Tambahkan header untuk halaman pertama
        addHeader();

        // Judul laporan
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text('Ringkasan Transaksi', marginX, yPos);
        yPos += 10;

        // Ringkasan Total (seperti di UI)
        const { pemasukan, pengeluaran, piutang } = computeSummaryFromList(filteredTransactions);
        doc.setFontSize(11);
        doc.setFillColor(220, 240, 230); // Light green tone
        doc.rect(marginX, yPos, 80, 8, 'F');
        doc.text(`Total Pemasukan: ${formatRupiah(pemasukan)}`, marginX + 5, yPos + 5);
        yPos += 8;

        doc.setFillColor(240, 220, 220); // Light red tone
        doc.rect(marginX, yPos, 80, 8, 'F');
        doc.text(`Total Pengeluaran: ${formatRupiah(pengeluaran)}`, marginX + 5, yPos + 5);
        yPos += 8;

        doc.setFillColor(235, 235, 240); // Light gray tone
        doc.rect(marginX, yPos, 80, 8, 'F');
        doc.text(`Total Piutang: ${formatRupiah(piutang)}`, marginX + 5, yPos + 5);
        yPos += 15;

        // Header Tabel
        doc.setFontSize(11);
        doc.setFillColor(245, 245, 245); // Lighter gray for header
        doc.rect(marginX, yPos, pageWidth - marginX - marginX, 10, 'F');
        let xPos = marginX + 3;
        const headers = ["Tanggal", "Pembeli", "Produk", "Jumlah", "Harga Satuan", "Total", "Jenis", "Status", "Kategori", "Catatan"];
        const colWidths = [25, 25, 30, 15, 25, 25, 20, 20, 20, 30];
        headers.forEach((header, i) => {
          doc.text(header, xPos, yPos + 6);
          xPos += colWidths[i];
        });
        yPos += 10;

        // Isi data transaksi
        doc.setFontSize(10);
        doc.setTextColor(51, 51, 51); // text-color
        filteredTransactions.forEach((tx, i) => {
          if (yPos > pageHeight - marginY - 10) { // Cek jika halaman penuh
            addFooter(doc.internal.getNumberOfPages(), 0); // Placeholder for total pages
            doc.addPage();
            addHeader(); // Tambahkan header halaman baru
            // Ulangi header tabel di halaman baru
            doc.setFontSize(11);
            doc.setFillColor(245, 245, 245);
            doc.rect(marginX, yPos, pageWidth - marginX - marginX, 10, 'F');
            xPos = marginX + 3;
            headers.forEach((header, j) => {
              doc.text(header, xPos, yPos + 6);
              xPos += colWidths[j];
            });
            yPos += 10;
            doc.setFontSize(10);
            doc.setTextColor(51, 51, 51);
          }

          // Baris data
          doc.setFillColor(i % 2 === 0 ? 255 : 250, i % 2 === 0 ? 255 : 250, i % 2 === 0 ? 255 : 250);
          doc.rect(marginX, yPos, pageWidth - marginX - marginX, 10, 'F');
          doc.setDrawColor(200, 200, 200);
          doc.setLineWidth(0.1);
          let xPosTemp = marginX;
          colWidths.forEach(w => {
            doc.line(xPosTemp, yPos, xPosTemp, yPos + 10);
            xPosTemp += w;
          });
          doc.line(xPosTemp, yPos, xPosTemp, yPos + 10); // Garis terakhir
          doc.line(marginX, yPos, pageWidth - marginX, yPos); // Garis atas baris
          doc.line(marginX, yPos + 10, pageWidth - marginX, yPos + 10); // Garis bawah baris

          // Isi data
          xPos = marginX + 3;
          const productNames = tx.items ? tx.items.map(item => item.namaProduk).join(', ') : tx.produk || 'N/A';
          const totalQuantity = tx.items ? tx.items.reduce((sum, item) => sum + item.jumlah, 0) : tx.jumlah || 0;
          const totalHargaSatuan = tx.items ? tx.items.reduce((sum, item) => sum + item.hargaSatuan, 0) : tx.harga || tx.total;

          const rowData = [
            formatDateIndonesian(tx.tanggal),
            tx.pembeli || "-",
            productNames,
            totalQuantity.toString(),
            formatRupiah(totalHargaSatuan),
            tx.total,
            tx.jenis === "pemasukan" ? "Pemasukan" : "Pengeluaran",
            tx.statusPembayaran === "lunas" ? "Lunas" : "Belum Lunas",
            tx.kategori || "-",
            tx.catatan || "-"
          ];
          rowData.forEach((data, j) => {
            const lines = doc.splitTextToSize(data, colWidths[j] - 5);
            doc.text(lines[0] || "", xPos, yPos + 6);
            xPos += colWidths[j];
          });
          yPos += 10;
        });

        // Hitung total halaman setelah semua konten ditambahkan
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          addFooter(i, totalPages);
        }

        // Simpan file
        doc.save(`femmeiatracker_${new Date().toISOString().slice(0,10)}.pdf`);
        showAlert("Berhasil ekspor data ke PDF!");
      } catch (error) {
        console.error("Gagal ekspor PDF:", error);
        showAlert("Gagal ekspor PDF: " + error.message, true);
      }
    };

    // Invoice Generation
    function renderInvoiceDropdown() {
      const select = document.getElementById("selectTransaction");
      select.innerHTML = '<option value="">-- Pilih Transaksi untuk Invoice --</option>';
      // Hanya tampilkan transaksi pemasukan yang belum lunas atau lunas
      transactions.slice().sort((a, b) => b.tanggal - a.tanggal).forEach(transaction => {
        if (transaction.jenis === "pemasukan") {
          const productNames = transaction.items ? transaction.items.map(item => item.namaProduk).join(', ') : transaction.produk || 'N/A';
          const option = document.createElement("option");
          option.value = transaction.id;
          option.textContent = `${formatDateIndonesian(transaction.tanggal)} - ${productNames} - ${formatRupiah(transaction.total)} (${transaction.statusPembayaran === 'lunas' ? 'Lunas' : 'Belum Lunas'})`;
          select.appendChild(option);
        }
      });
    }

    document.getElementById("selectTransaction").addEventListener("change", function() {
      const transactionId = this.value;
      if (transactionId) {
        renderInvoice(transactionId);
      } else {
        document.getElementById("noInvoiceMessage").style.display = "block";
        document.getElementById("invoicePreview").style.display = "none";
      }
    });

    function renderInvoice(transactionId) {
      const transaction = transactions.find(tx => tx.id === transactionId);
      if (!transaction) {
        document.getElementById("noInvoiceMessage").style.display = "block";
        document.getElementById("invoicePreview").style.display = "none";
        return;
      }

      document.getElementById("noInvoiceMessage").style.display = "none";
      document.getElementById("invoicePreview").style.display = "block";

      // Isi data invoice
      document.getElementById("invoiceDate").textContent = formatDateIndonesian(transaction.tanggal);
      document.getElementById("invoiceNumber").textContent = `INV-${transaction.id.slice(0, 8).toUpperCase()}`;
      document.getElementById("invoiceBuyer").textContent = transaction.pembeli || "Pelanggan";
      document.getElementById("invoiceTotal").textContent = formatRupiah(transaction.total);
      document.getElementById("printDate").textContent = formatDateIndonesian(new Date());

      // Isi item invoice
      const invoiceItemsTbody = document.getElementById("invoiceItems");
      invoiceItemsTbody.innerHTML = "";
      // Handle both new 'items' array and old single product format for invoice items
      const itemsToDisplay = transaction.items || [{
          namaProduk: transaction.produk || 'N/A',
          jumlah: transaction.jumlah || 1,
          hargaSatuan: transaction.harga || (transaction.total / (transaction.jumlah || 1))
      }];

      itemsToDisplay.forEach((item, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${item.namaProduk}</td>
            <td style="text-align: center;">${item.jumlah}</td>
            <td style="text-align: right;">${formatRupiah(item.hargaSatuan)}</td>
            <td style="text-align: right;">${formatRupiah(item.jumlah * item.hargaSatuan)}</td>
        `;
        invoiceItemsTbody.appendChild(tr);
      });

      // Add Status Label
      let statusLabel = document.querySelector('.invoice-status-label');
      if (!statusLabel) {
          statusLabel = document.createElement('div');
          statusLabel.classList.add('invoice-status-label');
          document.querySelector('.invoice-container').prepend(statusLabel);
      }
      statusLabel.textContent = transaction.statusPembayaran === 'lunas' ? 'LUNAS' : 'BELUM LUNAS';
      statusLabel.classList.remove('lunas', 'belum-lunas');
      statusLabel.classList.add(transaction.statusPembayaran === 'lunas' ? 'lunas' : 'belum-lunas');
    }

    document.getElementById("btnExportInvoicePDF").addEventListener("click", async function() {
      const transactionId = document.getElementById("selectTransaction").value;
      const exportButton = document.getElementById("btnExportInvoicePDF");

      if (!transactionId) {
        showAlert("Pilih transaksi terlebih dahulu!", true);
        return;
      }

      const transaction = transactions.find(tx => tx.id === transactionId);
      if (!transaction) {
        showAlert("Transaksi tidak ditemukan!", true);
        return;
      }

      // Nonaktifkan tombol untuk mencegah double click/download
      exportButton.disabled = true;
      exportButton.textContent = "Memproses...";

      try {
        await loadJsPDF();
        // Correctly access the jsPDF constructor
        const { jsPDF } = window.jspdf; 
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const pageHeight = doc.internal.pageSize.getHeight();
        const pageWidth = doc.internal.pageSize.getWidth();
        const marginX = 20;
        const marginY = 20;
        let yPos = marginY;

        // Header Perusahaan
        doc.setFontSize(24);
        doc.setTextColor(31, 41, 55); // accent-dark
        doc.text('FemmeiaCloth', pageWidth / 2, yPos, { align: 'center' });
        yPos += 8;
        doc.setFontSize(10);
        doc.setTextColor(102, 102, 102); // accent-mid
        doc.text('Tamalanrea, Makassar, Indonesia', pageWidth / 2, yPos, { align: 'center' });
        yPos += 5;
        doc.text('Email: femmeiacloth@gmail.com | Phone: +6285341899229', pageWidth / 2, yPos, { align: 'center' });
        yPos += 15;

        // Garis Pemisah
        doc.setDrawColor(224, 224, 224); // accent-light
        doc.setLineWidth(0.5);
        doc.line(marginX, yPos, pageWidth - marginX, yPos);
        yPos += 10;

        // Judul Invoice dan Detail
        doc.setFontSize(18);
        doc.setTextColor(31, 41, 55); // accent-dark
        doc.text('INVOICE', marginX, yPos);
        doc.setFontSize(10);
        doc.setTextColor(102, 102, 102); // accent-mid
        doc.text(`Tanggal: ${formatDateIndonesian(transaction.tanggal)}`, pageWidth - marginX, yPos, { align: 'right' });
        yPos += 5;
        doc.text(`Nomor Invoice: INV-${transaction.id.slice(0, 8).toUpperCase()}`, pageWidth - marginX, yPos, { align: 'right' });
        yPos += 15;

        // Ditagih Kepada
        doc.setFontSize(12);
        doc.setTextColor(31, 41, 55); // accent-dark
        doc.text('Ditagih Kepada:', marginX, yPos);
        yPos += 6;
        doc.setFontSize(11);
        doc.setTextColor(51, 51, 51); // text-color
        doc.text(transaction.pembeli || 'Pelanggan', marginX, yPos);
        yPos += 15;

        // Tabel Item
        doc.setFontSize(10);
        doc.setFillColor(245, 245, 245); // Lighter gray for header
        doc.rect(marginX, yPos, pageWidth - (2 * marginX), 10, 'F');
        doc.setTextColor(31, 41, 55); // accent-dark
        
        const tableHeaders = ["No.", "Produk", "Jumlah", "Harga Satuan", "Subtotal"];
        const colWidths = [10, 70, 20, 30, 30]; // Adjusted widths for better fit
        let currentX = marginX;
        tableHeaders.forEach((header, i) => {
            let align = 'left';
            if (i === 2) align = 'center'; // Jumlah
            if (i === 3 || i === 4) align = 'right'; // Harga Satuan, Subtotal
            doc.text(header, currentX + (colWidths[i] / 2), yPos + 6, { align: align });
            currentX += colWidths[i];
        });
        yPos += 10;

        doc.setFontSize(9);
        doc.setTextColor(51, 51, 51); // text-color
        const itemsToPrint = transaction.items || [{
            namaProduk: transaction.produk || 'N/A',
            jumlah: transaction.jumlah || 1,
            hargaSatuan: transaction.harga || (transaction.total / (transaction.jumlah || 1))
        }];

        itemsToPrint.forEach((item, index) => {
            doc.setFillColor(index % 2 === 0 ? 255 : 250, index % 2 === 0 ? 255 : 250, index % 2 === 0 ? 255 : 250);
            doc.rect(marginX, yPos, pageWidth - (2 * marginX), 8, 'F');
            doc.setDrawColor(180, 180, 180);
            doc.setLineWidth(0.1);
            doc.line(marginX, yPos, pageWidth - marginX, yPos); // Garis bawah baris sebelumnya

            currentX = marginX;
            const rowData = [
                (index + 1).toString(),
                item.namaProduk,
                item.jumlah.toString(),
                formatRupiah(item.hargaSatuan),
                formatRupiah(item.jumlah * item.hargaSatuan)
            ];

            rowData.forEach((data, j) => {
                let align = 'left';
                if (j === 2) align = 'center';
                if (j === 3 || j === 4) align = 'right';
                doc.text(data, currentX + (colWidths[j] / 2), yPos + 5, { align: align });
                currentX += colWidths[j];
            });
            yPos += 8;
        });

        // Total
        yPos += 5;
        doc.setFontSize(12);
        doc.setTextColor(31, 41, 55); // accent-dark
        doc.text('Total:', pageWidth - marginX - colWidths[4] - 5, yPos); // Adjusted position
        doc.text(formatRupiah(transaction.total), pageWidth - marginX, yPos, { align: 'right' });
        yPos += 20;

        // Thank You Note
        doc.setFontSize(10);
        doc.setTextColor(102, 102, 102); // accent-mid
        doc.text('Terima kasih atas kepercayaan Anda kepada FemmeiaCloth.', pageWidth / 2, yPos, { align: 'center' });
        yPos += 5;
        doc.text('Kami berharap dapat melayani Anda kembali di masa depan.', pageWidth / 2, yPos, { align: 'center' });
        yPos += 20;

        // Footer
        doc.setFontSize(9);
        doc.setTextColor(102, 102, 102); // accent-mid
        doc.text(`Invoice ini dibuat pada ${formatDateIndonesian(new Date())}`, pageWidth / 2, pageHeight - marginY, { align: 'center' });

        // Status Label (New Feature)
        const statusText = transaction.statusPembayaran === 'lunas' ? 'LUNAS' : 'BELUM LUNAS';
        const statusBgColor = transaction.statusPembayaran === 'lunas' ? [0, 184, 148] : [214, 48, 49]; // Green or Red
        doc.setFillColor(statusBgColor[0], statusBgColor[1], statusBgColor[2]);
        doc.setTextColor(255, 255, 255); // White text
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        const statusTextWidth = doc.getStringUnitWidth(statusText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
        const statusPaddingX = 5;
        const statusPaddingY = 3;
        const statusRectWidth = statusTextWidth + (2 * statusPaddingX);
        const statusRectHeight = doc.internal.getFontSize() + (2 * statusPaddingY);
        const statusX = pageWidth - marginX - statusRectWidth;
        const statusY = marginY + 10; // Adjust position as needed
        doc.roundedRect(statusX, statusY, statusRectWidth, statusRectHeight, 3, 3, 'F');
        doc.text(statusText, statusX + statusPaddingX, statusY + statusRectHeight - statusPaddingY);
        doc.setFont('helvetica', 'normal'); // Reset font style
        doc.setTextColor(51, 51, 51); // Reset text color

        // Simpan PDF
        const firstProductName = itemsToPrint[0] ? itemsToPrint[0].namaProduk : 'invoice';
        doc.save(`femmeia_invoice_${firstProductName.replace(/ /g, '_')}_${formatDateIndonesian(transaction.tanggal).replace(/ /g, '_')}.pdf`);
        showAlert("Invoice berhasil diekspor ke PDF!");
      } catch (error) {
        console.error("Gagal ekspor invoice ke PDF:", error);
        showAlert("Gagal ekspor invoice ke PDF: " + error.message, true);
      } finally {
        // Aktifkan kembali tombol setelah proses selesai
        exportButton.disabled = false;
        exportButton.textContent = "Export Invoice ke PDF";
      }
    });

    // Chart
    let myChart = null;
    let myMonthlyChart = null;
    async function loadChartJS() {
      return new Promise((resolve) => {
        if (window.Chart) return resolve();
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = () => {
          // Ensure Chart.js plugins are also loaded if needed, e.g., chartjs-plugin-datalabels
          // For this example, we don't need extra plugins, so just resolve.
          resolve();
        };
        document.head.appendChild(script);
      });
    }
    async function renderChart(pemasukan, pengeluaran, piutang) {
      await loadChartJS();
      const ctx = document.getElementById('grafik').getContext('2d');
      if(myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Pemasukan', 'Pengeluaran', 'Piutang'],
          datasets: [{
            data: [pemasukan, pengeluaran, piutang],
            backgroundColor: [
              'rgba(0, 184, 148, 0.7)',
              'rgba(214, 48, 49, 0.7)',
              'rgba(255, 193, 7, 0.7)' // Warna untuk Piutang
            ],
            borderColor: [
              'rgba(0, 184, 148, 1)',
              'rgba(214, 48, 49, 1)',
              'rgba(255, 193, 7, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) label += ': ';
                  if (context.raw !== null) label += formatRupiah(context.raw);
                  return label;
                }
              }
            }
          }
        }
      });
    }
    async function renderMonthlyChart() {
      await loadChartJS();
      const ctx = document.getElementById('grafikBulanan').getContext('2d');
      if(myMonthlyChart) myMonthlyChart.destroy();
      // Hitung pemasukan & pengeluaran per bulan
      const monthly = {};
      transactions.forEach(tx => {
        const ym = `${tx.tanggal.getFullYear()}-${String(tx.tanggal.getMonth()+1).padStart(2,"0")}`;
        if (!monthly[ym]) monthly[ym] = { pemasukan: 0, pengeluaran: 0, piutang: 0 };
        if (tx.jenis === "pemasukan") {
            if (tx.statusPembayaran === "lunas") {
                monthly[ym].pemasukan += tx.total;
            } else {
                monthly[ym].piutang += tx.total;
            }
        } else {
            monthly[ym].pengeluaran += tx.total;
        }
      });
      const labels = Object.keys(monthly).sort();
      const pemasukanData = labels.map(l => monthly[l].pemasukan);
      const pengeluaranData = labels.map(l => monthly[l].pengeluaran);
      const piutangData = labels.map(l => monthly[l].piutang);

      myMonthlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Pemasukan', data: pemasukanData, backgroundColor: 'rgba(0,184,148,0.7)' },
            { label: 'Pengeluaran', data: pengeluaranData, backgroundColor: 'rgba(214,48,49,0.7)' },
            { label: 'Piutang', data: piutangData, backgroundColor: 'rgba(255, 193, 7, 0.7)' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true, ticks: { callback: v=>formatRupiah(v) } } }
        }
      });
    }

    // Admin Product & Category Management
    const adminModal = document.getElementById('adminModal');
    const adminProductBtn = document.getElementById('adminProductBtn');
    const closeAdminModalBtn = document.getElementById('closeAdminModalBtn');
    const adminModalTabButtons = document.querySelectorAll('.admin-modal-tab-button');
    const kategoriTabContent = document.getElementById('kategoriTabContent');
    const produkTabContent = document.getElementById('produkTabContent');

    const inputKategori = document.getElementById('inputKategori');
    const addKategoriBtn = document.getElementById('addKategoriBtn');
    const kategoriListDiv = document.getElementById('kategoriList');

    const inputNamaProduk = document.getElementById('inputNamaProduk');
    const inputHargaProduk = document.getElementById('inputHargaProduk');
    const selectKategoriProduk = document.getElementById('selectKategoriProduk');
    const addProdukBtn = document.getElementById('addProdukBtn');
    const updateProdukBtn = document.getElementById('updateProdukBtn');
    const cancelEditProdukBtn = document.getElementById('cancelEditProdukBtn');
    const produkListDiv = document.getElementById('produkList');
    const editProductIdInput = document.getElementById('editProductId');

    let categories = [];
    let products = [];

    // Open/Close Admin Modal
    adminProductBtn.addEventListener('click', () => {
        adminModal.style.display = 'flex';
        loadKategoriProduk();
        loadProduk();
    });

    closeAdminModalBtn.addEventListener('click', () => {
        adminModal.style.display = 'none';
    });

    // Tab Switching
    adminModalTabButtons.forEach(button => {
        button.addEventListener('click', () => {
            adminModalTabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            kategoriTabContent.classList.remove('active');
            produkTabContent.classList.remove('active');

            if (button.dataset.tab === 'kategori') {
                kategoriTabContent.classList.add('active');
            } else {
                produkTabContent.classList.add('active');
            }
        });
    });

    // CRUD Kategori
    async function loadKategoriProduk() {
        kategoriListDiv.innerHTML = '';
        categories = [];
        try {
            const q = query(collection(db, "kategoriProduk"), orderBy("nama", "asc"));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                categories.push({ id: doc.id, ...doc.data() });
            });
            renderKategoriList();
            populateKategoriDropdown(); // Update dropdown in product form
        } catch (error) {
            console.error("Error loading categories:", error);
            showAlert("Gagal memuat kategori.", true);
        }
    }

    function renderKategoriList() {
        kategoriListDiv.innerHTML = '';
        if (categories.length === 0) {
            kategoriListDiv.innerHTML = '<p style="text-align: center; color: #666;">Belum ada kategori.</p>';
            return;
        }
        categories.forEach(cat => {
            const item = document.createElement('div');
            item.classList.add('admin-modal-list-item');
            item.innerHTML = `
                <span>${cat.nama}</span>
                <div class="actions">
                    <button class="btn-delete" data-id="${cat.id}" data-type="kategori">Hapus</button>
                </div>
            `;
            kategoriListDiv.appendChild(item);
        });
        addDeleteListeners('kategori');
    }

    addKategoriBtn.addEventListener('click', async () => {
        const nama = inputKategori.value.trim();
        if (!nama) {
            showAlert("Nama kategori tidak boleh kosong!", true);
            return;
        }
        try {
            await addDoc(collection(db, "kategoriProduk"), { nama: nama });
            showAlert("Kategori berhasil ditambahkan!");
            inputKategori.value = '';
            loadKategoriProduk();
        } catch (error) {
            showAlert("Gagal menambahkan kategori: " + error.message, true);
        }
    });

    // CRUD Produk
    async function loadProduk() {
        produkListDiv.innerHTML = '';
        products = [];
        try {
            const q = query(collection(db, "produk"), orderBy("nama", "asc"));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                products.push({ id: doc.id, ...doc.data() });
            });
            renderProdukList();
            // Update all product dropdowns in the main transaction form
            document.querySelectorAll('.product-select').forEach(select => {
                loadProductsToDropdown(select);
            });
        } catch (error) {
            console.error("Error loading products:", error);
            showAlert("Gagal memuat produk.", true);
        }
    }

    function renderProdukList() {
        produkListDiv.innerHTML = '';
        if (products.length === 0) {
            produkListDiv.innerHTML = '<p style="text-align: center; color: #666;">Belum ada produk.</p>';
            return;
        }
        products.forEach(prod => {
            const item = document.createElement('div');
            item.classList.add('admin-modal-list-item');
            const categoryName = categories.find(cat => cat.id === prod.kategori)?.nama || 'Tidak Diketahui';
            item.innerHTML = `
                <span>${prod.nama} (${formatRupiah(prod.harga)}) - ${categoryName}</span>
                <div class="actions">
                    <button class="btn-edit" data-id="${prod.id}" data-type="produk">Edit</button>
                    <button class="btn-delete" data-id="${prod.id}" data-type="produk">Hapus</button>
                </div>
            `;
            produkListDiv.appendChild(item);
        });
        addDeleteListeners('produk');
        addEditListeners('produk');
    }

    function populateKategoriDropdown() {
        selectKategoriProduk.innerHTML = '<option value="">Pilih Kategori</option>';
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.nama;
            selectKategoriProduk.appendChild(option);
        });
    }

    addProdukBtn.addEventListener('click', async () => {
        const nama = inputNamaProduk.value.trim();
        const harga = parseInt(inputHargaProduk.value);
        const kategoriId = selectKategoriProduk.value;

        if (!nama || isNaN(harga) || harga <= 0 || !kategoriId) {
            showAlert("Nama, Harga (harus angka positif), dan Kategori produk harus diisi!", true);
            return;
        }
        try {
            await addDoc(collection(db, "produk"), { nama: nama, harga: harga, kategori: kategoriId });
            showAlert("Produk berhasil ditambahkan!");
            inputNamaProduk.value = '';
            inputHargaProduk.value = '';
            selectKategoriProduk.value = '';
            loadProduk();
        } catch (error) {
            showAlert("Gagal menambahkan produk: " + error.message, true);
        }
    });

    updateProdukBtn.addEventListener('click', async () => {
        const productId = editProductIdInput.value;
        const nama = inputNamaProduk.value.trim();
        const harga = parseInt(inputHargaProduk.value);
        const kategoriId = selectKategoriProduk.value;

        if (!productId || !nama || isNaN(harga) || harga <= 0 || !kategoriId) {
            showAlert("Data produk tidak lengkap untuk update!", true);
            return;
        }
        try {
            await updateDoc(doc(db, "produk", productId), { nama: nama, harga: harga, kategori: kategoriId });
            showAlert("Produk berhasil diperbarui!");
            resetProdukForm();
            loadProduk();
        } catch (error) {
            showAlert("Gagal memperbarui produk: " + error.message, true);
        }
    });

    cancelEditProdukBtn.addEventListener('click', () => {
        resetProdukForm();
    });

    function resetProdukForm() {
        editProductIdInput.value = '';
        inputNamaProduk.value = '';
        inputHargaProduk.value = '';
        selectKategoriProduk.value = '';
        addProdukBtn.style.display = 'block';
        updateProdukBtn.style.display = 'none';
        cancelEditProdukBtn.style.display = 'none';
    }

    function addDeleteListeners(type) {
        document.querySelectorAll(`.btn-delete[data-type="${type}"]`).forEach(button => {
            button.onclick = async function() {
                const id = this.dataset.id;
                const confirmDelete = confirm(`Yakin ingin menghapus ${type} ini?`);
                if (confirmDelete) {
                    try {
                        await deleteDoc(doc(db, type === 'kategori' ? "kategoriProduk" : "produk", id));
                        showAlert(`${type} berhasil dihapus!`);
                        if (type === 'kategori') {
                            loadKategoriProduk();
                        } else {
                            loadProduk();
                        }
                    } catch (error) {
                        showAlert(`Gagal menghapus ${type}: ` + error.message, true);
                    }
                }
            };
        });
    }

    function addEditListeners(type) {
        if (type === 'produk') {
            document.querySelectorAll(`.btn-edit[data-type="produk"]`).forEach(button => {
                button.onclick = function() {
                    const productId = this.dataset.id;
                    const productToEdit = products.find(p => p.id === productId);
                    if (productToEdit) {
                        editProductIdInput.value = productToEdit.id;
                        inputNamaProduk.value = productToEdit.nama;
                        inputHargaProduk.value = productToEdit.harga;
                        selectKategoriProduk.value = productToEdit.kategori;

                        addProdukBtn.style.display = 'none';
                        updateProdukBtn.style.display = 'block';
                        cancelEditProdukBtn.style.display = 'inline-block';
                    }
                };
            });
        }
    }

  </script>
  
</body>
</html>
